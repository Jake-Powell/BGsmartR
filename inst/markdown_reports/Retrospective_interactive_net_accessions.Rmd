---
title: "Retrospective Overview of the Collection - Net Accessions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(ggplot2)
library(plotly)
library(rjson)
library(xlsx)
library(sf)
```


```{r, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - min_year for retrospective reports.
# - collection the name to be printed in the report.

# load('/Users/jakepowell/Cambridge/Enriched reports/CUBG_enriched_report.rda')
# report = enriched_report
# collection = 'CUBG'
# create_excel = TRUE
# save_widgets = TRUE
# min_year = 1980
# collection_coords = c(0.128305,52.193403)
# do_coord = !is.na(collection_coords[1])
# output_dir = getwd()

report = enriched_report

if(save_widgets){
  widget_dir = paste0(output_dir,'/',collection,'_Widgets')
  dir.create(widget_dir,showWarnings = FALSE)
  
  whole_collection_widget_dir = paste0(widget_dir,'/Whole_collection')
  dir.create(whole_collection_widget_dir,showWarnings = FALSE)
    
  new_accessions_widget_dir = paste0(widget_dir,'/New_accessions')
  dir.create(new_accessions_widget_dir,showWarnings = FALSE)
  
  lost_accessions_widget_dir = paste0(widget_dir,'/Lost_accessions')
  dir.create(lost_accessions_widget_dir,showWarnings = FALSE)
  
  net_accessions_widget_dir = paste0(widget_dir,'/Net_accessions')
  dir.create(net_accessions_widget_dir,showWarnings = FALSE)
}

# Add endemic/notendemic split.
report$endemic = rep(NA, nrow(report))
report$endemic[!is.na(report$POWO_Dist_area_code_l3)] = 'Not Endemic'
endemic_index = which(stringr::str_length(report$POWO_Dist_area_code_l3) ==3)
report$endemic[endemic_index] = 'Endemic'

# Add threatened/notthreatened split.
report$threatened = rep('Not Threatened', nrow(report))
threat_index = which(report$redList_category %in% c('VU','EN','CR', 'EW', 'EX'))
report$threatened[threat_index] = 'Threatened'

# Update the original family to only have first letter capitalised.
report$Family = stringr::str_to_title(report$Family)

# Set the min year of the report
if(is.null(min_year)){
  min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
}

# Load the geographic information.
wgsrpd3 = BGSmartR::wgsrpd3

# Extract the location of the collection (if we have coordinates)
if(do_coord){
pnts <- data.frame( x = collection_coords[1], y = collection_coords[2])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
level3_name = collection_geog_details$LEVEL3_NAM
level3_code = collection_geog_details$LEVEL3_COD
level2_name = collection_geog_details$LEVEL2_NAM
level2_code = collection_geog_details$LEVEL2_COD
level1_name = collection_geog_details$LEVEL1_NAM
level1_code = collection_geog_details$LEVEL1_COD

text = paste0(level3_name, ', ', level2_name, ', ', level1_name,'.')

}

# Get the current year.
year_cur = as.numeric(format(Sys.Date(),'%Y'))

# extract and calculate the number of bad accessions years.
bad_accessions_index = which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear))
if(length(bad_accessions_index)>0){
  bad_accessions = report[which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear)),]
  no_bad_accessions = nrow(bad_accessions)
  #Export the bad accessions.
  # write.csv(bad_accessions[,1:(which(names(bad_accessions) == 'sanitised_taxon')-1)], file = paste0(output_dir,'/', collection,'_issue_accession_year.csv'), row.names = FALSE)
  # Reduce report to not include those with bad accessions.
  report = report[-which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear)),]
} else{
  no_bad_accessions = 0 
}
```

This report uses data from **`r collection`** and analyses the collection from **`r min_year`** to **`r year_cur`**.

 A retrospective overview uses a combination of the accession year and item status date to calculate which plants are existing each year. This approach assumes that plants only die when their record is updated to reflect this. 

The collection contains **`r no_bad_accessions`** items that have either a missing/incorrect accession year, since we cannot accurately describe when these plants are existing we remove these records for the following analysis. These records can be found in the file **`r collection`_issue_accession_year.csv**.

This document outlines the changes in the number of accessions, species, families, genera, provenance, endemic species and threatened species. 

<hr style="border:4px solid gray">

```{r, new accessions, echo = F}
years = min_year:year_cur
#########
# Reduce data frame to only accessions.
#########
# Remove entries without an AccYear.
accessions = report[!is.na(report$AccYear),]
# Reduce report to only the earliest year of accession.
accessions = accessions[order(accessions$AccYear),]
unique_accessions = unique(accessions$AccNoFull)
accessions = report[match(unique_accessions, accessions$AccNoFull),]  

# For each year strip the quantities of interest into a list.
new_accessions = lapply(years, function(year){
  # Accessions for the year
  garden_current = accessions[accessions$AccYear == year,]
  
   # Number of families.
  families = data.frame(original = garden_current$Family, POWO = garden_current$POWO_family)
  use_family = families$POWO
  use_family[is.na(use_family)] = families$original[is.na(use_family)]
  family = unique(use_family)
  no_families <- length(family)

  # Number of genera.
  genus = data.frame(original = garden_current$Genus, POWO = garden_current$POWO_genus)
  use_genus = genus$POWO
  use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
  no_genus <- length(unique(use_genus))

  # Number of Accessions.
  no_accessions = nrow(garden_current)
  
  #No species (#remove cultivars, indeterminants, hybrids and those without infrageneric level)
  POWO_GenusSpecies = rep(NA, nrow(garden_current))
  POWO_GenusSpecies[!is.na(garden_current$POWO_plant_name_id)] = paste0(garden_current$POWO_genus[!is.na(garden_current$POWO_plant_name_id)], ' ', garden_current$POWO_species[!is.na(garden_current$POWO_plant_name_id)])
  species_data = data.frame(original = garden_current$GenusSpecies, POWO = POWO_GenusSpecies, infra = garden_current$infrageneric_level)
  species_only = species_data[!grepl('5|6|0',species_data$infra),]
  species_only = species_only[!is.na(species_only$infra),]
  use_species = species_only$POWO
  use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
  no_species = length(unique(use_species))
  
  # Breakdown of endemic.
  endemic = table(garden_current$endemic)
  
  # Number of endemic (local)
  if(do_coord){
    no_endemic_local = sum(garden_current$POWO_Dist_area_code_l3[garden_current$endemic == 'Endemic'] == level3_code, na.rm = T)
  }else{
    no_endemic_local = NA
  }
  breakdown_endemic = table(garden_current$endemic)
  
  # Breakdown of provenance.
  provenance = table(garden_current$ProvenanceCode)
  
  # Breakdown of threatened.
  breakdown_threatened = table(garden_current$threatened)
  
  # Breakdown of threatened categories
  breakdown_threatened_cateogory = table(garden_current$redList_category)
  breakdown_threatened_cateogory = breakdown_threatened_cateogory[match(c('VU','EN','CR', 'EW', 'EX'), names(breakdown_threatened_cateogory))]
  
  # Breakdown of infrageneric diversity.
  breakdown_infrageneric = table(garden_current$infrageneric_level)
  
  
  return(list(no_accessions = no_accessions, no_families = no_families, no_genus = no_genus, no_species = no_species,
              breakdown_endemic = endemic, no_endemic_local = no_endemic_local,
              breakdown_provenance = provenance,
              breakdown_threatened = breakdown_threatened, breakdown_threatened_cateogory = breakdown_threatened_cateogory,
              breakdown_infrageneric = breakdown_infrageneric))
})
names(new_accessions) = paste0('year-', years)

time_series_info = new_accessions
```

```{r, lost accessions, echo = F, eval = T}
years = min_year:year_cur
#########
# Find which accessions are lost each year. 
# Where by lost we mean an item is not existing, and the year where the final item of an accession becomes lost.
#########
accessions = report
# Reduce report to only accessions that have being lost (i.e remove those that are currently existing).
accessions_alive = unique(accessions$AccNoFull[accessions$ItemStatusType == 'Existing'])
accessions = accessions[!accessions$AccNoFull %in% accessions_alive,]

# To reduce from items to accessions only use the most recent status_year
accessions = accessions[rev(order(accessions$status_year)),]
unique_accessions = unique(accessions$AccNoFull)
accessions = accessions[match(unique_accessions, accessions$AccNoFull),]  


# For each year strip the quantities of interest into a list.
lost_accessions = lapply(years, function(year){
  # Accessions for the year
  garden_current = accessions[accessions$status_year == year,]
  
   # Number of families.
  families = data.frame(original = garden_current$Family, POWO = garden_current$POWO_family)
  use_family = families$POWO
  use_family[is.na(use_family)] = families$original[is.na(use_family)]
  family = unique(use_family)
  no_families <- length(family)

  # Number of genera.
  genus = data.frame(original = garden_current$Genus, POWO = garden_current$POWO_genus)
  use_genus = genus$POWO
  use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
  no_genus <- length(unique(use_genus))

  # Number of Accessions.
  no_accessions = nrow(garden_current)
  
  #No species (#remove cultivars, indeterminants, hybrids and those without infrageneric level)
  POWO_GenusSpecies = rep(NA, nrow(garden_current))
  POWO_GenusSpecies[!is.na(garden_current$POWO_plant_name_id)] = paste0(garden_current$POWO_genus[!is.na(garden_current$POWO_plant_name_id)], ' ', garden_current$POWO_species[!is.na(garden_current$POWO_plant_name_id)])
  species_data = data.frame(original = garden_current$GenusSpecies, POWO = POWO_GenusSpecies, infra = garden_current$infrageneric_level)
  species_only = species_data[!grepl('5|6|0',species_data$infra),]
  species_only = species_only[!is.na(species_only$infra),]
  use_species = species_only$POWO
  use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
  no_species = length(unique(use_species))
  
  # Breakdown of endemic.
  endemic = table(garden_current$endemic)
  
  # Number of endemic (local)
  if(do_coord){
    no_endemic_local = sum(garden_current$POWO_Dist_area_code_l3[garden_current$endemic == 'Endemic'] == level3_code, na.rm = T)
  }else{
    no_endemic_local = NA
  }
  breakdown_endemic = table(garden_current$endemic)
  
  # Breakdown of provenance.
  provenance = table(garden_current$ProvenanceCode)
  
  # Breakdown of threatened.
  breakdown_threatened = table(garden_current$threatened)
  
  # Breakdown of threatened categories
  breakdown_threatened_cateogory = table(garden_current$redList_category)
  breakdown_threatened_cateogory = breakdown_threatened_cateogory[match(c('VU','EN','CR', 'EW', 'EX'), names(breakdown_threatened_cateogory))]
  
  # Breakdown of infrageneric diversity.
  breakdown_infrageneric = table(garden_current$infrageneric_level)
  
  
  return(list(no_accessions = no_accessions, no_families = no_families, no_genus = no_genus, no_species = no_species,
              breakdown_endemic = endemic, no_endemic_local = no_endemic_local,
              breakdown_provenance = provenance,
              breakdown_threatened = breakdown_threatened, breakdown_threatened_cateogory = breakdown_threatened_cateogory,
              breakdown_infrageneric = breakdown_infrageneric))
})
names(lost_accessions) = paste0('year-', years)

time_series_info = lost_accessions
```

##  Net Accessions

In this section we look at net number of accessions varies across years by comparing new and lost accessions.

### Net Accessions each Year

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_new_accessions = unlist(lapply(new_accessions, function(x){x$no_accessions}))
no_lost_accessions = unlist(lapply(lost_accessions, function(x){x$no_accessions}))
accessions_data = data.frame(year = years, new_accessions = no_new_accessions,
                             lost_accessions = no_lost_accessions, 
                             net_accessions = no_new_accessions - no_lost_accessions)
accessions_data$text = paste0('Date: ',years, ' <br>', 'Net Accessions: ', accessions_data$net_accessions, ' <br>',
                              'New Accessions: ', accessions_data$new_accessions, ' <br>',
                              'Lost Accessions: ', accessions_data$lost_accessions, ' <br>')
accessions_data$plus_minus = accessions_data$net_accessions > 0

accessions_data_net = accessions_data[,1:4]

fig <- plot_ly(accessions_data, x = ~year, y = ~net_accessions, type = 'bar', hovertext = ~text, hoverinfo = 'text', color = ~plus_minus,colors = c('red','blue'))
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Net Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')
fig <- fig %>% layout(showlegend = FALSE)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bar_no_accessions.html'),selfcontained = T)
}

fig
```

***

### Net Number of Accessions by species, infraspecific, and cultivars each year

We first create bars graphs of the net number of accessions for indeterminants, species, infraspecific, and cultivars. 

#### Net Accessions each Year by type of taxa (individual)

```{r, echo = F,  fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_new_accessions = data.frame(t(data.frame(lapply(new_accessions, function(x){
  details = x$breakdown_infrageneric
  
  indet = sum(as.numeric(details[grepl('0',names(details))]))
  species = sum(as.numeric(details[grepl('1',names(details))]))
  infra = sum(as.numeric(details[grepl('2|3|4',names(details))]))
  hort = sum(as.numeric(details[grepl('5|6',names(details))]))
  
  return(c(indet, species, infra, hort))
  }))))
names(no_new_accessions) = c('Indeterminat', 'Species', 'Infraspecific', 'Horticultral')
no_lost_accessions = data.frame(t(data.frame(lapply(lost_accessions, function(x){
  details = x$breakdown_infrageneric
  
  indet = sum(as.numeric(details[grepl('0',names(details))]))
  species = sum(as.numeric(details[grepl('1',names(details))]))
  infra = sum(as.numeric(details[grepl('2|3|4',names(details))]))
  hort = sum(as.numeric(details[grepl('5|6',names(details))]))
  
  return(c(indet, species, infra, hort))
  }))))
names(no_lost_accessions) = c('Indeterminat', 'Species', 'Infraspecific', 'Horticultral')

types = vector('list',4)
for(i in 1:4){
  current = data.frame(year = years,new = no_new_accessions[,i], lost =no_lost_accessions[,i])
  current$net = current$new - current$lost
  current$text = paste0('Date: ',years, ' <br>', 'Net Accessions: ', current$net, ' <br>',
                              'New Accessions: ', current$new, ' <br>',
                              'Lost Accessions: ', current$lost, ' <br>')
  current$plus_minus = current$net > 0
  types[[i]] = current
}
names(types) = c('Indeterminat', 'Species', 'Infraspecific', 'Horticultral')

# Manipulate data for saving to excel.
dataa = do.call(cbind, types)
dataa[which(grepl('year|plus|text',names(dataa)))[-1]] = NULL
names(dataa) = stringr::str_replace_all(names(dataa), '\\.', ' ')
names(dataa)[1] = 'Year'
#### Plot on four separate graphs with bars.
figs = vector('list',4)
for(i in 1:length(types)){
  fig <- plot_ly(types[[i]], x = ~year, y = ~net, type = 'bar', hovertext = ~text, hoverinfo = 'text', color = ~plus_minus,colors = c('red','blue'))
fig <- fig %>% layout(title = names(types)[i],
         xaxis = list(title = "Year"),
         yaxis = list (title = "Net Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')
fig <- fig %>% layout(showlegend = FALSE)
figs[[i]] = fig
}

fig = manipulateWidget::combineWidgets(list = figs, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bars_indet_species_infra_hort.html'),selfcontained = T)
}

fig
```

#### Net Accessions each Year by type of taxa (combined)

Show by either line graphs or scatter graphs.

```{r,echo = F,  fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#### Plot on a single graph as lines.
fig = plot_ly()
for(i in 1:length(types)){
  fig <- fig %>% add_trace(x = years, y=types[[i]]$net,type='scatter', mode = 'lines+markers', name = names(types)[i])
}
fig <- fig %>% layout(hovermode = 'x')
fig

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bars_indet_species_infra_hort_combined.html'),selfcontained = T)
}

#### Plot on a single graph as lines.
fig = plot_ly()
for(i in 1:length(types)){
  fig <- fig %>% add_trace(x = years, y=types[[i]]$net,type='scatter', mode = 'markers', name = names(types)[i])
}
fig <- fig %>% layout(hovermode = 'x')
fig

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bars_indet_species_infra_hort_combined.html'),selfcontained = T)
}
```


<hr style="border:4px solid gray">

### Net Number of Accessions by provenance


#### Net Accessions each Year by provenance (individual)

```{r, echo = F,  fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#Get the unique Provenance codes for the collection
unique_provenance_values = unique(report$ProvenanceCode)

# Get the number of plants with provenance code for each year.
no_new_accessions = data.frame(t(data.frame(lapply(new_accessions, function(x){
  details = x$breakdown_provenance
  
  no_prov = as.numeric(details[match(unique_provenance_values, names(details))])
  no_prov[is.na(no_prov)] = 0

  return(no_prov)

  }))))
names(no_new_accessions) = unique_provenance_values

# Get the number of plants with provenance code for each year.
no_lost_accessions = data.frame(t(data.frame(lapply(lost_accessions, function(x){
  details = x$breakdown_provenance
  
  no_prov = as.numeric(details[match(unique_provenance_values, names(details))])
  no_prov[is.na(no_prov)] = 0

  return(no_prov)

  }))))
names(no_lost_accessions) = unique_provenance_values

# Change the labels for known provenances.
names(no_lost_accessions)[match(c('G','W','U'), names(no_lost_accessions))] = c('Garden', 'Wild', 'Unknown')
names(no_new_accessions)[match(c('G','W','U'), names(no_new_accessions))] = c('Garden', 'Wild', 'Unknown')
unique_provenance_values[match(c('G','W','U'), unique_provenance_values)] = c('Garden', 'Wild', 'Unknown')

types = vector('list',length(unique_provenance_values))
for(i in 1:length(unique_provenance_values)){
  current = data.frame(year = years,new = no_new_accessions[,i], lost =no_lost_accessions[,i])
  current$net = current$new - current$lost
  current$text = paste0('Date: ',years, ' <br>', 'Net Accessions: ', current$net, ' <br>',
                              'New Accessions: ', current$new, ' <br>',
                              'Lost Accessions: ', current$lost, ' <br>')
  current$plus_minus = current$net > 0
  types[[i]] = current
}
names(types) = unique_provenance_values

# Manipulate data for saving to excel.
dataa_prov = do.call(cbind, types)
dataa_prov[which(grepl('year|plus|text',names(dataa_prov)))[-1]] = NULL
names(dataa_prov) = stringr::str_replace_all(names(dataa_prov), '\\.', ' ')
names(dataa_prov)[1] = 'Year'


#### Plot on four separate graphs with bars.
figs = vector('list',length(unique_provenance_values))
for(i in 1:length(types)){
  fig <- plot_ly(types[[i]], x = ~year, y = ~net, type = 'bar', hovertext = ~text, hoverinfo = 'text', color = ~plus_minus,colors = c('red','blue'))
fig <- fig %>% layout(title = names(types)[i],
         xaxis = list(title = "Year"),
         yaxis = list (title = "Net Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')
fig <- fig %>% layout(showlegend = FALSE)
figs[[i]] = fig
}

fig = manipulateWidget::combineWidgets(list = figs, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bars_provenance.html'),selfcontained = T)
}

fig
```

#### Net Accessions each Year by provenance (combined)

Show by either line graphs or scatter graphs.

```{r,echo = F,  fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#### Plot on a single graph as lines.
fig = plot_ly()
for(i in 1:length(types)){
  fig <- fig %>% add_trace(x = years, y=types[[i]]$net,type='scatter', mode = 'lines+markers', name = names(types)[i])
}
fig <- fig %>% layout(hovermode = 'x')
fig

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/lines_provenance_combined.html'),selfcontained = T)
}

fig = plot_ly()
for(i in 1:length(types)){
  fig <- fig %>% add_trace(x = years, y=types[[i]]$net,type='scatter', mode = 'markers', name = names(types)[i])
}
fig <- fig %>% layout(hovermode = 'x')
fig

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/points_provenance_combined.html'),selfcontained = T)
}
```


<hr style="border:4px solid gray">



### Net Number of Accessions of endemic species

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_new_accessions = unlist(lapply(new_accessions, function(x){as.numeric(x$breakdown_endemic['Endemic'])}))
no_lost_accessions = unlist(lapply(lost_accessions, function(x){as.numeric(x$breakdown_endemic['Endemic'])}))
accessions_data = data.frame(year = years, new_accessions = no_new_accessions,
                             lost_accessions = no_lost_accessions)
accessions_data$new_accessions[is.na(accessions_data$new_accessions)] = 0
accessions_data$lost_accessions[is.na(accessions_data$lost_accessions)] = 0
accessions_data$net_accessions = accessions_data$new_accessions - accessions_data$lost_accessions
accessions_data$text = paste0('Date: ',years, ' <br>', 'Net Accessions: ', accessions_data$net_accessions, ' <br>',
                              'New Accessions: ', accessions_data$new_accessions, ' <br>',
                              'Lost Accessions: ', accessions_data$lost_accessions, ' <br>')
accessions_data$plus_minus = accessions_data$net_accessions > 0

accessions_data_endemic = accessions_data[,1:4]

fig <- plot_ly(accessions_data, x = ~year, y = ~net_accessions, type = 'bar', hovertext = ~text, hoverinfo = 'text', color = ~plus_minus,colors = c('red','blue'))
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Net Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')
fig <- fig %>% layout(showlegend = FALSE)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bar_no_accessions_endemic_species.html'),selfcontained = T)
}

fig
```


***

### Net Number of Accessions of threatened species

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_new_accessions = unlist(lapply(new_accessions, function(x){as.numeric(x$breakdown_threatened['Threatened'])}))
no_lost_accessions = unlist(lapply(lost_accessions, function(x){as.numeric(x$breakdown_threatened['Threatened'])}))
accessions_data = data.frame(year = years, new_accessions = no_new_accessions,
                             lost_accessions = no_lost_accessions)
accessions_data$new_accessions[is.na(accessions_data$new_accessions)] = 0
accessions_data$lost_accessions[is.na(accessions_data$lost_accessions)] = 0
accessions_data$net_accessions = accessions_data$new_accessions - accessions_data$lost_accessions
accessions_data$text = paste0('Date: ',years, ' <br>', 'Net Accessions: ', accessions_data$net_accessions, ' <br>',
                              'New Accessions: ', accessions_data$new_accessions, ' <br>',
                              'Lost Accessions: ', accessions_data$lost_accessions, ' <br>')
accessions_data$plus_minus = accessions_data$net_accessions > 0

accessions_data_threatened = accessions_data[,1:4]
fig <- plot_ly(accessions_data, x = ~year, y = ~net_accessions, type = 'bar', hovertext = ~text, hoverinfo = 'text', color = ~plus_minus,colors = c('red','blue'))
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Net Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')
fig <- fig %>% layout(showlegend = FALSE)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(net_accessions_widget_dir,'/Bar_no_accessions_threatened_species.html'),selfcontained = T)
}

fig
```


***

```{r,echo=F}
# Return excel workbook with data for each figure and table

library(xlsx)
wb = xlsx::createWorkbook()
sh1 = xlsx::createSheet(wb, 'Net Accessions')
xlsx::addDataFrame(accessions_data_net, sh1, startRow = 1,row.names = F)
sh4 = xlsx::createSheet(wb, 'Species, infraspecific, and cultivars')
xlsx::addDataFrame(dataa, sh4, startRow = 1,row.names = F)
sh5 = xlsx::createSheet(wb, 'Provanence')
xlsx::addDataFrame(dataa_prov, sh5, startRow = 1,row.names = F)
sh6 = xlsx::createSheet(wb, 'Endemic')
xlsx::addDataFrame(accessions_data_endemic, sh6, startRow = 1,row.names = F)
sh7 = xlsx::createSheet(wb, 'Threatened')
xlsx::addDataFrame(accessions_data_threatened, sh7, startRow = 1,row.names = F)
xlsx::saveWorkbook(wb, file = paste0(output_dir,'/',collection,'_data_for_figures_reterospective_net_accession.xlsx'))
```
