---
title: "Last Status Update"
output: html_document
---

###### {-}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)
library(anytime)
```

```{r, imported parameters}
# #Inputs
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/Valencia_enriched_report.rda')
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/CUBG_June2023_enriched_report.rda')
# collection = 'CUBG'
# separate_figure_folder = FALSE
# output_dir = getwd()
# report_kind = 'static'
# ggtheme = NULL
# value_on_fig = TRUE
# table_font_size = 10
# export_data = F
# save_excel = F
# separate_figure_folder = F
```

```{r theme_ggplot2, echo = FALSE}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.background = element_rect(fill = 'transparent', color = NA),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

`r if(any(!c('sanitised_taxon', 'extracted_author', 'AccNoFull', 'ItemAccNoFull', 'ItemStatusDate') %in% names(enriched_report))){"*** \n **Warning!**\n\n This enriched report contains missing 'original' columns needed to perform the analyses in this report. Default values have been created. In particular, the following were missing "}`

`r if(!'ItemStatusDate' %in% names(enriched_report)){"- sanitised_taxon: cannot perform last update analysis.\n"}`

```{r, Extracting information from enriched report, echo = F}
if(!'AccNoFull' %in% names(enriched_report)){enriched_report$AccNoFull = 1:nrow(enriched_report)}
report = enriched_report
no_records = nrow(report)

# Reduce the report to existing (non-cultivars or hybrids)
index_want = which(report$ItemStatusType == 'Existing')
no_want = length(index_want)
report = report[index_want,]

# Get the best name from POWO first o/w original report.
report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)
best_name = paste0(report$POWO_taxon_name, ' ', report$POWO_taxon_authors)
best_name[which(best_name == 'NA NA')] = report$good_name[which(best_name == 'NA NA')]
report$best_name = best_name


#Select columns of interest
interest = report[,match(c('AccNoFull', 'TaxonNameFull' ,'best_name', 'sanitised_taxon', 'extracted_author', 'POWO_taxon_authors', 'POWO_taxon_name', 'ItemAccNoFull', 'ItemStatusDate'), names(report))]

# Create a column with the name if we want to print the taxa. (latin words with italic, others plain.)
print_name = interest$sanitised_taxon
name_with_italic = unlist(lapply(stringr::str_split(print_name, ' '), function(x){
  x[which(!grepl('\\.',x))] = paste0('*',x[which(!grepl('\\.',x))],'*')
  paste0(x, collapse = ' ')
}))
print_name = paste0(name_with_italic, ' ', interest$extracted_author)
interest$print_name = print_name



if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

exporting_data_store = list()
```

This report explores the time since the last update for records of existing plants at `r collection`.


```{r, Anaylsis, echo = F}
# First let's reduce our report to only the information we need.
size_report = nrow(interest)

# Get the current date. 
current_date <- Sys.Date()
current_year <- as.numeric(format(current_date, '%Y'))

#How many records have missing ItemStatusDate?
missing_index = which(interest$ItemStatusDate == '' | is.na(interest$ItemStatusDate))
missing_ItemStatusDate = length(missing_index)

# Get the year from each item.
ItemYear = BGSmartR::extract_year(interest$ItemStatusDate)
# anytime::addFormats(c('%d-%m-%Y', '%d/%m/%Y'))
# ItemStatusDate = as.Date(format(anytime::anydate(interest$ItemStatusDate), "%Y-%m-%d"))

#How many records have a date after the current date?
future_index = which(ItemYear - current_year > 0)
future_ItemStatusDate = length(future_index)

#How many records have a date that appears to be a placeholder?
placeholder_index = which(1650 - ItemYear > 0)
placeholder_ItemStatusDate = length(placeholder_index)

# Reduce report into data removing missing/future itemstatusdates.
if(length(c(missing_index,future_index, placeholder_index))> 0){
  data = interest[-c(missing_index,future_index, placeholder_index),]
} else{
  data = interest
}
data$year = BGSmartR::extract_year(data$ItemStatusDate)

do_last_update = TRUE
if(nrow(data) == 0){
 do_last_update = FALSE  
}

if(do_last_update){
  # Items (year).
year = data$year
table_year = table(year)
year = names(table_year) ; no_items = as.numeric(table_year)

years = min(as.numeric(year)):current_year
no_items_full = rep(0,length(years))
no_items_full[match(as.numeric(year), years)] = no_items

last_update_items = data.frame(year = years, no_items = no_items_full)
last_update_items$cumulative = cumsum(last_update_items$no_items)
last_update_items$year_num = as.numeric(last_update_items$year)
last_update_items$year_ago = current_year -last_update_items$year_num
last_update_items$textA = paste0(last_update_items$year_ago, ' year/s ago<br>',
                                 last_update_items$no_items, ' items')

last_update_items_store = last_update_items[,c(1,5,2,3)]
names(last_update_items_store) = c('Year', 'Number of years ago', 'Number of Items', 'Cumulative number of items')
exporting_data_store$Table_summarising_last_status_update_of_items_in_the_collection = last_update_items_store
}


# MANAGEMENT SHEETS: Those with issue in the ItemStatusDate.
issue_index = unique(c(placeholder_index, future_index, missing_index))
if(length(issue_index) > 0){
  issue_management_sheet = interest[issue_index, match(c('TaxonNameFull', 'POWO_taxon_name', 'POWO_taxon_authors', 'AccNoFull', 'ItemStatusDate'), names(interest))]
issue_management_sheet$powo_name = paste0(issue_management_sheet$POWO_taxon_name, ' ', issue_management_sheet$POWO_taxon_authors)
issue_management_sheet$powo_name[issue_management_sheet$powo_name == 'NA NA'] = NA

issue_type = rep('', nrow(issue_management_sheet))
issue_type[issue_index %in% placeholder_index] = 'Placeholder ItemStatueDate'
issue_type[issue_index %in% future_index] = 'ItemStatueDate is in the Future'
issue_type[issue_index %in% missing_index] = 'ItemStatueDate is missing'
issue_management_sheet$issue_type = issue_type
issue_management_sheet = issue_management_sheet[,c(4,1,6,5,7)]
names(issue_management_sheet) = c('Accession Number',
                                  "Original Report Taxonomic Name",
                                  "Matched POWO Taxonomic Name",
                                  "Item Status Date",
                                  "Item Status Date Issue"
                                  )

writexl::write_xlsx(issue_management_sheet, path =paste0(output_dir,'/',collection,'_ItemStatusDate_issue_list.xlsx'))

}

# MANAGEMENT SHEETS: Records that haven't been updated in the last 5 years.
if(length(issue_index)>0){
  older_5_year_sheet = interest[-issue_index, match(c('TaxonNameFull', 'POWO_taxon_name', 'POWO_taxon_authors', 'AccNoFull', 'ItemStatusDate'), names(interest))]
}else{
  older_5_year_sheet = interest[, match(c('TaxonNameFull', 'POWO_taxon_name', 'POWO_taxon_authors', 'AccNoFull', 'ItemStatusDate'), names(interest))]
}

ItemStatusDate = older_5_year_sheet$ItemStatusDate
ItemStatusDate[stringr::str_length(ItemStatusDate) == 4] = paste0(ItemStatusDate, '-01-01')
ItemStatusDate[stringr::str_length(ItemStatusDate) == 7] = paste0(ItemStatusDate, '-01')

age_year = as.numeric(Sys.Date() - as.Date(ItemStatusDate))/365
days_since_update = (as.numeric(Sys.Date() - as.Date(ItemStatusDate)))
older_5_year_sheet$days_since_update = days_since_update

older_5_year_sheet = older_5_year_sheet[which(age_year >=5),]
if(nrow(older_5_year_sheet) > 0){
  older_5_year_sheet$powo_name = paste0(older_5_year_sheet$POWO_taxon_name, ' ', older_5_year_sheet$POWO_taxon_authors)
older_5_year_sheet$powo_name[older_5_year_sheet$powo_name == 'NA NA'] = NA
older_5_year_sheet = older_5_year_sheet[,c(4,1,7,5,6)]
names(older_5_year_sheet) = c('Accession Number',
                                  "Original Report Taxonomic Name",
                                  "Matched POWO Taxonomic Name",
                                  "Item Status Date",
                                  "Days Since Last Update"
                                  )
writexl::write_xlsx(older_5_year_sheet, path =paste0(output_dir,'/',collection,'_Accessions_last_update_5_years_or_longer_list.xlsx'))

}

```

***

The collection has `r format(size_report, big.mark = ',')` items that are currently existing. Of these:

- `r format(missing_ItemStatusDate, big.mark = ',')` have missing item status date.

```{r, missing item status date - table}
if(missing_ItemStatusDate > 0){
  to_show = interest[missing_index, match(c('ItemAccNoFull', 'ItemStatusDate', 'sanit'), names(sanitised_taxon))]
  names(to_show) = c('ID', 'Item Status Date', 'Taxa')
 
  exporting_data_store$Table_showing_records_in_the_LC_with_missing_ItemStatusDate = to_show
  
   if(report_kind == 'static'){
    to_show[1:min(nrow(to_show),5),] |>
    flextable() |>
    set_caption(caption = "Items with missing ItemStatusDate") |> 
    font(fontname = "Calibri (Body)", part = "all") |> 
    fontsize(size = table_font_size, part = "body") |> 
    theme_booktabs() |> # default theme
    autofit()
  }else{
      DT::datatable(to_show, rownames = FALSE)
  }
}
```

- `r format(future_ItemStatusDate, big.mark = ',')` have a status date that is in the future (i.e after `r current_date`).

```{r, future item status date - table}
if(future_ItemStatusDate > 0){
  to_show = interest[future_index, match(c('ItemAccNoFull', 'ItemStatusDate', 'sanitised_taxon'), names(interest))]
  names(to_show) = c('ID', 'Item Status Date', 'Taxa')
  
  exporting_data_store$Table_showing_records_in_the_LC_with_ItemStatusDate_in_the_future = to_show

   if(report_kind == 'static'){
    to_show[1:min(nrow(to_show),5),] |>
    flextable() |>
    set_caption(caption = "Items with a future for ItemStatusDate") |> 
    font(fontname = "Calibri (Body)", part = "all") |> 
    fontsize(size = table_font_size, part = "body") |> 
    theme_booktabs() |> # default theme
    autofit()
  }else{
      DT::datatable(to_show, rownames = FALSE)
  }
}
  
```

- `r format(placeholder_ItemStatusDate, big.mark = ',')` have a status date that is prior to 1650 which we assume are placeholders.

```{r,placeholder item status date - table}
if(placeholder_ItemStatusDate > 0){
  to_show = interest[placeholder_index, match(c('ItemAccNoFull', 'ItemStatusDate', 'sanitised_taxon'), names(interest))]
  names(to_show) = c('ID', 'Item Status Date', 'Taxa')
  
  exporting_data_store$Table_showing_records_in_the_LC_with_placeholder_ItemStatusDate = to_show

  if(report_kind == 'static'){
    to_show[1:min(nrow(to_show),5),] |>
    flextable() |>
    set_caption(caption = "Items with a placeholder for ItemStatusDate") |> 
    font(fontname = "Calibri (Body)", part = "all") |> 
    fontsize(size = table_font_size, part = "body") |> 
    theme_booktabs() |> # default theme
    autofit()
  }else{
      DT::datatable(to_show, rownames = FALSE)
  }
}
  
```

## Last update of items

`r if(!do_last_update){" It is not possible to analyse last update of items as 'ItemStatusDate' is either missing or empty."}`
`r if(do_last_update){paste0("We restrict the existing LC to only items that have an item status date, whose date is not in the future. We determine the time since the last update only using the year of ItemStatusDate. Whereby any item whose last item status date is 2020 is classed as ", current_year - 2020, " years ago.")}`

`r if(do_last_update){"### Charts of the last item status update"}`

```{r, Bar plots of last status date of items in the LC - static, eval = report_kind == 'static' & do_last_update,  fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# By year of last item status
p<-ggplot(data=last_update_items, aes(x=year_num, y=no_items)) +
  geom_bar(stat="identity") +
   labs(title=paste0("Last Item status update by Year"),
      y ="Number of items",
      x = "Last Status Update (Year)")
if(value_on_fig){
  p = p +geom_text(aes(label = no_items),vjust=-0.2)
}

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar_date_of_last_update.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p

# By number of years ago
p<-ggplot(data=last_update_items, aes(x=year_ago, y=no_items)) +
geom_bar(stat="identity") +
   labs(title=paste0("Last Item status update by how many years ago"),
      y ="Number of items",
      x = "Number of Years Since Last Status Update")
if(value_on_fig){
  p = p +geom_text(aes(label = no_items),vjust=-0.2)
}

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar_number_if_years_last_update.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

`r if(report_kind == 'interactive' & do_last_update){"##### Time of Last status date {.tabset}"}`

`r if(report_kind == 'interactive' & do_last_update){"###### By Year"}`
```{r  Bar plot of last status date of items in the LC - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'interactive' & do_last_update}
fig <- plot_ly(last_update_items, x = ~year, y = ~no_items, type = 'bar')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Last Status Update (Year)"),
         yaxis = list (title = "Number of items")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
   
  
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-date_of_last_update.html'))
}
  
```

`r if(report_kind == 'interactive' & do_last_update){"###### By Number of Years ago"}`
```{r  Bar plot of time since last status date of items in the LC - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'interactive' & do_last_update}
fig <- plot_ly(last_update_items, x = ~year_ago, y = ~no_items, hoverinfo = "text",  hovertext = ~textA, type = 'bar')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Number of Years Since Last Status Update"),
         yaxis = list (title = "Number of Items")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
   
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-years_since_last_update.html'))
}
  
```

`r if(report_kind == 'interactive' & do_last_update){"##### {-}"}`

`r if(do_last_update){"### Charts of the cumulative time since the last item status update"}`

`r if(do_last_update){"In this section we explore the number of items that haven't been updated since a particular year. This is shown by either the year or the number of years since the item has had an item status update."}`

```{r, Line plots of cumulative last status date of items in the LC - static, eval = report_kind == 'static' & do_last_update,  fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# By year of last item status
p<-ggplot(data=last_update_items, aes(x=year_num, y=cumulative)) +
  geom_line()+
  geom_point()+
   labs(title=paste0("Cumulative Last Item status update by Year"),
      y ="Cumulative Number of items",
      x = "Last Status Update (Year)")
if(value_on_fig){
  p = p +geom_text_repel(aes(label = cumulative),vjust=-0.4,
                         arrow = arrow(length = unit(0.02, "npc")))
}

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Line_cumulative_date_of_last_update.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p

# By number of years ago
p<-ggplot(data=last_update_items, aes(x=year_ago, y=cumulative)) +
  geom_line()+
  geom_point()+
   labs(title=paste0("Cumulative Last Item status update by how many years ago"),
      y ="Cumulative Number of items",
      x = "Number of Years Since Last Status Update")
if(value_on_fig){
  p = p +geom_text_repel(aes(label = cumulative),vjust=-0.2,
                         arrow = arrow(length = unit(0.02, "npc")))
}

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Line_cumulative_number_if_years_last_update.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```


`r if(report_kind == 'interactive' & do_last_update){"##### Cumulative Time of Last status date {.tabset}"}`

`r if(report_kind == 'interactive' & do_last_update){"###### By Year"}`
```{r  Line plot of cumulative last status date of items in the LC - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'interactive' & do_last_update}
text = paste0(last_update_items$cumulative, ' items with status <br> date ', last_update_items$year_num,' or older')

fig <- plot_ly(last_update_items, x = ~year_num) 
fig <- fig %>% add_trace(y = ~cumulative, name = '', mode = 'lines',type = 'scatter', hoverinfo = "text",  hovertext = text) 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Last status update"),
         yaxis = list (title = "Cumulative number of items")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
   
  
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Line-cumulative-date_of_last_update.html'))
}
  
```

`r if(report_kind == 'interactive' & do_last_update){"###### By Number of Years ago"}`
```{r  Line plot of cumulative time since last status date of items in the LC - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'interactive' & do_last_update}
text = paste0(last_update_items$cumulative, ' items with status <br> date at least ', last_update_items$year_ago,' year/s old')

fig <- plot_ly(last_update_items, x = ~year_ago) 
fig <- fig %>% add_trace(y = ~cumulative, name = '', mode = 'lines',type = 'scatter', hoverinfo = "text",  hovertext = text) 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Number of years since last status update"),
         yaxis = list (title = "Cumulative number of items")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
   
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-years_since_last_update.html'))
}
  
```

`r if(report_kind == 'interactive' & do_last_update){"##### {-}"}`


```{r, export data, echo = FALSE}
if(export_data){
  last_update_data = exporting_data_store
  # save as .rda.
  save(last_update_data, file = paste0(output_dir,'/',collection, '_last_update_data.rda'))
}
```

```{r, save excel version of data, eval = save_excel & export_data}
library(xlsx)
file = paste0(output_dir,'/',collection, '_last_update_data.xlsx')
wb <- createWorkbook()
datas <- exporting_data_store
data_titles = names(datas) |> stringr::str_replace_all('_', ' ')
sheetnames <- paste0('Sheet ', 1:length(datas))
sheets <- lapply(sheetnames,  createSheet, wb = wb)
for(i in 1:length(datas)){
  # First we'll create a new row, let's put the title on row 2
  titleRow <-createRow(sheets[[i]], rowIndex=1)
  # We'll add a cell to that row (in the first column) for the title
  sheetTitle <-createCell(titleRow, colIndex=1)
  # We'll add the sheet title to the cell
  setCellValue(sheetTitle[[1,1]], data_titles[i])
  # We'll choose the formatting for the cell
  xlsx::addDataFrame(datas[[i]], sheet = sheets[[i]],row.names = FALSE, startRow = 3)
}
saveWorkbook(wb, file = file)

```

***

