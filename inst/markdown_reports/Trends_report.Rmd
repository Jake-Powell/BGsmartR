---
title: "Trends in the living collection"
output: html_document
---

#### {-}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)

interactive_colour <- function(n){
  color = c('#f46d43', "#FDAE6B", '#848484', '#e6e6e6')
  if(n==2){
    return(color[c(1,4)])
  }
  color[1:n]
}

color_binary <- c('#f46d43', '#e6e6e6')
palette = 'Oranges'
```


<!-- Motivation HERE -->


```{r, imported parameters}
# #Inputs
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/CUBG_June2023_enriched_report.rda')
# collection = 'CUBG'
# coordinates = c(52.19378853629289,0.1277234065606053)
# load('/Users/jakepowell/Cambridge/Geography Module/wgsrpd3.rda')
# 
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE
# 
# separate_figure_folder = F
# output_dir = getwd()
# report_kind = 'interactive'
# ggtheme = NULL
# value_on_fig = TRUE
# min_year = 1970
# data_type = 'Accessions'
# earliest_allowable_record = 1650
# old_accession_year_codes = c(1000)
```

```{r, add logo, eval = report_kind == 'interactive'}
htmltools::img(src = knitr::image_uri(paste0(system.file(package = "BGSmartR"), "/logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:87.8px; height:100px')
```

```{r theme_ggplot2}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.background = element_rect(fill = 'transparent', color = NA),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

```{r, Add combined geography column to enriched report}
geography_data = enriched_report[,grepl('_area_code_l3', names(enriched_report))]
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}
# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}
level3codes[level3codes == "NA"] = NA

enriched_report$geography_codes = level3codes
```

```{r, Get location_type_text}
location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occuring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```

```{r, Find LC location, echo = FALSE}
coord_contained = TRUE
# Extract the location of the collection.
pnts <- data.frame( x = coordinates[2], y = coordinates[1])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
location_name = collection_geog_details$LEVEL3_NAM
location_code = collection_geog_details$LEVEL3_COD

if(length(location_name) == 0){
  coord_contained = FALSE
  # Try and find the nearest polygon.
  collection_geog_details  =  wgsrpd3[which.min(as.vector(sf::st_distance(tt1_trans, pnts_trans))),-5]
  location_name = collection_geog_details$LEVEL3_NAM
  location_code = collection_geog_details$LEVEL3_COD
}
```

`r if(any(!c('AccNoFull') %in% names(enriched_report))){"*** \n **Warning!**\n\n This enriched report contains missing 'original' columns needed to perform the analyses in this report. Default values have been created. In particular, the following were missing "}`

`r if(!'AccNoFull' %in% names(enriched_report)){"- AccNoFull: assume each item is its own accession.\n"}`

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"***"}`

```{r, Extracting required information from enriched report, echo = F}

needed_columns = c('AccNoFull', 'AccYear', 'ItemStatusDate', 'ItemStatusType')
if(!'AccNoFull' %in% names(enriched_report)){
  enriched_report$AccNoFull = 1:nrow(enriched_report)
}
if(!'AccYear' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$AccYear = rep(0, nrow(enriched_report))
}
if(!'ItemStatusDate' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$ItemStatusDate = rep(NA, nrow(enriched_report))
}
if(!'ItemStatusType' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$ItemStatusType = rep('Existing', nrow(enriched_report))
}
if(all(is.na(enriched_report$ItemStatusDate))){
  do_over_time = FALSE
}
if(all(is.na(enriched_report$ItemStatusType))){
  do_over_time = FALSE
}
if(all(is.na(enriched_report$AccYear))){
  do_over_time = FALSE
}
#Extract endemic information from enriched_report
endemic = rep('Not Endemic', nrow(enriched_report))
endemic_index = which(stringr::str_length(enriched_report$geography_codes) == 3)
endemic[endemic_index] = 'Endemic'
enriched_report$endemic = endemic
rm(endemic)

# Extract threatened. 
threat_cat = c('VU','EN','CR','EW','EX')
threatened = rep('Not Threatened', nrow(enriched_report))
threatened[which(enriched_report$redList_category %in% threat_cat)] = 'Threatened'
threatened[which(enriched_report$POWO_Red_category %in% threat_cat)] = 'Threatened'
enriched_report$threatened = threatened
rm(threatened)

# Extract threatened category. 
threatened_category = rep(NA, nrow(enriched_report))
for(i in 1:length(threat_cat)){
 threatened_category[which(enriched_report$redList_category == threat_cat[i])] = threat_cat[i]
 threatened_category[which(enriched_report$POWO_Red_category == threat_cat[i])] = threat_cat[i]
}
enriched_report$threatened_category = threatened_category
rm(threatened_category)

# Convert Provenance code to text.
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'G'] = 'Garden'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'U'] = 'Unknown'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'W'] = 'Wild'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'Z'] = 'Wild-derived'

# Extract tree.
tree =rep('Not Tree', nrow(enriched_report))
tree[enriched_report$Enrich_is_tree] = 'Tree'
enriched_report$tree = tree
rm(tree)

# Extract native.
nativeo = rep('Not Native', nrow(enriched_report))
native_index = grepl(location_code,enriched_report$geography_codes)
nativeo[native_index] = 'Native'
enriched_report$native = nativeo
rm(nativeo)

# Create a sanitised taxonomic name.
enriched_report$good_name = paste0(enriched_report$sanitised_taxon, ' ', enriched_report$extracted_author)

best_name = paste0(enriched_report$POWO_taxon_name, ' ', enriched_report$POWO_taxon_authors)
best_name[which(best_name == 'NA NA')] = enriched_report$good_name[which(best_name == 'NA NA')]
enriched_report$best_name = best_name

report_original = enriched_report

report = enriched_report

if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

exporting_data_store = list()

## Data for trends
max_year = as.numeric(format(Sys.Date(),'%Y'))
years = min_year:max_year

# Set old unknown records to have a date ( = earliest_allowable_record) and remove all records prior to this time.
if(!is.null(old_accession_year_codes)){
  has_old_accessions_code = which(report$AccYear %in% old_accession_year_codes)
  no_old_accessions = length(has_old_accessions_code)
  report$AccYear[has_old_accessions_code] = earliest_allowable_record
}
to_keep = which(as.numeric(report$AccYear) >= earliest_allowable_record  & as.numeric(report$AccYear) <= max_year)
still_issue = nrow(report) - length(to_keep)
report = report[to_keep,]

report = report[!is.na(report$ItemStatusDate),]

report_after_old_acc = report
### Find the number of items/accessions where we have to do some fixing to the most recent status update.
post_date = report$ItemStatusDate
index_string_length_4 = which(stringr::str_length(post_date) == 4)
index_string_length_7 = which(stringr::str_length(post_date) == 7)
missing_date = length(c(index_string_length_4, index_string_length_7))

### (END) Find the number of items/accessions where we have to do some fixing to the most recent status update.
```

#### {-}

This report uses data from **`r collection`** and analyses trends in the collection from **`r min_year`** to **`r max_year`**.

<!-- `r if(!is.null(old_accession_year_codes)){paste0("Within the collection the accession years '", paste0(old_accession_year_codes, collapse = ', '),"' are used to denote items which have unknown accession year but have being in the collection since near the beginning. There are ", no_old_accessions," items in the collection with these accession years. In this analysis we set the accession year of such plants to ", earliest_allowable_record, ".")}` -->

<!-- `r if(!is.null(old_accession_year_codes)){"Afterwards the"}else{'The'}` collection contains **`r still_issue`** items whose accession year is not within `r earliest_allowable_record` and `r max_year`. These records are excluded in the following analysis. -->

<!-- To determine how long a plant survives in the collection we use the date of the plants most recent update and whether the plant was noted to be alive or dead. All plants that were alive at their most recent check are assumed to be alive to the present day. For plants that are dead we take the most recent update date to be their date of death.  -->
<!-- `r if(missing_date > 0){paste0("Within the collection there are ", missing_date, ' ', data_type |> tolower(), ' that are either missing the day or month and day of their most recent status update. If only the day is missing we set it to the 28th, if the month and day are missing we set the date to the 31st of December. ')}` -->

This document outlines the changes in the number of items, accessions, taxa, species, genera, families, provenance categories and key collections. 

Using the accession date and the last item status date, for each year we recreate a snapshot of what was existing on the 31st of December.

```{r, Get Trends, echo = F}
# 
# Create index data frame for which plants (items) are existing each year. 
date = paste0(years, '-12-31')
plant_existing = BGSmartR::exist_at_date(date, AccessionYear = report$AccYear,
                       ItemStatusDate = report$ItemStatusDate,
                       ItemStatusType = report$ItemStatusType,post_date = '3000-01-01')

# Extract the number of 'Items', 'Accessions', 'Taxa', 'Species', 'Genera', 'Families' in the LC each year.
time_series_info = pbapply::pblapply(plant_existing, function(x){
  garden_current = report[x,]
  
  # Number of families.
  families = data.frame(original = garden_current$Family, POWO = garden_current$POWO_family)
  use_family = families$POWO
  use_family[is.na(use_family)] = families$original[is.na(use_family)]
  family = unique(use_family)
  no_families <- length(family)

  # Number of genera.
  genus = data.frame(original = garden_current$Genus, POWO = garden_current$POWO_genus)
  use_genus = genus$POWO
  use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
  no_genera <- length(unique(use_genus))


   #No species (#remove cultivars, indeterminate taxa, hybrids )
  POWO_GenusSpecies = rep(NA, nrow(garden_current))
  POWO_GenusSpecies[!is.na(garden_current$POWO_plant_name_id)] = paste0(garden_current$POWO_genus[!is.na(garden_current$POWO_plant_name_id)], ' ', garden_current$POWO_species[!is.na(garden_current$POWO_plant_name_id)])
  species_data = data.frame(original = garden_current$GenusSpecies, POWO = POWO_GenusSpecies, infra = garden_current$taxon_type)
  species_only = species_data[!grepl('5|6|0',species_data$infra),]
  species_only = species_only[!is.na(species_only$infra),]
  use_species = species_only$POWO
  use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
  no_species = length(unique(use_species))
  
  # Number of Taxa.
    taxa = data.frame(sanitsed_name = paste0(garden_current$sanitised_taxon, ' ', garden_current$extracted_author), powo_name = paste0(garden_current$POWO_taxon_name, ' ', garden_current$POWO_taxon_authors))
    taxa$powo_name[taxa$powo_name == 'NA NA'] = NA
  use_taxa = taxa$powo_name
  use_taxa[is.na(use_taxa)] = taxa$sanitsed_name[is.na(use_taxa)]
  no_taxa <- length(unique(use_taxa))

  # Number of accessions.
  unique_accessions = unique(garden_current$AccNoFull)
  unique_accessions = unique_accessions[!is.na(unique_accessions)]
  no_accessions = length(unique_accessions)
  
  # Number of items
  no_items = nrow(garden_current)
  
  return(c(no_items, no_accessions, no_taxa, no_species, no_genera, no_families))
}) |> data.frame() |> t() |> data.frame()
names(time_series_info) = c('Items', 'Accessions', 'Taxa', 'Species', 'Genera', 'Families')

# Swap to accessions only for breakdown of endemic, native, etc if data_type == 'Accessions'
if(data_type == 'Accessions'){
  unique_accessions = unique(report$AccNoFull)
  
  LossYear = rep(NA,nrow(report))
  ItemStatusYear = as.numeric(stringr::str_extract(report$ItemStatusDate,pattern = '[0-9]{4}'))
  LossYear[report$ItemStatusType %in% c('NotExisting', 'Not Existing')] = ItemStatusYear[report$ItemStatusType %in% c('NotExisting', 'Not Existing')]
  report$LossYear = LossYear
  # Order the items where the lower indices have the most recent death date.
  LossYear_dummy = LossYear
  LossYear_dummy[is.na(LossYear_dummy)] = 4000
  ordered_items = order(LossYear_dummy,decreasing = T)
  report = report[ordered_items, ]
  
  #Match to the ordered accessions.
  match_to_best = match(unique_accessions,report$AccNoFull)
  
  #Reduce the data to unique accessions with most recent death date.
  report = report[match_to_best,]
  
  plant_existing = BGSmartR::exist_at_date(date, AccessionYear = report$AccYear,
                       ItemStatusDate = report$ItemStatusDate,
                       ItemStatusType = report$ItemStatusType,post_date = '3000-12-31')
}

time_series_info_subsets = pbapply::pblapply(plant_existing, function(x){
  garden_current = report[x,]
  # Breakdown of infrageneric diversity.
  breakdown_infrageneric = table(garden_current$taxon_type)
  
  # Breakdown of provenance.
  breakdown_provenance = table(garden_current$ProvenanceCode)
  
  # Breakdown of endemic
  breakdown_endemic = table(garden_current$endemic)
  
  # Number of native
  breakdown_native = table(garden_current$native)

  # Breakdown of threatened
  breakdown_threatened = table(garden_current$threatened)
  
  # Breakdown of threatened categories
  breakdown_threatened_cateogory = table(garden_current$threatened_category)

  # Breakdown by tree
  breakdown_tree= table(garden_current$tree)

  
  return(list(breakdown_infrageneric = breakdown_infrageneric, breakdown_provenance = breakdown_provenance, breakdown_endemic = breakdown_endemic, breakdown_native = breakdown_native, breakdown_threatened = breakdown_threatened, breakdown_threatened_cateogory = breakdown_threatened_cateogory, breakdown_tree = breakdown_tree))
})
names(time_series_info_subsets) = names(plant_existing)
```

```{r functions to plot trends}
single_trend_plot <- function(years, values, name, report_kind, separate_figure_folder){
  df = data.frame(years = years, values = values)
  if(report_kind == 'interactive'){
    df$text = paste0('Date: ', years, '-12-31 <br>', name,': ', values)
    
    fig <- plot_ly(df, x = ~years, y = ~values, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text', line = list(color = interactive_colour(1)))
    fig <- fig %>% layout(title = "",
             xaxis = list(title = "Year"),
             yaxis = list(title = paste0("Number of ", name |> tolower()))) 
    fig <- fig %>% layout(hovermode = 'x')

    if(separate_figure_folder){
      htmlwidgets::saveWidget(fig, file = paste0(figures_dir,'/',name,'_trend.html'),selfcontained = T)
    }
    return(fig)
  }
  if(report_kind == 'static'){
   p =  ggplot(data = df, aes(x = years, y = values)) + 
      geom_line(width = 1.1) +
       labs(title="",
            x ="Year",
            y = paste0('Number of ',name))+
     scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))
   if(separate_figure_folder){
     ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/', name, '_trend.pdf'),device = 'pdf', scale = 1)
   }
   return(p)
  }

}

group_trend_plots <- function(years, data, name, report_kind, separate_figure_folder, data_type, split = FALSE, group_order = NULL){
  data_prop = data /rowSums(data)*100
  tt = data.frame(year = years, data)
  names(tt) = c('year', names(data))
  dd = reshape(tt, idvar = "year", varying = list(2:ncol(tt)),
      v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
  if(is.null(group_order)){
      dd$group = factor(dd$group, levels = unique(dd$group))
  }else{
    dd$group = factor(dd$group, levels = group_order)
  }
  
  tt_prop = data.frame(year = years, data_prop)
  names(tt_prop) = c('year', names(data))
  dd_prop = reshape(tt_prop, idvar = "year", varying = list(2:ncol(tt)),
    v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
  dd_prop$group = factor(dd_prop$group, levels = unique(dd_prop$group))
  
    if(report_kind == 'static'){
      p1 = ggplot(dd, aes(x=year, y = count, group = group, color = group)) +
        geom_line(linewidth  =1.1 ) + 
        guides(color=guide_legend(title=paste0(name))) + 
        labs(title="",
            x ="Year",
            y = stringr::str_wrap(paste0("Number of ", data_type),width = 18)) +
             scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
        theme(legend.position="bottom")

 
       p2 = ggplot(dd_prop, aes(fill=group, y=count, x=year)) + 
        geom_bar(position="stack", stat="identity", width = 1) +
         scale_x_continuous(expand = c(0, 0)) +
         scale_y_continuous(expand = c(0, 0)) +
        labs(title="",
          x ="Year",
          y = "Percentage (%)") +
        guides(fill=guide_legend(title=paste0('Provenance')))
      
       p = ggpubr::ggarrange(p1, p2, labels = c("A", "B"),
          common.legend = TRUE, legend = "bottom", ncol = 1, nrow = 2, align = 'v')
       
   if(separate_figure_folder){
     ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/', name, '_trend.pdf'),device = 'pdf', scale = 1)
   }
    if(split){
      return(list(number = p1, proportion = p2))
    }else{
         return(p)

    }
    }
    if(report_kind == 'interactive'){
    # fig <- plot_ly(dd, x = ~year, y = ~count, color = ~group, type = 'scatter', mode = 'lines', line = list(color = interactive_colour(length(unique(dd$group)))))
    fig <- plot_ly(dd, x = ~year, y = ~count, color = ~group, type = 'scatter', mode = 'lines', colors = interactive_colour(length(unique(dd$group))))

    fig <- fig |> layout(yaxis = list(title = paste0("Number of ",data_type |> tolower(),"")),
                       xaxis = list(title = "Year"))
    fig <- fig |> layout(hovermode = 'x unified')
    
    if(separate_figure_folder){
      htmlwidgets::saveWidget(fig, file = paste0(figures_dir,'/',name,'_trend.html'),selfcontained = T)
    }
    
    
    dd_prop = data.frame(dd_prop, total = dd$count)
    
    fig2 <- plot_ly(dd_prop, x = ~year, y = ~count, color = ~group, type = 'bar',
                    hovertext = paste0(dd_prop$group,": ", round(dd_prop$count,digits = 1),'% (', dd_prop$total,')'),
                    hoverinfo = "x+text",
                    colors = interactive_colour(length(unique(dd$group))))
    
    
    fig2 <- fig2 |> layout(yaxis = list(title = paste0("Percentage")),
                       xaxis = list(title = "Year"))
    fig2 <- fig2 |> layout(hovermode = 'x unified',
                           barmode = 'stack',
                           bargap =0,
                           legend = list(traceorder = 'normal'),
                           yaxis = list(ticksuffix = '%'))
    fig2
    
      if(separate_figure_folder){
      htmlwidgets::saveWidget(fig2, file = paste0(figures_dir,'/',name,'_proportional_trend.html'),selfcontained = T)
    }
    }
  
  return(list(number = fig, proportion = fig2))
}

group_trend_plots_pair <- function(years, data, name, report_kind, separate_figure_folder, data_type, split = FALSE, group_order = NULL){
  if(!is.null(group_order)){data = data[,match(names(data),group_order)]}
  data_prop = data /rowSums(data)*100
  
  tt = data.frame(year = years, data)
  names(tt) = c('year', names(data))
  
  dd = reshape(tt, idvar = "year", varying = list(2:ncol(tt)),
      v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
  if(is.null(group_order)){
      dd$group = factor(dd$group, levels = unique(dd$group))
  }else{
    dd$group = factor(dd$group, levels = group_order)
  }
  
  tt_prop = data.frame(year = years, data_prop)
  names(tt_prop) = c('year', names(data))
  dd_prop = reshape(tt_prop, idvar = "year", varying = list(2:ncol(tt)),
    v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
   if(is.null(group_order)){
      dd_prop$group = factor(dd_prop$group, levels = unique(dd_prop$group))
  }else{
    dd_prop$group = factor(dd_prop$group, levels = group_order)
  }

    if(report_kind == 'static'){
      p1 = ggplot(dd, aes(x=year, y = count, group = group, color = group)) +
        geom_line(linewidth  =1.1 ) + 
        guides(color=guide_legend(title=paste0(name))) + 
        labs(title="",
            x ="Year",
            y = stringr::str_wrap(paste0("Number of ", data_type),width = 18)) +
             scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
        theme(legend.position="bottom")

 
       p2 = ggplot(dd_prop, aes(fill=group, y=count, x=year)) + 
        geom_bar(position="stack", stat="identity", width = 1) +
         scale_x_continuous(expand = c(0, 0)) +
         scale_y_continuous(expand = c(0, 0)) +
        labs(title="",
          x ="Year",
          y = "Percentage (%)") +
        guides(fill=guide_legend(title=paste0('Provenance')))
      
       p = ggpubr::ggarrange(p1, p2, labels = c("A", "B"),
          common.legend = TRUE, legend = "bottom", ncol = 1, nrow = 2, align = 'v')
       
   if(separate_figure_folder){
     ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/', name, '_trend.pdf'),device = 'pdf', scale = 1)
   }
    if(split){
      return(list(number = p1, proportion = p2))
    }else{
         return(p)

    }
    }
    if(report_kind == 'interactive'){

      colours = color_binary
      fig <- plot_ly(tt,
                     x = ~year,
                     y = tt[,2],
                     type = 'scatter',
                     mode = 'lines',
                     name = names(tt)[2],
                     line = list(color = color_binary[1]),
                     visible = T, showlegend = T) |>
        add_trace(y = tt[,3], 
                  name = names(tt)[3],
                   line = list(color = color_binary[2]),
                  visible='legendonly'
                  )|> 
        layout(yaxis = list(title = paste0("Number of ",data_type |> tolower(),"")),
               xaxis = list(title = "Year"),
               hovermode = 'x unified')
    fig <- fig |> layout(hovermode = 'x unified')
    
    if(separate_figure_folder){
      htmlwidgets::saveWidget(fig, file = paste0(figures_dir,'/',name,'_trend.html'),selfcontained = T)
    }
    
    
    dd_prop = data.frame(dd_prop, total = dd$count)
    
    fig2 <- plot_ly(dd_prop, x = ~year, y = ~count, color = ~group, type = 'bar',
                    hovertext = paste0(dd_prop$group,": ", round(dd_prop$count,digits = 1),'% (', dd_prop$total,')'),
                    hoverinfo = "x+text",
                    colors = interactive_colour(length(unique(dd$group))))
    
    
    fig2 <- fig2 |> layout(yaxis = list(title = paste0("Percentage")),
                       xaxis = list(title = "Year"))
    fig2 <- fig2 |> layout(hovermode = 'x unified',
                           barmode = 'stack',
                           bargap =0,
                           legend = list(traceorder = 'normal'),
                           yaxis = list(ticksuffix = '%'))
    fig2
    
      if(separate_figure_folder){
      htmlwidgets::saveWidget(fig2, file = paste0(figures_dir,'/',name,'_proportional_trend.html'),selfcontained = T)
    }
    }
  
  return(list(number = fig, proportion = fig2))
}
```

### Trends in collection size 

In this section, we are interested in trends over time in the collection size by exploring the change in items, accessions, taxa, species, genera, and families. In this context, taxa are all the biological names at the species or infraspecific levels (subsp., var., or f.; e.g. Androsace sarmentosa subsp. primuloides (Hook.f.) Govaerts); species are taxa but considered only to the species level (the binomial; e.g. Androsace sarmentosa). You can explore these trends in each category independently, or combined onto a single graph by normalising the values to allow for comparison. 


```{r  category trends - static, fig.dim = c(10, 5), eval = report_kind == 'static', fig.cap=paste0("Trends of items, accessions, taxa, species, genera and family in the LC since ", min_year)}
# Create each plot indiviudally incase we want to save these to the plots folder.
want = names(time_series_info)
for(i in 1:length(want)){
  p = single_trend_plot(years = years, values = time_series_info[[i]], name = want[i],
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)

}

# Now create the 3x2 plot showing each of the trends over time (6 total) using facet_wrap.
tt = data.frame(year = years, time_series_info)
dd = reshape(tt, idvar = "year", varying = list(2:7),
        v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
dd$group = factor(dd$group, levels = unique(dd$group))
p = ggplot(dd, aes(x=year, y = count)) +
  geom_line(width = 1.1) +
  facet_wrap(~group, scales = "free_y", ncol = 2) + 
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0.05, 0.05)) +
  labs(title="",
            x ="Year",
            y = "")

if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/items_accessions_taxa_species_genera_families_trend.pdf'),device = 'pdf', scale = 1)
}

p
```

`r if(report_kind == 'interactive'){"##### {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Items"}`
```{r  Items trend - interactive,  fig.dim = c(10, 4), eval = report_kind == 'interactive',out.extra='style="background-color: #9ecff7; padding:10px; display: inline-block;"'}
single_trend_plot(years = years, values = time_series_info$Items, name = 'Items',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)

```

`r if(report_kind == 'interactive'){"###### Accessions"}`
```{r  Accessions trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
single_trend_plot(years = years, values = time_series_info$Accessions, name = 'Accessions',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)
```

`r if(report_kind == 'interactive'){"###### Taxa"}`
```{r  Taxa trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
single_trend_plot(years = years, values = time_series_info$Taxa, name = 'Taxa',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)
```

`r if(report_kind == 'interactive'){"###### Species"}`
```{r  Species trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
single_trend_plot(years = years, values = time_series_info$Species, name = 'Species',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)
```

`r if(report_kind == 'interactive'){"###### Genera"}`
```{r  Genera trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
single_trend_plot(years = years, values = time_series_info$Genera, name = 'Genera',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)
```

`r if(report_kind == 'interactive'){"###### Families"}`
```{r  Families trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
single_trend_plot(years = years, values = time_series_info$Families, name = 'Families',
                  report_kind = report_kind, separate_figure_folder = separate_figure_folder)
```

`r if(report_kind == 'interactive'){"##### {-}"}`


```{r  category trends all in one - static, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'static', fig.cap=paste0("Combined trends of items, accessions, taxa, species, genera and family in the LC since ", min_year)}
time_series_info_normalised = as.data.frame(t(t(time_series_info)/as.numeric(apply(time_series_info, MARGIN=c(2), max))))

# Now create the 3x2 plot showing each of the trends over time (6 total) using facet_wrap.
tt = data.frame(year = years, time_series_info_normalised)
dd = reshape(tt, idvar = "year", varying = list(2:7),
        v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
# dd$group = factor(dd$group, levels = unique(dd$group))
p = ggplot(dd, aes(x=year, y = count, group = group, color = group)) +
  geom_line(linewidth  =1.1 ) + 
  guides(color=guide_legend(title=paste0('Category'))) + 
    scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0.01, 0.01)) +
  labs(title="",
            x ="Year",
            y = "% of maximum") +
    theme(legend.position="bottom")+
  theme(axis.text.y=element_blank(), 
      axis.ticks.y=element_blank())


if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/items_accessions_taxa_species_genera_families_trend.pdf'),device = 'pdf', scale = 1)
}
p
```

```{r  category trends all in one - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
time_series_info_normalised = as.data.frame(t(t(time_series_info)/as.numeric(apply(time_series_info, MARGIN=c(2), max))))
names(time_series_info_normalised) = paste0(names(time_series_info_normalised),'_Norm')
time_series_info_normalised = data.frame(years = years, time_series_info, time_series_info_normalised) 
data_names = names(time_series_info_normalised)

to_plot = c("Items", "Accessions", "Taxa", "Species", "Genera", "Families")
colours = scales::brewer_pal(palette = palette, direction = 1)(length(to_plot))
fig <- plot_ly(time_series_info_normalised, x = ~years)
fig <- fig %>%  add_trace(x = ~years, y = min(time_series_info_normalised[,8:13]), hoverinfo='text', type = 'scatter', text = ~years,
            mode = 'markers', marker=list(size=0, color='white'),
            showlegend=FALSE, opacity=0)
for(i in 1:length(to_plot)){
  fig <- fig %>% add_trace(y = time_series_info_normalised[,grepl(to_plot[i], data_names) & grepl('Norm', data_names)], name = to_plot[i], mode = 'lines',type = 'scatter', line = list(color = colours[i]),
                           text=paste0(to_plot[i], ': ',time_series_info_normalised[,which(grepl(to_plot[i], data_names))[1]]), hoverinfo = 'text') 
}

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "% of maximum")) 
fig <- fig %>% layout(hovermode = 'x unified',
         yaxis = list(showline= F,
                      showticklabels = F
                      # range = c(min(time_series_info_normalised[,5:7]),max(time_series_info_normalised[,5:7]))
                      ),
         margin = list(l=0, r=0, t=20, b=0, pad = 4),
         autosize = T,
         xaxis = list(range = c(min(years)-0.5, max(years))))

 if(separate_figure_folder){
      htmlwidgets::saveWidget(fig, file = paste0(figures_dir,'/items_accessions_taxa_species_genera_families_trend.html'),selfcontained = T)
    }

fig

```

***

### Trends by type of plant

This section explores the trends over time of different types of plants. We use characteristics in the name of plants to determine whether they are classified as indeterminate, species, subspecies, variety, forma, cultivar, and hybrid. We are going to explore the trends of biological (species and infraspecific categories), horticultural (hybrids and cultivars), and indeterminate taxa.

```{r Trends in taxon_type data}
taxon_type_categories = c('Species', 'Infraspecific', 'Horticultural', 'Indeterminate')
no_taxon_type = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_infrageneric
  
  no_indet = sum(details[grepl('0', names(details))])
  no_hort = sum(details[grepl('5|6', names(details))])
  no_species = sum(details[!grepl('0|5|6|2|3|4', names(details))])
  no_infra = sum(details[!grepl('0|5|6', names(details)) & grepl('2|3|4', names(details))])
  
  return(c(no_species, no_infra, no_hort, no_indet))
  }))))
names(no_taxon_type) = taxon_type_categories

int_plots = group_trend_plots(years, no_taxon_type, "Types of plant", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type)


```


```{r  Taxon type trend (number + proportion) - static, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'static', fig.cap=paste0("Trends in taxon type, where (A) and (B) shows the number and proportion of accessions, respectively.")}
int_plots
```

`r if(report_kind == 'interactive'){"##### {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  taxon_type trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  taxon_type trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`


***

### Trends by provenance categories

In this section we explore the trends over time by provenance categories.

```{r Trends in Provenance data}
Provenance_categories = unique(report$ProvenanceCode)
no_prov = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_provenance
  no_prov = as.numeric(details[match(Provenance_categories, names(details))])
  no_prov[is.na(no_prov)] = 0
  return(no_prov)
  }))))
names(no_prov) = Provenance_categories
force_order_index =match(c('Wild', 'Wild-derived', 'Garden', 'Unknown'), names(no_prov))
force_order_index = force_order_index[!is.na(force_order_index)]
no_prov = no_prov[,force_order_index] # Choose the ordering we want

int_plots = group_trend_plots(years, no_prov, "Provenance", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type)


```

```{r  Provenance trend (number + proportion) - static, fig.fullwidth=TRUE, fig.dim = c(10, 6), eval = report_kind == 'static', fig.cap=paste0("Trends in provenance, where (A) and (B) shows the number and proportion of accessions, respectively.")}
int_plots
```

`r if(report_kind == 'interactive'){"##### {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  Provenance trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  Provenance trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`



***

### Trends in key collections

In this section we look at trends across key collections in the living collection. This includes threatened, endemic, native, and tree species. 

<!-- - Threatened species, those classed as extinct, extinct in the wild, critically endangered, endangered or vulnerable by [IUCN's Red List](https://www.iucnredlist.org). -->
<!-- - Endemic species, those in the collection that belong to a single region according to [TDWG geographical codes](https://web.archive.org/web/20160125135239/http:/www.nhm.ac.uk/hosted_sites/tdwg/TDWG_geo2.pdf) (Brummitt, 2001) expressed to that system's third level. -->
<!-- - Native species, those in the collection that belong to the same region as the collection according to [TDWG geographical codes](https://web.archive.org/web/20160125135239/http:/www.nhm.ac.uk/hosted_sites/tdwg/TDWG_geo2.pdf) (Brummitt, 2001) expressed to that system's third level. -->
<!-- - Trees accessions in the collection that are contained within [BGCI's GlobalTreeSearch](https://tools.bgci.org/global_tree_search.php) (or synonymous names found in [Plants of the World Online](https://powo.science.kew.org)) -->

We first look at the normalised trends for all key collections combined.

```{r Trends in Key Collections}
Endemic_categories = unique(report$endemic)
no_endemic = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_endemic
  no_prov = as.numeric(details[match(Endemic_categories, names(details))])
  no_prov[is.na(no_prov)] = 0
  return(no_prov)
  }))))
names(no_endemic) = Endemic_categories
no_endemic = no_endemic[,c(2,1)]

native_categories = unique(report$native)
no_native = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_native
  no_prov = as.numeric(details[match(native_categories, names(details))])
  no_prov[is.na(no_prov)] = 0
  return(no_prov)
  }))))
names(no_native) = native_categories
no_native = no_native[,c(2,1)]

threatened_categories = unique(report$threatened)
no_threatened = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_threatened
  no_prov = as.numeric(details[match(threatened_categories, names(details))])
  no_prov[is.na(no_prov)] = 0
  return(no_prov)
  }))))
names(no_threatened) = threatened_categories
no_threatened = no_threatened[,c(2,1)]

Tree_categories = unique(report$tree)
no_tree = data.frame(t(data.frame(lapply(time_series_info_subsets, function(x){
  details = x$breakdown_tree
  no_prov = as.numeric(details[match(Tree_categories, names(details))])
  no_prov[is.na(no_prov)] = 0
  return(no_prov)
  }))))
names(no_tree) = Tree_categories
no_threatened = no_threatened[,c(2,1)]


int_endemic_plots = group_trend_plots_pair(years, no_endemic, "Endemic", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type, split = TRUE, group_order = c('Endemic', 'Not Endemic') )
  
int_native_plots = group_trend_plots_pair(years, no_native, "native", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type,  split = TRUE)
    
int_threatened_plots = group_trend_plots_pair(years, no_threatened, "threatened", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type, split = TRUE,
                                         group_order = c('Threatened', 'Not Threatened'))

int_tree_plots = group_trend_plots_pair(years, no_tree, "Tree", report_kind = report_kind, separate_figure_folder = separate_figure_folder, data_type = data_type, group_order = c('Tree', 'Not Tree'))


```

```{r Combined key taxa (number) only - static, eval = report_kind == 'static', fig.fullwidth=TRUE, fig.dim = c(10, 6),  fig.cap="Normalised trends for endemic, native and threatened species."}
combined_data = data.frame(Threatened = no_threatened$Threatened,
                           Endemic = no_endemic$Endemic,
                           Native = no_native$Native,
                           Tree = no_tree$Tree)

time_series_info_normalised = as.data.frame(t(t(combined_data)/as.numeric(apply(combined_data, MARGIN=c(2), max))))

# Now create the 3x2 plot showing each of the trends over time (6 total) using facet_wrap.
tt = data.frame(year = years, time_series_info_normalised)
dd = reshape(tt, idvar = "year", varying = list(2:length(tt)),
        v.names = "count", timevar = "group", times = names(tt)[-1], direction = "long")
dd$group = factor(dd$group, levels = unique(dd$group))
p = ggplot(dd, aes(x=year, y = count, group = group, color = group)) +
  geom_line(linewidth  =1.1 ) + 
  guides(color=guide_legend(title=paste0(''))) +
    scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0.01, 0.01)) +
  labs(title="",
            x ="Year",
            y = "") +
    theme(legend.position="bottom")+
  theme(axis.text.y=element_blank(), 
      axis.ticks.y=element_blank())



if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/key_taxa_combined_trend.pdf'),device = 'pdf', scale = 1)
}
p
```

```{r  Combined key taxa (number) only - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
combined_data = data.frame(Threatened = no_threatened$Threatened,
                           Endemic = no_endemic$Endemic,
                           Native = no_native$Native,
                           Tree = no_tree$Tree)

time_series_info_normalised = as.data.frame(t(t(combined_data)/as.numeric(apply(combined_data, MARGIN=c(2), max))))
names(time_series_info_normalised) = paste0(names(time_series_info_normalised),'_Norm')
time_series_info_normalised = data.frame(years = years, combined_data, time_series_info_normalised) 
data_names = names(time_series_info_normalised)


to_plot = c('Threatened', "Endemic", "Native", 'Tree')
colours = interactive_colour(length(to_plot))
fig <- plot_ly(time_series_info_normalised, x = ~years)
fig <- fig %>%  add_trace(x = ~years, y = min(time_series_info_normalised[,which(grepl('Norm',names(time_series_info_normalised)))]), hoverinfo='text', type = 'scatter', text = ~years,
            mode = 'markers', marker=list(size=0, color='white'),
            showlegend=FALSE, opacity=0)
for(i in 1:length(to_plot)){
  fig <- fig %>% add_trace(y = time_series_info_normalised[,grepl(to_plot[i], data_names) & grepl('Norm', data_names)], name = to_plot[i], mode = 'lines',type = 'scatter', line = list(color = colours[i]),
                           text=paste0(to_plot[i], ': ',time_series_info_normalised[,which(grepl(to_plot[i], data_names))[1]]), hoverinfo = 'text') 
}

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "")) 
fig <- fig %>% layout(hovermode = 'x unified',
         yaxis = list(showline= F, showticklabels = F),
         margin = list(l=0, r=0, t=20, b=0, pad = 4),
         autosize = T,
         xaxis = list(range = c(min(years)-0.5, max(years))))

 if(separate_figure_folder){
      htmlwidgets::saveWidget(fig, file = paste0(figures_dir,'/key_taxa_combined_trend.html'),selfcontained = T)
    }

fig

```


We now consider each key collection individually showing in addition the `r tolower(data_type)` which do not belong to each key collection.

```{r Key taxa trend individual in a single plot, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'static', fig.caption = "Trends for key collections"}

p1 = int_endemic_plots$number +
  labs(x = '', title = 'Endemic') +
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank()) +
  guides(color = FALSE, size = FALSE)+ 
  ggplot2::scale_colour_viridis_d(name = "", labels = c("Other","Key Taxa"))  +
  guides(color=guide_legend(title=""))+
  theme(plot.margin = unit(c(0,0.1,0,0), "lines"))
p2 = int_native_plots$number + labs(y = '', x = '', title = 'Native')+
  guides(color = FALSE, size = FALSE)+ 
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank())+
  theme(plot.margin = unit(c(0,0.1,-0.5,0), "lines"))
p3 = int_threatened_plots$number + labs(y = '', x = '', title = 'Threatened')+
  guides(color = FALSE, size = FALSE)+ 
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank())+
  theme(plot.margin = unit(c(0,0.1,-0.5,0), "lines"))

p4 = int_endemic_plots$proportion + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))
p5 = int_native_plots$proportion + labs(y = '')  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))
p6 = int_threatened_plots$proportion + labs(y = '')  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))

fig = ggpubr::ggarrange(p1,p2,p3,p4,p5,p6,
          common.legend = T, ncol = 3, nrow = 2, align = 'v', legend = 'bottom') +
  theme(plot.margin = margin(0.1,0.1,0,0.1, "cm")) 

 if(separate_figure_folder){
     ggplot2::ggsave(plot = fig, filename = paste0('key_taxa_number_percent_trend.pdf'),device = 'pdf', scale = 1)
   }
fig





p1 = ggplot(NULL, aes(x = years, y = no_endemic$Endemic) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="Endemic",
            x ="",
            y = paste0('Number of ',data_type))+
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank()) +
  theme(plot.margin = unit(c(0,0.1,0,0), "lines"))

p2 = ggplot(NULL, aes(x = years, y = no_native$Native) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="Native",
            x ="",
            y = "")+
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank()) +
  theme(plot.margin = unit(c(0,0.1,0,0), "lines"))

p3 = ggplot(NULL, aes(x = years, y = no_threatened$Threatened) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="Threatened",
            x ="",
            y = "")+
  theme(axis.text.x=element_blank(), 
      axis.ticks.x=element_blank()) +
  theme(plot.margin = unit(c(0,0.1,0,0), "lines"))

p4 = ggplot(NULL, aes(x = years, y = no_endemic$Endemic/rowSums(no_endemic)*100) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="",
            x ="Year",
            y = "Perentage (%)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))

p5 = ggplot(NULL, aes(x = years, y = no_native$Native/rowSums(no_native)*100) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="",
            x ="Year",
            y = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))

p6 = ggplot(NULL, aes(x = years, y = no_threatened$Threatened/rowSums(no_threatened)*100) ) + 
      geom_line(linewidth  =1.1) +
       labs(title="",
            x ="Year",
            y = "")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.margin = unit(c(-1,0.1,-0.5,0), "lines"))

fig = ggpubr::ggarrange(p1,p2,p3,p4,p5,p6,
          common.legend = T, ncol = 3, nrow = 2, align = 'v', legend = 'none') +
  theme(plot.margin = margin(0.1,0.1,0.5,0.1, "cm")) 

 if(separate_figure_folder){
     ggplot2::ggsave(plot = fig, filename = paste0('key_taxa_ONLY_number_percent_trend.pdf'),device = 'pdf', scale = 1)
   }
fig
```

`r if(report_kind == 'interactive'){"#####  Threatened trends {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  Threatened trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_threatened_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  Threatened trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_threatened_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`

`r if(report_kind == 'interactive'){"#####  Endemic trends {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  Endemic trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_endemic_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  Endemic trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_endemic_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`

`r if(report_kind == 'interactive'){"#####  Native trends {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  Native trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_native_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  Native trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_native_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`

`r if(report_kind == 'interactive'){"#####  Tree trends {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number"}`
```{r  Tree trend (number) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_tree_plots$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  Tree trend (proportion) - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
int_tree_plots$proportion
```

`r if(report_kind == 'interactive'){"##### {-}"}`

***

`r if(do_geography_trend){"### Trends in Geographic Distribution"}`

```{r geography trends (may take a while), eval = do_geography_trend}
report = report_original

## Data for trends
max_year = as.numeric(format(Sys.Date(),'%Y'))
min_year = min(earliest_allowable_record, min(as.numeric(report$AccYear)[as.numeric(report$AccYear) > 1650]))
years = min_year:max_year

# Set old unknown records to have a date ( = earliest_allowable_record) and remove all records prior to this time.
if(!is.null(old_accession_year_codes)){
  report$AccYearOrig = report$AccYear
  has_old_accessions_code = which(report$AccYear %in% old_accession_year_codes)
  accession_old_code = report$AccNoFull[has_old_accessions_code]
  no_old_accessions = length(has_old_accessions_code)
  report$AccYear[has_old_accessions_code] = earliest_allowable_record
}
to_keep = which(as.numeric(report$AccYear) >= earliest_allowable_record  & as.numeric(report$AccYear) <= max_year)
still_issue = nrow(report) - length(to_keep)
report = report[to_keep,]

report = report[!grepl('0',report$taxon_type),]
report = report[report$ItemStatusDate != '0000',]

date = paste0(years, '-12-31')
plant_existing = BGSmartR::exist_at_date(date, AccessionYear = report$AccYear,
                                         ItemStatusDate = report$ItemStatusDate,
                                         ItemStatusType = report$ItemStatusType, post_date = '3000-01-01')

if(data_type == 'Accessions'){
  unique_accessions = unique(report$AccNoFull)

  LossYear = rep(NA,nrow(report))
  ItemStatusYear = as.numeric(stringr::str_extract(report$ItemStatusDate,pattern = '[0-9]{4}'))
  LossYear[report$ItemStatusType %in% c('NotExisting', 'Not Existing')] = ItemStatusYear[report$ItemStatusType %in% c('NotExisting', 'Not Existing')]
  report$LossYear = LossYear
  # Order the items where the lower indices have the most recent death date.
  LossYear_dummy = LossYear
  LossYear_dummy[is.na(LossYear_dummy)] = 4000
  ordered_items = order(LossYear_dummy,decreasing = T)

  report = report[ordered_items, ]
  #Match to the ordered accessions.
  match_to_best = match(unique_accessions,report$AccNoFull)

  #Reduce the data to unique accessions with most recent death date.
  report = report[match_to_best,]

  plant_existing = BGSmartR::exist_at_date(date, AccessionYear = report$AccYear,
                                           ItemStatusDate = report$ItemStatusDate,
                                           ItemStatusType = report$ItemStatusType,post_date = '3000-12-31')
}

################################################


################################################
no_regions = length(wgsrpd3$LEVEL3_COD)
time_series_info_subsets = pbapply::pblapply(plant_existing, function(x){
  garden_current = report[x,]

  # Breakdown of geographic regions.
  no_accessions_regions = rep(NA,no_regions)
  for(i in 1:no_regions){
    index = grepl(pattern =  wgsrpd3$LEVEL3_COD[i], x = garden_current$geography_codes)
    if(any(index)){
      no_accessions_regions[i] = sum(index)
    }
  }
  no_accessions_regions[is.na(no_accessions_regions)] = 0
  breakdown_geography =  no_accessions_regions


  return(list(breakdown_geography = breakdown_geography))
})
r = report
if(!is.null(old_accession_year_codes)){
  r$AccYear[r$AccNoFull %in% accession_old_code] = old_accession_year_codes[1]
}
r$AccYear = as.numeric(r$AccYear)

CUBG_geo_over_time = data.frame(lapply(time_series_info_subsets, function(x){x$breakdown_geography})) |> t() |> data.frame()
names(CUBG_geo_over_time) = wgsrpd3$LEVEL3_COD

# geography_wcvp= wcvp$geography[,grepl('_code_l3', names(wcvp$geography))]
# geography_wcvp = geography_wcvp[,grepl(paste0(want,collapse='|'), names(geography_wcvp))]
# if(length(want) > 1){
#   level3codes_wcvp =do.call("paste", c(geography_wcvp, sep = ", "))
#   level3codes_wcvp = stringr::str_remove(level3codes_wcvp, ', NA')
#   level3codes_wcvp = stringr::str_remove(level3codes_wcvp, 'NA, ')
# }else{
#   level3codes_wcvp = geography_wcvp
# }


regions = wgsrpd3$LEVEL3_COD
regions_info = pbapply::pblapply(regions, function(x){

  # no_wcvp = sum(grepl(x,level3codes_wcvp),na.rm = T)

  records = r[grepl(x, r$geography_codes),]
  records = records[order(records$AccYear,decreasing = F),]
  first_rep = records$AccYear[1]
  example_plant = records$TaxonNameFull[1]
  web = records$POWO_web_address[1]

  # Years with an accession from the region
  years = unique(records$AccYear)
  years = sort(years[years != 0])
  consec = split(years,cumsum(c(1,diff(years)!=1)))
  mess = ''
  for(ii in 1:length(consec)){
    mino = min(consec[[ii]]) ; maxo = max(consec[[ii]])
    if(mino == maxo){
      mess =
        paste0(mess,min(consec[[ii]]), ', ' )
    }else{
      mess =
        paste0(mess,min(consec[[ii]]), '-', max(consec[[ii]]), ', ' )
    }

  }
  mess <- stringr::str_remove(mess,', $')

  # Years the plant is in the collection
  yr_in = as.numeric(stringr::str_extract(rownames(CUBG_geo_over_time),pattern = '[0-9]{4}'))
  want = which(CUBG_geo_over_time[match(x, names(CUBG_geo_over_time))]!=0)
  yr_in = yr_in[want]
  yr_in = sort(yr_in[yr_in != 0])
  consec = split(yr_in,cumsum(c(1,diff(yr_in)!=1)))
  mess_in = ''
  for(ii in 1:length(consec)){
    mino = min(consec[[ii]]) ; maxo = max(consec[[ii]])
    if(mino == maxo){
      mess_in =
        paste0(mess_in,min(consec[[ii]]), ', ' )
    }else{
      mess_in =
        paste0(mess_in,min(consec[[ii]]), '-', max(consec[[ii]]), ', ' )
    }

  }
  mess_in <- stringr::str_remove(mess_in,', $')


  return(c(x, first_rep, example_plant, web,mess,  mess_in#,no_wcvp
           ))
}) |> data.frame()
regions_info <- regions_info |> t() |> data.frame()
rownames(regions_info) = 1:nrow(regions_info)
names(regions_info) = c('code', 'first_acc_year', 'first_plant', 'web', 'all_acc_year', 'exist_in_LC'#, 'no_wcvp'
                        )
regions_info$all_acc_year[regions_info$all_acc_year == 'Inf--Inf'] = NA
regions_info$exist_in_LC[regions_info$exist_in_LC == 'Inf--Inf'] = NA
regions_info$exist_in_LC = stringr::str_replace_all(regions_info$exist_in_LC,pattern = '2024','Present')
name = wgsrpd3_level3_simp$name
level2_code = wgsrpd3$LEVEL2_COD[match(regions, wgsrpd3$LEVEL3_COD)]
level2_name = wgsrpd3_level2_simp$name[match(level2_code, wgsrpd3_level2_simp$code)]
level1_code = wgsrpd3$LEVEL1_COD[match(regions, wgsrpd3$LEVEL3_COD)]
level1_name = wgsrpd3_level1_simp$name[match(level1_code, wgsrpd3_level1_simp$code)]

regions_info = data.frame(Level_1 = level1_name, Level2 = level2_name, Level3 = name, regions_info)
#regions_info$no_wcvp = as.numeric(regions_info$no_wcvp)
regions_info$first_acc_year = as.numeric(regions_info$first_acc_year)
writexl::write_xlsx(regions_info, paste0(output_dir,'/',collection,'geography_region.xlsx'))


# Get first year for each continent.
continents = unique(regions_info$Level_1)
regions_info = regions_info[order(regions_info$first_acc_year),]
continents_info = regions_info[match(continents, regions_info$Level_1),]
continents_info = continents_info[,match(c('Level_1', 'first_acc_year', 'first_plant', 'web'), names(continents_info))]
names(continents_info) = c('Continent', 'First Accession Year', 'Plant', 'POWO Web Address')
writexl::write_xlsx(continents_info, paste0(output_dir,'/',collection,'geography_continent_first_assess.xlsx'))


##############################################
### Try and create plots
##############################################
year = as.numeric(stringr::str_extract(rownames(CUBG_geo_over_time), pattern = '[0-9]{4}'))
no_regions = as.numeric(apply(CUBG_geo_over_time, MARGIN=c(1), function(x){sum(x>0)}))
df = data.frame(year = year, regions = no_regions)

continents_info_p <- continents_info |>
  dplyr::group_by(.data$`First Accession Year`) |>
  dplyr::summarise(Continent = toString(.data$Continent)
  ) |>
  dplyr::ungroup()

continent_years = continents_info_p$`First Accession Year`
if(!is.null(old_accession_year_codes)){
  continent_years[continent_years %in% old_accession_year_codes] = earliest_allowable_record

}
if(report_kind == 'interactive'){
  fig <- plot_ly(data = df, x = ~year, y = ~regions, type = 'scatter', name = 'Regions', mode = 'lines', showlegend = FALSE, hovertemplate = paste0('%{y}'))
fig <- fig |> add_trace(x= continent_years, y = no_regions[match(continent_years,year)],  type = 'scatter', mode = 'markers', customdata = continents_info_p$Continent, hovertemplate = paste0('%{customdata}'), name = 'First Accession')
fig <- fig |> layout(yaxis = list(title = paste0("Number of regions")),
                     xaxis = list(title = "Year"))
fig <- fig |> layout(hovermode = 'x unified', hoverdistance = 1)
geog_fig = fig
}
```

`r if(do_geography_trend){paste0("In this section, we explore how the number of [TDWG geographical codes](https://web.archive.org/web/20160125135239/http:/www.nhm.ac.uk/hosted_sites/tdwg/TDWG_geo2.pdf) (Brummitt, 2001) represented in the collection varies over time. Not that this system splits the world into ", nrow(wgsrpd3_level3_simp), " regions. Note that Bouvet Island is the only region that has no native plants in POWO - i.e. it has no vascular plants.")}`


`r if(do_geography_trend){paste0("Below we show how many regions are represented in the collection since records began. This includes points when the first plant from each continent is accessioned. ")}`


```{r, geography regions represented trends - interactive, eval = do_geography_trend & report_kind == 'interactive', fig.fullwidth=TRUE, fig.dim = c(10, 4)}
geog_fig
```

`r if(do_geography_trend){paste0("The first plants accessioned from each continent is outlined below.")}`



```{r continent table, eval = do_geography_trend}
if(report_kind == 'interactive'){
   web_link = continents_info$`POWO Web Address`
   linked_name = paste0('<a href=',web_link,'>',continents_info$Plant,'</a>')
   continents_info$Plant = linked_name
   continents_info= continents_info[,-4]
  DT::datatable(continents_info, rownames = FALSE, escape = FALSE)
}
```




