---
title: "Geographic distribution of taxa in the collection"
output:
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)
```

```{r, imported parameters}
# Inputs
# As an input we get 
# - Enriched report
# - collection the name to be printed in the report.
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/CUBG_June2023_enriched_report.rda')
# coordinates = c(52.193403, 0.128305)
# collection = 'CUBG'
# separate_figure_folder = FALSE
# output_dir = '/Users/jakepowell/Desktop'
# load('/Users/jakepowell/Cambridge/Geography Module/wgsrpd3.rda')
# report_kind = 'interactive'
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE
# ggtheme = NULL
# export_data = FALSE
# color_binary = c('darkgray','darkgreen')
# palette = 'Greens'
```

```{r, add logo, eval = report_kind == 'interactive'}
htmltools::img(src = knitr::image_uri(paste0(system.file(package = "BGSmartR"), "/logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:100px; height:100px')
```

```{r, region names}

level_2 = c("10, 11, 12, 13, 14, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 40, 41, 42, 43, 50, 51, 60, 61, 62, 63, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 90, 91, Northern Europe, Middle Europe, Southwestern Europe, Southeastern Europe, Eastern Europe, Northern Africa, Macaronesia, West Tropical Africa, West-Central Tropical Africa, Northeast Tropical Africa, East Tropical Africa, South Tropical Africa, Southern Africa, Middle Atlantic Ocean, Western Indian Ocean, Siberia, Russian Far East, Middle Asia, Caucasus, Western Asia, Arabian Peninsula, China, Mongolia, Eastern Asia, Indian Subcontinent, Indo-China, Malesia, Papuasia, Australia, New Zealand, Southwestern Pacific, South-Central Pacific, Northwestern Pacific, North-Central Pacific, Subarctic America, Western Canada, Eastern Canada, Northwestern U.S.A., North-Central U.S.A., Northeastern U.S.A., Southwestern U.S.A., South-Central U.S.A., Southeastern U.S.A., Mexico, Central America, Caribbean, Northern South America, Western South America, Brazil, Southern South America, Subantarctic Islands, Antarctic Continent")
level_1 = c("1, 2, 3, 4, 5, 6, 7, 8, 9, Europe, Africa, Asia-Temperate, Asia-Tropical, Australasia, Pacific, Northern America, Southern America, Antarctic")

level_2 = data.frame(matrix(unlist(stringr::str_split(level_2, ', ')), ncol = 2))
names(level_2) = c('code', 'name') ; level_2$code = as.numeric(level_2$code)

level_1 = data.frame(matrix(unlist(stringr::str_split(level_1, ', ')), ncol = 2))
names(level_1) = c('code', 'name') ; level_1$code = as.numeric(level_1$code)

```

```{r, theme_ggplot2}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0.5),
          panel.grid.minor = ggplot2::element_blank(),
          panel.border = ggplot2::element_blank(),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0)),
          axis.line=element_blank(),
          axis.text.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

```{r, Add combined geography column to enriched report}
geography_data = enriched_report[,grepl('_area_code_l3', names(enriched_report))]
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}
# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}
level3codes[level3codes == "NA"] = NA

enriched_report$geography_codes = level3codes
```

```{r Extracting information from enriched report}
exporting_data_store = list()

if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

enriched_report = enriched_report[enriched_report$ItemStatusType == 'Existing',]


no_items = nrow(enriched_report)
no_powo_matched = sum(!is.na(enriched_report$POWO_plant_name_id))
percent_matched = round(no_powo_matched/no_items*100,digits=2)

```

```{r, Get location_type_text}
location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occuring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```


This report explores the geographic distribution of existing taxa in `r collection`.

To get geographic information the LC has been enriched with information from [Plants of the World Online (POWO)](https://powo.science.kew.org). Only records that are matched to POWO have geographic information. This is true for `r percent_matched`% (`r format(no_powo_matched ,big.mark = ',')`)  of the items in the LC.

POWO uses [TDWG geographical codes](https://www.tdwg.org/standards/wgsrpd/) (Brummitt, 2001) expressed to that system's third level. This splits the world into 369 regions. Moreover, POWO splits the geographic distribution by three conditions:

- Native / non-native,
- Extinct / Not extinct,
- Location is doubtful / otherwise.

This document considers locations that are : `r location_type_text` 

```{r, Extract geographic distribution, echo = FALSE}
# Prepare the data for the plots.

# Restrict to only those matched to WCVP.
wanted_info = enriched_report[!is.na(enriched_report$POWO_plant_name_id),]
# Add species by combining taxonomic name and authors
wanted_info$species = paste0(wanted_info$POWO_taxon_name, ' ', wanted_info$POWO_taxon_authors)
#Restrict to only unique species.
wanted_info = wanted_info[match(unique(wanted_info$species), wanted_info$species),]

# Get all BRU level 3 location codes.
All_locations = wgsrpd3$LEVEL3_COD

#Get the number of speices for each location.
no_species = unlist(lapply(All_locations, function(x){
  sum(grepl(x, wanted_info$geography_codes))
}))

#Get the number of endemic species for each location.
endemic_info = wanted_info[stringr::str_length(wanted_info$geography_codes) == 3,]
no_endemic = unlist(lapply(All_locations, function(x){
  sum(grepl(x, endemic_info$geography_codes))
}))

#Get the number of threatened species for each location.
indicesA = which(wanted_info$POWO_Red_category %in%  c('EN', 'VU', 'CR', 'EW', 'EX'))
indicesB = which(wanted_info$redList_category %in%  c('EN', 'VU', 'CR', 'EW', 'EX'))
indices = unique(c(indicesA, indicesB))
threatened_info = wanted_info[indices,]
no_threatened = unlist(lapply(All_locations, function(x){
  sum(grepl(x, threatened_info$geography_codes))
}))

# Get the level 1 and level 2 region names.
level_1_names = level_1$name[match(wgsrpd3$LEVEL1_COD, level_1$code)]
level_2_names = level_2$name[match(wgsrpd3$LEVEL2_COD, level_2$code)]

# Combine the wanted information into location data.
location_data = data.frame(code =  wgsrpd3$LEVEL3_COD,
                           name = wgsrpd3$LEVEL3_NAM,
                           level_2 = level_2_names,
                           level_1 = level_1_names,
                           no_species = no_species,
                           rep_species = no_species > 0,
                           no_endemic = no_endemic,
                           rep_endemic = no_endemic > 0,
                           no_threatened = no_threatened,
                           rep_threatened = no_threatened > 0
                           )

location_data$name = stringr::str_replace(location_data$name, pattern = 'I\\.',replacement = 'Island')
location_data$name = stringr::str_replace(location_data$name, pattern = 'Is\\.',replacement = 'Islands')
plot_info <- wgsrpd3 |>
  #add the location data to the geometry data
  dplyr::left_join(location_data, by=c("LEVEL3_COD"="code"))

# Do we want to export the data into an excel spreadsheet and r data file.
if(export_data){
  save(location_data, file = paste0(output_dir,'/',collection,'_geography_data.rda'))
  
  l = location_data
  names(l) = c('BRU level 3 code',
               'BRU level 3 name',
               'BRU level 2 region',
               'BRU level 1 region',
               'Number of Species',
               'Represented by Species',
               'Number of Endemic Species',
               'Represented by Endemic Species',
               'Number of Threatened Species',
               'Represented by Threatened Species')
  writexl::write_xlsx(l,path = paste0(output_dir,'/',collection,'_geography_data.xlsx'))
  rm(l)
}
```

```{r, interactive data setup}
if(report_kind == 'interactive'){
   # Due to the high level of detail in wgsrpd3 we need to go to a simplified geometry for the interactive geometry plots. 
  # load all geo areas
  wgsrpd3_level3_simp = BGSmartR::wgsrpd3_level3_simp
  
  plot_int_info <- wgsrpd3_level3_simp |>
  dplyr::left_join(location_data, by=c("code"="code"))
  plot_int_info$name = plot_int_info$name.x
  plot_int_info$name = stringr::str_replace(plot_int_info$name, pattern = 'I\\.',replacement = 'Island')
  plot_int_info$name = stringr::str_replace(plot_int_info$name, pattern = 'Is\\.',replacement = 'Islands')
  
  data_g = st_geometry(plot_int_info)

  centers = st_centroid(data_g)
  AA = unlist(centers)
  center_df = data.frame(long = AA[seq(1,length(AA),2)], lat = AA[seq(2,length(AA),2)])

  # Convert geometry into a format accepted by plotly
  mapp = sf::st_cast(wgsrpd3_level3_simp, "MULTIPOLYGON")
  geo_sf = geojsonsf::sf_geojson(mapp)
  data = rjson::fromJSON(geo_sf)
  feat = data$features
  for(i in 1:length(feat)){
    feat[[i]]$id = feat[[i]]$properties$code
  }
  data$features = feat
  
}

  index = seq(0,1,0.01)
  col_rep = color_binary
  colours = c(rep(col_rep[1],51), rep(col_rep[2],50))
  counter = 1:length(index)
  col_scale_rep = lapply(counter, function(i){return(c(index[i], colours[i]))})
  
  colours_cont = scales::brewer_pal(palette = palette, direction = 1)(7)
  ramp <- scales::colour_ramp(colours_cont)
  colos = ramp(seq(0, 1, length = 100))
  
  
  index = seq(0,1,0.01)
  colours_cont = c("black",colos)
  counter = 1:length(index)
  col_scale = lapply(counter, function(i){return(c(index[i], colours_cont[i]))})
```

`r if(report_kind == 'interactive'){"Below we show the data used for the geographic plots shown in the later sections."}`

```{r table - interative}

show_table = location_data[,-c(1,6,8,10)]
names(show_table) = c('BRU level 3 name',
               'BRU level 2 region',
               'BRU level 1 region',
               'Number of Species',
               'Number of Endemic Species',
               'Number of Threatened Species')

if(report_kind == 'interactive'){
  DT::datatable(data = show_table, rownames = FALSE, options = list(dom = 'tp'), filter = list(position = "top"))

}
```
***

## Species in the LC

Of 369 regions described by TDWG geographical codes, 368 of them have native species in POWO. The exception is Bouvet Island which has none. 

<!-- ### BRU level 3 areas represented in the LC -->

```{r, BRU level 3 areas represented in the LC - regions not represented.}
percent_rep = round(sum(plot_info$rep_species) / length(plot_info$rep_species) *100,digits = 2)
no_rep = plot_info$name[!plot_info$rep_species]
```


```{r, BRU level 3 areas represented in the LC - static figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6), eval = FALSE}
if(report_kind == 'static'){
  fig = ggplot(plot_info)+
  geom_sf(aes(fill=rep_species),  col="transparent")+
  stat_sf_coordinates(aes(col=rep_species))+
    scale_fill_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
    scale_color_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
  guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
         col = "none") 
    

  if(separate_figure_folder){
  ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_representation_of_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
  }

fig
}
```

```{r, BRU level 3 areas represented in the LC - interactive figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6), eval = FALSE}
if(report_kind == 'interactive'){
    text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Represented: ', plot_int_info$rep_species)
  plot_int_info$hover = text
  
  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=as.numeric(plot_int_info$rep_species),
     colorscale=col_scale_rep,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text'
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
  ) |>
    colorbar(title = "Species <br> Represented <br> in LC")  
  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(col_rep[as.numeric(plot_int_info$rep_species)+1]), 
                          hoverinfo = 'text',
                          inherit = FALSE) 
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Representation_of_Species.html'))
  }
  suppressWarnings(fig)
}
```
In the LC `r percent_rep`% of the BRU level 3 regions are represented, with `r length(no_rep)` regions un-represented. 

```{r, print regions not in if less than 10, results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


<!-- ### Number of species in the LC from each BRU level 3 area. -->

```{r, Number of species in the LC from each BRU level 3 area, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'static'){
  top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_species, decreasing = TRUE)][1:10]
top10_value = plot_info$no_species[order(plot_info$no_species, decreasing = TRUE)][1:10]
top10 = data.frame(region = top10_name, no_species = top10_value)

plot_info$no_species[plot_info$no_species == 0] = NA
fig = ggplot(plot_info)+
  geom_sf(aes(fill=no_species),  col="transparent")+
  stat_sf_coordinates(aes(col=no_species))+
  scale_colour_distiller(direction=1, 
                         name="Number of Species") +
  scale_fill_distiller(direction=1,
                       name="Number of Species")+
  coord_sf(expand=FALSE)

  if(separate_figure_folder){
  ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_number_of_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

fig
}
```

`r if(report_kind == 'static'){"The regions with the most number of species are:"}`

```{r, Number of species in the LC from each BRU level 3 area - regions most speciies, results='asis'}
if(report_kind == 'static'){
names(top10) = c('Region', 'Number of Species')
library(flextable)
top10 |>
  flextable() |>
  set_caption(caption = "Table 1: Top 10 regions with largest number of species in the LC") |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
}
```


```{r, Number of species in the LC from each BRU level 3 area - interactive, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'interactive'){
  text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Number of Species: ', plot_int_info$no_species)
  plot_int_info$hover = text

   colours_index = ceiling(as.numeric(plot_int_info$no_species)/max(as.numeric(plot_int_info$no_species))*(length(col_scale)-1)+1)
   
  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=colours_index,
     colorscale=col_scale,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text',
     showscale = FALSE
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
    ) |>hide_colorbar()
  # ) |>
  #   colorbar(title = "Number<br> of Species") 
 
  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(colours_cont[colours_index]), 
                          hoverinfo = 'text',
                          inherit = FALSE) |>
    layout(showlegend = F)
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Number_of_Species.html'))
  }
  suppressWarnings(fig)
}
```


***

## Endemic Species in the LC

Here we say a species is endemic if is belongs to a single BRU level 3 region (with the location criteria described at the start of the document).

### BRU level 3 areas represented by endemic species in the LC

```{r Endemic Species in the LC}
percent_rep = round(sum(plot_info$rep_endemic) / length(plot_info$rep_endemic) *100,digits = 2)
no_rep = plot_info$LEVEL3_NAM[!plot_info$rep_endemic]
```


```{r, Represented Endemic Species in the LC - figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'static'){
  fig = ggplot(plot_info)+
  geom_sf(aes(fill=rep_endemic),  col="transparent")+
  stat_sf_coordinates(aes(col=rep_endemic))+
     scale_fill_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
    scale_color_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
  guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
         col = "none")

  if(separate_figure_folder){
  ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_representation_of_endemic_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
  }
fig
}

```

```{r, Represented Endemic Species in the LC - interactive figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'interactive'){
    text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Represented: ', plot_int_info$rep_endemic)
  plot_int_info$hover = text
  
  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=as.numeric(plot_int_info$rep_endemic),
     colorscale=col_scale_rep,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text'
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
  ) |>
    colorbar(title = "Species <br>Represented <br>in LC")  
  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(col_rep[as.numeric(plot_int_info$rep_endemic)+1]), 
                          hoverinfo = 'text',
                          inherit = FALSE) 
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Representation_of_Endemic_Species.html'))
  }
  suppressWarnings(fig)
}
```

In the LC `r percent_rep`% of the BRU level 3 regions are represented by endemic species, with `r length(no_rep)` regions un-represented. 

```{r, Endemic Species in the LC 2,results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


### Number of endemic species in the LC from each BRU level 3 area.

```{r, Number Endemic Species in the LC - figure, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'static'){
top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_endemic, decreasing = TRUE)][1:10]
top10_value = plot_info$no_endemic[order(plot_info$no_endemic, decreasing = TRUE)][1:10]
top10 = data.frame(region = top10_name, no_endemic = top10_value)

plot_info$no_endemic[plot_info$no_endemic == 0] = NA
fig = ggplot(plot_info)+
  geom_sf(aes(fill=no_endemic),  col="transparent")+
  stat_sf_coordinates(aes(col=no_endemic))+
  scale_colour_distiller(direction=1, 
                         name="Number of Species") +
  scale_fill_distiller(direction=1,
                       name="Number of Species")+
  coord_sf(expand=FALSE)

  if(separate_figure_folder){
  ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_number_of_endemic_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
  }

fig
}
```

`r if(report_kind == 'static'){"The regions with the most number of endemic species are:"}`

```{r, Number Endemic Species in the LC - table, results='asis'}
if(report_kind == 'static'){
  
  names(top10) = c('Region', 'Number of Endemic Species')
  library(flextable)
  top10 |>
    flextable() |>
    set_caption(caption = "Table 1: Top 10 regions with largest number of endemic species in the LC") |> 
    font(fontname = "Calibri (Body)", part = "all") |> 
    fontsize(size = table_font_size, part = "body") |> 
    # add footer if you want
    # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
    #                colwidths = 4) |> 
    theme_booktabs() |> # default theme
    autofit()
}
```



```{r, Number of Endemic species in the LC from each BRU level 3 area - interactive, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'interactive'){
  text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Number of Species: ', plot_int_info$no_endemic)
  plot_int_info$hover = text
  colours_index = ceiling(as.numeric(plot_int_info$no_endemic)/max(as.numeric(plot_int_info$no_endemic))*(length(col_scale)-1)+1)
  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=colours_index,
     colorscale=col_scale,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text'
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
  ) |>
    colorbar(title = "Number<br> of Species") 

  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(colours_cont[colours_index]), 
                          hoverinfo = 'text',
                          inherit = FALSE) 
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Number_of_Endemic_Species.html'))
  }
  suppressWarnings(fig)
}
```
***

## Threatened Species in the LC

Here a threatened species is any taxa in the LC that has been flagged as vulnerable, endangered, critically endangered, extinct in the wild or extinct. A taxa can be flagged in two ways; either matching the original name in the collection directly to IUCN's red list or by matching the accepted name in POWO to IUCN's red list. 

### BRU level 3 areas represented by threatened species in the LC

```{r no threatened species regions represented}
percent_rep = round(sum(plot_info$rep_threatened) / length(plot_info$rep_threatened) *100,digits = 2)
no_rep = plot_info$LEVEL3_NAM[!plot_info$rep_threatened]
```


```{r, Represented Threatened Species in the LC - figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'static'){
  fig = ggplot(plot_info)+
    geom_sf(aes(fill=rep_threatened),  col="transparent")+
    stat_sf_coordinates(aes(col=rep_threatened))+
     scale_fill_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
    scale_color_manual(values = color_binary, name = "Cand", labels = c("No", "Yes"))+
    guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
           col = "none")
  
    if(separate_figure_folder){
    ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_representation_of_threatened_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  fig
}
```

```{r, Represented Threatened Species in the LC - interactive figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'interactive'){
    text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Represented: ', plot_int_info$rep_threatened)
  plot_int_info$hover = text
  
  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=as.numeric(plot_int_info$rep_threatened),
     colorscale=col_scale_rep,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text'
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
  ) |>
    colorbar(title = "Species <br>Represented <br>in LC")  
  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(col_rep[as.numeric(plot_int_info$rep_threatened)+1]), 
                          hoverinfo = 'text',
                          inherit = FALSE) 
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Representation_of_Threatened_Species.html'))
  }
  suppressWarnings(fig)
}
```
In the LC `r percent_rep`% of the BRU level 3 regions are represented by threatened species, with `r length(no_rep)` regions un-represented. 

```{r, show represented threatened regions, results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


### Number of threatened species in the LC from each BRU level 3 area.

```{r, Number Threatened Species in the LC - figure, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'static'){
  top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_threatened, decreasing = TRUE)][1:10]
  top10_value = plot_info$no_threatened[order(plot_info$no_threatened, decreasing = TRUE)][1:10]
  top10 = data.frame(region = top10_name, no_threatened = top10_value)
  
  plot_info$no_threatened[plot_info$no_threatened == 0] = NA
  fig = ggplot(plot_info)+
    geom_sf(aes(fill=no_threatened),  col="transparent")+
    stat_sf_coordinates(aes(col=no_threatened))+
    scale_colour_distiller(direction=1, 
                           name="Number of Species") +
    scale_fill_distiller(direction=1,
                         name="Number of Species")+
    coord_sf(expand=FALSE)
  
  
    if(separate_figure_folder){
    ggplot2::ggsave(plot = fig, filename = paste0(figures_dir, '/','Map_number_of_threatened_species.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  
  fig
  
}
```

`r if(report_kind == 'static'){"The regions with the most number of threatened species are:"}`

```{r, Number Threatened Species in the LC - table, results='asis'}
if(report_kind == 'static'){
  names(top10) = c('Region', 'Number of Threatened Species')
  library(flextable)
  top10 |>
    flextable() |>
    set_caption(caption = "Table 1: Top 10 regions with largest number of threatened species in the LC") |> 
    font(fontname = "Calibri (Body)", part = "all") |> 
    fontsize(size = table_font_size, part = "body") |> 
    # add footer if you want
    # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
    #                colwidths = 4) |> 
    theme_booktabs() |> # default theme
    autofit()
}
```

```{r, Number of Threatened species in the LC from each BRU level 3 area - interactive, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
if(report_kind == 'interactive'){
  text = paste0('Region: ', plot_int_info$name, '<br />', 
                'Number of Species: ', plot_int_info$no_threatened)
  plot_int_info$hover = text
colours_index = ceiling(as.numeric(plot_int_info$no_threatened)/max(as.numeric(plot_int_info$no_threatened))*(length(col_scale)-1)+1)

  fig = plot_ly(plot_int_info,  text = ~hover, hoverinfo = 'text') |>
    add_trace(type="choroplethmapbox",
     geojson=data,
     locations=wgsrpd3_level3_simp$code,
     z=colours_index,
     colorscale=col_scale,
     reversescale = FALSE,
     marker=list(line=list(
     width=0.01,color ='black'),
     text = plot_int_info$hover,
     hoverinfo = 'text'
    )) |>
    layout(
    mapbox=list(
      style="white-bg",
      center = list(lon = 0 ,lat= 60),
      zoom =0.46, 
      lataxis = list(range = c(-59, 90)))
  ) |>
    colorbar(title = "Number<br> of Species") 
  
  fig = fig |>  add_trace(type="scattermapbox",
                          mode = 'markers',
                          data = center_df,
                          lon = center_df$long,
                          lat = center_df$lat,
                          text = plot_int_info$hover,
                          color = I(colours_cont[colours_index]), 
                          hoverinfo = 'text',
                          inherit = FALSE) 
  
  
  


  
  if(FALSE){
    fig <- fig |> add_trace(type='scattermapbox',
                           mode = 'markers',
                           lon = coordinates[1],
                           lat = coordinates[2],
                          text = 'Collection',
                          color = I('orange'),
                           size = I(1),
     hoverinfo = 'text')
  }
  
  
  
  fig <- fig   |> config(modeBarButtonsToRemove = c("select2d", "lasso2d"))
  
  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Geography-Number_of_Threatened_Species.html'))
  }
  suppressWarnings(fig)
}
```

***
