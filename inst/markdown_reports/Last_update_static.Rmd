---
title: "Last Status Update"
output:
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(ggplot2)
library(anytime)
```

```{r, imported parameters, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - min_year for retrospective reports.
# - collection the name to be printed in the report.

report = enriched_report
```

```{r, Anaylsis, echo = F}
# First let's reduce our report to only the information we need.

# Only exisiting items
report = report[report$ItemStatusType == 'Existing',]

# Only columns of interest.
report = report[,match(c('sanitised_taxon', 'extracted_author', 'AccNoFull', 'ItemAccNoFull', 'ItemStatusDate', 'ItemType'), names(report))]

size_report = nrow(report)

# Get the current date. 
current_date <- Sys.Date()
current_year <- as.numeric(format(current_date, '%Y'))

#How many records have missing ItemStatusDate?
missing_index = which(report$ItemStatusDate == '')
missing_ItemStatusDate = length(missing_index)

# Get the year from each item.
ItemYear = BGSmartR::extract_year(report$ItemStatusDate)
# anytime::addFormats(c('%d-%m-%Y', '%d/%m/%Y'))
# ItemStatusDate = as.Date(format(anytime::anydate(report$ItemStatusDate), "%Y-%m-%d"))

#How many records have a date after the current date?
future_index = which(ItemYear - current_year > 0)
future_ItemStatusDate = length(future_index)

#How many records have a date that appears to be a placeholder?
placeholder_index = which(1650 - ItemYear > 0)
placeholder_ItemStatusDate = length(placeholder_index)

# Reduce report into data removing missing/future itemstatusdates. 
data = report[-c(missing_index,future_index, placeholder_index),]
data$year = BGSmartR::extract_year(data$ItemStatusDate)

# Items (year).
year = data$year
table_year = table(year)
last_update_items = data.frame(year = names(table_year), no_items = as.numeric(table_year))
last_update_items$cumulative = cumsum(last_update_items$no_items)
last_update_items$year_num = as.numeric(last_update_items$year)
last_update_items$year_ago = current_year -last_update_items$year_num

# if(is.null(min_year)){
#   min_year = min(last_update_items$year_num,na.rm = T)
# }
```

This report uses data from `r collection`.

***

The collection has `r format(size_report, big.mark = ',')` plants that are currently existing. Of these:

- `r format(missing_ItemStatusDate, big.mark = ',')` have missing item status date.
- `r format(future_ItemStatusDate, big.mark = ',')` have a status date that is in the future (i.e after `r current_date`).
- `r format(placeholder_ItemStatusDate, big.mark = ',')` have a status date that is prior to 1650 which we assume are placeholders.

## Last update of items

We restrict the database to only items that have an item status date, whose date is not in the future. 

#### Bar plot of Last status date of items in the collection

```{r, echo = F}
p<-ggplot(data=last_update_items, aes(x=year, y=no_items)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  labs(x="Last status update", y = "Number of items")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
   
```

#### Bar plot of number of years since last status update of items in the collection

```{r, echo = F}
p<-ggplot(data=last_update_items, aes(x=year_ago, y=no_items)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  labs(x="Number of years since last status update", y = "Number of items")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
   
```

#### Cumulative plot of Last status date of items in the collection

```{r, echo = F}
p<-ggplot(data=last_update_items, aes(x=year_num, y=cumulative)) +
  geom_line()+
  theme_minimal()+
  labs(x="Last status update", y = "Cumulative number of items")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
   
```

#### Cumulative plot of number of years since last status update of items in the collection

```{r, echo = F}
p<-ggplot(data=last_update_items, aes(x=year_ago, y=cumulative)) +
  geom_line()+
  theme_minimal()+
  labs(x="Number of years since last status update", y = "Cumulative number of items")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
p
   
```

***
