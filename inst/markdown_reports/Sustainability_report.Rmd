---
title: "Sustainability at the collection"
output: html_document
---

#### {-}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)

interactive_colour <- function(n){
  color = c('#f46d43', "#FDAE6B", '#848484', '#e6e6e6')
  if(n==2){
    return(color[c(1,4)])
  }
  color[1:n]
}

color_binary <- c('#f46d43', '#e6e6e6')
palette = 'Oranges'
```

```{css, echo = FALSE}
/* from https://ianlunn.github.io/Hover/ */
.hvr-sweep-to-left {
  display: inline-block;
  vertical-align: middle;
  -webkit-transform: perspective(1px) translateZ(0);
  transform: perspective(1px) translateZ(0);
  box-shadow: 0 0 1px rgba(0, 0, 0, 0);
  position: relative;
  -webkit-transition-property: color;
  transition-property: color;
  -webkit-transition-duration: 0.3s;
  transition-duration: 0.3s;
}
.hvr-sweep-to-left:before {
  content: "";
  position: absolute;
  z-index: -1;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #f46d43;
  -webkit-transform: scaleX(0);
  transform: scaleX(0);
  -webkit-transform-origin: 100% 50%;
  transform-origin: 100% 50%;
  -webkit-transition-property: transform;
  transition-property: transform;
  -webkit-transition-duration: 0.3s;
  transition-duration: 0.3s;
  -webkit-transition-timing-function: ease-out;
  transition-timing-function: ease-out;
}
.hvr-sweep-to-left:hover, .hvr-sweep-to-left:focus, .hvr-sweep-to-left:active {
  color: white;
}
.hvr-sweep-to-left:hover:before, .hvr-sweep-to-left:focus:before, .hvr-sweep-to-left:active:before {
  -webkit-transform: scaleX(1);
  transform: scaleX(1);
}

.blackbox {
  padding: 1em;
  background: #FDAE6B;
  border: 2px solid #e6e6e6;
  border-radius: 10px;
}
.center {
  text-align: center;
}
```


<!-- Motivation HERE -->


```{r, imported parameters}
# #Inputs
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/CUBG_June2023_enriched_report.rda')
# collection = 'CUBG'
# coordinates = c(52.19378853629289,0.1277234065606053)
# load('/Users/jakepowell/Cambridge/Geography Module/wgsrpd3.rda')
# 
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE

# separate_figure_folder = F
# output_dir = getwd()
# report_kind = 'interactive'
# ggtheme = NULL
# value_on_fig = TRUE
# min_year = 1970
# data_type = 'Accessions'
# earliest_allowable_record = 1650
# old_accession_year_codes = c(1000)
```

```{r, add logo, eval = report_kind == 'interactive'}
htmltools::img(src = knitr::image_uri(paste0(system.file(package = "BGSmartR"), "/logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:87.8px; height:100px')
```

```{r theme_ggplot2}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.background = element_rect(fill = 'transparent', color = NA),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

```{r, Add combined geography column to enriched report}
geography_data = enriched_report[,grepl('_area_code_l3', names(enriched_report))]
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}
# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}
level3codes[level3codes == "NA"] = NA

enriched_report$geography_codes = level3codes
```

```{r, Get location_type_text}
location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occuring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```

```{r, Find LC location, echo = FALSE}
coord_contained = TRUE
# Extract the location of the collection.
pnts <- data.frame( x = coordinates[2], y = coordinates[1])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
location_name = collection_geog_details$LEVEL3_NAM
location_code = collection_geog_details$LEVEL3_COD

if(length(location_name) == 0){
  coord_contained = FALSE
  # Try and find the nearest polygon.
  collection_geog_details  =  wgsrpd3[which.min(as.vector(sf::st_distance(tt1_trans, pnts_trans))),-5]
  location_name = collection_geog_details$LEVEL3_NAM
  location_code = collection_geog_details$LEVEL3_COD
}
```

`r if(any(!c('AccNoFull') %in% names(enriched_report))){"*** \n **Warning!**\n\n This enriched report contains missing 'original' columns needed to perform the analyses in this report. Default values have been created. In particular, the following were missing "}`

`r if(!'AccNoFull' %in% names(enriched_report)){"- AccNoFull: assume each item is its own accession.\n"}`

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"***"}`

```{r, Extracting required information from enriched report, echo = F}

needed_columns = c('AccNoFull', 'AccYear', 'ItemStatusDate', 'ItemStatusType')
if(!'AccNoFull' %in% names(enriched_report)){
  enriched_report$AccNoFull = 1:nrow(enriched_report)
}
if(!'AccYear' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$AccYear = rep(0, nrow(enriched_report))
}
if(!'ItemStatusDate' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$ItemStatusDate = rep(NA, nrow(enriched_report))
}
if(!'ItemStatusType' %in% names(enriched_report)){
  do_over_time = FALSE
  enriched_report$ItemStatusType = rep('Existing', nrow(enriched_report))
}
if(all(is.na(enriched_report$ItemStatusDate))){
  do_over_time = FALSE
}
if(all(is.na(enriched_report$ItemStatusType))){
  do_over_time = FALSE
}
if(all(is.na(enriched_report$AccYear))){
  do_over_time = FALSE
}
#Extract endemic information from enriched_report
endemic = rep('Not Endemic', nrow(enriched_report))
endemic_index = which(stringr::str_length(enriched_report$geography_codes) == 3)
endemic[endemic_index] = 'Endemic'
enriched_report$endemic = endemic
rm(endemic)

# Extract threatened. 
threat_cat = c('VU','EN','CR','EW','EX')
threatened = rep('Not Threatened', nrow(enriched_report))
threatened[which(enriched_report$redList_category %in% threat_cat)] = 'Threatened'
threatened[which(enriched_report$POWO_Red_category %in% threat_cat)] = 'Threatened'
enriched_report$threatened = threatened
rm(threatened)

# Extract threatened category. 
threatened_category = rep(NA, nrow(enriched_report))
for(i in 1:length(threat_cat)){
 threatened_category[which(enriched_report$redList_category == threat_cat[i])] = threat_cat[i]
 threatened_category[which(enriched_report$POWO_Red_category == threat_cat[i])] = threat_cat[i]
}
enriched_report$threatened_category = threatened_category
rm(threatened_category)

# Convert Provenance code to text.
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'G'] = 'Garden'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'U'] = 'Unknown'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'W'] = 'Wild'
enriched_report$ProvenanceCode[enriched_report$ProvenanceCode == 'Z'] = 'Wild-derived'

# Extract tree.
tree =rep('Not Tree', nrow(enriched_report))
tree[enriched_report$Enrich_is_tree] = 'Tree'
enriched_report$tree = tree
rm(tree)

# Extract native.
nativeo = rep('Not Native', nrow(enriched_report))
native_index = grepl(location_code,enriched_report$geography_codes)
nativeo[native_index] = 'Native'
enriched_report$native = nativeo
rm(nativeo)

LossYear = rep(NA,nrow(enriched_report))
ItemStatusYear = as.numeric(stringr::str_extract(enriched_report$ItemStatusDate,pattern = '[0-9]{4}'))
LossYear[enriched_report$ItemStatusType %in% c('NotExisting', 'Not Existing')] = ItemStatusYear[enriched_report$ItemStatusType %in% c('NotExisting', 'Not Existing')]
enriched_report$LossYear = LossYear

# Create a sanitised taxonomic name.
enriched_report$good_name = paste0(enriched_report$sanitised_taxon, ' ', enriched_report$extracted_author)

best_name = paste0(enriched_report$POWO_taxon_name, ' ', enriched_report$POWO_taxon_authors)
best_name[which(best_name == 'NA NA')] = enriched_report$good_name[which(best_name == 'NA NA')]
enriched_report$best_name = best_name

report_original = enriched_report

report = enriched_report

if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

exporting_data_store = list()

## Data for trends
max_year = as.numeric(format(Sys.Date(),'%Y'))
years = min_year:max_year

# Set old unknown records to have a date ( = earliest_allowable_record) and remove all records prior to this time.
if(!is.null(old_accession_year_codes)){
  has_old_accessions_code = which(report$AccYear %in% old_accession_year_codes)
  no_old_accessions = length(has_old_accessions_code)
  report$AccYear[has_old_accessions_code] = earliest_allowable_record
}
to_keep = which(as.numeric(report$AccYear) >= earliest_allowable_record  & as.numeric(report$AccYear) <= max_year)
still_issue = nrow(report) - length(to_keep)
report = report[to_keep,]

report = report[!is.na(report$ItemStatusDate),]

report_after_old_acc = report
### Find the number of items/accessions where we have to do some fixing to the most recent status update.
post_date = report$ItemStatusDate
index_string_length_4 = which(stringr::str_length(post_date) == 4)
index_string_length_7 = which(stringr::str_length(post_date) == 7)
missing_date = length(c(index_string_length_4, index_string_length_7))

### (END) Find the number of items/accessions where we have to do some fixing to the most recent status update.
```

###### {-} 

This report uses data from **`r collection`** and analyses longevity in the collection.

<!-- `r if(!is.null(old_accession_year_codes)){paste0("Within the collection the accession years '", paste0(old_accession_year_codes, collapse = ', '),"' are used to denote items which have unknown accession year but have being in the collection since near the beginning. There are ", no_old_accessions," items in the collection with these accession years. In this analysis we set the accession year of such plants to ", earliest_allowable_record, ".")}` -->

<!-- `r if(!is.null(old_accession_year_codes)){"Afterwards the"}else{'The'}` collection contains **`r still_issue`** items whose accession year is not within `r earliest_allowable_record` and `r max_year`. These records are excluded in the following analysis. -->

`r if(missing_date > 0){paste0("Within the collection there are ", missing_date, ' ', 'items' |> tolower(), ' that are either missing the day or month and day of their most recent status update. If only the day is missing we set it to the 28th, if the month and day are missing we set the date to the 31st of December. ')}`

This document outlines the sustainability of the collection by considering the age of plants currently in the collection, how long plants survive in the collection, how often new species are brought into the collection and how often they are lost.

```{r, Get survival, echo = F}
year_cur = Sys.Date() |> format('%Y') |> as.numeric()

#### 1) age of items in the collection --------
existing = report[report$ItemStatusType == 'Existing',]
plant_age  = year_cur - existing$AccYear |> as.numeric()
max_age = max(plant_age)
ages = 0:max_age
all = table(plant_age) |> as.data.frame()
names(all) = c('Age', 'Freq')
AA = rep(0, length(ages)) ; AA[match(all$Age, ages)] = all$Freq ; all = AA

#table for cats
threatened = table(plant_age[existing$threatened == 'Threatened']) |> as.data.frame()
if(nrow(threatened) == 0){
  threatened = rep(0, length(ages))
}else{
  names(threatened) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(threatened$Age, ages)] = threatened$Freq ; threatened = AA
  
}

tree = table(plant_age[existing$tree == 'Tree']) |> as.data.frame()
if(nrow(tree) == 0){
  tree = rep(0, length(ages))
}else{
  names(tree) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(tree$Age, ages)] = tree$Freq ; tree = AA 
}

native = table(plant_age[existing$native == 'Native']) |> as.data.frame()
if(nrow(native) == 0){
  native = rep(0, length(ages))
}else{
  names(native) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(native$Age, ages)] = native$Freq ; native = AA
}

endemic = table(plant_age[existing$endemic == 'Endemic']) |> as.data.frame()
if(nrow(endemic) == 0){
  endemic = rep(0, length(ages))
}else{
  names(endemic) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(endemic$Age, ages)] = endemic$Freq ; endemic = AA
}

indet = table(plant_age[grep('0', existing$taxon_type)]) |> as.data.frame()
if(nrow(indet) == 0){
  indet = rep(0, length(ages))
}else{
  names(indet) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(indet$Age, ages)] = indet$Freq ; indet = AA
}

hort = table(plant_age[grep('5|6', existing$taxon_type)]) |> as.data.frame()
if(nrow(hort) == 0){
  hort = rep(0, length(ages))
}else{
  names(hort) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(hort$Age, ages)] = hort$Freq ; hort = AA
}

species = table(plant_age[!grepl('0|5|6|2|3|4', existing$taxon_type)]) |> as.data.frame()
if(nrow(species) == 0){
  species = rep(0, length(ages))
}else{
  names(species) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(species$Age, ages)] = species$Freq ; species = AA
}

infra = table(plant_age[!grepl('0|5|6', existing$taxon_type) & grepl('2|3|4', existing$taxon_type)]) |> as.data.frame()
if(nrow(infra) == 0){
  infra = rep(0, length(ages))
}else{
  names(infra) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(infra$Age, ages)] = infra$Freq ; infra = AA
  
}

prov_values = unique(report$ProvenanceCode)
prov = lapply(prov_values, function(x){
  prov = table(plant_age[existing$ProvenanceCode == x]) |> as.data.frame()
  if(nrow(prov) == 0){ 
    prov = rep(0, length(ages))
  }else{
    names(prov) = c('Age', 'Freq')
    AA = rep(0, length(ages)) ; AA[match(prov$Age, ages)] = prov$Freq ; prov = AA
  }
  prov
}) |> data.frame()
names(prov) =prov_values
# combine
age_of_items = data.frame(ages = ages, all = all,
                          species = species, infra = infra, hort = hort, indet = indet,
                          prov,
                          threatened = threatened, endemic = endemic, native = native, tree = tree
                          )
names(age_of_items) = names(age_of_items) |>
  stringr::str_replace_all(pattern = '_', ' ') |>
  stringr::str_replace_all(pattern = '\\.', '-') |>
  stringr::str_to_sentence()

columns_names = names(age_of_items)[-1]
summary_table = lapply(columns_names, function(x){
  long = rep(age_of_items[['Ages']],age_of_items[[x]])
  c(mean(long), sd(long), quantile(long, probs = c(0,0.25,0.5,0.75,1))) |> as.numeric()|> round(2)
}) |> data.frame() |> t() |> data.frame()
names(summary_table) = c('Mean', 'SD', 'Min', 'Q1', 'Median (Q2)', 'Q3', 'Max') 
row.names(summary_table) =columns_names 
summary_table_item = summary_table
#### (END) age of items in the collection --------

#### 2) age of accessions in the collection --------
existing = report[report$ItemStatusType == 'Existing',]
existing = existing[match(unique(existing$AccNoFull), existing$AccNoFull),]
plant_age  = year_cur - existing$AccYear |> as.numeric()
max_age = max(plant_age)
ages = 0:max_age
all = table(plant_age) |> as.data.frame()
names(all) = c('Age', 'Freq')
AA = rep(0, length(ages)) ; AA[match(all$Age, ages)] = all$Freq ; all = AA

#table for cats
#table for cats
threatened = table(plant_age[existing$threatened == 'Threatened']) |> as.data.frame()
if(nrow(threatened) == 0){
  threatened = rep(0, length(ages))
}else{
  names(threatened) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(threatened$Age, ages)] = threatened$Freq ; threatened = AA
  
}

tree = table(plant_age[existing$tree == 'Tree']) |> as.data.frame()
if(nrow(tree) == 0){
  tree = rep(0, length(ages))
}else{
  names(tree) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(tree$Age, ages)] = tree$Freq ; tree = AA 
}

native = table(plant_age[existing$native == 'Native']) |> as.data.frame()
if(nrow(native) == 0){
  native = rep(0, length(ages))
}else{
  names(native) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(native$Age, ages)] = native$Freq ; native = AA
}

endemic = table(plant_age[existing$endemic == 'Endemic']) |> as.data.frame()
if(nrow(endemic) == 0){
  endemic = rep(0, length(ages))
}else{
  names(endemic) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(endemic$Age, ages)] = endemic$Freq ; endemic = AA
}

indet = table(plant_age[grep('0', existing$taxon_type)]) |> as.data.frame()
if(nrow(indet) == 0){
  indet = rep(0, length(ages))
}else{
  names(indet) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(indet$Age, ages)] = indet$Freq ; indet = AA
}

hort = table(plant_age[grep('5|6', existing$taxon_type)]) |> as.data.frame()
if(nrow(hort) == 0){
  hort = rep(0, length(ages))
}else{
  names(hort) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(hort$Age, ages)] = hort$Freq ; hort = AA
}

species = table(plant_age[!grepl('0|5|6|2|3|4', existing$taxon_type)]) |> as.data.frame()
if(nrow(species) == 0){
  species = rep(0, length(ages))
}else{
  names(species) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(species$Age, ages)] = species$Freq ; species = AA
}

infra = table(plant_age[!grepl('0|5|6', existing$taxon_type) & grepl('2|3|4', existing$taxon_type)]) |> as.data.frame()
if(nrow(infra) == 0){
  infra = rep(0, length(ages))
}else{
  names(infra) = c('Age', 'Freq')
  AA = rep(0, length(ages)) ; AA[match(infra$Age, ages)] = infra$Freq ; infra = AA
  
}

prov_values = unique(report$ProvenanceCode)
prov = lapply(prov_values, function(x){
  prov = table(plant_age[existing$ProvenanceCode == x]) |> as.data.frame()
  if(nrow(prov) == 0){ 
    prov = rep(0, length(ages))
  }else{
    names(prov) = c('Age', 'Freq')
    AA = rep(0, length(ages)) ; AA[match(prov$Age, ages)] = prov$Freq ; prov = AA
  }
  prov
}) |> data.frame()
names(prov) =prov_values
# combine
age_of_accessions = data.frame(ages = ages, all = all,
                          species = species, infraspecific = infra, horticultral = hort, indeterminate_taxa = indet,
                          prov,
                          threatened = threatened, endemic = endemic, native = native, tree = tree
                          )
names(age_of_accessions) = names(age_of_accessions) |>
  stringr::str_replace_all(pattern = '_', ' ') |>
  stringr::str_replace_all(pattern = '\\.', '-') |>
  stringr::str_to_sentence()

columns_names = names(age_of_accessions)[-1]
summary_table = lapply(columns_names, function(x){
  long = rep(age_of_accessions[['Ages']],age_of_accessions[[x]])
  c(mean(long), sd(long), quantile(long, probs = c(0,0.25,0.5,0.75,1))) |>  as.numeric() |> round(2)
}) |> data.frame() |> t() |> data.frame()
names(summary_table) = c('Mean', 'SD', 'Min', 'Q1', 'Median (Q2)', 'Q3', 'Max') 
row.names(summary_table) =columns_names 
summary_table_acc = summary_table
#### (END) age of accessions in the collection --------


```

```{r, sustain functions}
plot_single_age = function(age, count, data_type = 'items'){
  hover = paste0(count, ' ', data_type, ' in the collection are ', age, ' years old. (Accessioned in ',max_year - age,')')
  fig <- plot_ly(x = count, y = age, type = 'bar', orientation = 'h',
                 hoverinfo = 'text', hovertext = hover,
                 marker = list(color = interactive_colour(1))) |> 
    layout(xaxis = list(title = paste0('Number of ',data_type)),
           yaxis = list(title = paste0('Age (years)')),
           hovermode = 'y unified')
  fig
}
```

### Age of plants currently in the collection 

We first look at the age of existing items and accessions in the collection.

`r if(report_kind == 'interactive'){"##### {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Items"}`
```{r  Items age, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
age = age_of_items$Ages ; count = age_of_items$All
plot_single_age(age, count, 'items')
```

`r if(report_kind == 'interactive'){"###### Accessions"}`
```{r  Accessions trend - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
age = age_of_accessions$Ages ; count = age_of_accessions$All
plot_single_age(age, count, 'accessions')
```

`r if(report_kind == 'interactive'){"##### {-}"}`


The difference in plant age across plant characteristics is summarised in the table below

`r if(report_kind == 'interactive'){"##### {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Items"}`
```{r  Item age across charactistics, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
summary_table_item |>  DT::datatable(extensions = 'Buttons',
                  rownames = T,
                  options = list(scrollX = TRUE,
                                 # pageLength = min(nrow(show_table), 10),
                                 dom = 'Btp',
                                 buttons = c('copy', 'csv', 'excel', 'pdf'),
                                 paging=F,
                                 ordering=T),
                  filter = list(position = "top"))
```

`r if(report_kind == 'interactive'){"###### Accessions"}`
```{r  Accessions age across charactistics, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
summary_table_acc |>  DT::datatable(extensions = 'Buttons',
                  rownames = T,
                  options = list(scrollX = TRUE,
                                 # pageLength = min(nrow(show_table), 10),
                                 dom = 'Btp',
                                 buttons = c('copy', 'csv', 'excel', 'pdf'),
                                 paging=F,
                                 ordering=T),
                  filter = list(position = "top"))
```

`r if(report_kind == 'interactive'){"##### {-}"}`

***

### Survival in the collection

Rather than looking at the age of existing plants in the collection we now consider how long plants survive in the collection taking into account of all recorded plants in the collections history.

To determine how long a plant survives in the collection we use the date of the plants most recent update and whether the plant was noted to be alive or dead. All plants that were alive at their most recent check are assumed to be alive to the present day. For plants that are dead we take the most recent update date to be their date of death. 

In this section we shall begin by looking at survival curves across various plant characteristics in the collections followed by comparing the median survival times. 

```{r survival analysis}
#### Setup data for survival analysis ------

interest = report

if(!is.null(old_accession_year_codes)){
  has_old_accessions_code = which(interest$AccYear %in% old_accession_year_codes)
  no_old_accessions = length(has_old_accessions_code)
  interest$AccYear[has_old_accessions_code] = earliest_allowable_record
}

to_keep = which(as.numeric(interest$AccYear) >= earliest_allowable_record  & as.numeric(interest$AccYear) <= max_year)
still_issue = nrow(interest) - length(to_keep)
interest = interest[to_keep,]

do_survival = TRUE
enriched_report_wanted = interest[as.numeric(interest$AccYear) > 1650 & as.numeric(enriched_report$AccYear) < as.numeric(format(Sys.Date(),'%Y')),]
enriched_report_wanted = enriched_report_wanted[!is.na(enriched_report_wanted$ItemStatusDate),]
enriched_report_wanted = enriched_report_wanted[!is.na(enriched_report_wanted$AccYear),]

# Create a data-frame of the information we want.
wanted_data = enriched_report_wanted

if(nrow(wanted_data) == 0){
  do_survival = FALSE
}
if(do_survival){
  #Set accession date (just chose the first of June)
pre_date = rep(NA, length(wanted_data$AccYear))
pre_date = paste(wanted_data$AccYear, "06", "01", sep = "-")

# Convert ItemStatusDate into all dates (i.e if month or day missing add one)
post_date = rep(as.character(Sys.Date()), length(wanted_data$AccYear))
post_date[which(wanted_data$ItemStatusType == "NotExisting")] = as.character(wanted_data$ItemStatusDate[which(wanted_data$ItemStatusType == 
  "NotExisting")])

post_date[which(stringr::str_length(post_date) == 4)] = paste(post_date[which(stringr::str_length(post_date) == 
  4)], "12", "28", sep = "-")
post_date[which(stringr::str_length(post_date) == 7)] = paste(post_date[which(stringr::str_length(post_date) == 
  7)], "28", sep = "-")

# Create the time difference between accession and ItemStatusDate.
time = as.numeric(as.Date(post_date) - as.Date(pre_date)) /365.25

# Create status to tell whether the last item status date was item death or just a check.
status = rep(0,length(wanted_data$AccYear))
status[wanted_data$ItemStatusType == 'NotExisting'] = 1

wanted_data = data.frame(wanted_data, AccessionDate = pre_date,
                         StatusDate = post_date,
                         time = time,
                         Alive_dead = status)


# We haven't removed those with missing ItemStatusDate, these will most likely have negative time so remove these.
missing_itemstatusdate_index = which(wanted_data$time > 0)
status_year = wanted_data$ItemStatusDate |> stringr::str_extract('^[0-9]{4}') |> unlist() |> as.numeric()
status_before_current_year = which(status_year <= format(Sys.Date(),'%Y') |> as.numeric() )
to_keep = intersect(missing_itemstatusdate_index,status_before_current_year)
wanted_data = wanted_data[to_keep,]

enriched_report_wanted = enriched_report_wanted[to_keep,]

# missing_itemstatusdate_index = which(wanted_data$time > 0)
# wanted_data = wanted_data[missing_itemstatusdate_index,]
# enriched_report_wanted = enriched_report_wanted[missing_itemstatusdate_index,]


data_to_analyse = wanted_data

}
#### (END) Setup data for survival analysis ------

library(gtsummary)

median_vals = list() ; surv_percent_vals = list()
### Run survival fits across groups that we care about ------
fit_all = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1, data = data_to_analyse)
median_vals$items = fit_all |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$items = fit_all |> gtsummary::tbl_survfit(times = c(5,10,20))

fit_all$surv = fit_all$surv*100
fit_all$hover = paste0('Time: ',fit_all$time |> round(2),'<br>Items survival Probability: ', (fit_all$surv) |> round(2), '% <br> 95% conf interval: (',(fit_all$lower*100) |> round(2),  '%, ', (fit_all$upper*100) |> round(2),'%)')

data_acc = data_to_analyse
data_acc$ItemStatusDate[which(data_acc$ItemStatusType == 'Existing')] = '3000-01-01'
data_acc = data_acc[order(data_acc$ItemStatusDate,decreasing = T),]
data_acc = data_acc[match(unique(data_acc$AccNoFull), data_acc$AccNoFull),]
fit_accessions = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1, data = data_acc)
median_vals$accessions = fit_accessions |> 
    gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$accessions = fit_accessions |> gtsummary::tbl_survfit(times = c(5,10,20))

fit_accessions$surv = fit_accessions$surv*100
fit_accessions$hover = paste0('Time: ',fit_accessions$time |> round(2),'<br>Accessions survival Probability: ', (fit_accessions$surv) |> round(2), '% <br> 95% conf interval: (',(fit_accessions$lower*100) |> round(2),  '%, ', (fit_accessions$upper*100) |> round(2),'%)')

d = data_to_analyse[which(!grepl('0|2|3|4|5|6',data_to_analyse$taxon_type)),]
if(nrow(d) > 0){
  fit_species = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$species = fit_species |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$species = fit_species |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_species$surv = fit_species$surv*100
fit_species$hover = paste0('Time: ',fit_species$time|> round(2),'<br>Species survival Probability: ', (fit_species$surv) |> round(2), '% <br> 95% conf interval: (',(fit_species$lower*100) |> round(2),  '%, ', (fit_species$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(!grepl('0|5|6', data_to_analyse$taxon_type) & grepl('2|3|4', data_to_analyse$taxon_type)),]
if(nrow(d) > 0){
fit_infra = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$infra = fit_infra |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$infra = fit_infra |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_infra$surv = fit_infra$surv*100
fit_infra$hover = paste0('Time: ',fit_infra$time|> round(2),'<br>Infraspecific survival Probability: ', (fit_infra$surv) |> round(2), '% <br> 95% conf interval: (',(fit_infra$lower*100) |> round(2),  '%, ', (fit_infra$upper*100) |> round(2),'%)')
}

d = data_to_analyse[grep('5|6',data_to_analyse$taxon_type),]
if(nrow(d) > 0){
fit_hort = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$hort = fit_hort |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$hort = fit_hort |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_hort$surv = fit_hort$surv*100
fit_hort$hover = paste0('Time: ',fit_hort$time|> round(2),'<br>Horticultral survival Probability: ', (fit_hort$surv) |> round(2), '% <br> 95% conf interval: (',(fit_hort$lower*100) |> round(2),  '%, ', (fit_hort$upper*100) |> round(2),'%)')
}

d = data_to_analyse[grep('0',data_to_analyse$taxon_type),]
if(nrow(d) > 0){
fit_indet = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$indet = fit_indet |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$indet = fit_indet |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_indet$surv = fit_indet$surv*100
fit_indet$hover = paste0('Time: ',fit_indet$time|> round(2),'<br>Indeterminate survival Probability: ', (fit_indet$surv) |> round(2), '% <br> 95% conf interval: (',(fit_indet$lower*100) |> round(2),  '%, ', (fit_indet$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$ProvenanceCode == 'Garden'),]
if(nrow(d) > 0){
fit_garden = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$garden = fit_garden |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$garden = fit_garden |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_garden$surv = fit_garden$surv*100
fit_garden$hover = paste0('Time: ',fit_garden$time|> round(2),'<br>Garden origin survival Probability: ', (fit_garden$surv) |> round(2), '% <br> 95% conf interval: (',(fit_garden$lower*100) |> round(2),  '%, ', (fit_garden$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$ProvenanceCode == 'Wild'),]
if(nrow(d) > 0){
fit_wild = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$wild = fit_wild |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$wild = fit_wild |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_wild$surv = fit_wild$surv*100
fit_wild$hover = paste0('Time: ',fit_wild$time|> round(2),'<br>Wild origin survival Probability: ', (fit_wild$surv) |> round(2), '% <br> 95% conf interval: (',(fit_wild$lower*100) |> round(2),  '%, ', (fit_wild$upper*100) |> round(2),'%)')
}


d = data_to_analyse[which(data_to_analyse$ProvenanceCode == 'Wild-derived'),]
if(nrow(d) > 0){
  fit_z = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
  median_vals$z = fit_z |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
    surv_percent_vals$z = fit_z |> gtsummary::tbl_survfit(times = c(5,10,20))

fit_z$surv = fit_z$surv*100
fit_z$hover = paste0('Time: ',fit_z$time|> round(2),'<br>Wild-derived origin survival Probability: ', (fit_z$surv) |> round(2), '% <br> 95% conf interval: (',(fit_z$lower*100) |> round(2),  '%, ', (fit_z$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$ProvenanceCode == 'Unknown'),]
if(nrow(d) > 0){
  fit_unknown = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
  median_vals$unknown = fit_unknown |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
  surv_percent_vals$unknown = fit_unknown |> gtsummary::tbl_survfit(times = c(5,10,20))

fit_unknown$surv = fit_unknown$surv*100
fit_unknown$hover = paste0('Time: ',fit_unknown$time|> round(2),'<br>Unknown origin survival Probability: ', (fit_unknown$surv) |> round(2), '% <br> 95% conf interval: (',(fit_unknown$lower*100) |> round(2),  '%, ', (fit_unknown$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$native == 'Native'),]
if(nrow(d) > 0){
fit_native= ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                                data = d)
median_vals$native = fit_native |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$native = fit_native |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_native$surv = fit_native$surv*100
fit_native$hover = paste0('Time: ',fit_native$time|> round(2),'<br>Native survival Probability: ', (fit_native$surv) |> round(2), '% <br> 95% conf interval: (',(fit_native$lower*100) |> round(2),  '%, ', (fit_native$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$endemic == 'Endemic'),]
if(nrow(d) > 0){
fit_endemic= ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                                 data = d)
median_vals$endemic = fit_endemic |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$endemic = fit_endemic |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_endemic$surv = fit_endemic$surv*100
fit_endemic$hover = paste0('Time: ',fit_endemic$time|> round(2),'<br>Endemic survival Probability: ', (fit_endemic$surv) |> round(2), '% <br> 95% conf interval: (',(fit_endemic$lower*100) |> round(2),  '%, ', (fit_endemic$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$threatened == 'Threatened'),]
if(nrow(d) > 0){
fit_threatened= ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                                    data = d)
median_vals$threatened = fit_threatened |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$threatened = fit_threatened |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_threatened$surv = fit_threatened$surv*100
fit_threatened$hover = paste0('Time: ',fit_threatened$time|> round(2),'<br>Threatened survival Probability: ', (fit_threatened$surv) |> round(2), '% <br> 95% conf interval: (',(fit_threatened$lower*100) |> round(2),  '%, ', (fit_threatened$upper*100) |> round(2),'%)')
}

d = data_to_analyse[which(data_to_analyse$tree == 'Tree'),]
if(nrow(d) > 0){
fit_tree = ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ 1,
                              data = d)
median_vals$tree = fit_tree |> gtsummary::tbl_survfit(probs = c(0.5),  label_header = "**Median survival (95% CI)**")
surv_percent_vals$tree = fit_tree |> gtsummary::tbl_survfit(times = c(5,10,20))
fit_tree$surv = fit_tree$surv*100
fit_tree$hover = paste0('Time: ',fit_tree$time|> round(2),'<br>Tree survival Probability: ', (fit_tree$surv) |> round(2), '% <br> 95% conf interval: (',(fit_tree$lower*100) |> round(2),  '%, ', (fit_tree$upper*100) |> round(2),'%)')
}



### Run survival fits across groups that we care about ------
median_vals <<- median_vals
surv_percent_vals <<- surv_percent_vals
survival_table = lapply(names(median_vals), function(x){
  tb = median_vals[[x]]
  median = tb$table_body[1,5] |> as.character() #|> stringr::str_extract_all('[0-9]{1,3}') |> unlist() |> as.numeric()
  tb = surv_percent_vals[[x]]
  surv_prob = tb$table_body[1,5:7] |> as.character()
  return(c(x |> stringr::str_to_sentence(), median, surv_prob))
  }) |> data.frame() |> t() |> data.frame()
names(survival_table) = c('Characteristic', 'Median survival in years (95% CI)',
                          '5-year survival % (95% CI)',
                          '10-year survival % (95% CI)',
                          '20-year survival % (95% CI)')
rownames(survival_table) = 1:nrow(survival_table)
survival_table$Characteristic  = dplyr::case_match(survival_table$Characteristic,
                                                   'Hort' ~ 'Horticultral',
                                                   'Indet' ~ 'Indeterminate',
                                                   'Z' ~ 'Wild-derived',
                                                   "Infra" ~ 'Infraspecific',
                                                   .default = survival_table$Characteristic)
```

First we look at the survival time of the entire collection across varying metrics (where we look at survival across items unless specified otherwise in the whole collection)

##### Whole collection

```{r, items and accessions survival times, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
colors = interactive_colour(4)[1:2]

fig = plot_ly(data = data.frame(), type = 'scatter', mode = 'lines', x = fit_all$time, y = fit_all$surv, name = 'Items', hoverinfo = "text",  hovertext = fit_all$hover, line = list(color = colors[1]), visable = FALSE )
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_accessions$time, y = fit_accessions$surv, name = 'Accessions', hoverinfo = "text",  hovertext = fit_accessions$hover, line = list(color = colors[2]))

fig <- fig |> layout(title = "",
                     hovermode = 'xt unified',
         xaxis = list(title = "Years", showspikes=T, spikemode="across"),
         yaxis = list (title = "Survival probability", showspikes=T,  spikemode="across")
         )

hline <- function(y = 0, color = rgb(0,0,0,alpha=0.4)) {
  list(
    type = "line",
    x0 = 0,
    x1 = 1,
    xref = "paper",
    y0 = y,
    y1 = y,
    line = list(color = color, dash="dot")
  )
}
fig = fig |>
  layout(shapes = list(hline(50))) |> add_text(showlegend = FALSE, x = max(fit_accessions$time) *0.8, y = 50,
           text = c("median survival"))
fig
```

##### Type of plant

```{r, type of plant survival times, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
colors = scales::brewer_pal(palette = palette, direction = 1)(4)

fig = plot_ly(data = data.frame(), type = 'scatter', mode = 'lines', x = fit_species$time, y = fit_species$surv, name = 'Species', hoverinfo = "text",  hovertext = fit_species$hover, line = list(color = colors[1]))
if(exists("fit_infra")){
  fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_infra$time, y = fit_infra$surv, name = 'Infraspecific', hoverinfo = "text",  hovertext = fit_infra$hover, line = list(color = colors[2]))
}

if(exists("fit_hort")){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_hort$time, y = fit_hort$surv, name = 'Horticultral', hoverinfo = "text",  hovertext = fit_hort$hover, line = list(color = colors[3]))
}

if(exists("fit_indet")){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_indet$time, y = fit_indet$surv, name = 'Indeterminate', hoverinfo = "text",  hovertext = fit_indet$hover, line = list(color = colors[4]))
}

fig <- fig |> layout(title = "",
                     hovermode = 'xt unified',
         xaxis = list(title = "Years", showspikes=T, spikemode="across"),
         yaxis = list (title = "Survival probability", showspikes=T,  spikemode="across")
         )

hline <- function(y = 0, color = rgb(0,0,0,alpha=0.4)) {
  list(
    type = "line",
    x0 = 0,
    x1 = 1,
    xref = "paper",
    y0 = y,
    y1 = y,
    line = list(color = color, dash="dot")
  )
}
fig = fig |>
  layout(shapes = list(hline(50))) |> add_text(showlegend = FALSE, x = max(fit_species$time) *0.8, y = 50,
           text = c("median survival"))
fig

```

##### Provenance

```{r, provenance survival times, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
colors = interactive_colour(4)
names(colors) = c('Wild', 'Wild-derived', 'Garden', 'Unknown')

fig = plot_ly(data = data.frame(), type = 'scatter', mode = 'lines')

if(exists("fit_garden")){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_garden$time, y = fit_garden$surv, name = 'Wild', hoverinfo = "text",  hovertext = fit_garden$hover, line = list(color = colors[['Garden']]))
}

if(exists("fit_wild")){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_wild$time, y = fit_wild$surv, name = 'Wild', hoverinfo = "text",  hovertext = fit_wild$hover, line = list(color = colors[['Wild']]))
}

if(exists('fit_z')){
  fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_z$time, y = fit_z$surv, name = 'Wild-derived', hoverinfo = "text",  hovertext = fit_z$hover, line = list(color = colors[['Wild-derived']]))
}

if(exists('fit_unknown')){
  fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_unknown$time, y = fit_unknown$surv, name = 'Unknown', hoverinfo = "text",  hovertext = fit_unknown$hover, line = list(color = colors[['Unknown']]))
}

fig <- fig |> layout(title = "",
                     hovermode = 'xt unified',
         xaxis = list(title = "Years", showspikes=T, spikemode="across"),
         yaxis = list (title = "Survival probability", showspikes=T,  spikemode="across")
         )

hline <- function(y = 0, color = rgb(0,0,0,alpha=0.4)) {
  list(
    type = "line",
    x0 = 0,
    x1 = 1,
    xref = "paper",
    y0 = y,
    y1 = y,
    line = list(color = color, dash="dot")
  )
}
fig = fig |>
  layout(shapes = list(hline(50))) |> add_text(showlegend = FALSE, x = max(fit_species$time) *0.8, y = 50,
           text = c("median survival"))
fig
```

##### Key collections 

```{r, key collections survival times, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
colors = scales::brewer_pal(palette = palette, direction = 1)(5)

fig = plot_ly(data = data.frame(), type = 'scatter', mode = 'lines', x = fit_all$time, y = fit_all$surv, name = 'All', hoverinfo = "text",  hovertext = fit_all$hover, line = list(color = colors[1]), visable = FALSE )

if(exists('fit_native')){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_native$time, y = fit_native$surv, name = 'Native', hoverinfo = "text",  hovertext = fit_native$hover, line = list(color = colors[2]))
}

if(exists('fit_endemic')){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_endemic$time, y = fit_endemic$surv, name = 'Endemic', hoverinfo = "text",  hovertext = fit_endemic$hover, line = list(color = colors[3]))
}

if(exists('fit_threatened')){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_threatened$time, y = fit_threatened$surv, name = 'Threatened', hoverinfo = "text",  hovertext = fit_threatened$hover, line = list(color = colors[4]))
}

if(exists('fit_tree')){
fig = fig |> add_trace(inherit = FALSE, type = 'scatter', mode = 'lines',
            x = fit_tree$time, y = fit_tree$surv, name = 'Tree', hoverinfo = "text",  hovertext = fit_tree$hover, line = list(color = colors[5]))
}

fig <- fig |> layout(title = "",
                     hovermode = 'xt unified',
         xaxis = list(title = "Years", showspikes=T, spikemode="across"),
         yaxis = list (title = "Survival probability", showspikes=T,  spikemode="across")
         )

hline <- function(y = 0, color = rgb(0,0,0,alpha=0.4)) {
  list(
    type = "line",
    x0 = 0,
    x1 = 1,
    xref = "paper",
    y0 = y,
    y1 = y,
    line = list(color = color, dash="dot")
  )
}
fig = fig |>
  layout(shapes = list(hline(50))) |> add_text(showlegend = FALSE, x = max(fit_all$time) *0.8, y = 50,
           text = c("median survival"))
fig

```


```{r median survival times}
survival_table |>  DT::datatable(extensions = 'Buttons',
                  rownames = FALSE,
                  options = list(scrollX = TRUE,
                                 pageLength = nrow(survival_table),
                                 dom = 'Btp',
                                 buttons = c('copy', 'csv', 'excel', 'pdf'),
                                 paging=F,
                                 ordering=F))
```

***

### Gain and loss of species to the collection

In this section we only consider plants that were successfully matched to POWO.

Here we investigate the gain of plants that were not in the collection in the previous year and the loss of plants that causes the species to no longer be represented in the living collection.


```{r, gain new/unique plants POWO only}
# First need to create a list of taxonomic names that were in the LC each previous year
report_cur = report[!is.na(report$POWO_plant_name_id),]
existing_items = BGSmartR::exist_at_date(date = paste0(years-1,'-12-31'),
                                         AccessionYear = report_cur$AccYear,
                                         ItemStatusDate = report_cur$ItemStatusDate,
                                         ItemStatusType = report_cur$ItemStatusType,
                                         post_date = '3000-01-01')

taxonomic_names_in_LC_years = lapply(existing_items, function(x){
  data_cur = report_cur$best_name[x]
  return(unique(data_cur))
})

names(taxonomic_names_in_LC_years) = paste0('plants_previous_year_to_',years)
new_to_collection = unlist(lapply(years, function(x){
  plants_accessioned = unique(report_cur$best_name[which(report_cur$AccYear == x)])
  previous_plants = taxonomic_names_in_LC_years[[which(grepl(x,names(taxonomic_names_in_LC_years)))]]
  sum(!plants_accessioned %in% previous_plants)
}))
total_taxonomic_names = unlist(lapply(years, function(x){
  plants_accessioned = report_cur$best_name[report_cur$AccYear == x]
  length(unique(plants_accessioned))
}))

prop_new_collection = new_to_collection*100 /total_taxonomic_names
prop_new_collection[is.nan(prop_new_collection)] = NA

plot_data = data.frame(years, new_to_collection, total_taxonomic_names, prop_new_collection)
exporting_data_store$gained_taxa_with_new_to_LC_without_cult_or_indet = plot_data


plot_data_formatted = rbind(data.frame(year = plot_data$years, taxa = plot_data$new_to_collection, prop = plot_data$prop_new_collection, fill = rep('Yes',nrow(plot_data)) ),
                            data.frame(year = plot_data$years, taxa = plot_data$total_taxonomic_names -  plot_data$new_to_collection, prop = 100 - plot_data$prop_new_collection, fill = rep('No',nrow(plot_data)) )
)
plot_data_formatted$fill = factor(plot_data_formatted$fill, levels = c('Yes', 'No'))


  # plot_data_formatted$text = paste0(round(stacked_bar_data$no_accessions,digits = 2), ' accessions have ', stacked_bar_data$total_items, ' items')

  fig <- plot_ly(plot_data_formatted, x = ~year, y = ~taxa, color = ~fill, colors = interactive_colour(2), type = 'bar')
  fig <- fig |> layout(yaxis = list(title = 'Number of Taxa'),
                       xaxis = list(title = "Year"),
                       legend=list(title=list(text='New to collection?')),
                       barmode = 'stack')
  fig <- fig |> layout(hovermode = 'x unified', bargap =0)
  fig1 = fig

  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-Turnover_new_to_LC_gained_number_without_cult_indet.html'))
  }

  fig <- plot_ly(plot_data_formatted, x = ~year, y = ~prop, color = ~fill, colors = interactive_colour(2), type = 'bar')
  fig <- fig |> layout(yaxis = list(title = 'Percentage'),
                       xaxis = list(title = "Year"),
                       legend=list(title=list(text='New to collection?')),
                       barmode = 'stack')
  fig <- fig |> layout(hovermode = 'x unified', bargap =0)

  fig2 = fig

  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-Turnover_new_to_LC_gained_percentage_without_cult_indet.html'))
  }
  gained_new_taxa_without_cult_indet = list(number = fig1, percentage = fig2)

```

Below we show the number of gained taxa each year (where we count taxa by unique taxonomic name and author), and show how many of the gained taxa are new to the living collection.

`r if(report_kind == 'interactive'){"#####  Gained Taxa and whether the taxa is new to the living collection {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number of taxa"}`
```{r  number gained taxa are new without cult or indet - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
gained_new_taxa_without_cult_indet$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  percentage gained taxa are new without cult or indet - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
gained_new_taxa_without_cult_indet$percentage
```

`r if(report_kind == 'interactive'){"##### {-}"}`


```{r, loss unique plants powo only}
report_cur = report[!is.na(report$POWO_plant_name_id),]

# First need to create a list of taxonomic names that were in the LC at the end of the year.
existing_items = BGSmartR::exist_at_date(date = paste0(years,'-12-31'),
                                         AccessionYear = report_cur$AccYear,
                                         ItemStatusDate = report_cur$ItemStatusDate,
                                         ItemStatusType = report_cur$ItemStatusType,
                                         post_date = '3000-01-01')

taxonomic_names_in_LC_years = lapply(existing_items, function(x){
  data_cur = report_cur$best_name[x]
  return(unique(data_cur))
})

names(taxonomic_names_in_LC_years) = paste0('plants_at_end_of_year_',years)

lost_to_the_collection = unlist(lapply(years, function(x){
  plants_lost = unique(report_cur$best_name[which(report_cur$LossYear == x)])
  in_LC_end_year = taxonomic_names_in_LC_years[[which(grepl(x,names(taxonomic_names_in_LC_years)))]]
  sum(!plants_lost %in% in_LC_end_year)
}))

total_taxonomic_names = unlist(lapply(years, function(x){
  plants_lost = report_cur$best_name[which(report_cur$LossYear == x)]
  length(unique(plants_lost))
}))

prop_lost_unique = lost_to_the_collection*100 /total_taxonomic_names
prop_lost_unique[is.nan(prop_lost_unique)] = NA

plot_data = data.frame(years, lost_to_the_collection, total_taxonomic_names, prop_lost_unique)
exporting_data_store$lost_taxa_with_lost_to_LC_without_cult_or_indet = plot_data

plot_data_formatted = rbind(data.frame(year = plot_data$years, taxa = plot_data$lost_to_the_collection, prop = plot_data$prop_lost_unique, fill = rep('Yes',nrow(plot_data)) ),
                            data.frame(year = plot_data$years, taxa = plot_data$total_taxonomic_names -  plot_data$lost_to_the_collection, prop = 100 - plot_data$prop_lost_unique, fill = rep('No',nrow(plot_data)) )
)
plot_data_formatted$fill = factor(plot_data_formatted$fill, levels = c('Yes', 'No'))
  # plot_data_formatted$text = paste0(round(stacked_bar_data$no_accessions,digits = 2), ' accessions have ', stacked_bar_data$total_items, ' items')

  fig <- plot_ly(plot_data_formatted, x = ~year, y = ~taxa, color = ~fill, colors = interactive_colour(2), type = 'bar')
  fig <- fig |> layout(yaxis = list(title = 'Number of Taxa'),
                       xaxis = list(title = "Year"),
                       legend=list(title=list(text='No longer represented?')),
                       barmode = 'stack')
  fig <- fig |> layout(hovermode = 'x unified', bargap =0)
  fig1 = fig

  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-Turnover_loss_to_LC_unique_number_without_cult_indet.html'))
  }

  fig <- plot_ly(plot_data_formatted, x = ~year, y = ~prop, color = ~fill, colors = interactive_colour(2), type = 'bar')
  fig <- fig |> layout(yaxis = list(title = 'Percentage'),
                       xaxis = list(title = "Year"),
                       legend=list(title=list(text='No longer represented?')),
                       barmode = 'stack')
  fig <- fig |> layout(hovermode = 'x unified', bargap =0)

  fig2 = fig

  if(separate_figure_folder){
    htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-Turnover_loss_to_LC_unique_percentage_without_cult_indet.html'))
  }
  loss_unique_taxa_without_cult_indet = list(number = fig1, percentage = fig2)

```

<!-- Next up we consider the loss of taxa from the living collection each year. In the following graphs we show the total number of taxa which have loss. Moreover, we group the taxa into those that are no longer represented in the living collection and those that are at the end of the year. For example a taxa will be classed as 'No longer represented in the living collection' if during the year the taxa has experienced loss (plant removal/death) and on the 31st of December that year the taxa is no longer represented in the garden. This method does therefore class taxa which are not in th living collection for a period of the year to be still represented in the living collection as long as the taxa is reintroduced by the 31st of December. -->

Next up we consider the loss of taxa from the living collection each year.

`r if(report_kind == 'interactive'){"#####  Lost taxa and whether they are still represented in the living collection {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Number of Taxa"}`
```{r  number lost taxa are new without cult or indet - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
loss_unique_taxa_without_cult_indet$number
```

`r if(report_kind == 'interactive'){"###### Proportion"}`
```{r  percentage lost taxa are new without cult or indet - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
loss_unique_taxa_without_cult_indet$percentage
```

`r if(report_kind == 'interactive'){"##### {-}"}`

```{r, get WCVP plants that were in the LC but no more}
do_no_more_ids = TRUE
df = report[which(!is.na(report$POWO_plant_name_id)),]
df = df[which(df$ItemStatusType%in% c("NotExisting", "Existing")),]

df = df[which(df$threatened == "Threatened"),]
df$AccYear = df$AccYear |> as.numeric()
# df = df[which(!is.na(df$LossYear)),]

all_ids =  df$POWO_plant_name_id |> unique()
existing_ids = df$POWO_plant_name_id[which(df$ItemStatusType == 'Existing')] |> unique()
no_more_ids = all_ids[!all_ids %in% existing_ids]
no_more_info = data.frame(1,2,3,4,5,6,7,8,0)
names(no_more_info) = c('Taxa', 'Last year in collection', 'Total years in collection', 'Presence history', 'Threatened', 'Threatened category', 'Endemic', 'Naive', 'Tree')
no_more_info = no_more_info[FALSE,]
if(length(no_more_ids) > 0){
  column_interest = match(c('AccYear', 'LossYear', 'threatened', 'threatened_category', 'endemic', 'tree', 'native'), names(df))
  
  
no_more_info = pbapply::pblapply(no_more_ids, function(x){
  plant = df[which(df$POWO_plant_name_id == x), match(c("POWO_taxon_name", "POWO_taxon_authors"), names(df))][1,] |> paste0(collapse = ' ')
  info = df[df$POWO_plant_name_id == x, column_interest]
  
  if(all(is.na(info$LossYear) )){
    threat = info$threatened[1] ; threat_cat = info$threatened_category[1]
  endemic = info$endemic[1] ; tree = info$tree[1] ; nativeo = info$native[1]
    return(c(plant, NA, NA, NA, threat, threat_cat, endemic, nativeo, tree))
  }
  
  last_seen = max(info$LossYear, na.rm = T) ; first_seen = min(info$AccYear,na.rm = T)
  all_years = first_seen:last_seen
  seen_years = apply(info, 1, function(x){
    y = x[1:2] 
    if (any(is.na(y))){return(NULL)}
    return(x[1]:x[2])
    }) |> unlist() |> unique() |> sort()
  has_year = all_years %in% seen_years
  total_years = sum(has_year)
  consec = split(which(has_year),cumsum(c(1,diff(which(has_year))!=1)))
  
   mess = ''
  for(ii in 1:length(consec)){
    mess = 
    paste0(mess,all_years[min(consec[[ii]])], '-', all_years[max(max(consec[[ii]]), 1)], ', ' )
  }
  mess <- stringr::str_remove(mess,', $')
  
  # characteristics.
  threat = info$threatened[1] ; threat_cat = info$threatened_category[1]
  endemic = info$endemic[1] ; tree = info$tree[1] ; nativeo = info$native[1]
  return(c(plant, last_seen, total_years, mess, threat, threat_cat, endemic, nativeo, tree))
}) |> data.frame() |> t() |> data.frame()
names(no_more_info) = c('Taxa', 'Last year in collection', 'Total years in collection', 'Presence history', 'Threatened', 'Threatened category', 'Endemic', 'Naive', 'Tree')
rownames(no_more_info) = 1:nrow(no_more_info)
no_more_info$`Total years in collection` = no_more_info$`Total years in collection` |> as.numeric()
no_more_info$`Last year in collection` = no_more_info$`Last year in collection` |> as.numeric()

}
if(length(no_more_ids) == 0){no_more_info = data.frame() ; do_no_more_ids = FALSE}

```

:::: {.blackbox data-latex=""}

`r if(do_no_more_ids){"To download all plants (found within POWO) that are no longer found in the collection together with their history in the collection use the button below"}`

`r if(!do_no_more_ids){"All plants that are found in the collection. "}`

```{r link to download plants from missing endemic regions, eval = report_kind == 'interactive' & do_no_more_ids}
  no_more_info |>
  download_this(
    output_name = "collection_history_of_plants_no_longer_present_WCVP",
    output_extension = ".xlsx",
    button_label = "Download collection history of plants no longer present (xlsx)",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save",
    class = "hvr-sweep-to-left",
    self_contained = T
  )
```

::::

***
