---
title: "Overview of key taxa in the collection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(plotly)
require(rjson)
require(BGSmartR)
```

```{r, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - min_year for retrospective reports.
# - collection the name to be printed in the report.


report = enriched_report

if(is.null(min_year)){
  min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
}
```


```{r, echo=F}
report$endemic = rep(FALSE, nrow(report))
endemic_index = which(stringr::str_length(report$POWO_Dist_area_code_l3) ==3)
report$endemic[endemic_index] = TRUE
```

This report uses data from `r collection`. 

We explore the key taxa from the gardens collection in two ways:

- Endemics.
- Red list status.

***

## Endemics

```{r, echo = F}
no_records = nrow(report)
table_full = table(report$infrageneric_level)

in_POWO = which(!is.na(report$POWO_web_address))
no_records_POWO = nrow(report[in_POWO,])
table_POWO = table(report[in_POWO,]$infrageneric_level)

```

A taxa in the collection is classed as **endemic** if it is native to a single BRU level 3 area. Therefore, we need geographic information to quantify if a taxa is endemic. We extract geographic information using [Plants of the World Online](https://powo.science.kew.org) (POWO).

Of the `r format(no_records,big.mark=',')` records in your collection `r format(no_records_POWO,big.mark=',')` of them have geographic information extracted from POWO.

###  Geography of the endemic taxa in the collection

```{r, echo = F, eval = T,  fig.dim = c(10, 8)}
# reduce to only those records that are endemic.
re = report[report$endemic,]
re$good_name = paste0(re$sanitised_taxon, ' ', re$extracted_author)

# load all geo areas
wgsrpd3 = BGSmartR::wgsrpd3

details = data.frame(name = wgsrpd3$LEVEL3_NAM, code = wgsrpd3$LEVEL3_COD)
plants = rep('', nrow(details))
no_plants = rep(NA,nrow(details))
no_unique_plants = rep(NA,nrow(details))
plant_ex = rep('',nrow(details))
for(i in 1:length(details$code)){
  index = grepl(pattern = details$code[i], x = re$POWO_Dist_area_code_l3) 
  if(any(index)){
    plants[i] = paste0(unique(re$good_name[index]), collapse =', ')
    plant_ex[i] = unique(re$good_name[index])[1]
    no_plants[i] = sum(index)
    no_unique_plants[i] = length(unique(re$good_name[index]))
  }
}

details = data.frame(details, plants = plants, plant_ex = plant_ex,  no_plants = no_plants, no_unique_plants = no_unique_plants)

text = paste0('Region: ', details$name, '<br />', 
              'Number of plants: ', details$no_plants,  '<br />',
              'Unique plants: ', details$no_unique_plants,  '<br />',
              'Plant: ', details$plant_ex)
details$hover = text

# Convert geometry into a format accepted by plotly
mapp = sf::st_cast(wgsrpd3, "MULTIPOLYGON")
geo_sf = geojsonsf::sf_geojson(mapp)
data = rjson::fromJSON(geo_sf)
feat = data$features
for(i in 1:length(feat)){
  feat[[i]]$id = feat[[i]]$properties$LEVEL3_COD
}
data$features = feat

# geo styling
g <- list(
  scope = 'world',
  showland = TRUE,
  landcolor = toRGB("White"),
  showocean = TRUE,
  oceancolor = toRGB("LightBlue"),
  showcountries = F,
  lonaxis = list(showgrid = T),
  lataxis = list(showgrid = T)
)
fig <- plot_ly()
fig <- fig %>% add_trace(
  type="choropleth",
  geojson=data,
  locations=details$code,
  text = details$hover,
  hoverinfo = 'text',
  z=details$no_unique_plants,
  colorscale="Viridis",
  zmin=0,
  zmax=max(details$no_unique_plants),
  marker=list(line=list(
    width=0)
  )
)
fig <- fig %>% colorbar(title = "Number of Unique Plants")


fig <- fig %>% layout(
  geo = g
)

fig <- fig   %>% config(modeBarButtonsToRemove = c("select2d", "lasso2d"))

fig
```

Hover over regions for:

- Name of the `Region`.
- `Number of plants` in the collection that are endemic to the region.
- Number of `unique plants` in the collection that are endemic to the region.
- A single plant from the collection that is endemic to the region. 

***

### Retrospective overview of endemic taxa in the collection

```{r, echo = F}
# Get the earliest year for retrospective oveview.
# min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
date = paste0(min_year:2023, '-01-01')

# Use the whole dataset.
# Do we want to restrict to only those with geographic information.
dataset = report

result = BGSmartR::exist_at_date(date, acc = dataset$AccYear,
                       ItemStatusDate = dataset$ItemStatusDate,
                       ItemStatusType = dataset$ItemStatusType)

time_series_info = lapply(result, function(x){
  garden_current = dataset[x,]
  # Breakdown of endemic.
  breakdown_endemic = table(garden_current$endemic)
  
  return(list(breakdown_endemic = breakdown_endemic))
})
names(time_series_info) = names(result)
```

This section reviews the garden's collection over time. The first record in the garden comes from `r min_year -1` therefore we will take snapshots (existing plants) of the garden's collection on the 1st of January every year from `r min_year` to 2023.

Note that here we consider all the plants in the collection in a given year. Records that could not be matched to POWO are assumed to be widespread.

```{r, echo = F}
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_endemic
  
  endemic = sum(as.numeric(details[grepl('T',names(details))]))
  widespread = sum(as.numeric(details[grepl('F',names(details))]))

  return(c(endemic, widespread))
  }))))
names(no_items) = c('endemic', 'widespread')
prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
data = data.frame(year = as.numeric(stringr::str_extract(rownames(no_items),'[0-9]{4}')), no_items, prop)
```

#### Number of endemic taxa over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~endemic, name = 'Endemic', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~widespread, name = 'Widespread', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

#### Proportion of endemic taxa over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~endemic_prop, name = 'Endemic', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~widespread_prop, name = 'Widespread', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified', yaxis = list(ticksuffix = '%'))
fig
```

***


#### Proportion of endemic taxa over time (stacked)


```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
fig <- plot_ly(data, x = ~year, mode = 'none', stackgroup = 'one') 
fig <- fig %>% add_trace(y = ~endemic_prop, name = 'Endemic', type = 'scatter', fillcolor = 'red') 
fig <- fig %>% add_trace(y = ~widespread_prop, name = 'Widespread', type = 'scatter', fillcolor = 'yellow') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified', yaxis = list(ticksuffix = '%'))
fig
```

***

## Red list status

```{r, echo = F}
no_records = nrow(report)

in_redlist = which(!is.na(report$redList_authority))
no_records_redlist = nrow(report[in_redlist,])
```

A taxa in the collection has a red list status if we are able to match the record to [IUCN red list database](https://www.iucnredlist.org). 

Due to discrepancies between taxonomic naming between POWO and IUCN there are a minority of clashes between the two databases. Therefore, BGSmartR provide two methods to enrich the red list status. However, in this report we use the method:

- Match taxa directly to IUCN. 
<!-- - Match taxa to accepted name in POWO, then match the accepted name to IUCN.  -->

Of the `r format(no_records,big.mark=',')` records in your collection `r format(no_records_redlist,big.mark=',')` were enriched with IUCN red list information.

***

### Current overview of red list status in the collection 

```{r,echo=F}
# Reduce to plants that are threatened.
re = report[which(report$ItemStatusType == 'Existing'),]
re$good_name = paste0(re$sanitised_taxon, ' ', re$extracted_author)
```

#### Summary of red list status

The number of individual plants in the collection within a threatened red list status. 

```{r, echo=F, fig.dim = c(10, 4)}
data_cur = table(re$redList_category)
category = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')
number = as.numeric(data_cur[match(c('VU', 'EN','CR','EW', 'EX'), names(data_cur))])
d = data.frame(category = category, total_plants = number)
fig <- plot_ly(d,
  x = ~category,
  y = ~total_plants,
  type = "bar"
)
fig = fig %>% layout(xaxis = list(categoryorder = "array",
                    categoryarray = category))

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Category"),
         yaxis = list (title = "Total Number of Plants")) 

fig
```

Only considering unique taxa in the collection.

```{r, echo=F, fig.dim = c(10, 4)}
unique_plants = unique(re$TaxonNameFull)
re_cur = re[match(unique_plants, re$TaxonNameFull),]
data_cur = table(re_cur$redList_category)
category = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')
number = as.numeric(data_cur[match(c('VU', 'EN','CR','EW', 'EX'), names(data_cur))])
d = data.frame(category = category, total_plants = number)
fig <- plot_ly(d,
  x = ~category,
  y = ~total_plants,
  type = "bar"
)
fig = fig %>% layout(xaxis = list(categoryorder = "array",
                    categoryarray = category))

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Category"),
         yaxis = list (title = "Total Number of Unique Plants")) 

fig
```

####  Geography of the endemic taxa in the collection

```{r, echo = F, eval = T,  fig.dim = c(10, 8)}
re = report[which(report$ItemStatusType == 'Existing'),]
re$good_name = paste0(re$sanitised_taxon, ' ', re$extracted_author)
threatened_index = grepl('EX|EW|CR|EN|VU',re$redList_category)
re = re[threatened_index,]

# load all geo areas
# load("wgsrpd3.rda")
details = data.frame(name = wgsrpd3$LEVEL3_NAM, code = wgsrpd3$LEVEL3_COD)

options = c('ALL','EX', 'EW', 'CR', 'EN','VU')
zzx = lapply(options, function(x){
  # Reduce database to what we are interested in.
  if(x == 'ALL'){
    report_cur = re
  }
  else{
    report_cur = re[which(re$redList_category == x),]
  }
  
  # Setup variables.
  plants = rep('', nrow(details))
  no_plants = rep(NA,nrow(details))
  no_unique_plants = rep(NA,nrow(details))
  plant_ex = rep('',nrow(details))
  
  for(i in 1:length(details$code)){
    index = grepl(pattern = details$code[i], x = report_cur$POWO_Dist_area_code_l3) 
    if(any(index)){
      plants[i] = paste0(unique(report_cur$good_name[index]), collapse =', ')
      plant_ex[i] = unique(report_cur$good_name[index])[1]
      no_plants[i] = sum(index)
      no_unique_plants[i] = length(unique(report_cur$good_name[index]))
    }
  }
  
  de = data.frame(plants = plants, plant_ex = plant_ex,  no_plants = no_plants, no_unique_plants = no_unique_plants)
  names(de) =  paste0(x, '_', names(de))
  return(de)
})

details=data.frame(details, do.call("cbind", zzx))

text = paste0('Region: ', details$name, '<br />', 
              'Total: ', details$ALL_no_unique_plants, ' (', details$ALL_no_plants,  ')<br />')

has_VU = which(!is.na(details$VU_no_plants))
text[has_VU] = paste(text[has_VU], 'Vulnerable: ', details$VU_no_unique_plants[has_VU], ' (', details$VU_no_plants[has_VU],  ')<br />')

has_EN = which(!is.na(details$EN_no_plants))
text[has_EN] = paste(text[has_EN], 'Endangered: ', details$EN_no_unique_plants[has_EN], ' (', details$EN_no_plants[has_EN],  ')<br />')

has_CR = which(!is.na(details$CR_no_plants))
text[has_CR] = paste(text[has_CR], 'Crit Endangered: ', details$CR_no_unique_plants[has_CR], ' (', details$CR_no_plants[has_CR],  ')<br />')

has_EW = which(!is.na(details$EW_no_plants))
text[has_EW] = paste(text[has_EW], 'Extinct in the Wild: ', details$EW_no_unique_plants[has_EW], ' (', details$EW_no_plants[has_EW],  ')<br />')

has_EX = which(!is.na(details$EX_no_plants))
text[has_EX] = paste(text[has_EX], 'Extinct: ', details$EX_no_unique_plants[has_EX], ' (', details$EX_no_plants[has_EX],  ')<br />')

details$hover = text

# Convert geometry into a format accepted by plotly
mapp = sf::st_cast(wgsrpd3, "MULTIPOLYGON")
geo_sf = geojsonsf::sf_geojson(mapp)
data = rjson::fromJSON(geo_sf)
feat = data$features
for(i in 1:length(feat)){
  feat[[i]]$id = feat[[i]]$properties$LEVEL3_COD
}
data$features = feat

# geo styling
g <- list(
  scope = 'world',
  showland = TRUE,
  landcolor = toRGB("White"),
  showocean = TRUE,
  oceancolor = toRGB("LightBlue"),
  showcountries = F,
  lonaxis = list(showgrid = T),
  lataxis = list(showgrid = T)
)
fig <- plot_ly()
fig <- fig %>% add_trace(
  type="choropleth",
  geojson=data,
  locations=details$code,
  text = details$hover,
  hoverinfo = 'text',
  z=details$ALL_no_unique_plants,
  colorscale="Viridis",
  zmin=0,
  zmax=max(details$ALL_no_unique_plants, na.rm = T),
  marker=list(line=list(
    width=0)
  )
)
fig <- fig %>% colorbar(title = "Number of Unique Plants")
# fig <- fig %>% layout(
#   title = "Geographic Distribution of Garden's collection"
# )

fig <- fig %>% layout(
  geo = g
)

fig <- fig   %>% config(modeBarButtonsToRemove = c("select2d", "lasso2d"))

fig
```

Hover over regions for:

- Name of the `Region`.
- `Total` number of threatened taxa (Vulnerable, Endangered, Critically Endangered, Extinct in the Wild and Extinct), with format `XX (YY)` where `XX` is the number of unique taxa and YY is the total number of taxa. 

Of the same format as `Total` we provide the number of Vulnerable, Endangered, Critically Endangered, Extinct in the Wild and Extinct when they exist.  

<!--
For original there were two plots one with number of threatened and one with is area represented by threatened.
For interactive combine into one interactive plot. 
-->

### Table containing the threatened taxa in your collection

Below we provide summary information on the threated plants in your collection, where:

- `TaxonNameFull` is the combined taxon name and author as provided in your collection.
- `In_collection` the number of plants in 
- `Category` the red list status category, either VU = Vulnerable, EN = Endangered, CR = Critically Endangered, EW = Extinct in the Wild or EX = Extinct.
- `Trend` The population trend provided by IUCN where available.
- `Date` The date when the plant was assessed.
- `Sites` The number of collections that contain the taxa. Note that this uses BGCI data that has been 'cleaned' by using taxon names from POWO. 

```{r,echo = F}
# Get existing records that are threatened.
re = report[which(report$ItemStatusType == 'Existing'),]
re$good_name = paste0(re$sanitised_taxon, ' ', re$extracted_author)
threatened_index = grepl('EX|EW|CR|EN|VU',re$redList_category)
re = re[threatened_index,]

# Reduce to unique plants, and add number in collection. 
  re <- re |>
    dplyr::group_by(.data$TaxonNameFull) |>
    dplyr::summarise(In_collection = length(.data$TaxonNameFull)) |>
    dplyr::ungroup()
  
matched_index = match(re$TaxonNameFull, report$TaxonNameFull)
re$Category = report$redList_category[matched_index]
re$Trend = report$redList_population_trend[matched_index]
re$Date = report$redList_assessment_date[matched_index]
re$Sites = report$no_gardens[matched_index]
  
DT::datatable(re,options = list(dom = 'tp'), filter = list(position = "top"))
```


***


### Retrospective overview of red-listed species in the collection

```{r, echo = F}
# Get the earliest year for retrospective oveview.
# min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
date = paste0(min_year:2023, '-01-01')

# Use the whole dataset.
# Do we want to restrict to only those with geographic information.
dataset = report

result = BGSmartR::exist_at_date(date, acc = dataset$AccYear,
                       ItemStatusDate = dataset$ItemStatusDate,
                       ItemStatusType = dataset$ItemStatusType)

time_series_info = lapply(result, function(x){
  garden_current = dataset[x,]
  
  # Breakdown of red-list
  redList_category = table(garden_current$redList_category)
  
  # Total number of plants in the collection
  collection_size = nrow(garden_current)
  return(list(redList_category = redList_category, collection_size = collection_size))
})
names(time_series_info) = names(result)
```

This section reviews the garden's collection over time. The first record in the garden comes from `r min_year -1` therefore we will take snapshots (existing plants) of the garden's collection on the 1st of January every year from `r min_year` to 2023.

Note that here we consider all the plants in the collection in a given year. Records that could not be matched to IUCN's red list are assumed to not be threatened. 

Furthermore, we use the red-list status of taxa from the current day, thus we cannot account for the variability of plants that are deemed to be threatened over time. For example it is possible for the collection to have plants that are currently extinct in their collection in the past (prior to the taxa going extinct).  

Taxa are defined as `threatened` if they are either Vulnerable, Endangered, Critically Endangered, Extinct in the wild or Extinct. 

```{r, echo = F}
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$redList_category
  
  EX = sum(as.numeric(details[grepl('EX',names(details))]))
  EW = sum(as.numeric(details[grepl('EW',names(details))]))
  CR = sum(as.numeric(details[grepl('CR',names(details))]))
  EN = sum(as.numeric(details[grepl('EN',names(details))]))
  VU = sum(as.numeric(details[grepl('VU',names(details))]))

  return(c(EX,EW,CR,EN,VU))
  }))))

collection_size = as.numeric(unlist(lapply(time_series_info, function(x){ x$collection_size})))

names(no_items) = c('EX','EW','CR','EN','VU')
no_items$total = rowSums(no_items)
prop = round(no_items/collection_size*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
data = data.frame(year = as.numeric(stringr::str_extract(rownames(no_items),'[0-9]{4}')), no_items, prop)
```

#### Number of threatened taxa over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~total, name = 'Threatened', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

#### Proportion of collection that is threatened over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~total_prop, name = 'Threatened', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proporotion of Collection")) 
fig <- fig %>% layout(hovermode = 'x unified', yaxis = list(ticksuffix = '%'))
fig
```

#### Number of red-list status taxa over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~EX, name = 'Extinct', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~EW, name = 'Extinct in the Wild', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~CR, name = 'Critically Endangered', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~EN, name = 'Endangered', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~VU, name = 'Vulnerable', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```


#### Number of red-list status taxa over time (stacked)


```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
fig <- plot_ly(data, x = ~year, mode = 'none', stackgroup = 'one') 
fig <- fig %>% add_trace(y = ~EX, name = 'Extinct',type = 'scatter', fillcolor = 'black') 
fig <- fig %>% add_trace(y = ~EW, name = 'Extinct in the Wild', type = 'scatter', fillcolor = '#1f1f1f') 
fig <- fig %>% add_trace(y = ~CR, name = 'Critically Endangered', type = 'scatter', fillcolor = '#cd3700') 
fig <- fig %>% add_trace(y = ~EN, name = 'Endangered', type = 'scatter', fillcolor = 'orange') 
fig <- fig %>% add_trace(y = ~VU, name = 'Vulnerable', type = 'scatter', fillcolor = 'yellow') 
fig <- fig %>% layout(title = "",
                      xaxis = list(title = "Year"),
                      yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

#### Proportion of red-list status taxa (of collection) over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~EX_prop, name = 'Extinct', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~EW_prop, name = 'Extinct in the Wild', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~CR_prop, name = 'Critically Endangered', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~EN_prop, name = 'Endangered', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~VU_prop, name = 'Vulnerable', mode = 'lines',type = 'scatter') 
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Collection")) 
fig <- fig %>% layout(hovermode = 'x unified', yaxis = list(ticksuffix = '%'))
fig
```

***

