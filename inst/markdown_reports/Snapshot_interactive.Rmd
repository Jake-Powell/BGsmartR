---
title: "Snapshot"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
```

```{r, imported parameters, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - collection the name to be printed in the report.
load('/Users/jakepowell/Cambridge/Enriched reports/WCVP_Version10/CUBG_enriched_report.rda')
report = enriched_report
collection = 'CUBG'
create_excel = TRUE
save_widgets = FALSE
collection_coords = c(0.128305,52.193403)
output_dir = getwd()


report = enriched_report

do_coord = !is.na(collection_coords[1])

#Extract endemic information from report
report$endemic = rep('Not endemic', nrow(report))
endemic_index = which(stringr::str_length(report$POWO_Dist_area_code_l3) ==3)
report$endemic[endemic_index] = 'Endemic'

report$ProvenanceCode[report$ProvenanceCode == 'G'] = 'Garden'
report$ProvenanceCode[report$ProvenanceCode == 'U'] = 'Unknown'
report$ProvenanceCode[report$ProvenanceCode == 'W'] = 'Wild'
report$ProvenanceCode[report$ProvenanceCode == 'Z'] = 'Wild-derived'

report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)

best_name = paste0(report$POWO_taxon_name, ' ', report$POWO_taxon_authors)
best_name[which(best_name == 'NA NA')] = report$good_name[which(best_name == 'NA NA')]
report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)

report_original = report

if(save_widgets){
  widget_dir = paste0(output_dir,'/',collection,'_Widgets')
  dir.create(widget_dir,showWarnings = FALSE)
}

# Extract the location of the collection.
wgsrpd3 = BGSmartR::wgsrpd3
pnts <- data.frame( x = collection_coords[1], y = collection_coords[2])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
level3_name = collection_geog_details$LEVEL3_NAM
level3_code = collection_geog_details$LEVEL3_COD
level2_name = collection_geog_details$LEVEL2_NAM
level2_code = collection_geog_details$LEVEL2_COD
level1_name = collection_geog_details$LEVEL1_NAM
level1_code = collection_geog_details$LEVEL1_COD

text = paste0(level3_name, ' (L3), ', level2_name, ' (L2), ', level1_name,' (L1).')
```

This report uses data from **`r collection`**.

```{asis, eval=(do_coord == TRUE)}
Using [World Geographical Scheme for Recording Plant Distributions](https://www.tdwg.org/standards/wgsrpd/) (wgsrpd), the collection is found in 
```
`r if(do_coord){text}`

```{r, Anaylsis, echo = F}
# Restrict to existing plants.
report = report[report$ItemStatusType == 'Existing',]

# Number of Items.
no_items = nrow(report)

# Number of Accessions.
no_accessions = length(unique(report$AccNoFull))

# Number of taxa
no_taxa = length(unique(paste0(report$sanitised_taxon, ' ', report$extracted_author)))

#No families.
# = Use POWO family if available if not use the original.
families = data.frame(original = report$Family, POWO = report$POWO_family)
use_family = families$POWO
use_family[is.na(use_family)] = families$original[is.na(use_family)]
no_families <- length(unique(use_family))

#No genus
# = Use POWO genus if available if not use the original.
genus = data.frame(original = report$Genus, POWO = report$POWO_genus)
use_genus = genus$POWO
use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
no_genus <- length(unique(use_genus))


#No species
POWO_GenusSpecies = rep(NA, nrow(report))
POWO_GenusSpecies[!is.na(report$POWO_plant_name_id)] = paste0(report$POWO_genus[!is.na(report$POWO_plant_name_id)],
                                                              ' ',
                                                              report$POWO_species[!is.na(report$POWO_plant_name_id)])
species_data = data.frame(original = report$GenusSpecies, POWO = POWO_GenusSpecies, infra = report$infrageneric_level)

#remove cultivars, indeterminants, hybrids and those without infrageneric level
species_only = species_data[!grepl('5|6|0',species_data$infra),]
species_only = species_only[!is.na(species_only$infra),]

use_species = species_only$POWO
use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
no_species = length(unique(use_species))
species_later = no_species

species_powo = unique(species_only$POWO[!is.na(species_only$POWO)])
species_notpowo = unique(species_only$original[is.na(species_only$POWO)])
species_notpowo = species_notpowo[!species_notpowo %in% species_powo]
```

```{r, onRender text, echo = F}
render_barplot ="
    function(el) { 
    console.log(el)
      el.on('plotly_hover', function(data){
  var pn='',
      tn='',
      colors=[];
  for(var i=0; i < data.points.length; i++){
    pn = data.points[i].pointNumber;
    tn = data.points[i].curveNumber;
    colors = data.points[i].data.marker.color;
  };
  colors[pn] = '#31a354';
    
  var update = {'marker':{color: colors}};
  Plotly.restyle(el.id, update, [tn]);
});
      el.on('plotly_unhover', function(data){
  var pn='',
      tn='',
      colors=[];
  for(var i=0; i < data.points.length; i++){
    pn = data.points[i].pointNumber;
    tn = data.points[i].curveNumber;
    colors = data.points[i].data.marker.color;
  };
  colors[pn] = '#addd8e';
  var update = {'marker':{color: colors}};
  Plotly.restyle(el.id, update, [tn]);
});
    }
  "
```
This report provides a summary of the diversity and distribution of taxa currently present in the collection. We do this by restricting the database to only items that are `Existing`.

From Provence onwards we only consider 'non-horticultral' taxa. Therefore, from that point onwards the number of taxa is defined to be to the total taxa in the report in the species and infraspecific categories excluding cultivars and hybrids.

#### How many elements? (accessions, items, taxa, species)

```{r, Creating How many elements, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
basics = data.frame(count = c(no_items,no_accessions, no_taxa, species_later), objects = factor(x = c("Items", "Accessions", "Taxa", "Species"), levels = c("Items", "Accessions", "Taxa","Species")) )
basics$colors = rep('#addd8e', nrow(basics))
basics$text = paste0(format(basics$count,big.mark=','), ' ', basics$objects)
fig <- plot_ly(basics, x = ~objects, y = ~count, type = 'bar', marker = list(color = ~colors), hovertext = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = ""),
         yaxis = list (title = "Number")) 

fig = fig %>% htmlwidgets::onRender(render_barplot)
if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','Bar_how_many_elements.html'))
}

fig
```

In the above:

- Items: The number of records in the report.
- Accessions: The number of accessions in the report.
- Taxa: The number of taxa in the report. 
- Species: The number of taxa at the species level, excluding hybrids, cultivars, and indeterminate items. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`.

***

#### How many of each taxonomic units? (family, genera, species)

```{r, Creating How many of each taxonomic units?,  echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
taxa = data.frame(count = c(no_species,no_genus,no_families), TaxonomicCategory = c(c("Species", "Genera", "Families")))
taxa$colors = rep('#addd8e', nrow(taxa))
taxa$text = paste0(format(taxa$count,big.mark=','), ' ', taxa$TaxonomicCategory)

fig <- plot_ly(taxa, x = ~TaxonomicCategory, y = ~count, type = 'bar', marker = list(color = ~colors), hovertext = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Taxonomic Category"),
         yaxis = list (title = "Number")) 

fig = fig %>% htmlwidgets::onRender(render_barplot)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','Bar:how_many_each_taxonomic_unit.html'))
}

fig
```

In the above:

- Families: The number of families found in the report.
- Genera: The number of genera found in the report.
- Species: The number of taxa at the species level, excluding hybrids, cultivars, and indeterminate items. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`.


***

#### How many species, infraspecific, and cultivars?

```{r, Creating How many species, infraspecific, and cultivars?, echo=F, fig.show="hold", out.width="40%"}
########################################
### Infraspecific diversity pie chart.
########################################
# First get POWO taxon name if it exists, if not use sanitised name.
taxon_names = report$POWO_taxon_name
taxon_names[is.na(taxon_names)] = report$sanitised_taxon[is.na(taxon_names)]

indet = taxon_names[grepl('0',report$infrageneric_level)]
no_indet = length(indet)
no_unique_indet = length(unique(indet))
  
hort = taxon_names[grepl('5|6',report$infrageneric_level)]
no_hort = length(hort)
no_unique_hort = length(unique(hort))

taxon_rank = taxon_names[grepl('2|3|4',report$infrageneric_level)]
no_taxon_rank = length(taxon_rank)
no_unique_taxon_rank = length(unique(taxon_rank))

species = taxon_names[grepl('1',report$infrageneric_level)]
no_species = length(species)
no_unique_species = length(unique(species))

taxa_infra_unique = data.frame(number = c(no_unique_species, no_unique_taxon_rank, no_unique_hort),
                        InfragenericLevel = c('Species','Infraspecific taxa', 'Horticultral taxa'))

taxa_infra = data.frame(number = c(no_species, no_taxon_rank, no_hort),
                        InfragenericLevel = c('Species','Infraspecific taxa', 'Horticultral taxa'))

colors = viridis::viridis(nrow(taxa_infra))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(taxa_infra))

fig1 <- plot_ly(taxa_infra, labels = ~InfragenericLevel, values = ~number,
                type = 'pie',
                marker = list(colors = colors_alpha),
                pull = rep(0,nrow(taxa_infra)),
                hole =.4) %>% layout(title = 'All Items')


fig1 =  fig1 %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))

fig2 <- plot_ly(taxa_infra_unique, labels = ~InfragenericLevel, values = ~number,
                type = 'pie',
                marker = list(colors = colors_alpha),
                pull = rep(0,nrow(taxa_infra)),
                hole =.4) %>% layout(title = 'Taxa in Collection')

fig2 =  fig2 %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))


if(save_widgets){
  htmlwidgets::saveWidget(fig1, file = paste0(widget_dir, '/','Pie_how_many_species_hort_infra_all_items.html'))
  htmlwidgets::saveWidget(fig2, file = paste0(widget_dir, '/','Pie_how_many_species_hort_infra_taxa_in_collection.html'))  
}


htmltools::browsable(
  tagList(list(
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig1
    ),
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig2
    )
  ))
)

```
where:

- Horticultural taxa: consists of hybrids and cultivars.
- Infraspecific taxa: includes subspecies (subsp.), varieties (var.) and forma (f.).
- Species: consists of species names that are not further divided into infraspecific categories

The collection also contains `r no_indet` indeterminate taxa which were removed prior to creating chart. Indeterminate taxa include those such as `Solanum sp.`, `Solanaceae Indet` and `Octomeria aff. serrana`. 

***

#### What are the ratios of provenance types in the collection?

```{r, remove hort from report, echo = FALSE}
report = report[!grepl('5|6',report$infrageneric_level),]
```

```{r, Creating What are the ratios of provenance types in the collection?, echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
########################################
### provenance pie chart.
########################################
# First get POWO taxon name if it exists, if not use sanitised name.
 accessions = unlist(lapply(stringr::str_split(report$ItemAccNoFull,pattern = '\\*'),function(x){x[1]} ))
      unique_accessions = unique(accessions)
      wanted_index = match(unique(accessions), accessions)
      report_cur = report[wanted_index,]
      word='Accessions'

prov_table = table(report_cur$ProvenanceCode)
provenance = data.frame(Provenance = names(prov_table), number = as.numeric(prov_table))
provenance$text = paste0(provenance$Provenance, '<br>', provenance$number, ' Accessions<br>',
                         round(provenance$number/sum(provenance$number)*100,digits=2), '%')
########################################

colors = viridis::viridis(nrow(provenance))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(provenance))
fig <- plot_ly(provenance, labels = ~Provenance, values = ~number,
               type = 'pie',
               marker = list(colors = colors_alpha),
               pull = rep(0,nrow(provenance)),
               hole =.4,
               hoverinfo = 'text',
               hovertext = ~text)

fig =  fig %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','pie:provenance.html'))
}

fig
```

Above we show the proportion of provenance over the number of accessions in the collection.

***

#### What is the geographical origin of the collection?

```{r, echo = F}
########################################
## Create data/information for the geography plot.
########################################
# reduce to only those records with POWO match.
re = report[!is.na(report$POWO_Dist_area_code_l3),]
```
```{r, Formatting geography data, echo = F, eval = T, echo =F, fig.dim = c(10, 5)}
# load all geo areas
wgsrpd3 = BGSmartR::wgsrpd3_level3_simp

details = data.frame(name = wgsrpd3$name, code = wgsrpd3$code)
plants = rep('', nrow(details))
no_plants = rep(NA,nrow(details))
no_unique_plants = rep(NA,nrow(details))
plant_ex = rep('',nrow(details))
for(i in 1:length(details$code)){
  index = grepl(pattern = details$code[i], x = re$POWO_Dist_area_code_l3) 
  if(any(index)){
    plants[i] = paste0(unique(re$good_name[index]), collapse =', ')
    plant_ex[i] = unique(re$good_name[index])[1]
    no_plants[i] = sum(index)
    no_unique_plants[i] = length(unique(re$good_name[index]))
  }
}

details = data.frame(details, plants = plants, plant_ex = plant_ex,  no_plants = no_plants, no_unique_plants = no_unique_plants)
details$no_unique_plants[is.na(details$no_unique_plants)] = 0
details$no_plants[is.na(details$no_plants)] = 0

text = paste0('Region: ', details$name, '<br />', 
              'Number of Items: ', details$no_plants,  '<br />',
              'Number of Taxa: ', details$no_unique_plants,  '<br />')
details$hover = text


# Convert geometry into a format accepted by plotly
mapp = sf::st_cast(wgsrpd3, "MULTIPOLYGON")
geo_sf = geojsonsf::sf_geojson(mapp)
data = rjson::fromJSON(geo_sf)
feat = data$features
for(i in 1:length(feat)){
  feat[[i]]$id = feat[[i]]$properties$code
}
data$features = feat

index = seq(0,1,0.01)
colours = c("#FFFFFF",rev(viridis::viridis(100)))
counter = 1:length(index)
col_scale = lapply(counter, function(i){return(c(index[i], colours[i]))})

if(do_coord){
  coords = collection_coords
}else{
  coords = c(0,0)
}
fig = plot_ly(details,  text = details$hover, hoverinfo = 'text') %>% add_trace(type="choroplethmapbox",
   geojson=data,
   locations=wgsrpd3$code,
   z=details$no_unique_plants,
   colorscale=col_scale,
   reversescale = FALSE,
   marker=list(line=list(
   width=0.01,color ='black'),
   text = details$hover,
   hoverinfo = 'text',
   zmin=0,
   zmax=max(details$no_unique_plants, na.rm = T)
  )
)%>% layout(
  mapbox=list(
    style="white-bg",
    center = list(lon = 0 ,lat= 60),
    zoom =0.46, 
    lataxis = list(range = c(-59, 90)))
) %>% colorbar(title = "Number<br> of Taxa")
if(do_coord){
  fig <- fig %>% add_trace(type='scattermapbox',
                         mode = 'markers',
                         lon = coords[1],
                         lat = coords[2],
                        text = 'Collection',
                        color = I('red'),
                         size = I(30),
   hoverinfo = 'text')
}



fig <- fig   %>% config(modeBarButtonsToRemove = c("select2d", "lasso2d"))

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','Geography.html'))
}
```

For plants that we successfully matched to POWO (**`r format(nrow(re),big.mark=',')`** items corresponding to **`r format(length(unique(re$good_name)),big.mark=',')`** taxa) we have geographic distribution data, which is visualised below

```{r, Creating geography figure, echo =F, fig.dim = c(10, 6), eval = T}
########################################
## Geography plot.
########################################
fig
```
where the number of taxa only includes records that are matched to POWO. 

Hover over regions for:

- Name of the `Region`.
- `Number of items` in the report that are native to the region.
- `Number of Taxa` in the report that are native to the region.

```{asis, eval=(do_coord == TRUE)}
Moreover, the location of the collection is shown by the red circle on the map.
```


***

#### How many endemic species are in the collection?

```{r, Creating Number and/or proportion of endemic species?, echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
########################################
### Endemic pie chart.
########################################
# First get POWO taxon name if it exists, if not use sanitised name.
species = report$good_name[which(!grepl('0|5|6',report$infrageneric_level))]
      wanted_index = match(unique(species), species)
report_cur = report[wanted_index,]

endemic_table = table(report_cur$endemic)
endemic = data.frame(Endemic = names(endemic_table), number = as.numeric(endemic_table))
endemic$text = paste0(endemic$Endemic, '<br>', endemic$number, ' Species<br>',
                         round(endemic$number/sum(endemic$number)*100,digits=2), '%')
colors = viridis::viridis(nrow(endemic))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(endemic))
fig <- plot_ly(endemic, labels = ~Endemic, values = ~number,
               type = 'pie',
               marker = list(colors = colors_alpha),
               pull = rep(0,nrow(endemic)),
               hole =.4,
               hoverinfo = 'text',
               hovertext = ~text)

fig =  fig %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','Pie_endemic.html'))
}

fig
```

```{r, echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
########################################
### Endemic "local"
########################################
if(!is.na(do_coord)){
endemic_report = report_cur[report_cur$endemic == 'Endemic',]
level3_local = sum(endemic_report$POWO_Dist_area_code_l3 == level3_code)

level2_level3_codes = wgsrpd3$LEVEL3_COD[wgsrpd3$LEVEL2_COD == level2_code]
level2_local = sum(endemic_report$POWO_Dist_area_code_l3 %in% level2_level3_codes)

level1_level3_codes = wgsrpd3$LEVEL3_COD[wgsrpd3$LEVEL1_COD == level1_code]
level1_local = sum(endemic_report$POWO_Dist_area_code_l3 %in% level1_level3_codes)

text = paste0('Of the endemic taxa in the collection ', level3_local,' (', round(level3_local/nrow(endemic_report)*100,digits=2),'%) are endemic to ', level3_name,'.')

}
if(level3_local <= 20 && level3_local > 1){
  text = paste0(text, '. <br> These include (showing up to 20 species): <br> <div>
    <ul class="columns" data-columns="2">
        <li>',paste0(endemic_report$good_name[endemic_report$POWO_Dist_area_code_l3 == level3_code],collapse ='</li> <li>'), '</li>
    </ul>
</div>', collapse='')
}

```

`r if(!is.na(do_coord)){HTML(text)}`

***

#### How many threatened species are in the collection?

```{r, creating threatened figure, echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
########################################
### threatened pie chart.
########################################
# First get POWO taxon name if it exists, if not use sanitised name.
species = report$good_name[which(!grepl('0|5|6',report$infrageneric_level))]
      wanted_index = match(unique(species), species)
report_cur = report[wanted_index,]

red_table = table(report_cur$redList_category)
threat_total = sum(red_table[names(red_table) %in% c('VU','EN','CR','EW','EX')])
threat = data.frame(threat = c('Threatened', 'Not Threatened'), number = c(threat_total, nrow(report_cur) - threat_total))
threat$text = paste0(threat$threat, '<br>', threat$number, ' Species<br>',
                         round(threat$number/sum(threat$number)*100,digits=2), '%')

# First get POWO taxon name if it exists, if not use sanitised name.
red_table = table(report_cur$redList_category)
red_table = red_table[names(red_table) %in% c('VU','EN','CR','EW','EX')]
threat_type = data.frame(threat = names(red_table), number = as.numeric(red_table))
order_threat = match(c('VU','EN','CR','EW','EX'),threat_type$threat)
order_threat = order_threat[!is.na(order_threat)]
threat_type = threat_type[order_threat,]
threat_type$threat = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')[match(threat_type$threat, c('VU','EN','CR','EW','EX'))]

threat_type$text = paste0(threat_type$threat, '<br>', threat_type$number, ' Species<br>',
                         round(threat_type$number/sum(threat_type$number)*100,digits=2), '%')


colors = viridis::viridis(nrow(threat))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(threat))
fig1 <- plot_ly(threat, labels = ~threat, values = ~number,
               type = 'pie',
               marker = list(colors = colors_alpha),
               pull = rep(0,nrow(threat)),
               hole =.4,
               hoverinfo = 'text',
               hovertext = ~text) %>% layout(title = 'All records')

fig1 =  fig1 %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))


# colours taken from 'https://royalsocietypublishing.org/doi/10.1098/rstb.2014.0003'.
colors = c('#fdf851', '#f4a540', '#ed3833', '#808080', '#000000')
colors = colors[match(threat_type$threat, c('Vulnerable', 'Endangered', 'Critically Endangered',
                                            'Extinct in the Wild', 'Extinct'))]

# colors = viridis::viridis(nrow(threat_type))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(threat_type))
fig2 <- plot_ly(threat_type, labels = ~threat, values = ~number,sort = FALSE,
               type = 'pie',
               marker = list(colors = colors),
               pull = rep(0,nrow(threat_type)),
               hole =.4,
               hoverinfo = 'text',
               hovertext = ~text) %>% layout(title = "Breakdown by risk categories")

fig2 =  fig2 %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))

if(save_widgets){
  htmlwidgets::saveWidget(fig1, file = paste0(widget_dir, '/','Pie_threatened.html'))
    htmlwidgets::saveWidget(fig2, file = paste0(widget_dir, '/','Pie_threatened_category.html'))

}


htmltools::browsable(
  tagList(list(
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig1
    ),
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig2
    )
  ))
)
```

We match records to IUCN red list to extract which records are threatened.

***

#### What is the rarity of the extant collection?

```{r, creating rarity figure, echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
########################################
### rareity pie chart.
########################################
# First get POWO taxon name if it exists, if not use sanitised name.

unique_taxa = unique(report$good_name)
report_unique = report[match(unique_taxa, report$good_name),]
report_unique = report_unique[grepl('1|2|3|4',report_unique$infrageneric_level),]

those_with_no_gardens = sum(!is.na(report_unique$no_gardens))
those_without_no_gardens = nrow(report_unique) - those_with_no_gardens

no_gardens_table = table(report_unique$no_gardens)
extant_gardens = data.frame(in_collection = as.numeric(no_gardens_table) , extant = as.numeric(names(no_gardens_table)))

# For those with less than 5 species in the collection retrieve them. 
extant_numbers = extant_gardens$extant[extant_gardens$in_collection <= 5]
plants = unlist(lapply(extant_numbers, function(x){
  return(paste0(report_unique$sanitised_taxon[which(report_unique$no_gardens == x)], collapse = '<br />'))
}))

text = paste0('Taxa In Collection: ', extant_gardens$in_collection, '<br />', 
              'Global Collections Holding Taxa: ', extant_gardens$extant,  '<br />')
index = match(extant_numbers, extant_gardens$extant) 
text[index] = paste0(text[index], 'Taxa: ', plants, '<br />')
extant_gardens$hover = text

# Scatter plot of species in collection against collections holding a species worldwide.
fig1 <- plot_ly(extant_gardens, x = ~extant, y = ~in_collection, 
         type = 'scatter',
         mode = 'markers',
         text = extant_gardens$hover,
         hoverinfo = 'text')
fig1 <- fig1 %>% layout(title = "",
  xaxis = list(title = "Number of Collections Holding a Taxon Worldwide"),
  yaxis = list (title = "Number of Taxa Grown at the Collection")) 
fig1 <- layout(fig1,
             shapes = list(
               list(type = "rect",
                    fillcolor = "#41ab5d", line = list(color = "#41ab5d"), opacity = 0.3,
                    x0 = 0, x1 = 15.5, xref = "x",
                    y0 = 0, y1 = max(extant_gardens$in_collection), yref = "y"),
                list(type = "rect",
                    fillcolor = "#78c679", line = list(color = "#78c679"), opacity = 0.3,
                    x0 = 15.5, x1 = 50.5, xref = "x",
                    y0 = 0, y1 = max(extant_gardens$in_collection), yref = "y"),
               list(type = "rect",
                    fillcolor = "#addd8e", line = list(color = "#addd8e"), opacity = 0.3,
                    x0 = 50.5, x1 = 100.5, xref = "x",
                    y0 = 0, y1 = max(extant_gardens$in_collection), yref = "y"),
                list(type = "rect",
                    fillcolor = "#d9f0a3", line = list(color = "#d9f0a3"), opacity = 0.3,
                    x0 = 100.5, x1 = max(extant_gardens$extant), xref = "x",
                    y0 = 0, y1 = max(extant_gardens$in_collection), yref = "y")               
              ))


# Pie chart of grouped extant number of collections.
breaks = c(0,10,50,100)
grouped = table(cut(report_unique$no_gardens, breaks = c(breaks, max(report_unique$no_gardens, na.rm=T))))
grouped_extant = data.frame(group = names(grouped), number = as.numeric(grouped))

fig2 <- plot_ly(grouped_extant, labels = ~group, values = ~number, type = 'pie')

colors = c('#41ab5d', '#78c679', '#addd8e', '#d9f0a3')
# colors = viridis::viridis(nrow(threat_type))
colors_alpha = BGSmartR::add_alpha(colors, alpha = 0.5)
zeros = rep(0,nrow(grouped_extant))
fig2 <- plot_ly(grouped_extant, labels = ~group, values = ~number, sort = FALSE,
               type = 'pie',
               marker = list(colors = colors),
               pull = rep(0,nrow(grouped_extant)),
               hole =.4)

fig2 =  fig2 %>% htmlwidgets::onRender(paste0("function(el, x) {
            el.on('plotly_hover', function(d){
              var pn;
              var oCol = [",
            paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
            "];
              var nCol = [",
              paste0("'",paste(colors_alpha, collapse = "', '"),"'",collapse=''),
              "];
              var pull = [", paste0(zeros, collapse =', '), "];
              pn = d.points[0].pointNumber;
              nCol[pn] = oCol[pn];
              pull[pn] = 0.1;
              var update = {marker:{colors: nCol}, pull:[pull]};
              Plotly.restyle(el.id, update);
            });
            el.on('plotly_unhover', function(d){
              var oCol = [",
              paste0("'",paste(colors, collapse = "', '"),"'",collapse=''),
              "];
              var pull =[", paste0(zeros, collapse =', '), "];
              var update = {marker:{colors: oCol}, pull:pull};
              Plotly.restyle(el.id, update);
            });}", collapse =''))



if(save_widgets){
  htmlwidgets::saveWidget(fig1, file = paste0(widget_dir, '/','Scatter_rareity.html'))
  htmlwidgets::saveWidget(fig2, file = paste0(widget_dir, '/','Pie_rareity.html'))
  
}

htmltools::browsable(
  tagList(list(
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig1
    ),
    tags$div(
      style = 'width:50%;display:block;float:left;',
      fig2
    )
  ))
)
```

In the scatter plot above we show the taxa in the case there are 5 or fewer grown at the collection.

***


#### What is the taxonomic diversity of the collection?

Below we produce a sunburst chart showing the taxonomic diversity of the collection. Hovering over any segment shows the number of the taxa in the collection within the group (family, genera, etc).

```{r, Create taxonomic diversity, echo = F}
# Sunburst chart of taxonomic hierarchy.
# taxonomic hierarchy. =
# - Class
# - Order
# - Family
# - Genus
# - Species
#
# POWO only gives information up to family. Moreover POWO only deals with vascular plants, which corresponds to 460/620 plant families.

# Using the plant list the families are grouped into 4 major groups.
# - The Angiosperms (Flowering plants)
# - The Gymnosperms (Conifers, cycads and allies)
# - The Pteridophytes (Ferns and fern allies)
# - The Bryophytes (Mosses and liverworts)

Angiosperms = 'Acanthaceae
Achariaceae
Achatocarpaceae
Acoraceae
Actinidiaceae
Adoxaceae
Aextoxicaceae
Aizoaceae
Akaniaceae
Alismataceae
Alseuosmiaceae
Alstroemeriaceae
Altingiaceae
Amaranthaceae
Amaryllidaceae
Amborellaceae
Anacampserotaceae
Anacardiaceae
Anarthriaceae
Ancistrocladaceae
Anisophylleaceae
Annonaceae
Aphanopetalaceae
Aphloiaceae
Apiaceae
Apocynaceae
Apodanthaceae
Aponogetonaceae
Aquifoliaceae
Araceae
Araliaceae
Arecaceae
Argophyllaceae
Aristolochiaceae
Asparagaceae
Asteliaceae
Asteropeiaceae
Atherospermataceae
Austrobaileyaceae
Balanopaceae
Balanophoraceae
Balsaminaceae
Barbeuiaceae
Barbeyaceae
Basellaceae
Bataceae
Begoniaceae
Berberidaceae
Berberidopsidaceae
Betulaceae
Biebersteiniaceae
Bignoniaceae
Bixaceae
Blandfordiaceae
Bonnetiaceae
Boraginaceae
Boryaceae
Brassicaceae
Bromeliaceae
Brunelliaceae
Bruniaceae
Burmanniaceae
Burseraceae
Butomaceae
Buxaceae
Byblidaceae
Cabombaceae
Cactaceae
Calceolariaceae
Calophyllaceae
Calycanthaceae
Calyceraceae
Campanulaceae
Campynemataceae
Canellaceae
Cannabaceae
Cannaceae
Capparaceae
Caprifoliaceae
Cardiopteridaceae
Caricaceae
Carlemanniaceae
Caryocaraceae
Caryophyllaceae
Casuarinaceae
Celastraceae
Centrolepidaceae
Centroplacaceae
Cephalotaceae
Ceratophyllaceae
Cercidiphyllaceae
Chloranthaceae
Chrysobalanaceae
Circaeasteraceae
Cistaceae
Cleomaceae
Clethraceae
Clusiaceae
Colchicaceae
Columelliaceae
Combretaceae
Commelinaceae
Compositae
Connaraceae
Convolvulaceae
Coriariaceae
Cornaceae
Corsiaceae
Corynocarpaceae
Costaceae
Crassulaceae
Crossosomataceae
Ctenolophonaceae
Cucurbitaceae
Cunoniaceae
Curtisiaceae
Cyclanthaceae
Cymodoceaceae
Cynomoriaceae
Cyperaceae
Cyrillaceae
Cytinaceae
Daphniphyllaceae
Dasypogonaceae
Datiscaceae
Degeneriaceae
Diapensiaceae
Dichapetalaceae
Didiereaceae
Dilleniaceae
Dioncophyllaceae
Dioscoreaceae
Dipentodontaceae
Dipterocarpaceae
Dirachmaceae
Doryanthaceae
Droseraceae
Drosophyllaceae
Ebenaceae
Ecdeiocoleaceae
Elaeagnaceae
Elaeocarpaceae
Elatinaceae
Emblingiaceae
Ericaceae
Eriocaulaceae
Erythroxylaceae
Escalloniaceae
Eucommiaceae
Euphorbiaceae
Euphroniaceae
Eupomatiaceae
Eupteleaceae
Fagaceae
Flacourtiaceae
Flagellariaceae
Fouquieriaceae
Frankeniaceae
Garryaceae
Geissolomataceae
Gelsemiaceae
Gentianaceae
Geraniaceae
Gerrardinaceae
Gesneriaceae
Gisekiaceae
Gomortegaceae
Goodeniaceae
Goupiaceae
Grossulariaceae
Grubbiaceae
Guamatelaceae
Gunneraceae
Gyrostemonaceae
Haemodoraceae
Halophytaceae
Haloragaceae
Hamamelidaceae
Hanguanaceae
Haptanthaceae
Heliconiaceae
Helwingiaceae
Hernandiaceae
Himantandraceae
Huaceae
Humiriaceae
Hydatellaceae
Hydnoraceae
Hydrangeaceae
Hydrocharitaceae
Hydroleaceae
Hydrostachyaceae
Hypericaceae
Hypoxidaceae
Icacinaceae
Iridaceae
Irvingiaceae
Iteaceae
Ixioliriaceae
Ixonanthaceae
Joinvilleaceae
Juglandaceae
Juncaceae
Juncaginaceae
Kirkiaceae
Koeberliniaceae
Krameriaceae
Lacistemataceae
Lactoridaceae
Lamiaceae
Lanariaceae
Lardizabalaceae
Lauraceae
Lecythidaceae
Leguminosae
Lentibulariaceae
Lepidobotryaceae
Liliaceae
Limeaceae
Limnanthaceae
Linaceae
Linderniaceae
Loasaceae
Loganiaceae
Lophiocarpaceae
Lophopyxidaceae
Loranthaceae
Lowiaceae
Lythraceae
Magnoliaceae
Malpighiaceae
Malvaceae
Marantaceae
Marcgraviaceae
Martyniaceae
Mayacaceae
Melanthiaceae
Melastomataceae
Meliaceae
Melianthaceae
Menispermaceae
Menyanthaceae
Metteniusaceae
Misodendraceae
Mitrastemonaceae
Molluginaceae
Monimiaceae
Montiaceae
Montiniaceae
Moraceae
Moringaceae
Muntingiaceae
Musaceae
Myodocarpaceae
Myricaceae
Myristicaceae
Myrothamnaceae
Myrtaceae
Nartheciaceae
Nelumbonaceae
Nepenthaceae
Neuradaceae
Nitrariaceae
Nothofagaceae
Nyctaginaceae
Nymphaeaceae
Ochnaceae
Olacaceae
Oleaceae
Onagraceae
Oncothecaceae
Opiliaceae
Orchidaceae
Orobanchaceae
Oxalidaceae
Paeoniaceae
Pandaceae
Pandanaceae
Papaveraceae
Paracryphiaceae
Passifloraceae
Paulowniaceae
Pedaliaceae
Penaeaceae
Pennantiaceae
Pentadiplandraceae
Pentaphragmataceae
Pentaphylacaceae
Penthoraceae
Peraceae
Peridiscaceae
Petenaeaceae
Petermanniaceae
Petrosaviaceae
Phellinaceae
Philesiaceae
Philydraceae
Phrymaceae
Phyllanthaceae
Phyllonomaceae
Physenaceae
Phytolaccaceae
Picramniaceae
Picrodendraceae
Piperaceae
Pittosporaceae
Plantaginaceae
Platanaceae
Plocospermataceae
Plumbaginaceae
Poaceae
Podostemaceae
Polemoniaceae
Polygalaceae
Polygonaceae
Pontederiaceae
Portulacaceae
Posidoniaceae
Potamogetonaceae
Primulaceae
Proteaceae
Putranjivaceae
Quillajaceae
Rafflesiaceae
Ranunculaceae
Rapateaceae
Resedaceae
Restionaceae
Rhabdodendraceae
Rhamnaceae
Rhipogonaceae
Rhizophoraceae
Roridulaceae
Rosaceae
Rousseaceae
Rubiaceae
Ruppiaceae
Rutaceae
Sabiaceae
Salicaceae
Salvadoraceae
Santalaceae
Sapindaceae
Sapotaceae
Sarcobataceae
Sarcolaenaceae
Sarraceniaceae
Saururaceae
Saxifragaceae
Scheuchzeriaceae
Schisandraceae
Schlegeliaceae
Schoepfiaceae
Scrophulariaceae
Setchellanthaceae
Simaroubaceae
Simmondsiaceae
Siparunaceae
Sladeniaceae
Smilacaceae
Solanaceae
Sphaerosepalaceae
Sphenocleaceae
Stachyuraceae
Staphyleaceae
Stegnospermataceae
Stemonaceae
Stemonuraceae
Stilbaceae
Strasburgeriaceae
Strelitziaceae
Stylidiaceae
Styracaceae
Surianaceae
Symplocaceae
Talinaceae
Tamaricaceae
Tapisciaceae
Tecophilaeaceae
Tetrachondraceae
Tetramelaceae
Tetrameristaceae
Theaceae
Thomandersiaceae
Thurniaceae
Thymelaeaceae
Ticodendraceae
Tofieldiaceae
Torricelliaceae
Tovariaceae
Trigoniaceae
Trimeniaceae
Triuridaceae
Trochodendraceae
Tropaeolaceae
Typhaceae
Ulmaceae
Urticaceae
Vahliaceae
Velloziaceae
Verbenaceae
Violaceae
Vitaceae
Vivianiaceae
Vochysiaceae
Winteraceae
Xanthorrhoeaceae
Xeronemataceae
Xyridaceae
Zingiberaceae
Zosteraceae
Zygophyllaceae'
Angiosperms = unlist(stringr::str_split(Angiosperms, pattern = '\n'))
Angiosperms = data.frame(major = rep('Angiosperms', length(Angiosperms)), family = Angiosperms)

Gymnosperms = 'Araucariaceae
Cupressaceae
Cycadaceae
Ephedraceae
Ginkgoaceae
Gnetaceae
Pinaceae
Podocarpaceae
Sciadopityaceae
Taxaceae
Welwitschiaceae
Zamiaceae'
Gymnosperms = unlist(stringr::str_split(Gymnosperms, pattern = '\n'))
Gymnosperms = data.frame(major = rep('Gymnosperms', length(Gymnosperms)), family = Gymnosperms)

Pteridophytes = 'Anemiaceae
Apleniaceae
Aspleniaceae
Athyriaceae
Blechnaceae
Cibotiaceae
Culcitaceae
Cyatheaceae
Cystodiaceae
Cystopteridaceae
Davalliaceae
Dennstaedtiaceae
Dicksoniaceae
Diplaziopsidaceae
Dipteridaceae
Dryopteridacae
Dryopteridaceae
Equisetaceae
Gleicheniaceae
Hymenophyllaceae
Hypodematiaceae
Isoëtaceae
Lindsaeaceae
Lomariopsidaceae
Lonchitidaceae
Loxsomataceae
Lycopodiaceae
Lygodiaceae
Marattiaceae
Marsileaceae
Matoniaceae
Metaxyaceae
Nephrolepidaceae
Oleandraceae
Onocleaceae
Ophioglossaceae
Osmundaceae
Plagiogyriaceae
Polypodiaceae
Psilotaceae
Pteridaceae
Rhachidosoraceae
Saccolomataceae
Salviniaceae
Schizaeaceae
Selaginellaceae
Tectariaceae
Thelypteridaceae
Thyrsopteridaceae
Woodsiaceae'
Pteridophytes = unlist(stringr::str_split(Pteridophytes, pattern = '\n'))
Pteridophytes = data.frame(major = rep('Pteridophytes', length(Pteridophytes)), family = Pteridophytes)


Bryophytes = 'Acrobolbaceae
Adelanthaceae
Allisoniaceae
Amblystegiaceae
Anastrophyllaceae
Andreaeaceae
Andreaeobryaceae
Aneuraceae
Antheliaceae
Anthocerotaceae
Archidiaceae
Arnelliaceae
Aulacomniaceae
Aytoniaceae
Balantiopsaceae
Bartramiaceae
Blasiaceae
Brachytheciaceae
Brevianthaceae
Bruchiaceae
Bryaceae
Bryobartramiaceae
Bryoxiphiaceae
Buxbaumiaceae
Calomniaceae
Calymperaceae
Calypogeiaceae
Catagoniaceae
Catoscopiaceae
Cephaloziaceae
Cephaloziellaceae
Chaetophyllopsaceae
Chonecoleaceae
Cinclidotaceae
Cleveaceae
Climaciaceae
Conocephalaceae
Corsiniaceae
Cryphaeaceae
Cyrtopodaceae
Daltoniaceae
Dendrocerotaceae
Dicnemonaceae
Dicranaceae
Diphysciaceae
Disceliaceae
Ditrichaceae
Echinodiaceae
Encalyptaceae
Entodontaceae
Ephemeraceae
Erpodiaceae
Eustichiaceae
Exormothecaceae
Fabroniaceae
Fissidentaceae
Fontinalaceae
Fossombroniaceae
Funariaceae
Geocalycaceae
Gigaspermaceae
Goebeliellaceae
Grimmiaceae
Gymnomitriaceae
Gyrothyraceae
Haplomitriaceae
Hedwigiaceae
Helicophyllaceae
Herbertaceae
Hookeriaceae
Hylocomiaceae
Hymenophytaceae
Hypnaceae
Hypnodendraceae
Hypopterygiaceae
Jackiellaceae
Jubulaceae
Jubulopsaceae
Jungermanniaceae
Lejeuneaceae
Lembophyllaceae
Lepicoleaceae
Lepidolaenaceae
Lepidoziaceae
Leptodontaceae
Lepyrodontaceae
Leskeaceae
Leucodontaceae
Leucomiaceae
Lophocoleaceae
Lophoziaceae
Lunulariaceae
Makinoaceae
Marchantiaceae
Mastigophoraceae
Meesiaceae
Mesoptychiaceae
Meteoriaceae
Metzgeriaceae
Microtheciellaceae
Mitteniaceae
Mizutaniaceae
Mniaceae
Monocarpaceae
Monocleaceae
Monosoleniaceae
Myriniaceae
Myuriaceae
Neckeraceae
Neotrichocoleaceae
Notothyladaceae
Octoblepharaceae
Oedipodiaceae
Orthorrhynchiaceae
Orthotrichaceae
Oxymitraceae
Pallaviciniaceae
Pelliaceae
Phyllodrepaniaceae
Phyllogoniaceae
Pilotrichaceae
Plagiochilaceae
Plagiotheciaceae
Pleurophascaceae
Pleuroziaceae
Pleuroziopsaceae
Polytrichaceae
Porellaceae
Pottiaceae
Prionodontaceae
Pseudoditrichaceae
Pseudolepicoleaceae
Pterigynandraceae
Pterobryaceae
Ptilidiaceae
Ptychomitriaceae
Ptychomniaceae
Racopilaceae
Radulaceae
Regmatodontaceae
Rhabdoweisiaceae
Rhachitheciaceae
Rhacocarpaceae
Rhizogoniaceae
Ricciaceae
Riellaceae
Rigodiaceae
Rutenbergiaceae
Scapaniaceae
Schistochilaceae
Schistostegaceae
Scorpidiaceae
Seligeriaceae
Sematophyllaceae
Serpotortellaceae
Sorapillaceae
Sphaerocarpaceae
Sphagnaceae
Spiridentaceae
Splachnaceae
Splachnobryaceae
Stereophyllaceae
Takakiaceae
Targioniaceae
Tetraphidaceae
Thamnobryaceae
Theliaceae
Thuidiaceae
Timmiaceae
Trachypodaceae
Treubiaceae
Trichocoleaceae
Trichotemnomataceae
Vandiemeniaceae
Vetaformaceae
Viridivelleraceae
Wardiaceae
Wiesnerellaceae'
Bryophytes = unlist(stringr::str_split(Bryophytes, pattern = '\n'))
Bryophytes = data.frame(major = rep('Bryophytes', length(Bryophytes)), family = Bryophytes)

higher_level = rbind(Angiosperms,Gymnosperms,Pteridophytes,Bryophytes)

report  =enriched_report
#restrict to only matched to POWO.
report = report[!is.na(report$POWO_plant_name_id),]
report = report[report$ItemStatusType == 'Existing',]

# only taxa.
report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)
unique_taxa = unique(report$good_name)
wanted_index = match(unique_taxa, report$good_name)
report = report[wanted_index,]
word='Taxa'
      
genus = report$POWO_genus
genus[is.na(genus)] = report$Genus[is.na(genus)]

table_genus = table(genus)
data = data.frame(genus = names(table_genus), count = as.numeric(table_genus))

family = report$POWO_family
family[is.na(family)] = report$Family[is.na(family)]
family[is.na(family)] = 'NA'

data$family = family[match(data$genus, genus)]

data$major = higher_level$major[match(data$family, higher_level$family)]

data = data[,c(4,3,1,2)]
data$major[is.na(data$major)] = 'Unknown Major'


labels = c(unique(data$major), unique(data$family), unique(data$genus))
major_index = 1:length(unique(data$major))
family_index = (max(major_index)+1):(max(major_index)+length(unique(data$family)))
genus_index = (max(family_index)+1):(max(family_index)+length(unique(data$genus)))

parents = rep('', length(labels))
parents[family_index] = data$major[match(labels[family_index], data$family)]
parents[genus_index] = data$family[match(data$genus, labels[genus_index])]

values = rep(NA, length(labels))
values[genus_index] = data$count[match(data$genus, labels[genus_index])]
total_for_families <-  aggregate(. ~family, data[,c(2,4)], sum, na.rm = TRUE)

values[family_index] = total_for_families$count[match(labels[family_index], total_for_families$family)]
total_for_major <-  aggregate(. ~major, data[,c(1,4)], sum, na.rm = TRUE)
values[major_index] = total_for_major$count[match(labels[major_index], total_for_major$major)]


data_formatted = data.frame(labels=  labels, parents = parents, values = values)
data_formatted$text = paste0(data_formatted$labels, '<br>', data_formatted$values, ' Taxa<br>')
 
fig <- plotly::plot_ly(
  labels = data_formatted$labels,
  parents =data_formatted$parents,
  values = data_formatted$values,
  type = 'sunburst',
  insidetextorientation='radial',
  branchvalues = 'total',
  hoverinfo = 'text',
  hovertext = data_formatted$text
)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/','sunburst:taxonomic_diversity.html'))
}

 fig

```


***

#### Verbal Summary including average statistics (previous 5 years)


```{r, formatting data for 5 years ago, echo = F}
###
# Data from 5 years ago.
###
year_cur = as.numeric(format(Sys.Date(),'%Y'))
years = year_cur-5

bad_accession = length(which(report_original$AccYear < 1750 | report_original$AccYear> year_cur | is.na(report_original$AccYear)))

history_index = BGSmartR::exist_at_date(c(Sys.Date()-1, paste0(years, '-01-01')), acc = report_original$AccYear,
                       ItemStatusDate = report_original$ItemStatusDate,
                       ItemStatusType = report_original$ItemStatusType)
 
historic_details = lapply(history_index, function(year_index){
  report_cur = report_original[year_index,]
  
# Number of Items.
no_items = nrow(report_cur)

# Number of Accessions.
no_accessions = length(unique(report_cur$AccNoFull))

# Number of taxa
no_taxa = length(unique(paste0(report_cur$sanitised_taxon, ' ', report_cur$extracted_author)))

#No families.
# = Use POWO family if available if not use the original.
families = data.frame(original = report_cur$Family, POWO = report_cur$POWO_family)
use_family = families$POWO
use_family[is.na(use_family)] = families$original[is.na(use_family)]
no_families <- length(unique(use_family))

#No genus
# = Use POWO genus if available if not use the original.
genus = data.frame(original = report_cur$Genus, POWO = report_cur$POWO_genus)
use_genus = genus$POWO
use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
no_genus <- length(unique(use_genus))


#No species
POWO_GenusSpecies = rep(NA, nrow(report_cur))
POWO_GenusSpecies[!is.na(report_cur$POWO_plant_name_id)] = paste0(report_cur$POWO_genus[!is.na(report_cur$POWO_plant_name_id)],
                                                              ' ',
                                                              report_cur$POWO_species[!is.na(report_cur$POWO_plant_name_id)])
species_data = data.frame(original = report_cur$GenusSpecies, POWO = POWO_GenusSpecies, infra = report_cur$infrageneric_level)

#remove cultivars, indeterminants, hybrids and those without infrageneric level
species_only = species_data[!grepl('5|6|0',species_data$infra),]
species_only = species_only[!is.na(species_only$infra),]

use_species = species_only$POWO
use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
no_species = length(unique(use_species))
species_later = no_species

species_powo = unique(species_only$POWO[!is.na(species_only$POWO)])
species_notpowo = unique(species_only$original[is.na(species_only$POWO)])
species_notpowo = species_notpowo[!species_notpowo %in% species_powo]
  
# Get infra info
hort_info = table(report_cur$infrageneric_level)

# Get provenance
prov_info = table(report_cur$ProvenanceCode)

# Get endemic
endemic_info = table(report_cur$endemic)

# Get red list
redList_info = table(report_cur$redList_category)

return(list(no_items =  no_items,
            no_accessions = no_accessions,
            no_taxa = no_taxa,
            no_families = no_families,
            no_genus =  no_genus,
            no_species = no_species,
            hort_info = hort_info,
            prov_info = prov_info,
            endemic_info = endemic_info,
            redList_info = redList_info
            ))
})
names(historic_details) = c('Current',paste0('Year: ', years))
```


In this section we will compare the composition of the collection to 5 years ago (**`r  as.numeric(format(Sys.Date(),'%Y'))-5`**). To make this possible we use a combination of the accession year and item status date to calculate which plants are existing at each time point. This approach assumes that plants only die when their record is updated to reflect this. 

Your collection contains **`r bad_accession`** items that have either a missing/incorrect accession year such as `0000`, `1000` or `9999`.  As we cannot accurately describe if these plants existed 5 years ago we remove the records prior to the comparison between **`r  as.numeric(format(Sys.Date(),'%Y'))-5`** and **`r year_cur`**. 

```{r, Creating compare now to 5 years ago, echo = FALSE}
summary_numbers = data.frame(lapply(historic_details, function(x){
  endemic =  as.numeric(x$endemic_info[match('Endemic', names(x$endemic_info))])
  threatened = sum(x$redList_info[grepl('CR|EN|EW|EX|VU', names(x$redList_info))])
  return(c(x$no_items, 
           x$no_accessions,
           x$no_taxa,
           x$no_families,
           x$no_genus,
           x$no_species, 
           endemic,
           threatened
         ))
}))
sum_names = c('no_items', 
           'no_accessions',
           'no_taxa',
           'no_families',
           'no_genus',
           'no_species','endemic','threatened')

rownames(summary_numbers) = sum_names

nice_names = c('Number of Items', 
           'Number of Accessions',
           'Number of Taxa',
           'Number of Families',
           'Number of Genus',
           'Number of Species',
           'Number of Endemic',
           'Number of Threatened')
# Decide text to say whether the garden size are shrunk or grown over the last 5 years.
if(summary_numbers[1,1] - summary_numbers[1,2] > 0){
  grow_shrink = paste0('grown by ',  round((summary_numbers[1,1]/summary_numbers[1,2]-1)*100,digits=1),
                       '%.')
}else if(summary_numbers[1,1] - summary_numbers[1,2] < 0) {
   grow_shrink = paste0('shrunk by ',
                        round((1-summary_numbers[1,1]/summary_numbers[1,2])*100,digits=1),
                         '%.')
}else{
   grow_shrink = 'remained the same size.'
}

# Summary text for each group (taxa, families, etc)
grown = NULL
not_grown = NULL
same = NULL
for(i in 3:nrow(summary_numbers)){
  if(summary_numbers[i,1] - summary_numbers[i,2] > 0){
  grown = paste0(grown, '- ',nice_names[i],' has grown by ',  round((summary_numbers[i,1]/summary_numbers[i,2]-1)*100,digits=1),
                       '%. <br>')
}else if(summary_numbers[i,1] - summary_numbers[i,2] < 0) {
   not_grown = paste0(not_grown, '- ',nice_names[i], ' has shrunk by ',
                        round((1-summary_numbers[i,1]/summary_numbers[i,2])*100,digits=1),
                         '%. <br>')
}else{
   same = paste0(same, ', ', nice_names[i] )
}
}
if(!is.null(grown)){
  grown = paste0('We see that the following parts have grown in the last 5 years: <br> <br>',grown)
}
if(!is.null(not_grown)){
  not_grown = paste0('We see that the following parts have shrunk in the last 5 years: <br> <br>',not_grown)
}
if(!is.null(same)){
  same = paste0(same, 'have remained the same.')
}
 
# Relative proportion of endemic and threatened.
endemic_index = which(sum_names == 'endemic') 
endemic_prop = summary_numbers[endemic_index,]/ summary_numbers[1,]*100
endemic_diff = endemic_prop[1]- endemic_prop[2]
if(abs(endemic_diff) >0.01){
  if(endemic_diff > 0.01){
     endemic_text = paste0('increased from ',round(endemic_prop[2],digits=2),'% to ',round(endemic_prop[1],digits=2),'%')
  }else{
    endemic_text = paste0('decreased from ',round(endemic_prop[2],digits=2),'% to ',round(endemic_prop[1],digits=2),'%')
  }
}else{
  endemic_text = 'remained the same'
}

threat_index = which(sum_names == 'threatened') 
threat_prop = summary_numbers[threat_index,]/ summary_numbers[1,]*100
threat_diff = threat_prop[1]- threat_prop[2]
if(abs(threat_diff) >0.01){
  if(threat_diff > 0.01){
     threat_text = paste0('increased from ',round(threat_prop[2],digits=2),'% to ',round(threat_prop[1],digits=2),'%')
  }else{
    threat_text = paste0('decreased from ',round(threat_prop[2],digits=2),'% to ',round(threat_prop[1],digits=2),'%')
  }
}else{
  threat_text = 'remained the same'
}
  

rownames(summary_numbers) = nice_names

colnames(summary_numbers) = c('Current', as.character(years))
summary_numbers = summary_numbers[,c(2,1)]
DT::datatable(summary_numbers)
```

From the table above, we see that the number of items in the collection has **`r grow_shrink`**


**`r grown` `r not_grown` `r same`**

The proportion of the collection that is threatened has **`r threat_text`**, and the proportion that is endemic has **`r endemic_text`**.

The growth rate of the collection in the last five years is **`r round((summary_numbers[2,2]/summary_numbers[2,1])^(0.2) -1,digits=2)`**.

***

```{r, creating excel output, echo=F}
# Return excel workbook with data for each figure and table
if(create_excel){
  library(xlsx)
wb = xlsx::createWorkbook()
sh1 = xlsx::createSheet(wb, 'How many elements')
xlsx::addDataFrame(basics[,rev(1:2)], sh1, startRow = 1,row.names = F)
sh2 = xlsx::createSheet(wb, 'How many of each taxonomic units')
xlsx::addDataFrame(taxa[,rev(1:2)], sh2, startRow = 1,row.names = F)
sh3 = xlsx::createSheet(wb, 'Species, Horticultral, infraspecific')
xlsx::addDataFrame(taxa_infra[,rev(1:ncol(taxa_infra))], sh3, startRow = 1,row.names = F)
sh4 = xlsx::createSheet(wb, 'Provenance')
xlsx::addDataFrame(provenance[,1:2], sh4, startRow = 1,row.names = F)
sh5 = xlsx::createSheet(wb, 'Geography')
xlsx::addDataFrame(details[,c(1:2,5:6)], sh5, startRow = 1,row.names = F)
sh6 = xlsx::createSheet(wb, 'Endemic')
xlsx::addDataFrame(endemic[,1:2], sh6, startRow = 1,row.names = F)
sh7 = xlsx::createSheet(wb, 'Threatened')
xlsx::addDataFrame(threat[,1:2], sh7, startRow = 1,row.names = F)
sh8 = xlsx::createSheet(wb, 'Red list category')
xlsx::addDataFrame(threat_type[,1:2], sh8, startRow = 1,row.names = F)
sh9 = xlsx::createSheet(wb, 'Global collections')
xlsx::addDataFrame(extant_gardens[,1:2], sh9, startRow = 1,row.names = F)
sh10 = xlsx::createSheet(wb, 'Taxonomic diversity')
xlsx::addDataFrame(data_formatted[,c(1,3)], sh10, startRow = 1)
sh10 = xlsx::createSheet(wb, 'Compare to 5 year ago')
xlsx::addDataFrame(summary_numbers, sh11, startRow = 1)
xlsx::saveWorkbook(wb, file = paste0(output_dir,'/',collection,'_data_for_figures.xlsx'))
}

```
