---
title: "Retrospective Overview of the Collection - Whole Collection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(ggplot2)
library(plotly)
library(rjson)
library(xlsx)
library(sf)
```


```{r, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - min_year for retrospective reports.
# - collection the name to be printed in the report.

# load('/Users/jakepowell/Cambridge/Enriched reports/CUBG_enriched_report.rda')
# report = enriched_report
# collection = 'CUBG'
# create_excel = TRUE
# save_widgets = TRUE
# min_year = 1980
# collection_coords = c(0.128305,52.193403)
# do_coord = !is.na(collection_coords[1])
# output_dir = getwd()

report = enriched_report

if(save_widgets){
  widget_dir = paste0(output_dir,'/',collection,'_Widgets')
  dir.create(widget_dir,showWarnings = FALSE)
  
  whole_collection_widget_dir = paste0(widget_dir,'/Whole_collection')
  dir.create(whole_collection_widget_dir,showWarnings = FALSE)
    
  new_accessions_widget_dir = paste0(widget_dir,'/New_accessions')
  dir.create(new_accessions_widget_dir,showWarnings = FALSE)
  
  lost_accessions_widget_dir = paste0(widget_dir,'/Lost_accessions')
  dir.create(lost_accessions_widget_dir,showWarnings = FALSE)
  
  net_accessions_widget_dir = paste0(widget_dir,'/Net_accessions')
  dir.create(net_accessions_widget_dir,showWarnings = FALSE)
}

# Add endemic/notendemic split.
report$endemic = rep(NA, nrow(report))
report$endemic[!is.na(report$POWO_Dist_area_code_l3)] = 'Not Endemic'
endemic_index = which(stringr::str_length(report$POWO_Dist_area_code_l3) ==3)
report$endemic[endemic_index] = 'Endemic'

# Add threatened/notthreatened split.
report$threatened = rep('Not Threatened', nrow(report))
threat_index = which(report$redList_category %in% c('VU','EN','CR', 'EW', 'EX'))
report$threatened[threat_index] = 'Threatened'

# Update the original family to only have first letter capitalised.
report$Family = stringr::str_to_title(report$Family)

# Set the min year of the report
if(is.null(min_year)){
  min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
}

# Load the geographic information.
wgsrpd3 = BGSmartR::wgsrpd3

# Extract the location of the collection (if we have coordinates)
if(do_coord){
pnts <- data.frame( x = collection_coords[1], y = collection_coords[2])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
level3_name = collection_geog_details$LEVEL3_NAM
level3_code = collection_geog_details$LEVEL3_COD
level2_name = collection_geog_details$LEVEL2_NAM
level2_code = collection_geog_details$LEVEL2_COD
level1_name = collection_geog_details$LEVEL1_NAM
level1_code = collection_geog_details$LEVEL1_COD

text = paste0(level3_name, ', ', level2_name, ', ', level1_name,'.')

}

# Get the current year.
year_cur = as.numeric(format(Sys.Date(),'%Y'))

# extract and calculate the number of bad accessions years.
bad_accessions_index = which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear))
if(length(bad_accessions_index)>0){
  bad_accessions = report[which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear)),]
  no_bad_accessions = nrow(bad_accessions)
  #Export the bad accessions.
  write.csv(bad_accessions[,1:(which(names(bad_accessions) == 'sanitised_taxon')-1)], file = paste0(output_dir,'/', collection,'_issue_accession_year.csv'), row.names = FALSE)
  # Reduce report to not include those with bad accessions.
  report = report[-which(report$AccYear < 1750 | report$AccYear> year_cur | is.na(report$AccYear)),]
} else{
  no_bad_accessions = 0 
}





```

This report uses data from **`r collection`** and analyses the collection from **`r min_year`** to **`r year_cur`**.

 A retrospective overview uses a combination of the accession year and item status date to calculate which plants are existing each year. This approach assumes that plants only die when their record is updated to reflect this. 

The collection contains **`r no_bad_accessions`** items that have either a missing/incorrect accession year, since we cannot accurately describe when these plants are existing we remove these records for the following analysis. These records can be found in the file **`r collection`_issue_accession_year.csv**.

This document outlines the changes in the number of accessions, items, taxa, species, families, genera, provenance, endemic species and threatened species. 


<hr style="border:4px solid gray">

## Whole Collection

```{r, whole collection, echo = F}
# Create index data frame for which plants are existing each year. 
years = min_year:year_cur
date = paste0(years, '-01-01')
plant_existing = BGSmartR::exist_at_date(date, acc = report$AccYear,
                       ItemStatusDate = report$ItemStatusDate,
                       ItemStatusType = report$ItemStatusType)

#  Extract the desired information fro each year.
time_series_info = lapply(plant_existing, function(x){
  garden_current = report[x,]
  
  # Number of families.
  families = data.frame(original = garden_current$Family, POWO = garden_current$POWO_family)
  use_family = families$POWO
  use_family[is.na(use_family)] = families$original[is.na(use_family)]
  family = unique(use_family)
  no_families <- length(family)

  # Number of genera.
  genus = data.frame(original = garden_current$Genus, POWO = garden_current$POWO_genus)
  use_genus = genus$POWO
  use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
  no_genus <- length(unique(use_genus))


   #No species (#remove cultivars, indeterminants, hybrids and those without infrageneric level)
  POWO_GenusSpecies = rep(NA, nrow(garden_current))
  POWO_GenusSpecies[!is.na(garden_current$POWO_plant_name_id)] = paste0(garden_current$POWO_genus[!is.na(garden_current$POWO_plant_name_id)], ' ', garden_current$POWO_species[!is.na(garden_current$POWO_plant_name_id)])
  species_data = data.frame(original = garden_current$GenusSpecies, POWO = POWO_GenusSpecies, infra = garden_current$infrageneric_level)
  species_only = species_data[!grepl('5|6|0',species_data$infra),]
  species_only = species_only[!is.na(species_only$infra),]
  use_species = species_only$POWO
  use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
  no_species = length(unique(use_species))
  
  # Number of Taxa.
    taxa = data.frame(sanitsed_name = paste0(garden_current$sanitised_taxon, ' ', garden_current$extracted_author), powo_name = paste0(garden_current$POWO_taxon_name, ' ', garden_current$POWO_taxon_authors))
    taxa$powo_name[taxa$powo_name == 'NA NA'] = NA
  use_taxa = taxa$powo_name
  use_taxa[is.na(use_taxa)] = taxa$sanitsed_name[is.na(use_taxa)]
  no_taxa <- length(unique(use_taxa))

  # Number of accessions.
  no_accessions = length(unique(garden_current$AccNoFull))
  
  # Number of items
  no_items = nrow(garden_current)
  
  # Breakdown of infrageneric diversity.
  breakdown_infrageneric = table(garden_current$infrageneric_level)
  
  # Breakdown of provenance.
  breakdown_provenance = table(garden_current$ProvenanceCode)
  
  # Breakdown of endemic
  breakdown_endemic = table(garden_current$endemic)
  
  # Number of endemic (local)
  if(do_coord){
    no_endemic_local = sum(garden_current$POWO_Dist_area_code_l3[garden_current$endemic == 'Endemic'] == level3_code, na.rm = T)
  }else{
    no_endemic_local = NA
  }
  breakdown_endemic = table(garden_current$endemic)
  
  # Breakdown of threatened
  breakdown_threatened = table(garden_current$threatened)
  
  # Breakdown of threatened categories
  breakdown_threatened_cateogory = table(garden_current$redList_category)
  breakdown_threatened_cateogory = breakdown_threatened_cateogory[match(c('VU','EN','CR', 'EW', 'EX'), names(breakdown_threatened_cateogory))]
  
  # Breakdown of geographic regions.
  # no_regions = length(wgsrpd3$LEVEL3_COD)
  # no_plants = rep(NA,no_regions)
  # no_unique_plants = rep(NA,no_regions)
  # for(i in 1:no_regions){
  #   index = grepl(pattern =  wgsrpd3$LEVEL3_COD[i], x = garden_current$POWO_Dist_area_code_l3) 
  #   if(any(index)){
  #     no_plants[i] = sum(index)
  #     no_unique_plants[i] = length(unique(garden_current$good_name[index]))
  #   }
  # }
  # no_plants[is.na(no_plants)] = 0
  # no_unique_plants[is.na(no_unique_plants)] = 0
  # breakdown_geography =  no_plants
  # breakdown_geography_unique =  no_unique_plants
  # 
  
  return(list(no_families = no_families, family = family, no_genus = no_genus, no_species = no_species, no_taxa = no_taxa, no_accessions = no_accessions, no_items = no_items, breakdown_infrageneric = breakdown_infrageneric, breakdown_provenance = breakdown_provenance, breakdown_endemic = breakdown_endemic, no_endemic_local = no_endemic_local, breakdown_threatened = breakdown_threatened, breakdown_threatened_cateogory = breakdown_threatened_cateogory))
})
names(time_series_info) = names(plant_existing)
```

In this section we look at how the composition of the whole collection varies.

### What is the change over time in all elements (accessions, items, taxa, species) or taxonomic units (families, genera, etc ) 


#### Change in Number of Items

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_items = unlist(lapply(time_series_info, function(x){x$no_items}))
items_data = data.frame(year = as.numeric(stringr::str_extract(names(no_items),'[0-9]{4}')), no_items = no_items)
items_data$text = paste0('Date: ',names(no_items), ' <br>', 'Items: ', items_data$no_items)

fig <- plot_ly(items_data, x = ~year, y = ~no_items, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_items.html'),selfcontained = T)
}

fig
```

The number of items is defined by the number of 'existing' records. By 'existing' we mean that the current date is after the item's accession year and the item is still existing. 


#### Change in Number of Accessions

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_accessions = unlist(lapply(time_series_info, function(x){x$no_accessions}))
accessions_data = data.frame(year = years, no_accessions = no_accessions)
accessions_data$text = paste0('Date: ',years, ' <br>', 'Accessions: ', accessions_data$no_accessions)

fig <- plot_ly(accessions_data, x = ~year, y = ~no_accessions, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_accessions.html'),selfcontained = T)
}
fig
```

We use `AccNoFull` from the original report. 

***

#### Change in Number of Taxa

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_taxa = unlist(lapply(time_series_info, function(x){x$no_taxa}))
taxa_data = data.frame(year = years, no_taxa = no_taxa)
taxa_data$text = paste0('Date: ',years, ' <br>', 'Taxa: ', taxa_data$no_taxa)

fig <- plot_ly(taxa_data, x = ~year, y = ~no_taxa, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Taxa")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_taxa.html'),selfcontained = T)
}
fig
```

We use the accepted name from POWO where possible. If no match was found, we use the sanitised name and author (standardise symbols/capitalisation) from the information provided. 

***

#### Change in Number of Species

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_species = unlist(lapply(time_series_info, function(x){x$no_species}))
species_data = data.frame(year = as.numeric(stringr::str_extract(names(no_species),'[0-9]{4}')), no_species = no_species)
species_data$text = paste0('Date: ',years, ' <br>', 'Species: ', species_data$no_species)

fig <- plot_ly(species_data, x = ~year, y = ~no_species, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Species")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_species.html'),selfcontained = T)
}
fig
```

We ignore records that are indeterminants, cultivars and hybrids. We then use `GenusSpecies` from matched POWO records where available, otherwise we use `GenusSpecies` from the original report. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`. 

***

#### Combined items, accessions, taxa, species

To combine viewing the changes in items, accessions, taxa and species into a single plot we scale the number of each such that the maximum value is one and the minimum value is zero (by dividing by the maximum value.

```{r, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
combined1_data = data.frame(items_data[,1:2],
                            no_accessions = accessions_data[,2],
                            no_taxa = taxa_data[,2],
                            no_species = species_data[,2])
colours = c(1,viridis::inferno(ncol(combined1_data)-1))

combined1B_data=combined1_data
for(i in 2:ncol(combined1_data)){
  combined1_data[[i]] = combined1_data[[i]]/max(combined1_data[[i]], na.rm=T)
}
names(combined1_data) = c('Year', 'Items', 'Accessions', 'Taxa', 'Species')
fig1 <- plot_ly(combined1_data, x = ~Year)
fig1 <- fig1 %>%  add_trace(x = ~Year, y = 0, hoverinfo='text', type = 'scatter', text = ~Year,
            mode = 'markers', marker=list(size=0, color='white'),
            showlegend=FALSE, opacity=0)
for(i in 2:ncol(combined1_data)){
  fig1 <- fig1 %>% add_trace(y = combined1_data[[i]], name = names(combined1_data)[i], mode = 'lines',type = 'scatter', line = list(color = colours[i]), text=paste0(names(combined1_data)[i], ': ',combined1B_data[[i]]), hoverinfo = 'text') 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified',
         yaxis = list(showline= F, showticklabels = F))

if(save_widgets){
  htmlwidgets::saveWidget(fig1, file = paste0(whole_collection_widget_dir,'/Line_no_items_acessions_taxa_species.html'),selfcontained = T)
}

fig1

```

#### Change in the Number of Families

```{r, echo = F, fig.dim = c(10, 4)}
families = unlist(lapply(time_series_info, function(x){x$no_families}))
families_data = data.frame(year = years, no_families = families)
families_data$text = paste0('Date: ',names(families), ' <br>', 'Families: ', families_data$no_families)

fig <- plot_ly(families_data, x = ~year, y = ~no_families, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Families")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_families.html'),selfcontained = T)
}

fig
```

We use the family taken from matched POWO record where available, otherwise we use the family from the original report.

```{r, echo = F}
families = lapply(time_series_info, function(x){x$family})
all_families = unique(unlist(families))
all_families= all_families[!is.na(all_families)]
no_all_families = length(all_families)

years_in_garden_all_family = data.frame(lapply(all_families, function(family){
  years_in_garden = unlist(lapply(families, function(family_year){
    return(family %in% family_year)
  }))
}))
years_in_garden_all_family = t(years_in_garden_all_family)
rownames(years_in_garden_all_family) = all_families
years_in_garden_all_family = data.frame(years_in_garden_all_family)
names(years_in_garden_all_family) = stringr::str_extract(names(years_in_garden_all_family), '[0-9]{4}')

family_not_in_garden_cur = all_families[!years_in_garden_all_family[[ncol(years_in_garden_all_family)]]]
family_not_in_garden_cur_index = which(!years_in_garden_all_family[[ncol(years_in_garden_all_family)]])

number_of_years = rep(0, nrow(years_in_garden_all_family))
years_shortened = rep(NA, nrow(years_in_garden_all_family))

for(jjj in 1:nrow(years_in_garden_all_family)){
  cur = years_in_garden_all_family[jjj,]
  years_in = as.numeric(names(years_in_garden_all_family)[unlist(cur)])
  no_years_in = length(years_in)
  #Reduce to only change in years.
  keep = NULL ; diff = 0
  for(i in 1:length(years_in)){
    if(i ==1){
      keep =  c(keep,years_in[i])
      prev = years_in[i]
    } else if(i ==length(years_in)){
      if(years_in[i-1] == years_in[i] -1){
        keep =  c(keep, '-', years_in[i])
      } else{
        keep =  c(keep, ', ', years_in[i])  
      }
    } else if(i ==2){
      if(years_in[i-1] != years_in[i] -1){
        keep = c(keep, ', ', years_in[i])
    }
    else{
      now = years_in[i]
      prev = years_in[i-1]
      prev_2 = years_in[i-2]
      if(now != prev+1){
        if(prev == prev_2 +1){
          keep = c(keep, '-',now)
        } else{
           keep = c(keep, ', ',now)
        }
      }
    }
  }
  
  
  
  
  }
  keep = paste0(keep, collapse ='')
  
  number_of_years[jjj] = no_years_in
  years_shortened[jjj] = keep
}

table_families = data.frame(all_families, number_of_years, years_shortened)
names(table_families) = c('Family', 'Number of Years', 'Years')
```

Throughout the years there has been **`r no_all_families`** families in the collection. Of these **`r length(family_not_in_garden_cur)`** are no longer present. `r if(length(family_not_in_garden_cur_index) > 0){'These families are outlined in the table below.'}`

```{r,echo = F}
if(length(family_not_in_garden_cur_index) > 0){
  DT::datatable(table_families[family_not_in_garden_cur_index,], rownames = FALSE)
}

```

***

#### Change in Number of Genera

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_genus = unlist(lapply(time_series_info, function(x){x$no_genus}))
genus_data = data.frame(year = as.numeric(stringr::str_extract(names(no_genus),'[0-9]{4}')), no_genus = no_genus)
genus_data$text = paste0('Date: ',names(no_genus), ' <br>', 'Genus: ', genus_data$no_genus)

fig <- plot_ly(genus_data, x = ~year, y = ~no_genus, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Genera")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_genera.html'),selfcontained = T)
}

fig
```

We use the genus taken from matched POWO record where available, otherwise we use the genus from the original report.

***

#### Combined family, genera and species

To combine viewing the changes in family, genera and species into a single plot we scale the number of each such that the maximum value is one and the minimum value is zero (by dividing by the maximum value.

```{r, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
combined2_data = data.frame(families_data[,1:2],
                            no_genus = genus_data[,2],
                            no_species = species_data[,2])
colours = c(1,viridis::inferno(ncol(combined1_data)-1))

combined2B_data=combined2_data
for(i in 2:ncol(combined2_data)){
  combined2_data[[i]] = combined2_data[[i]]/max(combined2_data[[i]], na.rm=T)
}
names(combined2_data) = c('Year', 'Families', 'Genera', 'Species')

fig1 <- plot_ly(combined2_data, x = ~Year)
fig1 <- fig1 %>%  add_trace(x = ~Year, y = 0, hoverinfo='text', type = 'scatter', text = ~Year,
            mode = 'markers', marker=list(size=0, color='white'),
            showlegend=FALSE, opacity=0)
for(i in 2:ncol(combined2_data)){
  fig1 <- fig1 %>% add_trace(y = combined2_data[[i]], name = names(combined2_data)[i], mode = 'lines',type = 'scatter', line = list(color = colours[i]), text=paste0(names(combined2_data)[i], ': ',combined2B_data[[i]]), hoverinfo = 'text') 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified',
         yaxis = list(showline= F, showticklabels = F))

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_no_families_genera_species.html'),selfcontained = T)
}

fig1

```

<hr style="border:4px solid gray">

### Change in the number of species, infraspecific, and cultivars

We group the plants into:

- Indeterminant: consists of indeterminant plants.
- Species: consists of species, where subspecies, varieties and forma have not been included.
- Infraspecific: includes subspecies (subsp.), varieties (var.) and forma (f.).
- Horticultural: consists of hybrids and cultivars.


```{r, echo = F}
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_infrageneric
  
  indet = sum(as.numeric(details[grepl('0',names(details))]))
  species = sum(as.numeric(details[grepl('1',names(details))]))
  infra = sum(as.numeric(details[grepl('2|3|4',names(details))]))
  hort = sum(as.numeric(details[grepl('5|6',names(details))]))
  
  return(c(indet, species, infra, hort))
  }))))
names(no_items) = c('Indeterminate', 'Species', 'Infraspecific', 'Horticultral')
prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
infra_data = data.frame(year = years, no_items, prop)
infra_data$text = paste0('Date: ', names(time_series_info), ' <br>', 'Indeterminat: ', infra_data$indet,
                   ' <br>', 'Species: ', infra_data$species,
                   ' <br>', 'Infraspecific: ', infra_data$infra,
                   ' <br>', 'Horticultral: ', infra_data$hort)
```


#### Change in Total Number of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## Grouped species, hort etc RAW NUMBERS FOUR GRAPH OPTIONS.
infra_data1 = infra_data[,1:(length(no_items)+1)]
infra_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(infra_columns))
infra_labels = names(infra_data1)[infra_columns]

fig1 <- plot_ly(infra_data1, x = ~year) 
for(i in 1:length(infra_columns)){
  fig1 <- fig1 %>% add_trace(y = infra_data1[,infra_columns[i]], name = infra_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(infra_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(infra_columns)){
  fig2 <- fig2 %>% add_trace(y = infra_data1[,infra_columns[i]], name = infra_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(infra_data1, x = ~year)
for(i in 1:length(infra_columns)){
  fig3 <- fig3 %>% add_trace(y = infra_data1[,infra_columns[i]],
                             name = infra_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(infra_data1, x = ~year)
for(i in 1:length(infra_columns)){
  fig4 <- fig4 %>% add_trace(y = infra_data1[,infra_columns[i]],
                             type='bar',
                             name = infra_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/number_species_infraspecific_and_cultivars.html'),selfcontained = T)
}

fig
```


#### Change in Proportion of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## Grouped species, hort etc RAW NUMBERS FOUR GRAPH OPTIONS.
infra_data1 = infra_data[,c(1, which(grepl('prop', names(infra_data))))]
infra_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(infra_columns))
infra_labels = names(no_items)

fig1 <- plot_ly(infra_data1, x = ~year) 
for(i in 1:length(infra_columns)){
  fig1 <- fig1 %>% add_trace(y = infra_data1[,infra_columns[i]], name = infra_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(infra_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(infra_columns)){
  fig2 <- fig2 %>% add_trace(y = infra_data1[,infra_columns[i]], name = infra_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(infra_data1, x = ~year)
for(i in 1:length(infra_columns)){
  fig3 <- fig3 %>% add_trace(y = infra_data1[,infra_columns[i]],
                             name = infra_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(infra_data1, x = ~year)
for(i in 1:length(infra_columns)){
  fig4 <- fig4 %>% add_trace(y = infra_data1[,infra_columns[i]],
                             type='bar',
                             name = infra_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(widget_dir, '/Whole_Collection/','proportion_species_infraspecific_and_cultivars.html'),selfcontained = T)
}

fig
```

<hr style="border:4px solid gray">

### Change in Provenance

```{r, echo = F}
#Get the unique Provenance codes for the collection
unique_provenance_values = unique(report$ProvenanceCode)

# Get the number of plants with provenance code for each year.
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_provenance
  
  no_prov = as.numeric(details[match(unique_provenance_values, names(details))])
  no_prov[is.na(no_prov)] = 0
  # garden = sum(as.numeric(details[grepl('G',names(details))]))
  # unknown = sum(as.numeric(details[grepl('U',names(details))]))
  # wild = sum(as.numeric(details[grepl('W',names(details))]))
  return(no_prov)
  # return(c(garden, unknown, wild))
  }))))
names(no_items) = unique_provenance_values
# Change the labels for known provenances.
names(no_items)[match(c('G','W','U'), names(no_items))[!is.na(match(c('G','W','U'), names(no_items)))]] = c('Garden', 'Wild', 'Unknown')[!is.na(match(c('G','W','U'), names(no_items)))]

prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
prov_data = data.frame(year = years, no_items, prop)
```

To extract provenance information we use the data field `ProvenanceCode`.
The collection has provenance codes: **`r paste0(unique_provenance_values, collapse=', ')`**.

Where we have:

- G = Garden: plants of garden origin.
- W = Wild: plants of wild origin.
- U = Unknown: plants whose origin is unknown.

`r if(any(is.na(report$ProvenanceCode))){ paste0('The collection contains ', sum(is.na(report$ProvenanceCode)), ' records that have missing provenance code. We remove these plants before considering how the provenance has changed over time.')}`

#### Change in Total Number of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE RAW NUMBERS FOUR GRAPH OPTIONS.
prov_data1 = prov_data[,1:(length(no_items)+1)]
prov_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(prov_columns))
prov_labels = names(prov_data1)[prov_columns]

fig1 <- plot_ly(prov_data1, x = ~year) 
for(i in 1:length(prov_columns)){
  fig1 <- fig1 %>% add_trace(y = prov_data1[,prov_columns[i]], name = prov_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(prov_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(prov_columns)){
  fig2 <- fig2 %>% add_trace(y = prov_data1[,prov_columns[i]], name = prov_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(prov_data1, x = ~year)
for(i in 1:length(prov_columns)){
  fig3 <- fig3 %>% add_trace(y = prov_data1[,prov_columns[i]],
                             name = prov_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(prov_data1, x = ~year)
for(i in 1:length(prov_columns)){
  fig4 <- fig4 %>% add_trace(y = prov_data1[,prov_columns[i]],
                             type='bar',
                             name = prov_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/number_provenance.html'),selfcontained = T)
}

fig
```


#### Change in Proportion of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE Proportion FOUR GRAPH OPTIONS.
prov_data1 = prov_data[,c(1,which(grepl('prop',names(prov_data))))]
prov_columns = 2:(length(no_items)+1)
colours = viridis::inferno(length(prov_columns))
prov_labels = names(no_items)

fig1 <- plot_ly(prov_data1, x = ~year) 
for(i in 1:length(prov_columns)){
  fig1 <- fig1 %>% add_trace(y = prov_data1[,prov_columns[i]], name = prov_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(prov_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(prov_columns)){
  fig2 <- fig2 %>% add_trace(y = prov_data1[,prov_columns[i]], name = prov_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(prov_data1, x = ~year)
for(i in 1:length(prov_columns)){
  fig3 <- fig3 %>% add_trace(y = prov_data1[,prov_columns[i]],
                             name = prov_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(prov_data1, x = ~year)
for(i in 1:length(prov_columns)){
  fig4 <- fig4 %>% add_trace(y = prov_data1[,prov_columns[i]],
                             type='bar',
                             name = prov_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/proportion_provenance.html'),selfcontained = T)
}

fig
```

<hr style="border:4px solid gray">

### Change in Endemic Species

```{r, echo = F}
unique_no_endemic_values = unique(report$endemic)[!is.na(unique(report$endemic))]

# Get the number of plants with provenance code for each year.
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_endemic
  
  no_endemic = as.numeric(details[match(unique_no_endemic_values, names(details))])
  no_endemic[is.na(no_endemic)] = 0

  return(no_endemic)
  }))))
names(no_items) = unique_no_endemic_values

prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
endemic_data = data.frame(year = years, no_items, prop)
```

To extract which species are endemic we first match to POWO to retrieve geographic information. Then a taxa is classed as endemic if it belongs to a single BRU level 3 region. 

Therefore, we require a match to POWO to know if a taxa is endemic or not. In the collection there are **`r sum(is.na(report$endemic))`** items that could not be matched to POWO. For the figures shown below we REMOVE these items. 

#### Change in Total Number of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE RAW NUMBERS FOUR GRAPH OPTIONS.
endemic_data1 = endemic_data[,1:(length(no_items)+1)]
endemic_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(endemic_columns))
endemic_labels = names(endemic_data1)[endemic_columns]
endemic_labels = stringr::str_replace_all(endemic_labels, '\\.', ' ')

fig1 <- plot_ly(endemic_data1, x = ~year) 
for(i in 1:length(endemic_columns)){
  fig1 <- fig1 %>% add_trace(y = endemic_data1[,endemic_columns[i]], name = endemic_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(endemic_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(endemic_columns)){
  fig2 <- fig2 %>% add_trace(y = endemic_data1[,endemic_columns[i]], name = endemic_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(endemic_data1, x = ~year)
for(i in 1:length(endemic_columns)){
  fig3 <- fig3 %>% add_trace(y = endemic_data1[,endemic_columns[i]],
                             name = endemic_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(endemic_data1, x = ~year)
for(i in 1:length(endemic_columns)){
  fig4 <- fig4 %>% add_trace(y = endemic_data1[,endemic_columns[i]],
                             type='bar',
                             name = endemic_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/number_endemic.html'),selfcontained = T)
}

fig
```


#### Change in Proportion of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE Proportion FOUR GRAPH OPTIONS.
endemic_data1 = endemic_data[,c(1,which(grepl('prop',names(endemic_data))))]
endemic_columns = 2:(length(no_items)+1)
colours = viridis::inferno(length(endemic_columns))
endemic_labels = names(no_items)

fig1 <- plot_ly(endemic_data1, x = ~year) 
for(i in 1:length(endemic_columns)){
  fig1 <- fig1 %>% add_trace(y = endemic_data1[,endemic_columns[i]], name = endemic_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(endemic_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(endemic_columns)){
  fig2 <- fig2 %>% add_trace(y = endemic_data1[,endemic_columns[i]], name = endemic_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(endemic_data1, x = ~year)
for(i in 1:length(endemic_columns)){
  fig3 <- fig3 %>% add_trace(y = endemic_data1[,endemic_columns[i]],
                             name = endemic_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(endemic_data1, x = ~year)
for(i in 1:length(endemic_columns)){
  fig4 <- fig4 %>% add_trace(y = endemic_data1[,endemic_columns[i]],
                             type='bar',
                             name = endemic_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/proportion_endemic.html'),selfcontained = T)
}

fig
```


The collection is located in `r level3_name`. Below we show how the number of plants endemic to `r level3_name` changes over time. 

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_endemic_local = unlist(lapply(time_series_info, function(x){x$no_endemic_local}))
endemic_local_data = data.frame(year = as.numeric(stringr::str_extract(names(time_series_info),'[0-9]{4}')), no_endemic_local = no_endemic_local)
endemic_local_data$text = paste0('Date: ',names(time_series_info), ' <br>', 'Local Endemic: ', endemic_local_data$no_endemic_local)

fig <- plot_ly(endemic_local_data, x = ~year, y = ~no_endemic_local, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig <- fig %>% layout(hovermode = 'x')

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/Line_endemic_local.html'),selfcontained = T)
}

fig
```


<hr style="border:4px solid gray">

### Change in Threatened Species

```{r, echo = F}
unique_no_threatened_values = unique(report$threatened)[!is.na(unique(report$threatened))]

# Get the number of plants with provenance code for each year.
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_threatened
  
  no_threatened = as.numeric(details[match(unique_no_threatened_values, names(details))])
  no_threatened[is.na(no_threatened)] = 0

  return(no_threatened)
  }))))
names(no_items) = unique_no_threatened_values

prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
threatened_data = data.frame(year = years, no_items, prop)
```

To extract which species are threatened we  match to IUCN red list. Then a taxa is classed as threatened if it is either: vulnerable, endangered, critically endangered, extinct in the wild or extinct. Note that we plants are matched to a recent version of IUCN red list. Therefore, the time series figures below do not account for the changing nature of the IUCN red list. For example the collection could contain an extinct plant in the 1970s, this does not mean the plant was necessarily extinct then but that the plant is now classed as extinct. 

Therefore, we require a match to IUCN red list to know if a taxa is threatened or not. In the collection there are **`r sum(is.na(report$redList_category))`** items that could not be matched to IUCN red list. In this case we assume taxa not found in IUCN red list are NOT THREATENED.

#### Change in Total Number of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE RAW NUMBERS FOUR GRAPH OPTIONS.
threatened_data1 = threatened_data[,1:(length(no_items)+1)]
threatened_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(threatened_columns))
threatened_labels = names(threatened_data1)[threatened_columns]
threatened_labels = stringr::str_replace_all(threatened_labels, '\\.', ' ')

fig1 <- plot_ly(threatened_data1, x = ~year) 
for(i in 1:length(threatened_columns)){
  fig1 <- fig1 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(threatened_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(threatened_columns)){
  fig2 <- fig2 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig3 <- fig3 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             name = threatened_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig4 <- fig4 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             type='bar',
                             name = threatened_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/number_threatened.html'),selfcontained = T)
}

fig
```


#### Change in Proportion of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE Proportion FOUR GRAPH OPTIONS.
threatened_data1 = threatened_data[,c(1,which(grepl('prop',names(threatened_data))))]
threatened_columns = 2:(length(no_items)+1)
colours = viridis::inferno(length(threatened_columns))
threatened_labels = names(no_items)

fig1 <- plot_ly(threatened_data1, x = ~year) 
for(i in 1:length(threatened_columns)){
  fig1 <- fig1 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(threatened_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(threatened_columns)){
  fig2 <- fig2 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig3 <- fig3 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             name = threatened_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig4 <- fig4 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             type='bar',
                             name = threatened_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/proportion_threatened.html'),selfcontained = T)
}

fig
```


Concentrating only on the threatened species the following figures outline the categories of the threatened taxa over the history of the collection. 

```{r, echo = F}
unique_no_threatened_cat_values =  c('VU','EN','CR', 'EW', 'EX')

# Get the number of plants with provenance code for each year.
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_threatened_cateogory
  
  no_threatened = as.numeric(details[match(unique_no_threatened_cat_values, names(details))])
  no_threatened[is.na(no_threatened)] = 0

  return(no_threatened)
  }))))
names(no_items) = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')

prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
threatened_cat_data = data.frame(year = years, no_items, prop)
```

#### Change in Total Number of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE RAW NUMBERS FOUR GRAPH OPTIONS.
threatened_data1 = threatened_cat_data[,1:(length(no_items)+1)]
threatened_columns =2:(length(no_items)+1)
colours = viridis::inferno(length(threatened_columns))
threatened_labels = names(threatened_cat_data)[threatened_columns]
threatened_labels = stringr::str_replace_all(threatened_labels, '\\.', ' ')

fig1 <- plot_ly(threatened_data1, x = ~year) 
for(i in 1:length(threatened_columns)){
  fig1 <- fig1 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(threatened_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(threatened_columns)){
  fig2 <- fig2 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig3 <- fig3 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             name = threatened_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig4 <- fig4 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             type='bar',
                             name = threatened_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/number_threatened_category.html'),selfcontained = T)
}

fig
```

#### Change in Proportion of Plants over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
## PROVENANCE Proportion FOUR GRAPH OPTIONS.
threatened_data1 = threatened_cat_data[,c(1,which(grepl('prop',names(threatened_cat_data))))]
threatened_columns = 2:(length(no_items)+1)
colours = viridis::inferno(length(threatened_columns))
threatened_labels = names(no_items)

fig1 <- plot_ly(threatened_data1, x = ~year) 
for(i in 1:length(threatened_columns)){
  fig1 <- fig1 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i], mode = 'lines',type = 'scatter', line = list(color = colours[i])) 
}
fig1 <- fig1 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig1 <- fig1 %>% layout(hovermode = 'x unified')


#Stacked Line graph
fig2 <- plot_ly(threatened_data1, x = ~year, mode = 'none', stackgroup = 'one')
for(i in 1:length(threatened_columns)){
  fig2 <- fig2 %>% add_trace(y = threatened_data1[,threatened_columns[i]], name = threatened_labels[i],type = 'scatter', fillcolor = colours[i]) 
}
fig2 <- fig2 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items")) 
fig2 <- fig2 %>% layout(hovermode = 'x unified')

# Bar graph
fig3 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig3 <- fig3 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             name = threatened_labels[i],
                             marker = list(color = colours[i],line = list(color = 'rgb(8,48,107)', width = 0)),
                             type = 'bar')
}
fig3 <- fig3 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'group')
fig3 <- fig3 %>% layout(hovermode = 'x unified')

# Stacked bar graph
fig4 <- plot_ly(threatened_data1, x = ~year)
for(i in 1:length(threatened_columns)){
  fig4 <- fig4 %>% add_trace(y = threatened_data1[,threatened_columns[i]],
                             type='bar',
                             name = threatened_labels[i],
                             marker = list(color = colours[i], line = list(color = colours[i], width = 0)))
}
fig4 <- fig4 %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Items"),
          barmode = 'stack')
fig4 <- fig4 %>% layout(hovermode = 'x unified', bargap =0)

fig = manipulateWidget::combineWidgets(fig1, fig2, fig3, fig4, nrow = 2)

if(save_widgets){
  htmlwidgets::saveWidget(fig, file = paste0(whole_collection_widget_dir,'/proportion_threatened_category.html'),selfcontained = T)
}

fig
```


```{r,echo=F}
# Return excel workbook with data for each figure and table

library(xlsx)
wb = xlsx::createWorkbook()
sh1 = xlsx::createSheet(wb, 'Items, accessions, taxa, species')
xlsx::addDataFrame(combined1B_data, sh1, startRow = 1,row.names = F)
sh2 = xlsx::createSheet(wb, 'Family, genera and species')
xlsx::addDataFrame(combined2B_data, sh2, startRow = 1,row.names = F)
sh3 = xlsx::createSheet(wb, 'Family time in collection')
xlsx::addDataFrame(table_families, sh3, startRow = 1,row.names = F)
sh4 = xlsx::createSheet(wb, 'Species, infraspecific, and cultivars')
xlsx::addDataFrame(infra_data[,-ncol(infra_data)], sh4, startRow = 1,row.names = F)
sh5 = xlsx::createSheet(wb, 'Provanence')
xlsx::addDataFrame(prov_data, sh5, startRow = 1,row.names = F)
sh6 = xlsx::createSheet(wb, 'Endemic')
xlsx::addDataFrame(endemic_data, sh6, startRow = 1,row.names = F)
if(do_coord){
  sh6B = xlsx::createSheet(wb, paste0('Endemic to ',level3_name))
  xlsx::addDataFrame(endemic_local_data[,-ncol(endemic_local_data)], sh6B, startRow = 1,row.names = F)  
}
sh7 = xlsx::createSheet(wb, 'Threatened')
xlsx::addDataFrame(threatened_data, sh7, startRow = 1,row.names = F)
sh8 = xlsx::createSheet(wb, 'Red list category')
xlsx::addDataFrame(threatened_cat_data, sh8, startRow = 1,row.names = F)
xlsx::saveWorkbook(wb, file = paste0(output_dir,'/',collection,'_data_for_figures_reterospective_whole_collection.xlsx'))
```

<hr style="border:4px solid gray">

