---
title: "Exploration of native taxa in the LC"
output:
  word_document:
    toc: true
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(sf)
library(flextable)
```

```{r theme_ggplot2, echo = FALSE}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

```{r, inputs, echo = FALSE}
# Inputs
# As an input we get 
# - enriched_report, the LC with enrichment.
# - location, the BRU level 3 code of the LC.
# - collection, the name of the LC.
# - wcvp, BGSmartR version of wcvp.
# - native, 
# - extinct, 
# - doubtful_locations
# - wgsrpd3, the geography information.
# - min_year, the year to start change of time figures.
# - table_font_size, the size input to the ggplots.

#Example
# collection = 'Holden'
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/Holden_enriched_report.rda') 
# coordinates = c(41.61155751645494, -81.30082804984981)

# 
# collection = 'CUBG'
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/CUBG_June2023_enriched_report.rda')
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE
# load('/Users/jakepowell/Cambridge/WCVP/Version 11/wcvp_with_redlistcategory.rda')
# coordinates = c(51.48383834346519, -0.28925804656565474)
# load('wgsrpd3.rda')
# min_year = 1970
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/Kew_enriched_report.rda')
# export_data = T
# table_font_size = 14

if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

exporting_data_store = list()

location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occuring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```


```{r, Find LC location, echo = FALSE}
# Extract the location of the collection.
pnts <- data.frame( x = coordinates[2], y = coordinates[1])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
location_name = collection_geog_details$LEVEL3_NAM
location_code = collection_geog_details$LEVEL3_COD
```
This report explores native species existing in `r collection`, and how the representation of native species has varied over time.

 To determine the geographic distribution of items in the LC we enrich with information from [Plants of the World Online](https://powo.science.kew.org), by matching taxonomic names. POWO uses [TDWG geographical codes](https://www.tdwg.org/standards/wgsrpd/) (Brummitt, 2001) expressed to that system's third level. This splits the world into 369 regions. Thus, each accepted name in POWO is associated with a list of geographic regions. POWO splits the geographic regions associated with a taxa by three conditions:

- Native / introduced,
- Extinct / Not extinct,
- Location is doubtful / otherwise.

This document considers locations that are : `r location_type_text` 
 
Within TDWG geographical codes `r collection` is  found within the region `r location_name`. Therefore, any taxa whose geographic distribution includes `r location_name` is classed as native to the LC. Otherwise taxa are classed as non-native.

The location of the LC and the native region are shown below.

```{r, LC location and native region plot, fig.fullwidth=TRUE, fig.dim = c(10, 6), results='hide',fig.keep='all', message=FALSE}
collection_geog_details$occurrence_type = 'native'
lims <- st_bbox(collection_geog_details)
p <- rWCVP::wcvp_distribution_map(collection_geog_details, crop_map=TRUE) + 
  theme(legend.position="none") +
  geom_sf(data=pnts_sf, fill="purple",col="purple", shape=20, size = 3) +
  coord_sf(xlim=lims[c(1,3)], ylim=lims[c(2,4)]) +
  theme(legend.position = "none",
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.title = element_text(hjust = 0.5))

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Map_LC_location_and_native region.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

***

### How many native species are in the LC?

```{r, How many native species are in the LC - data, echo = FALSE}
geography_data = wcvp$geography[,grepl('_area_code_l3', names(wcvp$geography))]
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}
# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}

native_index = grepl(location_code, level3codes)
native_plant_ids =  wcvp$geography$plant_name_id[native_index]
native_plant_ids = native_plant_ids[!is.na(native_plant_ids)]

native_wcvp = wcvp$wcvp_names[wcvp$wcvp_names$plant_name_id %in% native_plant_ids,]

# native_wcvp currently also contains genus only (records) so we need to reduce to species.
native_wcvp = native_wcvp[-which(native_wcvp$taxon_rank == 'Genus'),]

no_native_taxa = nrow(native_wcvp)
no_native_families = length(unique(native_wcvp$family))
no_native_genus = length(unique(native_wcvp$genus))
no_native_species = length(unique(paste0(native_wcvp$genus, ' ', native_wcvp$species)))


# Get the existing native plants from the LC to the location. 
LC_native = enriched_report[enriched_report$POWO_plant_name_id %in% native_plant_ids,]
LC_native_exisiting = LC_native[LC_native$ItemStatusType == 'Existing',]

no_native_items_LC = nrow(LC_native_exisiting)
no_native_accessions_LC = length(unique(LC_native_exisiting$AccNoFull))
no_native_families_LC = length(unique(LC_native_exisiting$POWO_family))
no_native_genus_LC = length(unique(LC_native_exisiting$POWO_genus))
no_native_species_LC = length(unique(paste0(LC_native_exisiting$POWO_genus, ' ', LC_native_exisiting$POWO_species)))
no_native_taxa_LC = length(unique(paste0(LC_native_exisiting$POWO_taxon_name, ' ', LC_native_exisiting$POWO_taxon_authors)))

category = c('Family', 'Genus', 'Species', 'Taxa')
WCVP = c(no_native_families, no_native_genus, no_native_species, no_native_taxa)
LC  = c(no_native_families_LC, no_native_genus_LC, no_native_species_LC, no_native_taxa_LC)
proportion = paste0(round(LC/WCVP*100, digits = 2),'%')

df = data.frame(category, WCVP,LC, proportion)
names(df) = c('Category', 'Number found in WCVP', ' Number found in LC', 'Proportion of WCVP found in LC')
```

In the LC there are `r format(no_native_items_LC, big.mark=',')` items corresponding to  `r format(no_native_accessions_LC, big.mark=',')` accessions of existing native plants. In the following table we show how many families/genus/species/taxa of native plants are represented in the LC (compared to all plants from `r location_name` in WCVP).

```{r, How many native species are in the LC - table, echo = FALSE}
if(export_data){
  exporting_data_store$Representative_of_native_species_in_LC_current = df
}
df |>
  flextable() |>
  set_caption(caption = "Native plants in the collection compared to WCVP") |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
```

Below we produce figures detailing how the representation of native families/genus/species/taxa has changed over time in the LC. 

```{r, How many native species are in the LC - figures, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# LC_native contains, The LC reduced to native plants.
LC_native_over_time = LC_native
# The current year.
year_cur = as.numeric(format(Sys.Date(),'%Y'))

# Get which items are existing each year in the collection.
years = min_year:year_cur
date = paste0(years, '-01-01')

# Add Genus species columns from WCVP.
GenusSpecies = paste0(LC_native_over_time$POWO_genus, ' ', LC_native_over_time$POWO_species)
LC_native_over_time$GenusSpecies_new = GenusSpecies

# Remove those with missing item status date.
LC_native_over_time = LC_native_over_time[!is.na(LC_native_over_time$ItemStatusDate),]
LC_native_over_time = LC_native_over_time[LC_native_over_time$AccYear > 1650 &
                                            LC_native_over_time$AccYear <= year_cur,]
# Get the species/genera that are existing
plant_existing_LC_native = BGSmartR::exist_at_date(date, AccessionYear = LC_native_over_time$AccYear,
                       ItemStatusDate = LC_native_over_time$ItemStatusDate,
                       ItemStatusType = LC_native_over_time$ItemStatusType)

# For each year get the number in each group (species and genera)
over_time_info = lapply(plant_existing_LC_native, function(x){
    garden_current = LC_native_over_time[x,]

    # Get the values of interest.
    no_families_LC = length(unique(garden_current$POWO_family))
    no_genus_LC = length(unique(garden_current$POWO_genus))
    no_species_LC = length(unique(paste0(garden_current$POWO_genus, ' ', garden_current$POWO_species)))
    no_taxa_LC = length(unique(paste0(garden_current$POWO_taxon_name, ' ', garden_current$POWO_taxon_authors)))
   
    return(c(no_families_LC, no_genus_LC, no_species_LC, no_taxa_LC))
}) |>
                  data.frame() |>
                  t() |> 
                  data.frame()
names(over_time_info) = c('Family', 'Genus', 'Species', 'Taxa')
over_time_info = data.frame(Date = date, over_time_info)
row.names(over_time_info) = 1:nrow(over_time_info)

if(export_data){
  exporting_data_store$Representative_of_native_species_in_LC_over_time = over_time_info
}

# DT::datatable(over_time_info, rownames = FALSE, caption = paste0('Native plant to ', location, ' over time'),
#               options = list(scrollX =  TRUE,
#                              scrollY = '70vh',
#                              pageLength =  min(nrow(over_time_info),200),
#                              columnDefs = list(list(className = 'dt-center', targets = 0:3))
#                              ),
#               escape = FALSE)

to_do = c('Family', 'Genus', 'Species', 'Taxa')
titles  = c('Families', 'Genera', 'Species', 'Taxa')
# Loop over to_do.
for(i in 1:length(to_do)){
  count = as.numeric(unlist(over_time_info[match(to_do[i], names(over_time_info))]))
  percent = round(count/df$`Number found in WCVP`[which(df$Category == to_do[i])]*100, digits = 3)
  
  plot_dataA = data.frame(date =years, 
                               percent = percent,
                               represented = rep('Represented', length(date)))
  plot_dataB = data.frame(date =years, 
                             percent = 100-percent,
                              represented = rep('Not Represented', length(date)))
  
  plot_data = rbind(plot_dataA, plot_dataB)
  
  
  names(plot_data) = c('dates', 'percentage', 'represented')

  p = ggplot(plot_data, aes(fill=represented, y=percentage, x=dates)) + 
    geom_bar(position="stack", stat="identity", width = 1) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Representation of ", titles[i] , " over time"),
        x ="Year",
        y = "Percentage (%)") +
    guides(fill=guide_legend(title=paste0("Native ", titles[i]))) +
    scale_fill_discrete()
  
  if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','How_many_native_species_are_in_the_LC', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
  print(p)
}
 
```

***

### What proportion of the LC at `r collection` is native and how has this varied over time?

In this section we explore the number of native plants in the LC compared to all plants in the LC. In particular, we will determine if the number of native plants in the LC is stable, increasing or decreasing. 

We will examine the proportion of the LC that is native, this is shown in the table below.

```{r, What proportion of the LC at `r collection` is native and how has this varied over time,echo = FALSE}
LC = enriched_report
LC_existing = LC[LC$ItemStatusType == 'Existing',]

is_native = rep(FALSE, nrow(LC_existing))
is_native[which(LC_existing$POWO_plant_name_id %in% native_plant_ids)] = TRUE
LC_existing$is_native = is_native


no_items = nrow(LC_existing)
no_items_native = sum(LC_existing$is_native)

accessions_data = LC_existing[match(unique(LC_existing$AccNoFull), LC_existing$AccNoFull),]
no_accessions = nrow(accessions_data)
no_accessions_native = sum(accessions_data$is_native)

taxa_data = LC_existing[match(unique(LC_existing$TaxonNameFull), LC_existing$TaxonNameFull),]
no_taxa = nrow(taxa_data)
no_taxa_native = sum(taxa_data$is_native)

species_data = LC_existing[!is.na(LC_existing$POWO_plant_name_id),]
species_data = LC_existing[match(unique(paste0(species_data$POWO_taxon_name, species_data$POWO_taxon_authors)),
                            paste0(species_data$POWO_taxon_name, species_data$POWO_taxon_authors)),]
no_species = nrow(species_data)
no_species_native = sum(species_data$is_native)

Kind = c('Items', 'Accessions', 'Taxa', 'Species')
All = c(no_items, no_accessions, no_taxa, no_species)
Native = c(no_items_native, no_accessions_native, no_taxa_native, no_species_native)
Proportion = paste0(round(Native/All*100,digits=2),'%')

to_show = data.frame(Kind = Kind, All = All, Native = Native, Proportion = Proportion)

if(export_data){
  exporting_data_store$Native_species_in_LC_current = to_show
}
to_show |>
  flextable() |>
  set_caption(caption = paste0('Native / non native plants (', location_name, ') in the LC')) |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
```

Next we show how the number of native plants in the LC has varied over time.

```{r, What proportion of the LC at `r collection` is native and how has this varied over time - number figures, echo = FALSE,  fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# Get the number of items accession taxa species for native plants in the LC.
over_time_info = lapply(plant_existing_LC_native, function(x){
    garden_current = LC_native_over_time[x,]

    # Get the values of interest.
    no_items = nrow(garden_current)
    no_accessions = length(unique(garden_current$AccNoFull))
    no_taxa = length(unique(garden_current$TaxonNameFull))
    no_species = length(unique(paste0(garden_current$POWO_taxon_name, garden_current$POWO_taxon_authors)[!is.na(garden_current$POWO_plant_name_id)]))
   
    return(c(no_items, no_accessions, no_taxa, no_species))
}) |>
                  data.frame() |>
                  t() |> 
                  data.frame()
names(over_time_info) = c('Items', 'Accessions', 'Taxa', 'Species')
over_time_info = data.frame(Date = date, over_time_info)
row.names(over_time_info) = 1:nrow(over_time_info)
native_data = over_time_info

if(export_data){
  exporting_data_store$Number_of_native_species_in_LC_over_time = native_data
}

to_do = c('Items', 'Accessions', 'Taxa', 'Species')
titles = c('items', 'accessions', 'taxa', 'species')
for(i in 1:length(to_do)){
  counts = native_data[,match(to_do[i], names(native_data))]
  plot_data = data.frame(date = years, counts = counts)
  
  p = ggplot(data=plot_data, aes(x=date, y=counts)) +
  geom_line()+
  geom_point() +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Number of native ", titles[i] , " over time"),
        x ="Year",
        y = paste0("Number of ",titles[i])) #+
    # guides(fill=guide_legend(title=paste0("Native ", titles[i]))) +
    # theme(text = element_text(size=table_font_size))
  
    if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','number_native_over_time', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  
  print(p)
}
```

Next we view native plants in the LC as a percentage of all plants in the LC over time.

```{r, What proportion of the LC at `r collection` is native and how has this varied over time - percentage figures, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# Do the same for the whole collection.
report = enriched_report
report = report[report$AccYear > 1650 & report$AccYear<=year_cur,]
report = report[!is.na(report$ItemStatusDate),]
plant_existing = BGSmartR::exist_at_date(date, AccessionYear = report$AccYear,
                       ItemStatusDate = report$ItemStatusDate,
                       ItemStatusType = report$ItemStatusType)

# For each year get the number in each group (species and genera)
over_time_info = lapply(plant_existing, function(x){
    garden_current = report[x,]
    
    # Get the values of interest.

    no_items = nrow(garden_current)
    no_accessions = length(unique(garden_current$AccNoFull))
    no_taxa = length(unique(garden_current$TaxonNameFull))
    no_species = length(unique(paste0(garden_current$POWO_taxon_name, garden_current$POWO_taxon_authors)[!is.na(garden_current$POWO_plant_name_id)]))

    return(c(no_items, no_accessions, no_taxa, no_species))
}) |>
                  data.frame() |>
                  t() |> 
                  data.frame()
names(over_time_info) = c('Items', 'Accessions', 'Taxa', 'Species')
over_time_info = data.frame(Date = date, over_time_info)
row.names(over_time_info) = 1:nrow(over_time_info)
LC_data = over_time_info

if(export_data){
  exporting_data_store$Total_species_in_LC_over_time = LC_data
}

to_do =  c('Items', 'Accessions', 'Taxa', 'Species')
titles = c('items', 'accessions', 'taxa', 'species')

# Loop over to_do.
for(i in 1:length(to_do)){
  native_counts = native_data[,match(to_do[i], names(native_data))]
  total_counts = LC_data[,match(paste0(to_do[i]), names(LC_data))]
  
  percent = round(native_counts/total_counts*100, digits = 3)

  plot_dataA = data.frame(date =years, 
                               percent = percent,
                               represented = rep('Native', length(date)))
  plot_dataB = data.frame(date =years, 
                             percent = 100-percent,
                              represented = rep('Non Native', length(date)))
  
  plot_data = rbind(plot_dataA, plot_dataB)
  plot_data$represented = factor(plot_data$represented,levels = c('Non Native','Native'))
  
  names(plot_data) = c('dates', 'percentage', 'represented')

  p = ggplot(plot_data, aes(fill=represented, y=percentage, x=dates)) + 
    geom_bar(position="stack", stat="identity", width = 1) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Proportion of ", titles[i] , " that are native in the LC over time"),
        x ="Year",
        y = "Percentage (%)") +
    guides(fill=guide_legend(title=paste0("Native ", titles[i]))) +
   scale_fill_discrete() # +
    # theme(text = element_text(size=table_font_size))
    
      if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','proportion_native_over_time', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
    
  print(p)
}
 

```

***

### Among the native plants in a LC, how many of them are endemic or redlisted?

In this section, we concentrate on native plants in the LC that are either endemic or redlisted.

Below we produce a Venn diagram of endemic and threatened plants that are native in the LC.

```{r, Among the native plants in a LC, how many of them are endemic or redlisted - Venn Diagram, echo = FALSE, results='hide',fig.keep='all', message=FALSE}
# LC_native_exisiting, native and existing part of LC database.

endemic = rep(FALSE, nrow(LC_native_exisiting))
endemic[which(stringr::str_length(LC_native_exisiting$POWO_Dist_110_area_code_l3) == 3)] = TRUE
total_endemic = sum(endemic)

threatened = rep(FALSE, nrow(LC_native_exisiting))
threatened[which(LC_native_exisiting$POWO_Red_category %in% c('EN', 'VU', 'CR', 'EW', 'EX'))] = TRUE
threatened[which(LC_native_exisiting$redList_category %in% c('EN', 'VU', 'CR', 'EW', 'EX'))] = TRUE
total_threatened = sum(threatened)

total_threat_endemic = sum(endemic & threatened)
library("VennDiagram") 

# move to new plotting page 
grid.newpage() 

# create pairwise Venn diagram 
# draw.pairwise.venn(area1=total_endemic, area2=total_threatened,cross.area=total_threat_endemic, 
#                    category=c("Endemic","Threatened"),fill=c("Yellow", "Red"))

draw.pairwise.venn(
  area1 = total_endemic,
  area2 = total_threatened,
  cross.area = total_threat_endemic,
  category = c("Endemic","Threatened"), fill = c("Yellow", "Red"),
  lty = "blank",
  cex = 1.1,
  cat.cex = 1.3,
  cat.pos = c(285, 105),
  cat.dist = 0.09,
  cat.just = list(c(-1, -1), c(1, 1)), ext.pos = 30,
  ext.dist = -0.05,
  ext.length = 0.85,
  ext.line.lwd = 2,
  ext.line.lty = "dashed"
)

      if(separate_figure_folder){
ggplot2::ggsave(filename = paste0(figures_dir, '/','Native_threatened_endemic_Venn_diagram.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
```


For these native and endemic/threatened plants we produce a table below detailing how many of each species is in the collection together with the accession number and when each item was last checked.

```{r, Among the native plants in a LC, how many of them are endemic or redlisted - table important taxa, echo = FALSE, ft.keepnext = FALSE}
accessions = LC_native_exisiting$AccNoFull
taxa = paste0(LC_native_exisiting$POWO_taxon_name, ' ', LC_native_exisiting$POWO_taxon_authors)
ItemStatusDate = LC_native_exisiting$ItemStatusDate

data = data.frame(accessions =accessions, 
                  taxa = taxa,
                  ItemStatusDate = ItemStatusDate, 
                  endemic = endemic, 
                  threatened = threatened)

data_compressed <- data |>
  dplyr::group_by(.data$taxa) |>
  dplyr::summarise(endemic = .data$endemic[1],
                   threatened = .data$threatened[1],
                   ItemStatusDates = toString(.data$ItemStatusDate),
                   Accessions = toString(unique(.data$accessions)),
                   Items = length(.data$ItemStatusDate)
                   
  ) |>
  dplyr::ungroup()

data_compressed = data_compressed[data_compressed$endemic | data_compressed$threatened,]

if(export_data){
  exporting_data_store$Detail_threatened_and_endemic_native_plants_in_LC = data.frame(data_compressed)
}

data_compressed |>
  flextable() |>
  set_caption(caption = paste0('Native plants in the LC that are endemic or threatened')) |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit() |>
  set_table_properties(width = 1, layout = "autofit")
```

***

### Provenance of native plants in the LC

In this section we are exploring the provenance of native plants in the collection. We shall do this in two parts: existing plants in the LC and how this has changed over time.

Below we produce a table of provenance for items and accessions.

```{r, Provenance of native plants in the LC, echo = FALSE}
# LC_native_exisiting the data of existing native plants in the LC. 

prov_items = data.frame(table(LC_native_exisiting$ProvenanceCode))
names(prov_items) = c('Provenance', 'Items')
prov_items$Provenance  = c('Garden', 'Unknown', 'Wild', 'Wild-dervived')[match(prov_items$Provenance, c('G', 'U', 'W', 'Z'))]  

prov_accessions = data.frame(table(LC_native_exisiting$ProvenanceCode[match(unique(LC_native_exisiting$AccNoFull), LC_native_exisiting$AccNoFull)]))
names(prov_accessions) = c('Provenance', 'Accessions')
prov_accessions$Provenance  = c('Garden', 'Unknown', 'Wild', 'Wild-dervived')[match(prov_accessions$Provenance, c('G', 'U', 'W', 'Z'))]  


flex_data = data.frame(prov_items$Provenance,
                       prov_items$Items, 
                       paste0(round(prov_items$Items/sum(prov_items$Items)*100,digits=2),'%'),
                       prov_accessions$Accessions,
                       paste0(round(prov_accessions$Accessions/sum(prov_accessions$Accessions)*100,digits=2),'%'))
names(flex_data) = c('Provenance', 'Items_Number', 'Items_Proportion', 'Accessions_Number', 'Accessions_Proportion')

if(export_data){
  exporting_data_store$Provenance_of_existing_native_plants_in_the_LC = flex_data
}

flex_data |>
  flextable() |>
  set_caption(caption = paste0('Provenance of existing native plants in the LC')) |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  separate_header() |> 
  align(align = "center", part = "all") |>
  autofit()

```

Putting the data into a pie charts yields

```{r, Provenance of native plants in the LC pie charts, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
# Basic piechart
pie1 = ggplot(prov_items, aes(x="", y=Items, fill=Provenance)) +
  geom_bar(stat="identity", width=1, color="white") +
  ggtheme(base_size = 18) +
  coord_polar("y", start=0) +
  ggtheme(base_size = 18) +
  ggtitle('Items') +
  scale_fill_discrete() +
  theme(legend.position = "none",
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.title = element_text(hjust = 0.5))

pie2 = ggplot(prov_accessions, aes(x="", y=Accessions, fill=Provenance)) +
  geom_bar(stat="identity", width=1, color="white") +
  ggtheme(base_size = 18) +
  coord_polar("y", start=0) +
  ggtitle('Accessions') + 
  scale_fill_discrete() +
  theme(legend.position = "none",
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.title = element_text(hjust = 0.5))

p = ggpubr::ggarrange(pie1, pie2, ncol=2, nrow=1, common.legend = TRUE, legend="bottom")

if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Provenance_of_native_plants.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}


p

```


We will now look at how the provenance of native plants in the LC has changed over time.

```{r, Provenance of native plants in the LC- change over time data, echo = FALSE}
# LC_native_over_time contains the over time native plants.
redlistcatA = LC_native_over_time$redList_category
redlistcatB = LC_native_over_time$POWO_Red_category

redlist_used = rep(NA, nrow(LC_native_over_time))
redlist_used[redlistcatA == 'VU' | redlistcatB == 'VU'] = 'VU'
redlist_used[redlistcatA == 'EN' | redlistcatB == 'EN'] = 'EN'
redlist_used[redlistcatA == 'CR' | redlistcatB == 'CR'] = 'CR'
redlist_used[redlistcatA == 'EW' | redlistcatB == 'EW'] = 'EW'
redlist_used[redlistcatA == 'EX' | redlistcatB == 'EX'] = 'EX'

LC_native_over_time$redlist_used = redlist_used

# For each year get the number in each group (species and genera)
over_time_info = lapply(plant_existing_LC_native, function(x){
  garden_current = LC_native_over_time[x,]
  
  prov_items =  data.frame(table(garden_current$ProvenanceCode))
  if(nrow(prov_items) == 0){
    return(list(prov_items = prov_items,
              prov_accessions = prov_items,
              redlistcat_items = prov_items,
              redlistcat_accessions = prov_items,
              redlistcat_taxa = prov_items))
  }
  names(prov_items) = c('Provenance', 'Items')
  
  prov_accessions = data.frame(table(garden_current$ProvenanceCode[match(unique(garden_current$AccNoFull), garden_current$AccNoFull)]))
  names(prov_accessions) = c('Provenance', 'Accessions')
  
  redlistcat_items = data.frame(table(garden_current$redlist_used))
  if(ncol(redlistcat_items) != 2){redlistcat_items = data.frame(matrix(ncol = 2, nrow = 0))}
  names(redlistcat_items) = c('RedListCategory', 'Items')
  
  redlistcat_accessions = data.frame(table(garden_current$redlist_used[match(unique(garden_current$AccNoFull), garden_current$AccNoFull)]))
  if(ncol(redlistcat_accessions) != 2){redlistcat_accessions = data.frame(matrix(ncol = 2, nrow = 0))}
  
  names(redlistcat_accessions) = c('RedListCategory', 'Accessions')
  
  taxa = paste0(garden_current$POWO_taxon_name, ' ', garden_current$POWO_taxon_authors)
  redlistcat_taxa = data.frame(table(garden_current$redlist_used[match(unique(taxa), taxa)]))
  if(ncol(redlistcat_taxa) != 2){redlistcat_taxa = data.frame(matrix(ncol = 2, nrow = 0))}
  
  names(redlistcat_taxa) = c('RedListCategory', 'Accessions')
  
  
  return(list(prov_items = prov_items,
              prov_accessions = prov_accessions,
              redlistcat_items = redlistcat_items,
              redlistcat_accessions = redlistcat_accessions,
              redlistcat_taxa = redlistcat_taxa))
})
prov_redlist_native_over_time = over_time_info

```

```{r, Provenance of native plants in the LC- change over time figures, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
to_do = c('items', 'accessions')
for(i in 1:length(to_do)){
  # Get the data from over_time_info.
  data_wanted = NULL
  wanted_item = which(grepl('prov',names(over_time_info[[1]])) & grepl(to_do[i],names(over_time_info[[1]])) )
  for(jj in 1:length(over_time_info)){
    info_year = over_time_info[[jj]][[wanted_item]]
    if(nrow(info_year) == 0){
      next
    }
    prop = round(info_year[,2] / sum(info_year[,2]) *100,digits = 3)
    info_year = data.frame(year = rep(names(over_time_info)[jj], nrow(info_year)),
                           info_year = info_year,
                           prop = prop)
    data_wanted = rbind(data_wanted, info_year)

  }
  names(data_wanted) = c('year', 'Provenance', 'Items', 'prop')
  data_wanted[,2] = as.character(data_wanted[,2])
  data_wanted[,2]  = c('Garden', 'Unknown', 'Wild', 'Wild-dervived')[match(data_wanted[,2], c('G', 'U', 'W', 'Z') )]
  data_wanted$year = as.numeric(stringr::str_extract(data_wanted$year,'[0-9]{4}'))
  
  
    if(export_data){
    item_name = paste0('Provenance_of_native_plants_in_the_LC_proportion_over_time_',to_do[i])
  exporting_data_store$AA = data_wanted
  names(exporting_data_store)[names(exporting_data_store) == 'AA'] = item_name
    }
  
    p = ggplot(data_wanted, aes(fill=Provenance, y=prop, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Provenance of ", to_do[i] , " that are native in the LC over time"),
        x ="Year",
        y = "Percentage (%)") +
    guides(fill=guide_legend(title=paste0('Provenance')))# +
    # theme(text = element_text(size=table_font_size))
    
    if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Provenance_of_native_over_time', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
  print(p)

}
```

### Threatened, native plants in the LC

In this section we are exploring the threatened, native plants in the collection. We shall do this in two parts: existing plants in the LC and how this has changed over time.

Below we produce a table of provenance for items and accessions.

```{r,  Threatened, native plants in the LC - table, echo = FALSE}
# LC_native_exisiting
# 
redlistcatA = LC_native_exisiting$redList_category
redlistcatB = LC_native_exisiting$POWO_Red_category

redlist_used = rep(NA, nrow(LC_native_exisiting))
redlist_used[redlistcatA == 'VU' | redlistcatB == 'VU'] = 'VU'
redlist_used[redlistcatA == 'EN' | redlistcatB == 'EN'] = 'EN'
redlist_used[redlistcatA == 'CR' | redlistcatB == 'CR'] = 'CR'
redlist_used[redlistcatA == 'EW' | redlistcatB == 'EW'] = 'EW'
redlist_used[redlistcatA == 'EX' | redlistcatB == 'EX'] = 'EX'

LC_native_exisiting$redlist_used = redlist_used

redlistcat_items = data.frame(table(LC_native_exisiting$redlist_used))
if(nrow(redlistcat_items) == 0){
  redlistcat_items = data.frame(matrix(ncol = 2, nrow = 0))
}
names(redlistcat_items) = c('RedListCategory', 'Items')
redlistcat_items$RedListCategory = as.character(redlistcat_items$RedListCategory)
redlistcat_items$RedListCategory  = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')[match(redlistcat_items$RedListCategory, c('VU', 'EN', 'CR', 'EW', 'EX'))]  

redlistcat_accessions = data.frame(table(LC_native_exisiting$redlist_used[match(unique(LC_native_exisiting$AccNoFull), LC_native_exisiting$AccNoFull)]))
if(nrow(redlistcat_accessions) == 0){
  redlistcat_accessions = data.frame(matrix(ncol = 2, nrow = 0))
}
names(redlistcat_accessions) = c('RedListCategory', 'Accessions')
redlistcat_items$RedListCategory = as.character(redlistcat_items$RedListCategory)
redlistcat_accessions$RedListCategory  = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')[match(redlistcat_accessions$RedListCategory, c('VU', 'EN', 'CR', 'EW', 'EX'))]  

if(nrow(redlistcat_items) > 0){
  flex_data = data.frame(redlistcat_items$RedListCategory,
                       redlistcat_items$Items, 
                       paste0(round(redlistcat_items$Items/sum(redlistcat_items$Items)*100,digits=2),'%'),
                       redlistcat_accessions$Accessions,
                       paste0(round(redlistcat_accessions$Accessions/sum(redlistcat_accessions$Accessions)*100,digits=2),'%'))
}else{
  flex_data = data.frame(matrix(ncol = 5, nrow = 0))
}
           

names(flex_data) = c('Red List Category', 'Items_Number', 'Items_Proportion', 'Accessions_Number', 'Accessions_Proportion')

if(export_data){
  exporting_data_store$Threatened_category_of_existing_native_plants_in_the_LC = flex_data
}

flex_data |>
  flextable() |>
  set_caption(caption = paste0('Threatened category of existing native plants in the LC')) |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  separate_header() |> 
  align(align = "center", part = "all") |>
  autofit()

```

Putting the data into a pie charts yields

```{r,  Threatened, native plants in the LC - pie charts, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 6)}
if(nrow(flex_data) > 0){
  # Basic piechart
pie1 = ggplot(redlistcat_items, aes(x="", y=Items, fill=RedListCategory)) +
  geom_bar(stat="identity", width=1, color="white") +
  ggtheme(base_size = 18) +
  coord_polar("y", start=0) +
  ggtitle('Items') +
  theme(legend.position = "none",
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.title = element_text(hjust = 0.5))

pie2 = ggplot(redlistcat_accessions, aes(x="", y=Accessions, fill=RedListCategory)) +
  geom_bar(stat="identity", width=1, color="white") +
  ggtheme(base_size = 18) +
  coord_polar("y", start=0) +
  ggtitle('Accessions') +
  theme(legend.position = "none",
        axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.title = element_text(hjust = 0.5))

p = ggpubr::ggarrange(pie1, pie2, ncol=2, nrow=1, common.legend = TRUE, legend="bottom",
                  font.label = list(size = table_font_size))

    if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','native_threatened.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
p
}

```


We will now look at how the threatened categories of native plants in the LC has changed over time.

```{r, Threatened, native plants in the LC - proportion over time, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
to_do = c('items', 'accessions')
if(nrow(flex_data) > 0){
for(i in 1:length(to_do)){
  # Get the data from over_time_info.
  data_wanted = NULL
  wanted_item = which(grepl('redlistcat',names(over_time_info[[1]])) & grepl(to_do[i],names(over_time_info[[1]])) )
  for(jj in 1:length(over_time_info)){
    info_year = over_time_info[[jj]][[wanted_item]]
     if(nrow(info_year) == 0){
      next
    }
    prop = round(info_year[,2] / sum(info_year[,2]) *100,digits = 3)
    info_year = data.frame(year = rep(names(over_time_info)[jj], nrow(info_year)), info_year, prop = prop)
    data_wanted = rbind(data_wanted, info_year)
  }
 data_wanted[,2]  = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')[match(data_wanted[,2], c('VU', 'EN', 'CR', 'EW', 'EX'))]  
  data_wanted$year = as.numeric(stringr::str_extract(data_wanted$year,'[0-9]{4}'))
  
  if(export_data){
    item_name = paste0('Threatened_native_plants_in_the_LC_proportion_over_time_',to_do[i])
  exporting_data_store$AA = data_wanted
  names(exporting_data_store)[names(exporting_data_store) == 'AA'] = item_name
}
  
    p = ggplot(data_wanted, aes(fill=RedListCategory, y=prop, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("RedList Category of ", to_do[i] , " that are native in the LC over time"),
        x ="Year",
        y = "Percentage (%)") +
    guides(fill=guide_legend(title=paste0('RedList Category')))# +
    # theme(text = element_text(size=table_font_size))
    
    if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_threatened_over_time', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
  print(p)

}
}
```

Note that there might not be many threatened native plants. Therefore, we also include line graphs of the number of each threatened category in the LC.

```{r, Threatened, native plants in the LC - number over time, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
to_do = c('items', 'accessions', 'taxa')
if(nrow(flex_data) > 0){
for(i in 1:length(to_do)){
  # Get the data from over_time_info.
  data_wanted = NULL
  wanted_item = which(grepl('redlistcat',names(over_time_info[[1]])) & grepl(to_do[i],names(over_time_info[[1]])) )
  for(jj in 1:length(over_time_info)){
    info_year = over_time_info[[jj]][[wanted_item]]
     if(nrow(info_year) == 0){
      next
    }
    prop = round(info_year[,2] / sum(info_year[,2]) *100,digits = 3)
    info_year = data.frame(year = rep(names(over_time_info)[jj], nrow(info_year)), info_year, prop = prop)
    data_wanted = rbind(data_wanted, info_year)
  }
 data_wanted[,2]  = c('Vulnerable', 'Endangered', 'Critically Endangered', 'Extinct in the Wild', 'Extinct')[match(data_wanted[,2], c('VU', 'EN', 'CR', 'EW', 'EX'))]  
  data_wanted$year = as.numeric(stringr::str_extract(data_wanted$year,'[0-9]{4}'))
  
  
  # Create plot.
  p = ggplot(data=data_wanted, aes(x=year, y=data_wanted[,3], group=RedListCategory)) +
  geom_line(aes(color=RedListCategory)) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("RedList Category of ", to_do[i] , " that are native in the LC over time"),
        x ="Year",
        y = paste0('Number of ',to_do[i])) +
    guides(color=guide_legend(title=paste0('RedList Category'))) #+
    # theme(text = element_text(size=table_font_size))
  
      if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Number_of_threatened_over_time', to_do[i] ,'.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
      }
  
  print(p)
}
}
```

***

### Turnover of native plants

This section looks at the turnover (gain/loss) of items and accessions of native plants in the LC.

We will first look at the turnover for items.

```{r, Native Turnover - Analyse items, echo = FALSE}
#Lost items
lost_items = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_status_year = LC_native_over_time[which(LC_native_over_time$status_year == year),]
  # Number of items lost.
  lost_items = have_status_year[which(have_status_year$ItemStatusType == 'NotExisting'),]
  no_lost_items = nrow(lost_items)
  
  return(c(year,no_lost_items))
}))))
names(lost_items) = c('Year', 'Number of items')
row.names(lost_items) = 1:nrow(lost_items)

# Gained items
gain_items = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_accYear = LC_native_over_time[which(LC_native_over_time$AccYear == year),]

  no_gain_items = nrow(have_accYear)
  
  return(c(year,no_gain_items))
}))))
names(gain_items) = c('Year', 'Number of items')
row.names(gain_items) = 1:nrow(gain_items)

# items
items = data.frame(lost_items, gain_items[,2], gain_items[,2] - lost_items[,2])
names(items) = c('Year', 'Number of lost items', 'Number of gained items', 'Net number of items')


if(export_data){
  exporting_data_store$Native_turnover_items = items
}
# DT::datatable(items, rownames = FALSE, caption = paste0('Native turnover (items)'),
#               options = list(scrollX =  TRUE,
#                              scrollY = '70vh',
#                              pageLength =  min(nrow(items),200),
#                              columnDefs = list(list(className = 'dt-center', targets = 0:3))
#                              ),
#               escape = FALSE)
```


```{r, Native Turnover - Gain/Loss items figures, echo = FALSE,  fig.fullwidth=FALSE, fig.dim = c(10, 4), results='hide',fig.keep='all', message=FALSE}
dataA = data.frame(items[,c(1,2)], rep('Lost', nrow(items)))
names(dataA) = LETTERS[1:3]
dataB = data.frame(items[,c(1,3)], rep('Gain', nrow(items)))
names(dataB) = LETTERS[1:3]
items_data = rbind(dataA, dataB)

p = ggplot(data=items_data, aes(x=A, y=B, group=C)) +
  geom_line(aes(color=C)) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Gain/Loss of native items in the LC over time"),
        x ="Year",
        y = paste0('Number of items')) +
    guides(color=guide_legend(title=paste0('Gain/Loss'))) +
    # theme(text = element_text(size=table_font_size)) +
  scale_color_manual(values=c("blue", "red"))
  print(p)
  
  if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_turnover_items.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

  
# Color based on value
color <- ifelse(items$`Net number of items` < 0, "pink", "lightblue")

p = ggplot(items, aes(x = Year, y = `Net number of items`)) +
  geom_bar(stat = "identity",
           show.legend = FALSE,
           fill = color,      # Background color
           color = "white") + # Border color
  # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=paste0("Net turnover of native items in the LC over time"),
      x ="Year",
      y = paste0('Number of items')) #+
  # theme(text = element_text(size=table_font_size))
print(p)  

  if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_net_turnover_items.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
```

Now do the same with accessions

```{r, Native Turnover - Analyse accessions, echo = FALSE}

accessions_alive = unique(LC_native_over_time$AccNoFull[LC_native_over_time$ItemStatusType == 'Existing'])
accessions = LC_native_over_time[!LC_native_over_time$AccNoFull %in% accessions_alive,]

# To reduce from items to accessions only use the most recent status_year
accessions = accessions[rev(order(accessions$status_year)),]
unique_accessions = unique(accessions$AccNoFull)
accessions = accessions[match(unique_accessions, accessions$AccNoFull),]  


#Lost accessions
lost_accessions = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_status_year = accessions[which(accessions$status_year == year),]
  
  # Number of accessions lost.
  lost_accessions = have_status_year[which(have_status_year$ItemStatusType == 'NotExisting'),]
  no_lost_accessions = nrow(lost_accessions)
  
  return(c(year,no_lost_accessions))
}))))
names(lost_accessions) = c('Year', 'Number of accessions')
row.names(lost_accessions) = 1:nrow(lost_accessions)

# Gained accessions
gain_accessions = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_accYear = accessions[which(accessions$AccYear == year),]

  no_gain_accessions = nrow(have_accYear)
  
  return(c(year,no_gain_accessions))
}))))
names(gain_accessions) = c('Year', 'Number of accessions')
row.names(gain_accessions) = 1:nrow(gain_accessions)

# accessions
accessions = data.frame(lost_accessions, gain_accessions[,2], gain_accessions[,2] - lost_accessions[,2])
names(accessions) = c('Year', 'Number of lost accessions', 'Number of gained accessions', 'Net number of accessions')


if(export_data){
  exporting_data_store$Native_turnover_accessions = accessions
}

# DT::datatable(accessions, rownames = FALSE, caption = paste0('Native turnover (accessions)'),
#               options = list(scrollX =  TRUE,
#                              scrollY = '70vh',
#                              pageLength =  min(nrow(accessions),200),
#                              columnDefs = list(list(className = 'dt-center', targets = 0:3))
#                              ),
#               escape = FALSE)
```

```{r, Native Turnover - Gain/Loss accessions figures, echo = FALSE,  fig.fullwidth=FALSE, fig.dim = c(10, 4), results='hide',fig.keep='all', message=FALSE}
dataA = data.frame(accessions[,c(1,2)], rep('Lost', nrow(accessions)))
names(dataA) = LETTERS[1:3]
dataB = data.frame(accessions[,c(1,3)], rep('Gain', nrow(accessions)))
names(dataB) = LETTERS[1:3]
accessions_data = rbind(dataA, dataB)

p = ggplot(data=accessions_data, aes(x=A, y=B, group=C)) +
  geom_line(aes(color=C)) +
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Gain/Loss of native accessions in the LC over time"),
        x ="Year",
        y = paste0('Number of accessions')) +
    guides(color=guide_legend(title=paste0('Gain/Loss'))) +
    # theme(text = element_text(size=table_font_size)) +
  scale_color_manual(values=c("blue", "red"))
  print(p)
  
  
    if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_turnover_accessions.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  
# Color based on value
color <- ifelse(accessions$`Net number of accessions` < 0, "pink", "lightblue")

p = ggplot(accessions, aes(x = Year, y = `Net number of accessions`)) +
  geom_bar(stat = "identity",
           show.legend = FALSE,
           fill = color,      # Background color
           color = "white") + # Border color
  # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title=paste0("Net turnover of native accessions in the LC over time"),
      x ="Year",
      y = paste0('Number of accessions')) #+
  # theme(text = element_text(size=table_font_size))
print(p)  

    if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_net_turnover_accessions.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
```

We can also view the gain/loss of native items/accessions as a proportion of all gained/lost items each year. This will show if the incoming proportion of native plants was more or less than the proportion of native plants in the collection. 

Items:

```{r, Native Turnover - Gain/Loss items proportion figures, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 4), results='hide',fig.keep='all', message=FALSE}
lost_items_all = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_status_year = report[report$status_year == year,]
  
  # Number of items lost.
  lost_items = have_status_year[have_status_year$ItemStatusType == 'NotExisting',]
  no_lost_items = nrow(lost_items)
  
  return(c(year,no_lost_items))
}))))
names(lost_items_all) = c('Year', 'Number of items')
row.names(lost_items_all) = 1:nrow(lost_items_all)

# Gained items
gain_items_all = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_accYear = report[report$AccYear == year,]

  no_gain_items = nrow(have_accYear)
  
  return(c(year,no_gain_items))
}))))
names(gain_items_all) = c('Year', 'Number of items')
row.names(gain_items_all) = 1:nrow(gain_items_all)

# items
items_all = data.frame(lost_items_all, gain_items_all[,2], gain_items_all[,2] - lost_items_all[,2])
names(items_all) = c('Year', 'Number of lost items', 'Number of gained items', 'Net number of items')

if(export_data){
  exporting_data_store$Whole_LC_turnover_items = items_all
}
### Plot of proportion of gained items being native.

plot_data = data.frame(year = gain_items$Year,
                       native = gain_items$`Number of items`, 
                       all = gain_items_all$`Number of items`)
plot_data$prop_native = round(plot_data$native / plot_data$all *100,digits=2)
native_counts = native_data$Items
total_counts = LC_data$Items
plot_data$native_LC = round(native_counts / total_counts *100,digits=2)

 p = ggplot(plot_data, aes(y=prop_native, x=year)) + 
    geom_bar(stat="identity", width = 1, fill = 'lightblue', col = 'black') +
   geom_point(aes(x = year, y = native_LC))+
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Proportion of gained items that are native in the LC over time"),
        x ="Year",
        y = "Native Percentage (%)") +
    guides(fill=guide_legend(title=paste0('Provenance'))) +
    # theme(text = element_text(size=table_font_size)) +
      labs(caption = "Black points are proportion of items in the LC that are native each year.")
  print(p)
  
      if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_gain_items_proportion.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  
### Plot of proportion of lost items being native.

plot_data = data.frame(year = lost_items$Year,
                       native = lost_items$`Number of items`, 
                       all = lost_items_all$`Number of items`)
plot_data$prop_native = round(plot_data$native / plot_data$all *100,digits=2)
native_counts = native_data$Items
total_counts = LC_data$Items
plot_data$native_LC = round(native_counts / total_counts *100,digits=2)

 p = ggplot(plot_data, aes(y=prop_native, x=year)) + 
    geom_bar(stat="identity", width = 1, fill = 'pink', col = 'black') +
   geom_point(aes(x = year, y = native_LC))+
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Proportion of lost items that are native in the LC over time"),
        x ="Year",
        y = "Native Percentage (%)") +
    guides(fill=guide_legend(title=paste0('Provenance'))) +
    # theme(text = element_text(size=table_font_size)) +
      labs(caption = "Black points are proportion of items in the LC that are native each year.")
  print(p)

        if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_loss_items_proportion.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
```

Accessions:

```{r, Native Turnover - Gain/Loss accessions proportion figures, echo = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 4), results='hide',fig.keep='all', message=FALSE}
accessions_all = report[rev(order(report$status_year)),]
unique_accessions_all = unique(accessions_all$AccNoFull)
accessions_all = accessions_all[match(unique_accessions_all, accessions_all$AccNoFull),]  


lost_accessions_all = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_status_year = accessions_all[accessions_all$status_year == year,]
  
  # Number of accessions lost.
  lost_accessions = have_status_year[have_status_year$ItemStatusType == 'NotExisting',]
  no_lost_accessions = nrow(lost_accessions)
  
  return(c(year,no_lost_accessions))
}))))
names(lost_accessions_all) = c('Year', 'Number of accessions')
row.names(lost_accessions_all) = 1:nrow(lost_accessions_all)

# Gained accessions
gain_accessions_all = data.frame(t(data.frame(lapply(years, function(year){
  # Accessions for the year
  have_accYear = accessions_all[accessions_all$AccYear == year,]

  no_gain_accessions = nrow(have_accYear)
  
  return(c(year,no_gain_accessions))
}))))
names(gain_accessions_all) = c('Year', 'Number of accessions')
row.names(gain_accessions_all) = 1:nrow(gain_accessions_all)

# accessions
accessions_all = data.frame(lost_accessions_all, gain_accessions_all[,2], gain_accessions_all[,2] - lost_accessions_all[,2])
names(accessions_all) = c('Year', 'Number of lost accessions', 'Number of gained accessions', 'Net number of accessions')


if(export_data){
  exporting_data_store$Whole_LC_turnover_accessions = accessions_all
}

### Plot of proportion of gained accessions being native.

plot_data = data.frame(year = gain_accessions$Year,
                       native = gain_accessions$`Number of accessions`, 
                       all = gain_accessions_all$`Number of accessions`)
plot_data$prop_native = round(plot_data$native / plot_data$all *100,digits=2)
native_counts = native_data$Accessions
total_counts = LC_data$Accessions
plot_data$native_LC = round(native_counts / total_counts *100,digits=2)

 p = ggplot(plot_data, aes(y=prop_native, x=year)) + 
    geom_bar(stat="identity", width = 1, fill = 'lightblue', col = 'black') +
   geom_point(aes(x = year, y = native_LC))+
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Proportion of gained accessions that are native in the LC over time"),
        x ="Year",
        y = "Native Percentage (%)") +
    guides(fill=guide_legend(title=paste0('Provenance'))) +
    # theme(text = element_text(size=table_font_size)) +
      labs(caption = "Black points are proportion of accessions in the LC that are native each year.")
  print(p)
  
          if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_gain_accessions_proportion.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
  
### Plot of proportion of lost accessions being native.

plot_data = data.frame(year = lost_accessions$Year,
                       native = lost_accessions$`Number of accessions`, 
                       all = lost_accessions_all$`Number of accessions`)
plot_data$prop_native = round(plot_data$native / plot_data$all *100,digits=2)
native_counts = native_data$Accessions
total_counts = LC_data$Accessions
plot_data$native_LC = round(native_counts / total_counts *100,digits=2)

 p = ggplot(plot_data, aes(y=prop_native, x=year)) + 
    geom_bar(stat="identity", width = 1, fill = 'pink', col = 'black') +
   geom_point(aes(x = year, y = native_LC))+
    # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black")) +
    labs(title=paste0("Proportion of lost accessions that are native in the LC over time"),
        x ="Year",
        y = "Native Percentage (%)") +
    guides(fill=guide_legend(title=paste0('Provenance'))) +
    # theme(text = element_text(size=table_font_size)) +
      labs(caption = "Black points are proportion of accessions in the LC that are native each year.")
  print(p)

          if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Native_loss_accessions_proportion.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
```


***



***

### Survival of native plants in the LC. 

In this section, we look at whether the survival period of native plant in longer than non-native plants. Note that plants can be long-lived and most collections will have plants that are older than the collection itself. Therefore, we need to lean into tools from statistics to analyse the lifespan of plants in a collection. Herein, we use survival analysis to calculate the probability that plants will survive for any number of years. 

Note that "lifespan" may be a preferable way to describe this section, however we use survival because accessioned plants may arrive in the garden already a few years old. As we will be using the accession date and item status date to determine the length of time plants have been in the collection this might not align perfectly with the age of the plant. Moreover, it is important to be aware that the data used in the analysis is not "perfect" in the sense that plants might have already died a large period of time prior to an audit, moreover this analysis doesn't account for circumstances of plant death which could be natural, or for renovation of a section of the garden, etc. 

In the following analysis, we assume that existing items are still existing to the present day. Therefore, even if the last item status date was a year ago if the plant was found to be existing then we assume it is still existing now. (I could change this to just use alive at Item status date, it won't make much difference. )

Since we only have the accession year we set the accession date to be the middle of the year (1st June).

Native plants are any that are from `r location_name`, non-native plants are plants that have geographic information (matched to WCVP) but are not from `r location_name`. This means that we exclude plants not matched to WCVP for the comparision (cultivars, etc). 
 
Below we show the survival probability (Kaplan-Meier plots) for native and non-native plants.

```{r, survival analysis, echo = FALSE}
# Remove those without accession year.
enriched_report = enriched_report[as.numeric(enriched_report$AccYear) > 1650 & as.numeric(enriched_report$AccYear) < 2024,]

# Create a data-frame of the information we want.
wanted_data = data.frame(enriched_report$TaxonNameFull, enriched_report$AccYear, enriched_report$ItemStatusDate, enriched_report$ItemStatusType)
names(wanted_data) = c('TaxonNameFull', 'AccYear', 'ItemStatusDate', 'ItemStatusType')

wanted_data = wanted_data[!is.na(wanted_data$ItemStatusDate),]
wanted_data = wanted_data[!is.na(wanted_data$AccYear),]
#Set accession date (just chose the first of June)
pre_date = rep(NA, length(wanted_data$AccYear))
pre_date = paste(wanted_data$AccYear, "06", "01", sep = "-")

# Convert ItemStatusDate into all dates (i.e if month or day missing add one)
post_date = rep(as.character(Sys.Date()), length(wanted_data$AccYear))
post_date[which(wanted_data$ItemStatusType == "NotExisting")] = as.character(wanted_data$ItemStatusDate[which(wanted_data$ItemStatusType == 
  "NotExisting")])

post_date[which(stringr::str_length(post_date) == 4)] = paste(post_date[which(stringr::str_length(post_date) == 
  4)], "12", "28", sep = "-")
post_date[which(stringr::str_length(post_date) == 7)] = paste(post_date[which(stringr::str_length(post_date) == 
  7)], "28", sep = "-")

# Create the time difference between accession and ItemStatusDate.
time = as.numeric(as.Date(post_date) - as.Date(pre_date)) /365.25

# Create status to tell whether the last item status date was item death or just a check.
status = rep(0,length(wanted_data$AccYear))
status[wanted_data$ItemStatusType == 'NotExisting'] = 1

wanted_data = data.frame(wanted_data, AccessionDate = pre_date,
                         StatusDate = post_date,
                         time = time,
                         Alive_dead = status)


# We haven't removed those with missing ItemStatusDate, these will most likely have negative time so remove these.
missing_itemstatusdate_index = which(wanted_data$time > 0)
wanted_data = wanted_data[missing_itemstatusdate_index,]
enriched_report = enriched_report[missing_itemstatusdate_index,]


## 1) Native or non-native (or doesn't have geography info.)
location = location_code
#Get which records are native.
native_non_native = rep('Not Native',nrow(enriched_report))
native_non_native[which(enriched_report$POWO_plant_name_id %in% native_plant_ids)] = 'Native'
native_non_native[is.na(enriched_report$POWO_Dist_000_area_code_l3)] = NA

data_to_analyse = data.frame(wanted_data$TaxonNameFull,
                             wanted_data$time,
                             wanted_data$Alive_dead,
                             native_non_native)
names(data_to_analyse) = c("TaxonNameFull", "time", "Alive_dead", "native_status")

if(export_data){
  exporting_data_store$Data_for_survival = data_to_analyse
}
```
```{r, survival analysis - figure, echo  = FALSE, fig.fullwidth=TRUE, fig.dim = c(10, 6), results='hide',fig.keep='all', message=FALSE}
# Create Kaplan-Meier plots comparing native and not native
ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ native_status, data = data_to_analyse) |> 
  ggsurvfit::ggsurvfit() +
  ggplot2::labs(
    x = "Years",
    y = "Overall survival probability"
  ) + 
  ggsurvfit::add_confidence_interval()+
    # theme(text = element_text(size=table_font_size))+
  labs(title=paste0("Survival probability of native and non native plants in the LC")) +
  labs(caption = "Shaded region represents 95% confidence interval.") +
  ggtheme() + scale_colour_discrete()

          if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','native_notnative_survival.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
    }
```

Next we give the survival probability for 10-year intervals. 

```{r, survival analysis - tables, echo = FALSE, message=FALSE}
# We can also get survival probabilities in a table
# 
ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ native_status, data = data_to_analyse) |> 
  gtsummary::tbl_survfit(
    times = c(10,20,30),
    label_header = "{time}-year survival (95% CI)")

ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ native_status, data = data_to_analyse) |> 
  gtsummary::tbl_survfit(
    times = c(40,50,60),
    label_header = "{time}-year survival (95% CI)")
ggsurvfit::survfit2(survival::Surv(time, Alive_dead) ~ native_status, data = data_to_analyse) |> 
  gtsummary::tbl_survfit(
    times = c(70,80,90),
    label_header = "{time}-year survival (95% CI)")
```


```{r, export data, echo = FALSE}
if(export_data){
  #remove all data except wanted to be exported.
  rm(list=setdiff(ls(), "exporting_data_store"))
  # Do some changes (which we do in smaller chunks in the actual code.)
  
  exporting_data_store$Number_of_native_species_in_LC_over_time
  Proportion_species_in_LC_over_time = exporting_data_store$Total_species_in_LC_over_time
  for(i in 2:5){
    Proportion_species_in_LC_over_time[[i]] = round(exporting_data_store$Number_of_native_species_in_LC_over_time[[i]] / exporting_data_store$Total_species_in_LC_over_time[[i]] *100, digits = 2)
  }
  exporting_data_store$Total_species_in_LC_over_time = Proportion_species_in_LC_over_time
  names(exporting_data_store)[ names(exporting_data_store) == 'Total_species_in_LC_over_time'] = 'Proportion_species_in_LC_over_time'
  
  exporting_data_store$Total_species_in_LC_over_time$Items =  
  
  # save as .rda.
  save(exporting_data_store, file = paste0(collection,'_data_for_figures.rda'))
  
  # save as xlsx.
  library(xlsx)
  file = paste0(collection,'_data_for_figures.xlsx')
  wb <- createWorkbook()
  datas <- exporting_data_store
  data_titles = names(datas) |> stringr::str_replace_all('_', ' ')
  sheetnames <- paste0('Sheet ', 1:length(datas))
  sheets <- lapply(sheetnames,  createSheet, wb = wb)
  for(i in 1:length(datas)){
    # First we'll create a new row, let's put the title on row 2
    titleRow <-createRow(sheets[[i]], rowIndex=1)
    # We'll add a cell to that row (in the first column) for the title
    sheetTitle <-createCell(titleRow, colIndex=1)
    # We'll add the sheet title to the cell
    setCellValue(sheetTitle[[1,1]], data_titles[i])
    # We'll choose the formatting for the cell
    xlsx::addDataFrame(datas[[i]], sheet = sheets[[i]],row.names = FALSE, startRow = 3)
  }
  saveWorkbook(wb, file = file)
}
```
***
