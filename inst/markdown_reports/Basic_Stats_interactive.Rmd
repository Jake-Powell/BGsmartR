---
title: "Current and retrospective overview of the collection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(ggplot2)
library(plotly)
library(rjson)
```

```{r, echo = F}
# Inputs
# As an input we get 
# - Enriched report
# - min_year for retrospective reports.
# - collection the name to be printed in the report.


report = enriched_report

if(is.null(min_year)){
  min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1
}
```

This report uses data from `r collection`. 

## Current overview of the collection


```{r, Anaylsis, echo = F}
# Restrict to existing plants.
report = report[report$ItemStatusType == 'Existing',]

#No families.
# = Use POWO family if available if not use the original.
families = data.frame(original = report$Family, POWO = report$POWO_family)
use_family = families$POWO
use_family[is.na(use_family)] = families$original[is.na(use_family)]
no_families <- length(unique(use_family))

#No genus
# = Use POWO genus if available if not use the original.
genus = data.frame(original = report$Genus, POWO = report$POWO_genus)
use_genus = genus$POWO
use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
no_genus <- length(unique(use_genus))


#No species
POWO_GenusSpecies = rep(NA, nrow(report))
POWO_GenusSpecies[!is.na(report$POWO_plant_name_id)] = paste0(report$POWO_genus[!is.na(report$POWO_plant_name_id)],
                                                              ' ',
                                                              report$POWO_species[!is.na(report$POWO_plant_name_id)])
species_data = data.frame(original = report$GenusSpecies, POWO = POWO_GenusSpecies, infra = report$infrageneric_level)

#remove cultivars, indeterminants, hybrids and those without infrageneric level
species_only = species_data[!grepl('5|6|0',species_data$infra),]
species_only = species_only[!is.na(species_only$infra),]

use_species = species_only$POWO
use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
no_species = length(unique(use_species))
species_later = no_species

species_powo = unique(species_only$POWO[!is.na(species_only$POWO)])
species_notpowo = unique(species_only$original[is.na(species_only$POWO)])
species_notpowo = species_notpowo[!species_notpowo %in% species_powo]
```

We restrict the database to only plants that are currently existing. This gives `r nrow(report)` records.

***

### General taxonomic diversity

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
## general_taxonomic_div plot.
taxa = data.frame(count = c(no_species,no_genus,no_families), TaxonomicCategory = c(c("Species", "Genera", "Families")))
general_taxonomic_div<-ggplot(data=taxa, aes(x=TaxonomicCategory, y=count)) +
  geom_bar(stat="identity", fill="#78c679")+
  # add values to the bars
  geom_text(aes(label=count), vjust=-0.3, color="black",
            position = position_dodge(0.9), size=3)+
  theme_minimal()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.line = element_line())+
  ylim(0,max(taxa$count)+max(taxa$count*0.05))+
  labs(title = "",x=NULL, y = "Number"
       )+
  theme(plot.title = element_text(color = "#78c679", face = "bold"))

general_taxonomic_div
```

In the above:

- Families: The family taken from matched POWO where available, otherwise the family from the original report.
- Genera: The genus taken from matched POWO where available, otherwise the family from the original report. 
- Species: Ignore records that are indeterminants, cultivars and hybrids. We then use the GenusSpecies from matched POWO where available, otherwise we use GenusSpecies from the original report. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`.

***

### Infrageneric diversity data

```{r, echo = F}
# Infrageneric diversity data

# First get POWO taxon name if it exists, if not use sanitised name.
taxon_names = report$POWO_taxon_name
taxon_names[is.na(taxon_names)] = report$sanitised_taxon[is.na(taxon_names)]


hort = taxon_names[grepl('5|6',report$infrageneric_level)]
no_hort = length(unique(hort))

taxon_rank = taxon_names[grepl('2|3|4',report$infrageneric_level)]
no_taxon_rank = length(unique(taxon_rank))

species = taxon_names[grepl('1',report$infrageneric_level)]
no_species = length(unique(species))

taxa_infra = data.frame(number = c(no_species, no_taxon_rank, no_hort),
                        InfragenericLevel = c('Species','Infra sp', 'Horticultral'))
taxa_infra$lab.ypos = cumsum(taxa_infra$number) - 0.5*taxa_infra$number
```


```{r,echo=F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
TaxLev_plot<- ggplot(data = taxa_infra, aes(x=2, y=number, fill=InfragenericLevel))+
  geom_bar(#width = 1, 
    stat = "identity", #color="white"
  )+  
  theme_void()+
  coord_polar("y", start=0, direction = -1) +
  theme(legend.position = "right")+
  scale_fill_manual(values = c('#e6e6e6', '#d9f0a3','#78c679'))+
  geom_text(aes(y= lab.ypos, label = number), color = "black", size=4)+
  xlim(0.5, 2.5)+ labs(fill = 'Taxonomic Level')
# labs(caption = "'infra sp' includes subsp., var., and f.,\n'horticultural' hybrids and cultivars",
#        fill = "Infrageneric diversity")+

TaxLev_plot
```

where:

- Horticultural: consists of hybrids and cultivars.
- Infra sp: includes subspecies (subsp.), varieties (var.) and forma (f.).
- Species: consists of species, where subspecies, varities and forma have not been included.

***

### Number of Accessions, Items, and Species

```{r,echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_items = nrow(report)
no_accessions = length(unique(report$AccNoFull))

basics = data.frame(count = c(no_items,no_accessions,species_later), objects = c(c("Items", "Accessions", "Species")))

general_numbers<-ggplot(data=basics, aes(x=objects, y=count)) +
  geom_bar(stat="identity", fill="#78c679")+
  # add values to the bars
  geom_text(aes(label=count), vjust=-0.3, color="black",
            position = position_dodge(0.9), size=3)+
  theme_minimal()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.line = element_line())+
  ylim(0,max(basics$count)+max(basics$count*0.05))+
  labs(title="\n",subtitle = "" ,x=NULL, y = "Number")
general_numbers
```


In the above:

- Items: The number of records in the report.
- Accessions: The number of accessions in the report. Calculated by counting the number of unique values in `AccNoFull`. 
- Species: Ignore records that are indeterminants, cultivars and hybrids. We then use the GenusSpecies from matched POWO where available, otherwise we use GenusSpecies from the original report. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`.

***

###  Geography of the plants in the collection


```{r, echo = F, eval = T}
# reduce to only those records with POWO match.
re = report[!is.na(report$POWO_Dist_area_code_l3),]
re$good_name = paste0(re$sanitised_taxon, ' ', re$extracted_author)
```
```{r, echo = F, eval = T}
# load all geo areas
wgsrpd3 = BGSmartR::wgsrpd3

details = data.frame(name = wgsrpd3$LEVEL3_NAM, code = wgsrpd3$LEVEL3_COD)
plants = rep('', nrow(details))
no_plants = rep(NA,nrow(details))
no_unique_plants = rep(NA,nrow(details))
plant_ex = rep('',nrow(details))
for(i in 1:length(details$code)){
  index = grepl(pattern = details$code[i], x = re$POWO_Dist_area_code_l3) 
  if(any(index)){
    plants[i] = paste0(unique(re$good_name[index]), collapse =', ')
    plant_ex[i] = unique(re$good_name[index])[1]
    no_plants[i] = sum(index)
    no_unique_plants[i] = length(unique(re$good_name[index]))
  }
}

details = data.frame(details, plants = plants, plant_ex = plant_ex,  no_plants = no_plants, no_unique_plants = no_unique_plants)

text = paste0('Region: ', details$name, '<br />', 
              'Number of plants: ', details$no_plants,  '<br />',
              'Unique plants: ', details$no_unique_plants,  '<br />',
              'Plant: ', details$plant_ex)
details$hover = text


# Convert geometry into a format accepted by plotly
mapp = sf::st_cast(wgsrpd3, "MULTIPOLYGON")
geo_sf = geojsonsf::sf_geojson(mapp)
data = rjson::fromJSON(geo_sf)
feat = data$features
for(i in 1:length(feat)){
  feat[[i]]$id = feat[[i]]$properties$LEVEL3_COD
}
data$features = feat

# geo styling
g <- list(
  scope = 'world',
  showland = TRUE,
  landcolor = toRGB("White"),
  showocean = TRUE,
  oceancolor = toRGB("LightBlue"),
  showcountries = F,
  lonaxis = list(showgrid = T),
  lataxis = list(showgrid = T)
)
fig <- plot_ly()
fig <- fig %>% add_trace(
  type="choropleth",
  geojson=data,
  locations=details$code,
  text = details$hover,
  hoverinfo = 'text',
  z=details$no_unique_plants,
  colorscale="Viridis",
  zmin=0,
  zmax=max(details$no_unique_plants),
  marker=list(line=list(
    width=0)
  )
)
fig <- fig %>% colorbar(title = "Number of Unique Plants")
# fig <- fig %>% layout(
#   title = "Geographic Distribution of Garden's collection"
# )

fig <- fig %>% layout(
  geo = g
)

fig <- fig   %>% config(modeBarButtonsToRemove = c("select2d", "lasso2d"))

```

For plants that we successfully matched to POWO (`r nrow(re)` records corresponding to `r length(unique(re$good_name))` unique plants) we have geographic distribution data. 


```{r, echo =F, fig.dim = c(10, 8), eval = T}
fig
```
Hover over regions for:

- Name of the `Region`.
- `Number of plants` in the collection that are native to the region.
- Number of `unique plants` in the collection that are native to the region.
- A single plant from the collection that is native to the region. 

***

<hr style="border: 0.3px solid green; width:80%;"></hr>


## Retrospective overview of the collection

```{r, echo = F}
# Function that gives the records that exist at a certain date. 
exist_at_date <- function(date, acc, ItemStatusDate, ItemStatusType){
  
  date = as.Date(date)
  # Accession date.
  pre_date = rep(NA,length(acc)) ; pre_date_char = rep(NA,length(acc)) 
  pre_date[which(acc > 1650)] =as.Date(paste(acc[which(acc > 1650)], '01', '01', sep = "-"), "%Y-%m-%d") 
  pre_date_char[which(acc > 1650)] = paste(acc[which(acc > 1650)], '01', '01', sep = "-")
  
  # use the current day, unless not existing then use the date of that entry. 
  post_date = rep(as.character(Sys.Date()),length(acc))
  post_date[ItemStatusType == 'NotExisting'] = ItemStatusDate[ItemStatusType == 'NotExisting']
  # If only a year is given assume it occurs on the 1st of Jan.
  post_date[stringr::str_length(post_date) == 4] = paste( post_date[stringr::str_length(post_date) == 4], '01', '01', sep = "-")
  # If only a year and month is given assume the dat is the 1st. 
  post_date[stringr::str_length(post_date) == 7] = paste( post_date[stringr::str_length(post_date) == 7], '01', sep = "-")
  dates = data.frame(pre = pre_date_char, post = post_date, pre_date = pre_date, post_date = as.Date(post_date, "%Y-%m-%d"))
  
  # Vector of whether the plant is existing on the date. 
  out = matrix(NA, nrow = length(acc), ncol = length(date))
  for(i in 1:length(date)){
    existing_on_date = rep(FALSE, length(acc))
    existing_on_date[which(date[i] >= dates$pre_date & date[i] < dates$post_date)] = TRUE
    
    out[,i] = existing_on_date
  }
  
  out = data.frame(out)
  names(out) = date

  return(out)  
}

# min_year = min(enriched_report$AccYear[enriched_report$AccYear>1750],na.rm = T) + 1

date = paste0(min_year:2023, '-01-01')

result = exist_at_date(date, acc = enriched_report$AccYear,
                       ItemStatusDate = enriched_report$ItemStatusDate,
                       ItemStatusType = enriched_report$ItemStatusType)

time_series_info = lapply(result, function(x){
  garden_current = enriched_report[x,]
  
  # Number of families.
  families = data.frame(original = garden_current$Family, POWO = garden_current$POWO_family)
  use_family = families$POWO
  use_family[is.na(use_family)] = families$original[is.na(use_family)]
  no_families <- length(unique(use_family))

  # Number of genera.
  genus = data.frame(original = garden_current$Genus, POWO = garden_current$POWO_genus)
  use_genus = genus$POWO
  use_genus[is.na(use_genus)] = genus$original[is.na(use_genus)]
  no_genus <- length(unique(use_genus))


   #No species (#remove cultivars, indeterminants, hybrids and those without infrageneric level)
  POWO_GenusSpecies = rep(NA, nrow(garden_current))
  POWO_GenusSpecies[!is.na(garden_current$POWO_plant_name_id)] = paste0(garden_current$POWO_genus[!is.na(garden_current$POWO_plant_name_id)], ' ', garden_current$POWO_species[!is.na(garden_current$POWO_plant_name_id)])
  species_data = data.frame(original = garden_current$GenusSpecies, POWO = POWO_GenusSpecies, infra = garden_current$infrageneric_level)
  species_only = species_data[!grepl('5|6|0',species_data$infra),]
  species_only = species_only[!is.na(species_only$infra),]
  use_species = species_only$POWO
  use_species[is.na(use_species)] = species_only$original[is.na(use_species)]
  no_species = length(unique(use_species))
  
  # Number of accessions.
  no_accessions = length(unique(garden_current$AccNoFull))
  
  # Number of items
  no_items = nrow(garden_current)
  
  # Breakdown of infrageneric diversity.
  breakdown_infrageneric = table(garden_current$infrageneric_level)
  
  # Breakdown of provenance.
  breakdown_provenance = table(garden_current$ProvenanceCode)
  
  
  return(list(no_families = no_families, no_genus = no_genus, no_species = no_species, no_accessions = no_accessions, no_items = no_items, breakdown_infrageneric = breakdown_infrageneric, breakdown_provenance = breakdown_provenance))
})
names(time_series_info) = names(result)
```

This section reviews the garden's collection over time. The first record in the garden comes from `r min_year -1` therefore we will take snapshots (existing plants) of the garden's collection on the 1st of January every year from `r min_year` to 2023.

***

### Change in number of familes over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
families = unlist(lapply(time_series_info, function(x){x$no_families}))
data = data.frame(year = as.numeric(stringr::str_extract(names(families),'[0-9]{4}')), no_families = families)
data$text = paste0('Date: ',names(families), ' <br>', 'Families: ', data$no_families)

fig <- plot_ly(data, x = ~year, y = ~no_families, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Families")) 
fig <- fig %>% layout(hovermode = 'x')

fig
```

We use the family taken from matched POWO record where available, otherwise we use the family from the original report.

***

### Change in number of genera over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_genus = unlist(lapply(time_series_info, function(x){x$no_genus}))
data = data.frame(year = as.numeric(stringr::str_extract(names(no_genus),'[0-9]{4}')), no_genus = no_genus)
data$text = paste0('Date: ',names(no_genus), ' <br>', 'Genus: ', data$no_genus)

fig <- plot_ly(data, x = ~year, y = ~no_genus, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Genera")) 
fig <- fig %>% layout(hovermode = 'x')

fig
```

We use the genus taken from matched POWO record where available, otherwise we use the genus from the original report.

***

### Change in number of species over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_species = unlist(lapply(time_series_info, function(x){x$no_species}))
data = data.frame(year = as.numeric(stringr::str_extract(names(no_species),'[0-9]{4}')), no_species = no_species)
data$text = paste0('Date: ',names(no_species), ' <br>', 'Species: ', data$no_species)

fig <- plot_ly(data, x = ~year, y = ~no_species, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Species")) 
fig <- fig %>% layout(hovermode = 'x')

fig
```

We ignore records that are indeterminants, cultivars and hybrids. We then use `GenusSpecies` from matched POWO records where available, otherwise we use `GenusSpecies` from the original report. Note that here we condense subspecies, varieties and forma into their corresponding species. For example `Tephrosia longipes var. drummondii` would be condensed to the species `Tephrosia longipes`. 

***

### Change in number of accessions over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_accessions = unlist(lapply(time_series_info, function(x){x$no_accessions}))
data = data.frame(year = as.numeric(stringr::str_extract(names(no_accessions),'[0-9]{4}')), no_accessions = no_accessions)
data$text = paste0('Date: ',names(no_species), ' <br>', 'Accessions: ', data$no_accessions)

fig <- plot_ly(data, x = ~year, y = ~no_accessions, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Accessions")) 
fig <- fig %>% layout(hovermode = 'x')

fig
```

We use `AccNoFull` from the original report. 

***

### Change in number of items over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
no_items = unlist(lapply(time_series_info, function(x){x$no_items}))
data = data.frame(year = as.numeric(stringr::str_extract(names(no_items),'[0-9]{4}')), no_items = no_items)
data$text = paste0('Date: ',names(no_items), ' <br>', 'Items: ', data$no_items)

fig <- plot_ly(data, x = ~year, y = ~no_items, type = 'scatter', mode = 'lines', text = ~text, hoverinfo = 'text')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Items")) 
fig <- fig %>% layout(hovermode = 'x')

fig
```

The number of items is defined by the number of 'existing' records. By 'existing' we mean that the current date is after the item's accession year and the item is still existing. 

***

### Change in infrageneric diversity over time.

We group the plants into:

- Indeterminant: consists of indeterminant plants.
- Species: consists of species, where subspecies, varities and forma have not been included.
- Infra sp: includes subspecies (subsp.), varieties (var.) and forma (f.).
- Horticultural: consists of hybrids and cultivars.


```{r, echo = F}
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_infrageneric
  
  indet = sum(as.numeric(details[grepl('0',names(details))]))
  species = sum(as.numeric(details[grepl('1',names(details))]))
  infra = sum(as.numeric(details[grepl('2|3|4',names(details))]))
  hort = sum(as.numeric(details[grepl('5|6',names(details))]))
  
  return(c(indet, species, infra, hort))
  }))))
names(no_items) = c('indet', 'species', 'infra', 'hort')
prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
data = data.frame(year = as.numeric(stringr::str_extract(rownames(no_items),'[0-9]{4}')), no_items, prop)
data$text = paste0('Date: ', names(time_series_info), ' <br>', 'Indeterminat: ', data$indet,
                   ' <br>', 'Species: ', data$species,
                   ' <br>', 'Infrageneic: ', data$infra,
                   ' <br>', 'Horticultral: ', data$hort)
```

We first produce a plot of the raw number of plants (records) over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~indet, name = 'Indeterminant',mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~species, name = 'Species', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~infra, name = 'Infrageneric', mode = 'lines',type = 'scatter')
fig <- fig %>% add_trace(y = ~hort, name = 'Horticultral', mode = 'lines',type = 'scatter')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

Then as the proportion of plants (records) at each time point.

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}

fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~indet_prop, name = 'Indeterminant',mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~species_prop, name = 'Species', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~infra_prop, name = 'Infrageneric', mode = 'lines',type = 'scatter')
fig <- fig %>% add_trace(y = ~hort_prop, name = 'Horticultral', mode = 'lines',type = 'scatter')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

***

### Change in provenance over time.

We group the plants into:

- Garden: plants of garden origin,
- Wild: plants of wild origin,
- Unknown: plants whose origin is unknown,

by using the date field `ProvenanceCode`.


```{r, echo = F}
no_items = data.frame(t(data.frame(lapply(time_series_info, function(x){
  details = x$breakdown_provenance
  
  garden = sum(as.numeric(details[grepl('G',names(details))]))
  unknown = sum(as.numeric(details[grepl('U',names(details))]))
  wild = sum(as.numeric(details[grepl('W',names(details))]))

  return(c(garden, unknown, wild))
  }))))
names(no_items) = c('garden', 'unknown', 'wild')
prop = round(no_items/rowSums(no_items)*100,digits=2)
names(prop) =paste0(names(prop),'_prop')
data = data.frame(year = as.numeric(stringr::str_extract(rownames(no_items),'[0-9]{4}')), no_items, prop)
```

We first produce a plot of the raw number of plants (records) over time

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}
#plot_ly line plot (raw)
fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~garden, name = 'Garden', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~unknown, name = 'Unknown', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~wild, name = 'Wild', mode = 'lines',type = 'scatter')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Number of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

Then as the proportion of plants (records) at each time point.

```{r, echo = F, fig.fullwidth=TRUE, fig.dim = c(10, 4)}

fig <- plot_ly(data, x = ~year) 
fig <- fig %>% add_trace(y = ~garden_prop, name = 'Garden', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~unknown_prop, name = 'Unknown', mode = 'lines',type = 'scatter') 
fig <- fig %>% add_trace(y = ~wild_prop, name = 'Wild', mode = 'lines',type = 'scatter')
fig <- fig %>% layout(title = "",
         xaxis = list(title = "Year"),
         yaxis = list (title = "Proportion of Plants")) 
fig <- fig %>% layout(hovermode = 'x unified')
fig
```

***
