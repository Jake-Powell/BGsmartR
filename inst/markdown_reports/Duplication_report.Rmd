---
title: "Rarity and duplication"
output: html_document
always_allow_html: true
---

###### {-} 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)
library(downloadthis)

interactive_colour <- function(n){
  color = c('#f46d43', '#50c1dc', '#848484', '#e6e6e6')
  if(n==2){
    return(color[c(1,4)])
  }
  color[1:n]
}
color_binary <- rev(c('#f46d43', '#e6e6e6'))
palette = 'Oranges'
```

```{css, echo = FALSE}
/* from https://ianlunn.github.io/Hover/ */
.hvr-sweep-to-left {
  display: inline-block;
  vertical-align: middle;
  -webkit-transform: perspective(1px) translateZ(0);
  transform: perspective(1px) translateZ(0);
  box-shadow: 0 0 1px rgba(0, 0, 0, 0);
  position: relative;
  -webkit-transition-property: color;
  transition-property: color;
  -webkit-transition-duration: 0.3s;
  transition-duration: 0.3s;
}
.hvr-sweep-to-left:before {
  content: "";
  position: absolute;
  z-index: -1;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #f46d43;
  -webkit-transform: scaleX(0);
  transform: scaleX(0);
  -webkit-transform-origin: 100% 50%;
  transform-origin: 100% 50%;
  -webkit-transition-property: transform;
  transition-property: transform;
  -webkit-transition-duration: 0.3s;
  transition-duration: 0.3s;
  -webkit-transition-timing-function: ease-out;
  transition-timing-function: ease-out;
}
.hvr-sweep-to-left:hover, .hvr-sweep-to-left:focus, .hvr-sweep-to-left:active {
  color: white;
}
.hvr-sweep-to-left:hover:before, .hvr-sweep-to-left:focus:before, .hvr-sweep-to-left:active:before {
  -webkit-transform: scaleX(1);
  transform: scaleX(1);
}

.blackbox {
  padding: 1em;
  background: #FDAE6B;
  border: 2px solid #e6e6e6;
  border-radius: 10px;
}
.center {
  text-align: center;
}
```

```{r, imported parameters}
#Inputs
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/ICCP_RBGE_enriched_report.rda')
# collection = 'ICCP at Royal Botanic Gardens Edinburgh'
# 
# separate_figure_folder = FALSE
# output_dir = '/Users/jakepowell/Desktop/Reports/ICCP at Royal Botanic Gardens Edinburgh'
# report_kind = 'static'
# ggtheme = NULL
# value_on_fig = TRUE
# min_year = 1970
# join_bigger_than = 4
# export_data  =T
# save_excel = T
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE
bru_codes = NA
```

```{r, add logo, eval = report_kind == 'interactive'}
htmltools::img(src = knitr::image_uri(paste0(system.file(package = "BGSmartR"), "/logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:87.8px; height:100px')
```


```{r theme_ggplot2, echo = FALSE}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.background = element_rect(fill = 'transparent', color = NA),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

```{r, Add combined geography column to enriched report}
geography_data = enriched_report[,grepl('_area_code_l3', names(enriched_report))]
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}
# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}
level3codes[level3codes == "NA"] = NA

enriched_report$geography_codes = level3codes
```

```{r, Get location_type_text}
location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occurring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```

```{r, Find LC location, echo = FALSE}
coord_contained = TRUE
# Extract the location of the collection.
pnts <- data.frame( x = coordinates[2], y = coordinates[1])

# create a points collection
pnts_sf <- do.call("st_sfc",c(lapply(1:nrow(pnts), 
                                     function(i) {sf::st_point(as.numeric(pnts[i, ]))}), list("crs" = 4326))) 

pnts_trans <- st_transform(pnts_sf, 2163) # apply transformation to pnts sf
tt1_trans <- st_transform(wgsrpd3, 2163)      # apply transformation to polygons sf

intersect = as.vector(st_intersects(tt1_trans, pnts_trans, sparse = FALSE))
collection_geog_details = wgsrpd3[which(intersect),-5]
location_name = collection_geog_details$LEVEL3_NAM
location_code = collection_geog_details$LEVEL3_COD

if(length(location_name) == 0){
  coord_contained = FALSE
  # Try and find the nearest polygon.
  collection_geog_details  =  wgsrpd3[which.min(as.vector(sf::st_distance(tt1_trans, pnts_trans))),-5]
  location_name = collection_geog_details$LEVEL3_NAM
  location_code = collection_geog_details$LEVEL3_COD
}



# If we are given bru_codes set the location codes to these. 
coord_location = location_code
coord_name = location_name

if(!is.na(bru_codes[1])){
  location_code = bru_codes
  location_name = wgsrpd3$LEVEL3_NAM[match(bru_codes, wgsrpd3$LEVEL3_COD)]
  collection_geog_details = wgsrpd3[match(bru_codes, wgsrpd3$LEVEL3_COD),-5]
}

```

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"*** \n **Warning!**\n\n This enriched report contains missing 'original' columns needed to perform the analyses in this report. Default values have been created. In particular, the following were missing "}`

`r if(!'no_gardens' %in% names(enriched_report)){"- no_gardens: cannot perform global scale analysis.\n"}`
`r if(!'AccNoFull' %in% names(enriched_report)){"- AccNoFull: assume each item is its own accession.\n"}`

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"***"}`

```{r, Extracting information from enriched report, echo = F}
do_global = TRUE
if(!'AccNoFull' %in% names(enriched_report)){enriched_report$AccNoFull = 1:nrow(enriched_report)}
if(!'no_gardens' %in% names(enriched_report)){do_global = FALSE}
report = enriched_report
no_records = nrow(report)

# Reduce the report to existing (non-cultivars or hybrids)
# index_want = which(report$ItemStatusType == 'Existing' & !grepl('0|5|6',report$taxon_type))
# no_want = length(index_want)
# report = report[index_want,]

# Get the best name from POWO first o/w original report.
report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)

powo_name = paste0(report$POWO_taxon_name, ' ', report$POWO_taxon_authors)
powo_name[which(powo_name == 'NA NA')] = NA
report$powo_name = powo_name

best_name = powo_name
best_name[which(is.na(best_name))] = report$good_name[which(is.na(best_name))]
report$best_name =best_name

#Extract endemic information from enriched_report
endemic = rep('Not Endemic', nrow(report))
endemic_index = which(stringr::str_length(report$geography_codes) == 3)
endemic[endemic_index] = 'Endemic'
report$endemic = endemic
rm(endemic)

# Extract threatened. 
threat_cat = c('VU','EN','CR','EW','EX')
threatened = rep('Not Threatened', nrow(report))
threatened[which(report$redList_category %in% threat_cat)] = 'Threatened'
threatened[which(report$POWO_Red_category %in% threat_cat)] = 'Threatened'
report$threatened = threatened
rm(threatened)

# Extract native.
nativeo = rep('Not Native', nrow(report))
native_index = grepl(location_code,report$geography_codes)
nativeo[native_index] = 'Native'
report$native = nativeo
rm(nativeo)

# Extract tree
tree = rep('Not Tree', nrow(report))
tree_index = which(report$Enrich_is_tree)
tree[tree_index] = 'Tree'
report$tree = tree
rm(tree)

#Select columns of interest
report = report[,match(c('AccNoFull','sanitised_taxon', 'TaxonNameFull', 'powo_name', 'extracted_author', 'POWO_taxon_name', 'POWO_taxon_authors', 'good_name', 'best_name', 'no_gardens', 'endemic', 'threatened', 'native', 'tree', 'ItemStatusType', 'taxon_type', 'AccYear'), names(report))]


index_want = which(report$ItemStatusType == 'Existing' & !grepl('0|5|6',report$taxon_type))
no_want = length(index_want)
interest = report[index_want,]
# interest_global = interest[which(interest$ItemStatusType == 'Existing' & !grepl('0|5|6',interest$taxon_type)),]
interest_global = interest

# Create a column with the name if we want to print the taxa. (latin words with italic, others plain.)
print_name = interest$sanitised_taxon
name_with_italic = unlist(lapply(stringr::str_split(print_name, ' '), function(x){
  x[which(!grepl('\\.',x))] = paste0('*',x[which(!grepl('\\.',x))],'*')
  paste0(x, collapse = ' ')
}))
print_name = paste0(name_with_italic, ' ', interest$extracted_author)
interest$print_name = print_name


if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

## - Deaccessioning list: sheet of very common, non-threatened, non-endemic taxa duplicated three or more times in a LC, including at least taxon name according to POWO, original name, and accession number
deaccessioning_list = interest[which(interest$threatened == 'Not Threatened' &
                                     interest$endemic == 'Not Endemic' & 
                                     interest$no_gardens > 100),]

# Reduce report unique by the number in each.
deaccessioning_list$count = rep(1,nrow(deaccessioning_list))
deaccessioning_list_format <- deaccessioning_list |>
    dplyr::group_by(.data$good_name) |>
    dplyr::summarise(original_report_taxon_name = toString(unique(.data$TaxonNameFull)),
                     powo_taxon_name = toString(unique(.data$powo_name)),
                     no_items_in_LC = sum(.data$count),
                    global = .data$no_gardens[1],
                     accessions = toString(unique(.data$AccNoFull)),
                     endemic = .data$endemic[1],
                     threatened = .data$threatened[1],
                    tree = .data$tree[1]
    ) |>
    dplyr::ungroup() 
deaccessioning_list_format = deaccessioning_list_format[deaccessioning_list_format$no_items_in_LC > 3,]
deaccessioning_list_format = deaccessioning_list_format[,-1]
names(deaccessioning_list_format) = c("Original Report Taxonomic Name", "Matched POWO Taxonomic Name", "Number of Items in the LC", "Number of global LC's holding Taxon", "Accessions in the LC", "Endemic status", "Threatened status", "Tree")
writexl::write_xlsx(deaccessioning_list_format, path =paste0(output_dir,'/',collection,'_deaccessioning_list.xlsx'))


# -Sheet of taxa in 0-10 LCs including at least taxon name according to POWO, original name, and accession number. Can these be fake rare taxa (typos, non-matching names)? If so, add warning to plot and management sheet.

rare_global_list = interest_global[which(interest_global$no_gardens <= 10 | is.na(interest_global$no_gardens)),]
rare_global_list$match_powo_issue = rare_global_list$POWO_taxon_name == rare_global_list$POWO_taxon_name
rare_global_list$match_powo_issue[is.na(rare_global_list$match_powo_issue)] = FALSE

# Reduce report unique by the number in each.
rare_global_list$count = rep(1,nrow(rare_global_list))
rare_global_list_format <- rare_global_list |>
    dplyr::group_by(.data$good_name) |>
    dplyr::summarise(original_report_taxon_name = toString(unique(.data$TaxonNameFull)),
                     powo_taxon_name = toString(unique(.data$powo_name)),
                     match_powo_issue = .data$match_powo_issue[1],
                     no_items_in_LC = sum(.data$count),
                    global = .data$no_gardens[1],
                     accessions = toString(unique(.data$AccNoFull)),
                     endemic = .data$endemic[1],
                     threatened = .data$threatened[1],
                    tree = .data$tree[1]
    ) |>
    dplyr::ungroup() 
no_different_rare_taxa = sum(!rare_global_list_format$match_powo_issue)
rare_global_list_format = rare_global_list_format[,-1]
names(rare_global_list_format) = c("Original Report Taxonomic Name", "Matched POWO Taxonomic Name", "Original Taxonomic Name same as POWO", "Number of Items in the LC", "Number of global LC's holding Taxon", "Accessions in the LC", "Endemic status", "Threatened status", "Tree")
writexl::write_xlsx(rare_global_list_format, path =paste0(output_dir,'/',collection,'_rare_global_list.xlsx'))


```

###### {-} 

This report explores rarity and duplication for existing plants at **`r collection`**. Rarity refers to the spread of a plant among living plant collections globally, whereas duplication focuses at the local scale by evaluating the number of plants of a given species in a single living collection.

Within this report we only consider plants that are not hybrids or cultivars. This reduces the number of records in the living collection to `r format(no_records, big.mark =',')` from `r format(nrow(interest), big.mark =',')`.

Where possible we use the name from matching to POWO; if this is not possible, we use the original name from the living collection. 

***

## Rarity in cultivation

`r if(!do_global){"Since the report does not contain the number of global collections holding taxa we cannot perform this analysis!"}`

`r if(do_global){"To find the rarity of plants on the Global scale we use BGCI's PlantSearch tool to extract the number of ex-situ sites a taxon is held in (only plants, not seeds or pollen)."}`

<!-- `r if(do_global){"- Match to POWO, and update taxonomic name and authority if needed (e.g. going to accepted name)."}` -->
<!-- `r if(do_global){"- Use the taxonomic name and authority to match to BGCI's plant search."}` -->
<!-- `r if(do_global){"- Extract the number of ex-situ sites, if the record does not exist set the number of gardens to zero."}` -->

`r if(do_global){"Below we show the number of taxa in the living collection against the number of sites the taxa is held globally. This is shown for all taxa as well as key collections - threatened, endemic, native and tree. \n"}`


```{r, taxa in collection against how many sites globally - data, eval = do_global}
# only unique records.
report_unique = unique(interest_global[,-1]) # Remove the accession number as it's not needed for unique species.
report_unique = interest_global[match(unique(interest_global$best_name), interest_global$best_name),]
no_unique_records = nrow(report_unique)
report_unique$no_gardens[is.na(report_unique$no_gardens)] = 0

# Reduce report unique by the number in each.
# report_unique$count = rep(1,nrow(report_unique))
data_plot <- report_unique |>
    dplyr::group_by(.data$no_gardens) |>
    dplyr::summarise(plants = toString(sanitised_taxon),
                     one_plant = sanitised_taxon[1],
                     no_species_in_garden = length(no_gardens),
                     threatened = sum(threatened == 'Threatened'),
                     endemic = sum(endemic == 'Endemic'),
                     native = sum(native == 'Native'),
                     tree = sum(tree == 'Tree')
    ) |>
    dplyr::ungroup() |> as.data.frame()

# data formatted if we want to export/save it.
globally_held_taxa = data_plot[,c(1,4,2)]
names(globally_held_taxa) = c("Number of global LCs", "Number of species in LC", "All taxa")

```

```{r, taxa in collection against how many sites globally - static figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'static'){
  colors = c('#41ab5d', '#78c679', '#addd8e', '#d9f0a3')
  xstart = c(0,10,50,100)
  xend = c(10,50,100, max(data_plot$no_gardens))
  
  grouped = table(cut(data_plot$no_gardens, breaks = c(xstart, max(data_plot$no_gardens, na.rm=T))))
  names(grouped) =  c('0 to 10', '11 to 50', '51 to 100', 'Over 100')
  
  rects <- data.frame(xstart = xstart, xend = xend, col = colors, Grouped = names(grouped))
  rects$Grouped = factor(rects$Grouped , levels = rects$Grouped)

  p = ggplot() + 
  geom_rect(data = rects, 
            aes(xmin = xstart, xmax = xend, ymin = -Inf, ymax = Inf, fill = Grouped), alpha = 1) +
    scale_fill_manual(values = colors) +
  geom_point(data = data_plot, aes(x=no_gardens, y=no_species_in_garden)) +
  labs(title=paste0(""),
       x ="Number of living collections holding \n the taxa worldwide",
       y = paste0('Number of taxa grown \n at the collection')) +
    theme(legend.position = "none")

  p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

   if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Scatter-grown_in_LC_against_global.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
   }
  
  p
}
```

```{r, taxa in collection against how many sites globally - interactive figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'interactive'){
colo_rare = rev(scales::brewer_pal(palette = palette, direction = 1)(5))

figs = list()
for(i in 4:ncol(data_plot)){
    text = paste0(as.vector(data_plot[,i]), ' ', rep(names(data_plot)[i],nrow(data_plot)), ' species in the garden are found in ', data_plot$no_gardens, ' collections globally')
  if(i == 4){
     text = paste0(data_plot$no_species_in_garden, ' species in the garden are found in ', data_plot$no_gardens, ' collections globally.')
  }
    data_plot_cur = data_plot
    data_plot_cur$text = text
  data_plot_cur = data_plot_cur[data_plot_cur[,i] != 0,]  
  
  fig <- plot_ly(data_plot_cur, x = ~no_gardens, y = data_plot_cur[,i], 
         type = 'scatter',  mode = 'markers', hoverinfo = "text",  hovertext = ~text, colors = rgb(0,0,0,alpha=0.7), color = 'color')
fig <- fig |> layout(title = "",
  xaxis = list(title = "Number of living collections holding the taxa worldwide"),
  yaxis = list (title = "Number of taxa grown at the collection")) 
fig <- layout(fig,
             shapes = list(
               list(type = "rect",
                    fillcolor = colo_rare[1], line = list(color = colo_rare[1]), opacity = 0.3,
                    x0 = 0, x1 = 1.5, xref = "x",
                    y0 = 0, y1 = max(data_plot[,i]), yref = "y"),
               list(type = "rect",
                    fillcolor = colo_rare[2], line = list(color = colo_rare[2]), opacity = 0.3,
                    x0 = 1.5, x1 = 10.5, xref = "x",
                    y0 = 0, y1 = max(data_plot[,i]), yref = "y"),
                list(type = "rect",
                    fillcolor = colo_rare[3], line = list(color = colo_rare[3]), opacity = 0.3,
                    x0 = 10.5, x1 = 50.5, xref = "x",
                    y0 = 0, y1 = max(data_plot[,i]), yref = "y"),
               list(type = "rect",
                    fillcolor = colo_rare[4], line = list(color = colo_rare[4]), opacity = 0.3,
                    x0 = 50.5, x1 = 100.5, xref = "x",
                    y0 = 0, y1 = max(data_plot[,i]), yref = "y"),
                list(type = "rect",
                    fillcolor = colo_rare[5], line = list(color = colo_rare[5]), opacity = 0.3,
                    x0 = 100.5, x1 = max(data_plot$no_gardens), xref = "x",
                    y0 = 0, y1 = max(data_plot[,i]), yref = "y")               
              ))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Scatter-grown_in_LC_against_global.html'))
}
figs[[i-3]] = fig
}
names(figs) = c('all',names(data_plot)[5:ncol(data_plot)])

# figs$all
}
```

`r if(report_kind == 'interactive'){"#####   {.tabset}"}`
`r if(report_kind == 'interactive'){"###### All"}`

```{r detailed rarity  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$all
```

`r if(report_kind == 'interactive'){"###### Threatened"}`
```{r detailed rarity threatened  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$threatened
```

`r if(report_kind == 'interactive'){"###### Endemic"}`
```{r detailed rarity endemic  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$endemic
```

`r if(report_kind == 'interactive'){"###### Native"}`
```{r detailed rarity native  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$native
```

`r if(report_kind == 'interactive'){"###### Tree"}`
```{r detailed rarity tree  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$tree
```

`r if(report_kind == 'interactive'){"##### {-}"}`

As another way to visualise rarity and compare the whole collection to its key collections, we defined discrete rarity categories as follows

- **Unique**: plants found nowhere else (0 or 1 collection). These are names that do not match any name or match a name reported in only one collection in BGCIâ€™s PlantSearch tool. Since it is not possible to know to which collection it belongs, BGsmartR assumes it belongs to yours and the name is in PlantSearch thanks to your input to that database. 
- **Very Rare**: plants found in 2-10 collections.
- **Rare**: plants found in 11-50 collections.
- **Common**: plants found in 51-100 collections.
- **Very Common**: plants found in more than 100 collections.


```{r, grouped rarity - data, fig.dim = c(10, 4), eval = do_global}
colo_rare = rev(scales::brewer_pal(palette = palette, direction = 1)(5))
counter <- 1
columns = names(data_plot)[4:ncol(data_plot)]
plot_data = lapply(columns, function(column){
  unique_ = sum(data_plot[[column]][data_plot$no_gardens %in% 0:1])
  v_rare = sum(data_plot[[column]][data_plot$no_gardens %in% 2:10])  
  rare = sum(data_plot[[column]][data_plot$no_gardens %in% 11:50]) 
  common = sum(data_plot[[column]][data_plot$no_gardens %in% 51:100]) 
  v_common = sum(data_plot[[column]][data_plot$no_gardens %in% 100:1500])
  
  doughnut_data = data.frame(rarity = c('Unique','Very Rare', 'Rare', 'Common', 'Very Common'),
                        no_items = c(unique_, v_rare, rare, common, v_common),
                        color = colo_rare)
doughnut_data$percent = round(doughnut_data$no_items / sum(doughnut_data$no_items)*100,digits = 1)
doughnut_data$type = rep(column, nrow(doughnut_data))
doughnut_data
})
plot_data = do.call('rbind',plot_data)
plot_data$type[plot_data$type == "no_species_in_garden"] = 'all'
plot_data$rarity = factor(plot_data$rarity, levels = unique(plot_data$rarity))
plot_data$type = stringr::str_to_title(plot_data$type)
plot_data$type =  factor(plot_data$type, levels = c('All', 'Threatened', 'Endemic', 'Native', 'Tree'))
plot_data$hover = paste0(plot_data$percent, '% (',plot_data$no_items,') of taxa are classed as ',plot_data$rarity,'' )
hor_stack_bar_plot = plot_ly(plot_data,
                             type = 'bar',
                             y = ~type,
                             x = ~percent,
                             color = ~rarity,
                             colors = unique(plot_data$color),
                             orientation = 'h',
                            hovertext = ~hover, hoverinfo = 'text')
hor_stack_bar_plot_acc <- hor_stack_bar_plot |> plotly::layout(xaxis = list(title = "Percentage of taxa"),
                                   yaxis = list(title = ''),barmode = 'stack',hovermode = 'y unified')


unique_ = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 0:1])
v_rare = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 2:10])  
rare = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 11:50]) 
common = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 51:100]) 
v_common = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 100:1500]) 

doughnut_data = data.frame(rarity = c('Unique','Very Rare', 'Rare', 'Common', 'Very Common'),
                        no_items = c(unique_, v_rare, rare, common, v_common),
                        color = colo_rare)
doughnut_data$percent = paste0(round(doughnut_data$no_items / sum(doughnut_data$no_items)*100,digits = 1),'%')


# data formatted if we want to export/save it.
globally_held_taxa_grouped = doughnut_data[,c(1,2,4,3)]
names(globally_held_taxa_grouped) = c("Rarity in global LCs",   "Number of Taxa in LC", "Percentage",  "Colour" )
```

```{r, grouped rarity - static figure, fig.dim = c(10, 4), eval = do_global}
# if(report_kind == 'static'){
# 
#   doughnut_data <- doughnut_data |> 
#   dplyr::mutate(csum = rev(cumsum(rev(no_items))), 
#          pos = no_items/2 + dplyr::lead(csum, 1),
#          pos = dplyr::if_else(is.na(pos), no_items/2, pos))
# 
#   
#   p = ggplot(doughnut_data, aes(x="", y=no_items, fill=forcats::fct_inorder(rarity))) +
#   geom_bar(stat="identity", width=1, color="white") +
#   # ggtheme(base_size = 18) +
#   coord_polar("y", start=0) +
#   ggtitle('') +
#   scale_fill_manual(values= colors,) +
#   theme(axis.line=element_blank(),
#         axis.text.x=element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks=element_blank(),
#         axis.title.x=element_blank(),
#         axis.title.y=element_blank(),
#         panel.background=element_blank(),
#         panel.border=element_blank(),
#         panel.grid.major=element_blank(),
#         panel.grid.minor=element_blank(),
#         plot.background=element_blank(),
#         plot.title = element_text(hjust = 0.5)) +
#     guides(fill=guide_legend(title="Rarity"))
#   
#   if(value_on_fig){
#     p = p + geom_label_repel(aes(y = pos,label = percent),
#         size = 4.5, nudge_x = 1, show.legend = FALSE, fill = "white")
#   }
#   
# 
# if(separate_figure_folder){
#    ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-grouped_global_rarity.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
# }
# 
# p
# }

```

```{r, grouped rarity - interactive figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'interactive'){
  text = paste0(doughnut_data$no_items, ' records classed as ', doughnut_data$rarity )

fig <- plot_ly(doughnut_data, labels = ~rarity, values = ~no_items, hoverinfo = "text",  hovertext = text, marker = list(colors = ~color) )
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",  showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-grouped_global_rarity.html'))
}

hor_stack_bar_plot_acc
}

```

`r if(do_global & no_different_rare_taxa > 0){paste0("Note that there are ", no_different_rare_taxa, " taxa in the living collection classed as unique or very rare (plants found in 0-10 living collections globally) where the original name from the report and POWO's name differ. See downloadable data at the end of this section.")}`


:::: {.blackbox data-latex=""}

Further information about the rarity of items in the living collection can be downloaded using the button below

```{r}
rare_global_list_format |>
  downloadthis::download_this(
    output_name = "rare_global_list",
    output_extension = ".xlsx",
    button_label = "Download rarity information (xlsx)",
    button_type = "default",
    has_icon = FALSE,
    # icon = "fa fa-save",
    class = "hvr-sweep-to-left",
    self_contained =  T
  )
```

::::

***

## Duplication in the living collection

Top 20 most common biological taxa in the collection

```{r, Headline table and stats}
taxa_count = sort(table(interest$best_name), decreasing = T)
rare = interest$no_gardens ==1 
not_in_no_gardens = is.na(interest$no_gardens )
unique_in_collection = names(taxa_count)[which(taxa_count == 1)]
unique = interest$best_name %in% unique_in_collection

unique_records = interest[which(rare & unique),]
unique_not_in_BGCI = interest[which(not_in_no_gardens & unique),]
no_unique = nrow(unique_records)
no_unique_not_in_BGCI = nrow(unique_not_in_BGCI)

unique_sum = data.frame(name = unique_records$best_name, in_BGCI = 'True')
unique_not_in_sum = data.frame(name = unique_not_in_BGCI$best_name, in_BGCI = 'False')

most_rare = rbind(unique_sum, unique_not_in_sum)
names(most_rare) = c('Taxa', "Is in BGCI's PlantSearch?")
most_rare = most_rare[order(most_rare$`Is in BGCI's PlantSearch?`, most_rare$Taxa),]
most_rare_table = most_rare |>  DT::datatable(extensions = 'Buttons',
                                              rownames = FALSE,
                                              options = list(scrollX = TRUE,
                                                             pageLength = min(nrow(most_rare),10),
                                                             dom = 'Btp',
                                                             buttons = c('copy', 'csv', 'excel', 'pdf'),
                                                             paging=ifelse(nrow(most_rare)>10,T,F),
                                                             ordering=T))

# DT::datatable(data = most_rare, rownames = FALSE, options = list(dom = 'tp',pageLength =  10))


most_common = data.frame(taxa_count[1:20])
names(most_common) = c('Taxa', 'Number of items in the living collection')
most_common_table = most_common |>  DT::datatable(extensions = 'Buttons',
                                                  rownames = FALSE,
                                                  options = list(scrollX = TRUE,
                                                                 pageLength = min(nrow(most_common),10),
                                                                 dom = 'Btp',
                                                                 buttons = c('copy', 'csv', 'excel', 'pdf'),
                                                                 paging=ifelse(nrow(most_rare)>10,T,F),
                                                                 ordering=T))





# DT::datatable(data = most_common, rownames = FALSE, options = list(dom = 'tp',pageLength =  5))

```

`r if(report_kind == "interactive"){most_common_table}`

In the living collection there are `r no_unique +  no_unique_not_in_BGCI` taxa that are unique to the living collection  and only a single item exists in the collection. These are shown in the table below. 

`r if(report_kind == "interactive"){most_rare_table}`

:::: {.blackbox data-latex=""}

Further information (such as accession number, threatened status, etc) can be downloaded below

```{r}
rare_global_list_format |>
  downloadthis::download_this(
    output_name = "rare_global_list",
    output_extension = ".xlsx",
    button_label = "Download rare global list (xlsx)",
    button_type = "default",
    has_icon = FALSE,
    # icon = "fa fa-save",
    class = "hvr-sweep-to-left",
    self_contained =  T
  )
```

::::


```{r}
count_per_taxa <- interest |>
  dplyr::group_by(.data$best_name) |>
  dplyr::summarise(Accessions = length(unique(.data$AccNoFull)),
                   items = length(.data$AccNoFull),
                   Threatened = .data$threatened[1],
                   endemic = .data$endemic[1]) |>
  dplyr::ungroup()

#Accessions
column = 'items'
# All
all = table(count_per_taxa[[column]])
all_big_20 = sum(all[as.numeric(names(all))>=20])
all_simp = data.frame(all[as.numeric(names(all))<20])
names(all_simp) = c('Accessions', 'Taxonomic Names')
all_simp$Accessions = as.numeric(all_simp$Accessions)
all_simp[nrow(all_simp)+1,] = c(20, all_big_20)

# threat
threat = table(count_per_taxa[[column]][count_per_taxa$Threatened == 'Threatened'])
threat_big_20 = sum(threat[as.numeric(names(threat))>=20])
threat_simp = data.frame(threat[as.numeric(names(threat))<20])
names(threat_simp) = c('Accessions', 'Taxonomic Names')
threat_simp$Accessions = as.numeric(threat_simp$Accessions)
threat_simp[nrow(threat_simp)+1,] = c(20, threat_big_20)

# endemic
endemic = table(count_per_taxa[[column]][count_per_taxa$endemic == 'Endemic'])
endemic_big_20 = sum(endemic[as.numeric(names(endemic))>=20])
endemic_simp = data.frame(endemic[as.numeric(names(endemic))<20])
names(endemic_simp) = c('Accessions', 'Taxonomic Names')
endemic_simp$Accessions = as.numeric(endemic_simp$Accessions)
endemic_simp[nrow(endemic_simp)+1,] = c(20, endemic_big_20)

# combine 
accessions = 1:20
no_values = data.frame(all_taxa = rep(0, length(accessions)), threat = 0, endemic = 0)
no_values$all_taxa[match(all_simp$Accessions, accessions)] = all_simp$`Taxonomic Names`
no_values$threat[match(threat_simp$Accessions, accessions)] = threat_simp$`Taxonomic Names`
no_values$endemic[match(endemic_simp$Accessions,accessions)] = endemic_simp$`Taxonomic Names`

densities = lapply(no_values, function(x){ x/sum(x)*100}) |> data.frame() #|> t() |> data.frame()
names(densities) = c('all_den', 'threat_den', 'endemic_den')
cum_densities = lapply(no_values, function(x){ cumsum(x)/max(cumsum(x))}) |> data.frame() #|> t() |> data.frame()
names(cum_densities) = c('all_cum_den', 'threat_cum_den', 'endemic_cum_den')

plot_data = data.frame(accessions, cum_densities)

   dd = reshape(plot_data, idvar = "Items", varying = list(2:ncol(plot_data)),
                 v.names = "count", timevar = "group", times = names(plot_data)[-1], direction = "long")
    # dd$group = factor(dd$group, levels = c('Threatened', 'Not Threatened' ))
    p=ggplot(dd, aes(x = Items, y = count, color = group, linetype = group))+
      geom_line(aes(linetype = group), linewidth = 1.1) +
      # scale_color_manual(values = c(colours[1:3]))+
      # scale_linetype_manual(values = c(1,1,1,1)) +
      labs(x = 'Number of items per species', y = '% of species', caption = '') +
      labs(color  = "", linetype = "") +
      scale_y_continuous(label = scales::label_number(suffix = ""))+
      scale_x_continuous(
        breaks = c(1,5,10,15,20),
        labels = ~ ifelse(.x == 20, paste0(.x, '+'), .x)) + 
      theme(
        legend.position = c(0.85, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)
      )

```


### Duplication of taxa

In this section we explore the duplication of taxa in the collection across both items and accessions. We show duplication in the whole collection and in its key collections. 

```{r, number of accessions per taxa - data}
# Reduced to only unique accessions.
accessions = interest[match(unique(interest$AccNoFull),interest$AccNoFull),]

# Get a vector of all the plant names in unique accessions and work out frequencies. 
# taxa_no_accessions = table(accessions$good_name)
# taxa_no_accessions = data.frame(taxa = names(taxa_no_accessions), no_accessions = as.numeric(taxa_no_accessions))
# taxa_no_accessions = taxa_no_accessions[order(taxa_no_accessions$no_accessions,decreasing = T),]

accession_taxa_group = accessions |> dplyr::group_by(best_name) |>
  dplyr::summarise(threatened = .data$threatened[1],
                   endemic = .data$endemic[1],
                   native = .data$native[1],
                   tree = .data$tree[1],
                   total = length(.data$best_name)
                   )

# Group the number of taxa by the number of accessions they have. 
accession_taxa = table(accession_taxa_group$total)
accession_taxa = data.frame(total_accessions = as.numeric(names(accession_taxa)), 
                            no_species = as.numeric(accession_taxa))
top_name_acc = accession_taxa_group$best_name[which(accession_taxa_group$total == max(accession_taxa$total_accessions))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of threatened taxa by the number of accessions they have 
acc_threat = accession_taxa_group[accession_taxa_group$threatened =='Threatened',]
accession_taxa_threat = table(acc_threat$total)
accession_taxa_threat = data.frame(total_accessions = as.numeric(names(accession_taxa_threat)), 
                            no_species = as.numeric(accession_taxa_threat))
top_name_threat_acc = acc_threat$best_name[which(acc_threat$total == max(accession_taxa_threat$total_accessions))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of endemic taxa by the number of accessions they have 
acc_endemic = accession_taxa_group[accession_taxa_group$endemic =='Endemic',]
accession_taxa_endemic = table(acc_endemic$total)
accession_taxa_endemic = data.frame(total_accessions = as.numeric(names(accession_taxa_endemic)), 
                            no_species = as.numeric(accession_taxa_endemic))
top_name_endemic_acc = acc_endemic$best_name[which(acc_endemic$total == max(accession_taxa_endemic$total_accessions))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of native taxa by the number of accessions they have 
acc_nat = accession_taxa_group[accession_taxa_group$native =='Native',]
accession_taxa_nat = table(acc_nat$total)
accession_taxa_nat = data.frame(total_accessions = as.numeric(names(accession_taxa_nat)), 
                            no_species = as.numeric(accession_taxa_nat))
top_name_nat_acc = acc_nat$best_name[which(acc_nat$total == max(accession_taxa_nat$total_accessions))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of tree taxa by the number of accessions they have 
acc_tree = accession_taxa_group[accession_taxa_group$tree =='Tree',]
accession_taxa_tree = table(acc_tree$total)
accession_taxa_tree = data.frame(total_accessions = as.numeric(names(accession_taxa_tree)), 
                            no_species = as.numeric(accession_taxa_tree))
top_name_tree_acc = acc_tree$best_name[which(acc_tree$total == max(accession_taxa_tree$total_accessions))][1]


accession_taxa_all_type = list(all = accession_taxa,
                               threatened = accession_taxa_threat,
                               endemic = accession_taxa_endemic,
                               native = accession_taxa_nat,
                               tree = accession_taxa_tree
                               )


# data formatted if we want to export/save it.
Local_accession_taxa = accession_taxa
Local_accession_taxa$percent = paste0(round(Local_accession_taxa$no_species / sum(Local_accession_taxa$no_species)*100,digits = 2),'%')
names(Local_accession_taxa) = c("Number of Accessions in LC", "Number of species in LC", "Percentage")


## Create number of taxa against number of accessions for each key collection and all. 
counter <- 1
figs_acc = lapply(accession_taxa_all_type, function(accession_taxa){
  if(nrow(accession_taxa) == 0){
    return(NULL)
  }
  accession_taxa$text = paste0(accession_taxa$no_species, ' Taxa in the LC have ', accession_taxa$total_accessions, ' accessions')
fig <- plot_ly(accession_taxa,
               x = ~total_accessions,
               y = ~no_species,
               type = "bar",
               hoverinfo = "text",
               hovertext = ~text,
               marker = list(color = interactive_colour(1))
)
fig <- fig |> layout(title = "",
         xaxis = list(title = "Number of accessions"),
         yaxis = list (title = paste0("Number of ",names(accession_taxa_all_type)[counter] ," taxa"), type = 'log')) 
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-accessions_per_taxa_',names(accession_taxa_all_type)[counter],'.html'))
}
counter <<- counter + 1
fig
})

## Create horizontal stacked bar for key collection and all in one plot. 
counter <- 1
plot_data = lapply(accession_taxa_all_type, function(d){
partA = d[match(c(1,2,3,4),d$total_accessions),]
four_plus = sum(d$no_species[as.numeric(d$total_accessions)>4])
data_supp = rbind(partA, c('>4',four_plus))
data_supp$percent = round(as.numeric(data_supp$no_species)/sum(as.numeric(data_supp$no_species))*100,digits=2)
data_supp$type = names(accession_taxa_all_type)[counter]
counter <<- counter+1

data_supp
})
plot_data = do.call('rbind',plot_data)
plot_data$total_accessions = factor(plot_data$total_accessions, levels = c(1,2,3,4,'>4'))
plot_data$type = stringr::str_to_title(plot_data$type)
plot_data$type =  factor(plot_data$type, levels = c('All', 'Threatened', 'Endemic', 'Native','Tree'))
plot_data$hover = paste0(plot_data$percent, '% (',plot_data$no_species,') of taxa have ',plot_data$total_accessions,' accession/s.' )
hor_stack_bar_plot = plot_ly(plot_data,
                             type = 'bar',
                             y = ~type,
                             x = ~percent,
                             color = ~total_accessions,
                             colors = scales::brewer_pal(palette = palette, direction = 1)(5),
                             orientation = 'h',
                            hovertext = ~hover, hoverinfo = 'text')
hor_stack_bar_plot_acc <- hor_stack_bar_plot |>
  plotly::layout(xaxis = list(title = "Percentage of taxa"),
                 yaxis = list(title = ''),
                 barmode = 'stack',
                 hovermode = 'y unified',
                 legend=list(title=list(text='Number of<br>accessions'))
                 )
```

```{r, number of items per taxa - data}
# Reduced to only unique accessions.
items = interest

# Get a vector of all the plant names in unique accessions and work out frequencies. 
# taxa_no_accessions = table(accessions$good_name)
# taxa_no_accessions = data.frame(taxa = names(taxa_no_accessions), no_accessions = as.numeric(taxa_no_accessions))
# taxa_no_accessions = taxa_no_accessions[order(taxa_no_accessions$no_accessions,decreasing = T),]

item_taxa_group = items |> dplyr::group_by(best_name) |>
  dplyr::summarise(threatened = .data$threatened[1],
                   endemic = .data$endemic[1],
                   native = .data$native[1],
                   tree = .data$tree[1],
                   total = length(.data$best_name)
                   )

# Group the number of taxa by the number of items they have. 
item_taxa = table(item_taxa_group$total)
item_taxa = data.frame(total_items = as.numeric(names(item_taxa)), 
                            no_species = as.numeric(item_taxa))
top_name = item_taxa_group$best_name[which(item_taxa_group$total == max(item_taxa$total_items))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of threatened taxa by the number of items they have 
item_threat = item_taxa_group[item_taxa_group$threatened =='Threatened',]
item_taxa_threat = table(item_threat$total)
item_taxa_threat = data.frame(total_items = as.numeric(names(item_taxa_threat)), 
                            no_species = as.numeric(item_taxa_threat))
top_name_threat = item_threat$best_name[which(item_threat$total == max(item_taxa_threat$total_items))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of endemic taxa by the number of items they have 
item_endemic = item_taxa_group[item_taxa_group$endemic =='Endemic',]
item_taxa_endemic = table(item_endemic$total)
item_taxa_endemic = data.frame(total_items = as.numeric(names(item_taxa_endemic)), 
                            no_species = as.numeric(item_taxa_endemic))
top_name_endemic = item_endemic$best_name[which(item_endemic$total == max(item_taxa_endemic$total_items))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of native taxa by the number of items they have 
item_nat = item_taxa_group[item_taxa_group$native =='Native',]
item_taxa_nat = table(item_nat$total)
item_taxa_nat = data.frame(total_items = as.numeric(names(item_taxa_nat)), 
                            no_species = as.numeric(item_taxa_nat))
top_name_nat = item_nat$best_name[which(item_nat$total == max(item_taxa_nat$total_items))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of tree taxa by the number of items they have 
item_tree = item_taxa_group[item_taxa_group$tree =='Tree',]
item_taxa_tree = table(item_tree$total)
item_taxa_tree = data.frame(total_items = as.numeric(names(item_taxa_tree)), 
                            no_species = as.numeric(item_taxa_tree))
top_name_tree = item_tree$best_name[which(item_tree$total == max(item_taxa_tree$total_items))][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

item_taxa_all_type = list(all = item_taxa,
                               threatened = item_taxa_threat,
                               endemic = item_taxa_endemic,
                               native = item_taxa_nat,
                          tree = item_taxa_tree
                               )


# data formatted if we want to export/save it.
Local_item_taxa = item_taxa
Local_item_taxa$percent = paste0(round(Local_item_taxa$no_species / sum(Local_item_taxa$no_species)*100,digits = 2),'%')
names(Local_item_taxa) = c("Number of items in LC", "Number of species in LC", "Percentage")


## Create number of taxa against number of items for each key collection and all. 
counter <- 1
figs_items = lapply(item_taxa_all_type, function(item_taxa){
  if(nrow(item_taxa) == 0){
    return(NULL)
  }
  item_taxa$text = paste0(item_taxa$no_species, ' Taxa in the LC have ', item_taxa$total_items, ' items')
fig <- plot_ly(item_taxa,
               x = ~total_items,
               y = ~no_species,
               type = "bar",
               hoverinfo = "text",
               hovertext = ~text,
               marker = list(color = interactive_colour(1))
               )
fig <- fig |> layout(title = "",
         xaxis = list(title = "Number of items"),
         yaxis = list (title = paste0("Number of ",names(item_taxa_all_type)[counter] ," taxa"), type = 'log')) 
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-items_per_taxa_',names(item_taxa_all_type)[counter],'.html'))
}
counter <<- counter + 1
fig
})

## Create horizontal stacked bar for key collection and all in one plot. 
counter <- 1
plot_data = lapply(item_taxa_all_type, function(d){
partA = d[match(c(1,2,3,4),d$total_items),]
four_plus = sum(d$no_species[as.numeric(d$total_items)>4])
data_supp = rbind(partA, c('>4',four_plus))
data_supp$percent = round(as.numeric(data_supp$no_species)/sum(as.numeric(data_supp$no_species))*100,digits=2)
data_supp$type = names(item_taxa_all_type)[counter]
counter <<- counter+1

data_supp
})
plot_data = do.call('rbind',plot_data)
plot_data$total_items = factor(plot_data$total_items, levels = c(1,2,3,4,'>4'))
plot_data$type = stringr::str_to_title(plot_data$type)
plot_data$type =  factor(plot_data$type, levels = c('All', 'Threatened', 'Endemic', 'Native', 'Tree'))
plot_data$hover = paste0(plot_data$percent, '% (',plot_data$no_species,') of taxa have ',plot_data$total_items,' item/s.' )
hor_stack_bar_plot = plot_ly(plot_data,
                             type = 'bar',
                             y = ~type,
                             x = ~percent,
                             color = ~total_items,
                             colors = scales::brewer_pal(palette = palette, direction = 1)(5),
                             orientation = 'h',
                            hovertext = ~hover, hoverinfo = 'text')
hor_stack_bar_plot_items <- hor_stack_bar_plot |>
  plotly::layout(xaxis = list(title = "Percentage of taxa"),
                 yaxis = list(title = ''),
                 barmode = 'stack',
                 hovermode = 'y unified',
                 legend=list(title=list(text='Number of<br>items'))
                 )


# Create a dataset of all plants that have only one item (add whether they are threatened endemic or native).
item_taxa_group_dataset = item_taxa_group[which(item_taxa_group$total == 1),]

```


<!-- <div class="boxBorder"> -->

`r if(report_kind == 'interactive'){"#####   {.tabset}"}`

`r if(report_kind == 'interactive'){"###### Accessions"}`
```{r Number of accessions per taxa summary  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
hor_stack_bar_plot_acc
```

`r if(report_kind == 'interactive'){"###### Items"}`
```{r Number of items per taxa summary  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
hor_stack_bar_plot_items
```

`r if(report_kind == 'interactive'){"##### {-}"}`

<!-- </div> -->

<!-- :::: {.blackbox data-latex=""} -->

<!-- The taxa in the collection with a single item can be downloaded below -->

<!-- ```{r} -->
<!-- item_taxa_group_dataset |> -->
<!--   download_this( -->
<!--     output_name = "taxa_single_item", -->
<!--     output_extension = ".xlsx", -->
<!--     button_label = "Download taxa with a single item in the collection (xlsx)", -->
<!--     button_type = "default", -->
<!--     has_icon = TRUE, -->
<!--     icon = "fa fa-save", -->
<!--     class = "hvr-sweep-to-left", -->
<!--     self_contained =  T -->
<!--   ) -->
<!-- ``` -->

<!-- :::: -->


#### Accessions per taxon
 
`r if(report_kind == 'interactive'){"#####   {.tabset}"}`
`r if(report_kind == 'interactive'){"###### All"}`

```{r Number of accessions per taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_acc$all
```

Where 

- **`r top_name_acc`**  is the taxon with the highest number of accessions - **`r max(accession_taxa$total_accessions)`** - in the whole collection.
- The mean number of accessions per taxon is **`r round(mean(accession_taxa_group$total),digits=2)`**.
- The median number of accessions per taxon is **`r median(accession_taxa_group$total)`**.
- **`r format(sum(accession_taxa_group$total == 1), big.mark =',')`** taxa have a single accession.



`r if(report_kind == 'interactive'){"###### Threatened"}`
```{r Number of accessions per threatened taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_acc$threatened
```

Where 

- **`r top_name_threat_acc`** is the taxon with the highest number of accessions - **`r max(accession_taxa_threat$total_accessions)`** - in the threatened key collection.
- The mean number of accessions per taxon is **`r round(mean(acc_threat$total),digits=2)`**.
- The median number of accessions per taxon is **`r median(acc_threat$total)`**.
- **`r format(sum(acc_threat$total == 1), big.mark =',')`** taxa have a single accession.

`r if(report_kind == 'interactive'){"###### Endemic"}`
```{r Number of accessions per endemic taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_acc$endemic
```

Where 

- **`r top_name_endemic_acc`** is the taxon with the highest number of accessions - **`r max(accession_taxa_endemic$total_accessions)`** - in the endemic key collection.
- The mean number of accessions per taxon is **`r round(mean(acc_endemic$total),digits=2)`**.
- The median number of accessions per taxon is **`r median(acc_endemic$total)`**.
- **`r format(sum(acc_endemic$total == 1), big.mark =',')`** taxa have a single accession.


`r if(report_kind == 'interactive'){"###### Native"}`
```{r Number of accessions per native taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_acc$native
```

Where 

- **`r top_name_nat_acc`** is the taxon with the highest number of accessions - **`r max(accession_taxa_nat$total_accessions)`** - in the native key collection.
- The mean number of accessions per taxon is **`r round(mean(acc_nat$total),digits=2)`**.
- The median number of accessions per taxon is **`r median(acc_nat$total)`**.
- **`r format(sum(acc_nat$total == 1), big.mark =',')`** taxa have a single accession.

`r if(report_kind == 'interactive'){"###### Tree"}`
```{r Number of accessions per tree  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_acc$tree
```

Where 

- **`r top_name_tree_acc`** is the taxon with the highest number of accessions - **`r max(accession_taxa_tree$total_accessions)`** - in the tree key collection.
- The mean number of accessions per taxon is **`r round(mean(acc_tree$total),digits=2)`**.
- The median number of accessions per taxon is **`r median(acc_tree$total)`**.
- **`r format(sum(acc_tree$total == 1), big.mark =',')`** taxa have a single accession.

`r if(report_kind == 'interactive'){"##### {-}"}`


***

#### Items per taxon 
 
`r if(report_kind == 'interactive'){"#####   {.tabset}"}`
`r if(report_kind == 'interactive'){"###### All"}`

```{r Number of items per taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_items$all
```

Where 

- **`r top_name`** is the taxon with the highest number of items - **`r max(item_taxa$total_items)`** - in the whole collection.
- The mean number of items per taxon is **`r round(mean(item_taxa_group$total),digits=2)`**.
- The median number of items per taxon is **`r median(item_taxa_group$total)`**.
- **`r format(sum(item_taxa_group$total == 1), big.mark =',')`** taxa have a single item.



`r if(report_kind == 'interactive'){"###### Threatened"}`
```{r Number of items per threatened taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_items$threatened
```

Where 

- **`r top_name_threat`** is the taxon with the highest number of items - **`r max(item_taxa_threat$total_items)`** - in the threatened key collection.
- The mean number of items per taxon is **`r round(mean(item_threat$total),digits=2)`**.
- The median number of items per taxon is **`r median(item_threat$total)`**.
- **`r format(sum(item_threat$total == 1), big.mark =',')`** taxa have a single item.

`r if(report_kind == 'interactive'){"###### Endemic"}`
```{r Number of items per endemic taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_items$endemic
```

Where 

- **`r top_name_endemic`** is the taxon with the highest number of items - **`r max(item_taxa_endemic$total_items)`** - in the endemic key collection.
- The mean number of items per taxon is **`r round(mean(item_endemic$total),digits=2)`**.
- The median number of items per taxon is **`r median(item_endemic$total)`**.
- **`r format(sum(item_endemic$total == 1), big.mark =',')`** taxa have a single item.


`r if(report_kind == 'interactive'){"###### Native"}`
```{r Number of items per native taxa  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_items$native
```

Where 

- **`r top_name_nat`** is the taxon with the highest number of items - **`r max(item_taxa_nat$total_items)`** - in the native key collection.
- The mean number of items per taxon is **`r round(mean(item_nat$total),digits=2)`**.
- The median number of items per taxon is **`r median(item_nat$total)`**.
- **`r format(sum(item_nat$total == 1), big.mark =',')`** taxa have a single item.


`r if(report_kind == 'interactive'){"###### Tree"}`
```{r Number of items per tree  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs_items$tree
```

Where 

- **`r top_name_tree`** is the taxon with the highest number of items - **`r max(item_taxa_tree$total_items)`** - in the tree key collection.
- The mean number of items per taxon is **`r round(mean(item_tree$total),digits=2)`**.
- The median number of items per taxon is **`r median(item_tree$total)`**.
- **`r format(sum(item_tree$total == 1), big.mark =',')`** taxa have a single item.

`r if(report_kind == 'interactive'){"##### {-}"}`

***

### Accession size 

We produce a summary bar chart showing how the number of items per accession varies across the key collections. 

```{r, number of items per accessions - data}
# Reduced to only unique items.
items = interest

# Get a vector of all the plant names in unique items and work out frequencies. 
# taxa_no_items = table(items$good_name)
# taxa_no_items = data.frame(taxa = names(taxa_no_items), no_items = as.numeric(taxa_no_items))
# taxa_no_items = taxa_no_items[order(taxa_no_items$no_items,decreasing = T),]

item_taxa_group = items |> dplyr::group_by(AccNoFull) |>
  dplyr::summarise(threatened = .data$threatened[1],
                   endemic = .data$endemic[1],
                   native = .data$native[1],
                   tree = .data$tree[1],
                   total = length(.data$AccNoFull)
                   )

# Group the number of taxa by the number of items they have. 
item_taxa = table(item_taxa_group$total)
item_taxa = data.frame(total_items = as.numeric(names(item_taxa)), 
                            no_species = as.numeric(item_taxa))
top_acc = item_taxa_group$AccNoFull[which(item_taxa_group$total == max(item_taxa$total_items))][1]
top_name = items$best_name[items$AccNoFull == top_acc][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of threatened taxa by the number of items they have 
item_threat = item_taxa_group[item_taxa_group$threatened =='Threatened',]
item_taxa_threat = table(item_threat$total)
item_taxa_threat = data.frame(total_items = as.numeric(names(item_taxa_threat)), 
                            no_species = as.numeric(item_taxa_threat))

top_acc_threat = item_threat$AccNoFull[which(item_threat$total == max(item_taxa_threat$total_items))][1]
top_name_threat = items$best_name[items$AccNoFull == top_acc_threat][1]

# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of endemic taxa by the number of items they have 
item_endemic = item_taxa_group[item_taxa_group$endemic =='Endemic',]
item_taxa_endemic = table(item_endemic$total)
item_taxa_endemic = data.frame(total_items = as.numeric(names(item_taxa_endemic)), 
                            no_species = as.numeric(item_taxa_endemic))
top_acc_endemic = item_endemic$AccNoFull[which(item_endemic$total == max(item_taxa_endemic$total_items))][1]
top_name_endemic = items$best_name[items$AccNoFull == top_acc_endemic][1]# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of native taxa by the number of items they have 
item_nat = item_taxa_group[item_taxa_group$native =='Native',]
item_taxa_nat = table(item_nat$total)
item_taxa_nat = data.frame(total_items = as.numeric(names(item_taxa_nat)), 
                            no_species = as.numeric(item_taxa_nat))
top_acc_nat = item_nat$AccNoFull[which(item_nat$total == max(item_taxa_nat$total_items))][1]
top_name_nat = items$best_name[items$AccNoFull == top_acc_nat][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of native taxa by the number of items they have 
item_tree = item_taxa_group[item_taxa_group$tree =='Tree',]
item_taxa_tree = table(item_tree$total)
item_taxa_tree = data.frame(total_items = as.numeric(names(item_taxa_tree)), 
                            no_species = as.numeric(item_taxa_tree))
top_acc_tree = item_tree$AccNoFull[which(item_tree$total == max(item_taxa_tree$total_items))][1]
top_name_tree = items$best_name[items$AccNoFull == top_acc_tree][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

item_taxa_all_type = list(all = item_taxa,
                               threatened = item_taxa_threat,
                               endemic = item_taxa_endemic,
                               native = item_taxa_nat,
                          tree = item_taxa_tree
                               )


# data formatted if we want to export/save it.
Local_item_taxa = item_taxa
Local_item_taxa$percent = paste0(round(Local_item_taxa$no_species / sum(Local_item_taxa$no_species)*100,digits = 2),'%')
names(Local_item_taxa) = c("Number of items in LC", "Number of species in LC", "Percentage")


## Create number of taxa against number of items for each key collection and all. 
counter <- 1
figs_items = lapply(item_taxa_all_type, function(item_taxa){
  if(nrow(item_taxa) == 0){return(NULL)}
  item_taxa$text = paste0(item_taxa$no_species, ' Taxa in the LC have ', item_taxa$total_items, ' items')
fig <- plot_ly(item_taxa,
               x = ~total_items,
               y = ~no_species,
               type = "bar",
               hoverinfo = "text",
               hovertext = ~text,
               marker = list(color = interactive_colour(1))
               )
fig <- fig |> layout(title = "",
         xaxis = list(title = "Number of items"),
         yaxis = list (title = paste0("Number of ",names(item_taxa_all_type)[counter] ," taxa"), type = 'log')) 
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-items_per_taxa_',names(item_taxa_all_type)[counter],'.html'))
}
counter <<- counter + 1
fig
})

## Create horizontal stacked bar for key collection and all in one plot. 
counter <- 1
plot_data = lapply(item_taxa_all_type, function(d){
partA = d[match(c(1,2,3,4),d$total_items),]
four_plus = sum(d$no_species[as.numeric(d$total_items)>4])
data_supp = rbind(partA, c('>4',four_plus))
data_supp$percent = round(as.numeric(data_supp$no_species)/sum(as.numeric(data_supp$no_species))*100,digits=2)
data_supp$type = names(item_taxa_all_type)[counter]
counter <<- counter+1

data_supp
})
plot_data = do.call('rbind',plot_data)
plot_data$total_items = factor(plot_data$total_items, levels = c(1,2,3,4,'>4'))
plot_data$type = stringr::str_to_title(plot_data$type)
plot_data$type =  factor(plot_data$type, levels = c('All', 'Threatened', 'Endemic', 'Native','Tree'))
plot_data$hover = paste0(plot_data$percent, '% (',plot_data$no_species,') of accessions have ',plot_data$total_items,' item/s.' )
hor_stack_bar_plot = plot_ly(plot_data,
                             type = 'bar',
                             y = ~type,
                             x = ~percent,
                             color = ~total_items,
                             colors = scales::brewer_pal(palette = palette, direction = 1)(5),
                             orientation = 'h',
                            hovertext = ~hover, hoverinfo = 'text')
hor_stack_bar_plot_items <- hor_stack_bar_plot |>
  plotly::layout(xaxis = list(title = "Percentage of accessions"),
                 yaxis = list(title = ''),
                 barmode = 'stack',
                 hovermode = 'y unified',
                 legend = list(title = list(text = 'Number of<br>items'))
                 )
```

```{r, number of items per accessions at time of accessioning - data, eval = F}
# Reduced to only unique items.
acc_to_consider = unique(interest$AccNoFull)
individals = report[report$AccNoFull %in% acc_to_consider,]

# Get a vector of all the plant names in unique individals and work out frequencies. 
# taxa_no_individals = table(individals$good_name)
# taxa_no_individals = data.frame(taxa = names(taxa_no_individals), no_individals = as.numeric(taxa_no_individals))
# taxa_no_individals = taxa_no_individals[order(taxa_no_individals$no_individals,decreasing = T),]

individal_taxa_group = individals |> dplyr::group_by(AccNoFull) |>
  dplyr::summarise(threatened = .data$threatened[1],
                   endemic = .data$endemic[1],
                   native = .data$native[1],
                   tree = .data$tree[1]
                   total = length(.data$AccNoFull)
                   )

# Group the number of taxa by the number of individals they have. 
individal_taxa = table(individal_taxa_group$total)
individal_taxa = data.frame(total_individals = as.numeric(names(individal_taxa)), 
                            no_species = as.numeric(individal_taxa))
a_top_acc = individal_taxa_group$AccNoFull[which(individal_taxa_group$total == max(individal_taxa$total_individals))][1]
a_top_name = individals$best_name[individals$AccNoFull == a_top_acc][1]
# top_name = interest$print_name[match(top_name,interest$best_name)]

# Group the number of threatened taxa by the number of individals they have 
acc_threat = individal_taxa_group[individal_taxa_group$threatened =='Threatened',]
individal_taxa_threat = table(acc_threat$total)
individal_taxa_threat = data.frame(total_individals = as.numeric(names(individal_taxa_threat)), 
                            no_species = as.numeric(individal_taxa_threat))

a_top_acc_threat = acc_threat$AccNoFull[which(acc_threat$total == max(individal_taxa_threat$total_individals))][1]
a_top_name_threat = individals$best_name[individals$AccNoFull == a_top_acc_threat][1]


# Group the number of endemic taxa by the number of individals they have 
acc_endemic = individal_taxa_group[individal_taxa_group$endemic =='Endemic',]
individal_taxa_endemic = table(acc_endemic$total)
individal_taxa_endemic = data.frame(total_individals = as.numeric(names(individal_taxa_endemic)), 
                            no_species = as.numeric(individal_taxa_endemic))

a_top_acc_endemic = acc_endemic$AccNoFull[which(acc_endemic$total == max(individal_taxa_endemic$total_individals))][1]
a_top_name_endemic = individals$best_name[individals$AccNoFull == a_top_acc_endemic][1]

# Group the number of native taxa by the number of individals they have 
acc_nat = individal_taxa_group[individal_taxa_group$native =='Native',]
individal_taxa_nat = table(acc_nat$total)
individal_taxa_nat = data.frame(total_individals = as.numeric(names(individal_taxa_nat)), 
                            no_species = as.numeric(individal_taxa_nat))

a_top_acc_nat = acc_nat$AccNoFull[which(acc_nat$total == max(individal_taxa_nat$total_individals))][1]
a_top_name_nat = individals$best_name[individals$AccNoFull == a_top_acc_nat][1]

# Group the number of tree taxa by the number of individals they have 
acc_tree = individal_taxa_group[individal_taxa_group$tree =='Tree',]
individal_taxa_tree = table(acc_tree$total)
individal_taxa_tree = data.frame(total_individals = as.numeric(names(individal_taxa_tree)), 
                            no_species = as.numeric(individal_taxa_tree))

a_top_acc_tree = acc_tree$AccNoFull[which(acc_tree$total == max(individal_taxa_tree$total_individals))][1]
a_top_name_tree = individals$best_name[individals$AccNoFull == a_top_acc_tree][1]

individal_taxa_all_type = list(all = individal_taxa,
                               threatened = individal_taxa_threat,
                               endemic = individal_taxa_endemic,
                               native = individal_taxa_nat,
                               tree = individal_taxa_tree
                               )


# data formatted if we want to export/save it.
Local_individal_taxa = individal_taxa
Local_individal_taxa$percent = paste0(round(Local_individal_taxa$no_species / sum(Local_individal_taxa$no_species)*100,digits = 2),'%')
names(Local_individal_taxa) = c("Number of individals in LC", "Number of species in LC", "Percentage")


## Create number of taxa against number of individals for each key collection and all. 
counter <- 1
figs_acc = lapply(individal_taxa_all_type, function(individal_taxa){
  individal_taxa$text = paste0(individal_taxa$no_species, ' Taxa in the LC have ', individal_taxa$total_individals, ' individals')
fig <- plot_ly(individal_taxa,
               x = ~total_individals,
               y = ~no_species,
               type = "bar",
               hoverinfo = "text",
               hovertext = ~text,
               marker = list(color = interactive_colour(1))
               )
fig <- fig |> layout(title = "",
         xaxis = list(title = "Number of individals"),
         yaxis = list (title = paste0("Number of ",names(individal_taxa_all_type)[counter] ," taxa"), type = 'log')) 
if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-individals_per_taxa_',names(individal_taxa_all_type)[counter],'.html'))
}
counter <<- counter + 1
fig
})

## Create horizontal stacked bar for key collection and all in one plot. 
counter <- 1
plot_data = lapply(individal_taxa_all_type, function(d){
partA = d[match(c(1,2,3,4),d$total_individals),]
four_plus = sum(d$no_species[as.numeric(d$total_individals)>4])
data_supp = rbind(partA, c('>4',four_plus))
data_supp$percent = round(as.numeric(data_supp$no_species)/sum(as.numeric(data_supp$no_species))*100,digits=2)
data_supp$type = names(individal_taxa_all_type)[counter]
counter <<- counter+1

data_supp
})
plot_data = do.call('rbind',plot_data)
plot_data$total_individals = factor(plot_data$total_individals, levels = c(1,2,3,4,'>4'))
plot_data$type = stringr::str_to_title(plot_data$type)
plot_data$type =  factor(plot_data$type, levels = c('All', 'Threatened', 'Endemic', 'Native', 'Tree'))
plot_data$hover = paste0(plot_data$percent, '% (',plot_data$no_species,') of accessions have ',plot_data$total_individals,' item/s.' )
hor_stack_bar_plot = plot_ly(plot_data,
                             type = 'bar',
                             y = ~type,
                             x = ~percent,
                             color = ~total_individals,
                             colors = scales::brewer_pal(palette = palette, direction = 1)(5),
                             orientation = 'h',
                            hovertext = ~hover, hoverinfo = 'text')
hor_stack_bar_plot_items_acc_time <- hor_stack_bar_plot |> plotly::layout(xaxis = list(title = "Percentage of accessions"),
                                   yaxis = list(title = ''),barmode = 'stack',hovermode = 'y unified')
```


```{r Number of items per accessions summary  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
hor_stack_bar_plot_items
```

***


#### Gained accessions by item size 

 In this section we explore how the number of items per accession varied across gained accessions each year.
 
```{r data prep for items per accession over time}
max_year = format(Sys.Date(),'%Y') |> as.numeric()
years = min_year:max_year
accession_size_info = report |> dplyr::group_by(AccNoFull) |>
  dplyr::summarise(threatened = sum(threatened == 'Threatened'),
                   endemic = sum(endemic == 'Endemic'),
                   native = sum(native == 'Native'),
                   tree = sum(tree == 'Tree'),
                   year = .data$AccYear[1],
                   all = length(.data$AccNoFull)
                   )
columns = c('all','threatened','endemic', 'native','tree')
items_per_acc_over_time = lapply(columns, function(column){
  if(all(accession_size_info[[column]] == 0)){
    return(NULL)
  }
  item_dists = lapply(years, function(year){
    item_per_access = accession_size_info[[column]][accession_size_info$year == year]
    item_per_access = item_per_access[which(item_per_access !=0)]
    if(length(item_per_access) == 0){return(NA)}
    item_dist = table(item_per_access)
    item_dist = data.frame(total_items = names(item_dist), no_accessions = as.numeric(item_dist))
    item_dist$total_items = as.numeric(item_dist$total_items)
    species_big_than = sum(item_dist$no_accessions[item_dist$total_items > join_bigger_than])
    item_dist = item_dist[item_dist$total_items <=join_bigger_than,]
    if(species_big_than > 0){
      item_dist[nrow(item_dist)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
    }

    item_dist$percent = round(as.numeric(item_dist$no_accessions) / sum(as.numeric(item_dist$no_accessions))*100,digits = 3)
    item_dist$year = year
    item_dist
  })
  item_dists = do.call('rbind',item_dists)
  item_dists = item_dists[which(!is.na(item_dists$total_items)),]
})
names(items_per_acc_over_time) = columns


figs = lapply(columns, function(column){
  d = items_per_acc_over_time[[column]]
  d$no_accessions = as.numeric(d$no_accessions)
  if(d$no_accessions |> length() == 0){return(NULL)}
  d$total_items = factor(d$total_items, levels = c( "1",   "2",   "3", "4",  "> 4" ))
  d$text = paste0(round(d$no_accessions,digits = 2), ' accessions have ', d$total_items, ' items')

fig <- plot_ly(d, x = ~year, y = ~no_accessions, color = ~total_items, type = 'bar',  hoverinfo = "text",  hovertext = ~text, sort = FALSE, colors = scales::brewer_pal(palette = palette, direction = 1)(5))
fig <- fig |> layout(yaxis = list(title = 'Number of accessions'),
                     xaxis = list(title = "Year"),
                     legend=list(title=list(text='Number of<br>items')),
                     barmode = 'stack')
fig <- fig |> layout(hovermode = 'x unified', bargap =0)
fig1 = fig

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-items_per_accession_over_time',column,'.html'))
}

d$text = paste0(round(d$percent,digits = 2), '% of accessions have ', d$total_items, ' items')
fig <- plot_ly(d, x = ~year, y = ~percent, color = ~total_items, type = 'bar',  hoverinfo = "text",  hovertext = ~text, colors = scales::brewer_pal(palette = palette, direction = 1)(5))
fig <- fig |> layout(yaxis = list(title = 'Percentage of accessions'),
                     xaxis = list(title = "Year"),
                     legend=list(title=list(text='Number of<br>items')),
                     barmode = 'stack')
fig <- fig |> layout(hovermode = 'x unified', bargap =0)

fig2 = fig

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-percentage_items_per_accession_over_time',column,'.html'))
}

return(list(number = fig1, percent = fig2))
})
names(figs) = columns



years = min_year:as.numeric(format(Sys.Date(),'%Y'))

items_per_accession_years = lapply(years, function(year){
  accession_numbers  = enriched_report$AccNoFull[enriched_report$AccYear == year]
  if(length(accession_numbers) == 0){return(NA)}
  item_per_access = table(accession_numbers)
  item_per_access = data.frame(accession = names(item_per_access), no_items = as.numeric(item_per_access))

  item_dist = table(item_per_access$no_items)
  item_dist = data.frame(total_items = as.numeric(names(item_dist)), no_accessions = as.numeric(item_dist))
  item_dist$percent = round(item_dist$no_accessions / sum(item_dist$no_accessions)*100,digits = 3)

  doughnut_data =  item_dist[,1:2]
  species_big_than = sum(doughnut_data$no_accessions[doughnut_data$total_items > join_bigger_than])
  doughnut_data = doughnut_data[doughnut_data$total_items <=join_bigger_than,]
  doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
  doughnut_data$no_accessions = as.numeric(doughnut_data$no_accessions)
  
  doughnut_data$percent = round(doughnut_data$no_accessions / sum(doughnut_data$no_accessions)*100,digits = 3)

  return(list(item_per_access = item_dist, item_per_access_short = doughnut_data))
})
names(items_per_accession_years) = paste0('year: ', years )


# For stacked bar plot.
stacked_bar_data = NULL
for(i in 1:length(items_per_accession_years)){
  if('item_per_access_short' %in% names(items_per_accession_years[[i]])){
    d_cur = items_per_accession_years[[i]]$item_per_access_short
    d_cur$year = rep(years[i], nrow(d_cur))
    stacked_bar_data = rbind(stacked_bar_data, d_cur)
  }
}
options = as.character(c(1:join_bigger_than, paste0('> ',join_bigger_than)))
cats = options[options %in% unique(stacked_bar_data$total_items)]


if(!is.null(stacked_bar_data)){
  stacked_bar_data$total_items  <-  factor(stacked_bar_data$total_items, cats)
  items_per_accessions_over_years_simp = stacked_bar_data[,c(4,1,2,3)]
  names(items_per_accessions_over_years_simp) = c("Year", "Number of items", "Number of accessions", "Percentage of accessions")
}else{
  items_per_accessions_over_years_simp = NA
}

```

```{r items per accession over time - static figure,  fig.dim = c(10, 4),  eval = report_kind == 'static' & !is.null(stacked_bar_data)}
p = ggplot(stacked_bar_data, aes(fill=total_items, y=no_accessions, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) + labs(x = 'Year', y = 'Number of Accessions', fill = 'Items per \n accession')
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

p

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Stacked_Bar-items_per_accession_over_time.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p = ggplot(stacked_bar_data, aes(fill=total_items, y=percent, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) + labs(x = 'Year', y = 'Proportion of Accessions', fill = 'Items per \n accession')
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

p

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Stacked_Bar-percentage_items_per_accession_over_time.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
```


`r if(report_kind == 'interactive'){"#####   {.tabset}"}`
`r if(report_kind == 'interactive'){"###### All"}`

```{r item per accession over time  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$all$number
figs$all$percent
```

`r if(report_kind == 'interactive'){"###### Threatened"}`
```{r item per accession over time threatened  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$threatened$number
figs$threatened$percent
```

`r if(report_kind == 'interactive'){"###### Endemic"}`
```{r item per accession over time endemic  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$endemic$number
figs$endemic$percent
```

`r if(report_kind == 'interactive'){"###### Native"}`
```{r item per accession over time native  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$native$number
figs$native$percent
```

`r if(report_kind == 'interactive'){"###### Tree"}`
```{r item per accession over time tree  - interactive, fig.fullwidth=TRUE, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
figs$tree$number
figs$tree$percent
```

`r if(report_kind == 'interactive'){"##### {-}"}`
 ***


```{r, export data, eval = export_data == TRUE}
duplication_data = list(
globally_held_taxa = globally_held_taxa,
globally_held_taxa_grouped = globally_held_taxa_grouped,
Local_accession_taxa = Local_accession_taxa,
Local_accession_taxa_simp = Local_accession_taxa_simp,
Local_item_taxa = Local_item_taxa,
Local_item_taxa_simp = Local_item_taxa_simp,
Local_item_per_access = Local_item_per_access,
Local_item_distribution = Local_item_distribution,
Local_item_distribution_existing = Local_item_distribution_existing,
Local_item_accession_existing_simp = Local_item_accession_existing_simp,
Local_item_accession_at_origin_simp = Local_item_accession_at_origin_simp,
items_per_accession_years = items_per_accession_years,
items_per_accessions_over_years_simp = items_per_accessions_over_years_simp)

save(duplication_data, file = paste0(output_dir,'/',collection, '_duplication_data.rda'))

library(xlsx)
wb = xlsx::createWorkbook()
sh0 = xlsx::createSheet(wb, 'globally_held_taxa')
xlsx::addDataFrame(as.data.frame(globally_held_taxa), sh0, startRow = 1,row.names = F)
sh1 = xlsx::createSheet(wb, 'globally_held_taxa_grouped')
xlsx::addDataFrame(globally_held_taxa_grouped, sh1, startRow = 1,row.names = F)
sh2 = xlsx::createSheet(wb, 'Local_accession_taxa')
xlsx::addDataFrame(Local_accession_taxa, sh2, startRow = 1,row.names = F)
sh3 = xlsx::createSheet(wb, 'Local_accession_taxa_simp')
xlsx::addDataFrame(Local_accession_taxa_simp, sh3, startRow = 1,row.names = F)
sh4 = xlsx::createSheet(wb, 'Local_item_taxa')
xlsx::addDataFrame(Local_item_taxa, sh4, startRow = 1,row.names = F)
sh5 = xlsx::createSheet(wb, 'Local_item_taxa_simp')
xlsx::addDataFrame(Local_item_taxa_simp, sh5, startRow = 1,row.names = F)
sh6 = xlsx::createSheet(wb, 'Local_item_per_access')
xlsx::addDataFrame(Local_item_per_access, sh6, startRow = 1,row.names = F)
sh7 = xlsx::createSheet(wb, 'Local_item_distribution')
xlsx::addDataFrame(Local_item_distribution, sh7, startRow = 1,row.names = F)
sh8 = xlsx::createSheet(wb, 'Local_item_distribution_existing')
xlsx::addDataFrame(Local_item_distribution_existing, sh8, startRow = 1,row.names = F)
sh9 = xlsx::createSheet(wb, 'Local_item_accession_existing_simp')
xlsx::addDataFrame(Local_item_accession_existing_simp, sh9, startRow = 1,row.names = F)
sh10 = xlsx::createSheet(wb, 'Local_item_accession_at_origin_simp')
xlsx::addDataFrame(Local_item_accession_at_origin_simp, sh10, startRow = 1, row.names = F)
sh11 = xlsx::createSheet(wb, 'items_per_accessions_over_years_simp')
xlsx::addDataFrame(items_per_accessions_over_years_simp, sh11, startRow = 1, row.names = F)
xlsx::saveWorkbook(wb, file = paste0(output_dir,'/',collection,'_duplication_data.xlsx'))
```
***

