---
title: "Duplication and rarity at the global and local scales"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(htmltools)
library(sf)
library(here)
library(flextable)
library(ggrepel)
```

```{r, imported parameters}
#Inputs
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/ICCP_RBGE_enriched_report.rda')
# collection = 'ICCP at Royal Botanic Gardens Edinburgh'
# 
# separate_figure_folder = FALSE
# output_dir = '/Users/jakepowell/Desktop/Reports/ICCP at Royal Botanic Gardens Edinburgh'
# report_kind = 'static'
# ggtheme = NULL
# value_on_fig = TRUE
# min_year = 1970
# join_bigger_than = 4
# export_data  =T
# save_excel = T
```

```{r theme_ggplot2, echo = FALSE}
library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
          panel.grid.minor = ggplot2::element_blank(),
          panel.background = element_rect(fill = 'transparent', color = NA),
          panel.border = ggplot2::element_blank(),
          axis.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          axis.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          axis.line = ggplot2::element_line(color = "black"),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned
```

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"*** \n **Warning!**\n\n This enriched report contains missing 'original' columns needed to perform the analyses in this report. Default values have been created. In particular, the following were missing "}`

`r if(!'no_gardens' %in% names(enriched_report)){"- no_gardens: cannot perform global scale analysis.\n"}`
`r if(!'AccNoFull' %in% names(enriched_report)){"- AccNoFull: assume each item is its own accession.\n"}`

`r if(any(!c('no_gardens','AccNoFull') %in% names(enriched_report))){"***"}`

```{r, Extracting information from enriched report, echo = F}
do_global = TRUE
if(!'AccNoFull' %in% names(enriched_report)){enriched_report$AccNoFull = 1:nrow(enriched_report)}
if(!'no_gardens' %in% names(enriched_report)){do_global = FALSE}
report = enriched_report
no_records = nrow(report)

# Reduce the report to existing (non-cultivars or hybrids)
index_want = which(report$ItemStatusType == 'Existing' & !grepl('0|5|6',report$taxon_type))
no_want = length(index_want)
report = report[index_want,]

# Get the best name from POWO first o/w original report.
report$good_name = paste0(report$sanitised_taxon, ' ', report$extracted_author)

powo_name = paste0(report$POWO_taxon_name, ' ', report$POWO_taxon_authors)
powo_name[which(powo_name == 'NA NA')] = NA
report$powo_name = powo_name

best_name = powo_name
best_name[which(is.na(best_name))] = report$good_name[which(is.na(best_name))]
report$best_name =best_name



#Extract endemic information from enriched_report
endemic = rep('Not Endemic', nrow(report))
endemic_index = which(stringr::str_length(report$geography_codes) == 3)
endemic[endemic_index] = 'Endemic'
report$endemic = endemic
rm(endemic)

# Extract threatened. 
threat_cat = c('VU','EN','CR','EW','EX')
threatened = rep('Not Threatened', nrow(report))
threatened[which(report$redList_category %in% threat_cat)] = 'Threatened'
threatened[which(report$POWO_Red_category %in% threat_cat)] = 'Threatened'
report$threatened = threatened
rm(threatened)

#Select columns of interest
interest = report[,match(c('AccNoFull','sanitised_taxon', 'TaxonNameFull', 'powo_name', 'extracted_author', 'POWO_taxon_name', 'POWO_taxon_authors', 'good_name', 'no_gardens', 'endemic', 'threatened'), names(report))]

# Create a column with the name if we want to print the taxa. (latin words with italic, others plain.)
print_name = interest$sanitised_taxon
name_with_italic = unlist(lapply(stringr::str_split(print_name, ' '), function(x){
  x[which(!grepl('\\.',x))] = paste0('*',x[which(!grepl('\\.',x))],'*')
  paste0(x, collapse = ' ')
}))
print_name = paste0(name_with_italic, ' ', interest$extracted_author)
interest$print_name = print_name


if(separate_figure_folder){
  figures_dir = paste0(output_dir,'/',collection,'_Figures')
  dir.create(figures_dir,showWarnings = FALSE)
}

## - Deaccessioning list: sheet of very common, non-threatened, non-endemic taxa duplicated three or more times in a LC, including at least taxon name according to POWO, original name, and accession number
deaccessioning_list = interest[which(interest$threatened == 'Not Threatened' &
                                     interest$endemic == 'Not Endemic' & 
                                     interest$no_gardens > 100),]

# Reduce report unique by the number in each.
deaccessioning_list$count = rep(1,nrow(deaccessioning_list))
deaccessioning_list_format <- deaccessioning_list |>
    dplyr::group_by(.data$good_name) |>
    dplyr::summarise(original_report_taxon_name = toString(unique(.data$TaxonNameFull)),
                     powo_taxon_name = toString(unique(.data$powo_name)),
                     no_items_in_LC = sum(.data$count),
                    global = .data$no_gardens[1],
                     accessions = toString(unique(.data$AccNoFull)),
                     endemic = .data$endemic[1],
                     threatened = .data$threatened[1]
    ) |>
    dplyr::ungroup() 
deaccessioning_list_format = deaccessioning_list_format[deaccessioning_list_format$no_items_in_LC > 3,]
deaccessioning_list_format = deaccessioning_list_format[,-1]
names(deaccessioning_list_format) = c("Original Report Taxonomic Name", "Matched POWO Taxonomic Name", "Number of Items in the LC", "Number of global LC's holding Taxon", "Accessions in the LC", "Endemic status", "Threatened status")
writexl::write_xlsx(deaccessioning_list_format, path =paste0(output_dir,'/',collection,'_deaccessioning_list.xlsx'))


# -Sheet of taxa in 0-10 LCs including at least taxon name according to POWO, original name, and accession number. Can these be fake rare taxa (typos, non-matching names)? If so, add warning to plot and management sheet.

rare_global_list = interest[which(interest$no_gardens <= 10),]
rare_global_list$match_powo_issue = rare_global_list$POWO_taxon_name == rare_global_list$POWO_taxon_name
rare_global_list$match_powo_issue[is.na(rare_global_list$match_powo_issue)] = FALSE

# Reduce report unique by the number in each.
rare_global_list$count = rep(1,nrow(rare_global_list))
rare_global_list_format <- rare_global_list |>
    dplyr::group_by(.data$good_name) |>
    dplyr::summarise(original_report_taxon_name = toString(unique(.data$TaxonNameFull)),
                     powo_taxon_name = toString(unique(.data$powo_name)),
                     match_powo_issue = .data$match_powo_issue[1],
                     no_items_in_LC = sum(.data$count),
                    global = .data$no_gardens[1],
                     accessions = toString(unique(.data$AccNoFull)),
                     endemic = .data$endemic[1],
                     threatened = .data$threatened[1]
    ) |>
    dplyr::ungroup() 
no_different_rare_taxa = sum(!rare_global_list_format$match_powo_issue)
rare_global_list_format = rare_global_list_format[,-1]
names(rare_global_list_format) = c("Original Report Taxonomic Name", "Matched POWO Taxonomic Name", "Original Taxonomic Name same as POWO", "Number of Items in the LC", "Number of global LC's holding Taxon", "Accessions in the LC", "Endemic status", "Threatened status")
writexl::write_xlsx(rare_global_list_format, path =paste0(output_dir,'/',collection,'_rare_global_list.xlsx'))


```

This report explores duplication for existing plants at `r collection`. This is performed in two ways:

- Global level: how many collections globally are taxa in the LC found.
- Collection Level: investigates how many items or accessions there are for each taxa.

In all sections we only consider plants that are:

- Are not hybrids or cultivars.

This reduces the number of records in the LC to `r format(no_records, big.mark =',')` from `r format(nrow(interest), big.mark =',')`.

Moreover, where possible we will use the taxonomic name from matching to POWO online, if this is not possible we use the original name from the LC. 

***

## Duplication on the global scale

`r if(!do_global){"Since the report does not contain the number of global collections holding taxa we cannot perform this analysis!"}`

`r if(do_global){"To find the rarity of plants on the Global scale we use BGCI's plant search to extract the number of ex-situ sites a taxa is held in (only plants, not seeds or pollen). Therefore, the process is as follows:"}`

`r if(do_global){"- Match to POWO, and update taxonomic name and authority if needed (e.g. going to accepted name)."}`
`r if(do_global){"- Use the taxonomic name and authority to match to BGCI's plant search."}`
`r if(do_global){"- Extract the number of ex-situ sites, if the record does not exist set the number of gardens to zero."}`

`r if(do_global & no_different_rare_taxa > 0){paste0("Note that there are ", no_different_rare_taxa, " taxa in the LC classed as very rare (<= 10 LCs globally) where the original taxonomic name from the report and POWO's taxonomic name differ. See 'rare global list' management sheet for further detail.")}`

`r if(do_global){"Below we show the number of taxa in the LC against the number of sites the taxa is held globally. \n"}`


```{r, taxa in collection against how many sites globally - data, eval = do_global}
# only unique records.
report_unique = unique(interest[,-1]) # Remove the accession number as it's not needed for unique species.
no_unique_records = nrow(report_unique)
report_unique$no_gardens[is.na(report_unique$no_gardens)] = 0

# Reduce report unique by the number in each.
report_unique$count = rep(1,nrow(report_unique))
data_plot <- report_unique |>
    dplyr::group_by(.data$no_gardens) |>
    dplyr::summarise(plants = toString(.data$sanitised_taxon),
                     no_species_in_garden = sum(.data$count),
                     one_plant = .data$sanitised_taxon[1]
    ) |>
    dplyr::ungroup() 

# data formatted if we want to export/save it.
globally_held_taxa = data_plot[,c(1,3,4,2)]
names(globally_held_taxa) = c("Number of global LCs", "Number of species in LC", "Example taxa", "All taxa")

```

```{r, taxa in collection against how many sites globally - static figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'static'){
  colors = c('#41ab5d', '#78c679', '#addd8e', '#d9f0a3')
  xstart = c(0,10,50,100)
  xend = c(10,50,100, max(data_plot$no_gardens))
  
  grouped = table(cut(data_plot$no_gardens, breaks = c(xstart, max(data_plot$no_gardens, na.rm=T))))
  names(grouped) =  c('0 to 10', '11 to 50', '51 to 100', 'Over 100')
  
  rects <- data.frame(xstart = xstart, xend = xend, col = colors, Grouped = names(grouped))
  rects$Grouped = factor(rects$Grouped , levels = rects$Grouped)

  p = ggplot() + 
  geom_rect(data = rects, 
            aes(xmin = xstart, xmax = xend, ymin = -Inf, ymax = Inf, fill = Grouped), alpha = 1) +
    scale_fill_manual(values = colors) +
  geom_point(data = data_plot, aes(x=no_gardens, y=no_species_in_garden)) +
  labs(title=paste0(""),
       x ="Number of LC's holding \n the taxa worldwide",
       y = paste0('Number of taxa grown \n at the collection')) +
    theme(legend.position = "none")

  p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

   if(separate_figure_folder){
  ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Scatter-grown_in_LC_against_global.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
   }
  
  p
}
```

```{r, taxa in collection against how many sites globally - interactive figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'interactive'){
  text = paste0(data_plot$no_species_in_garden, ' species in the garden are found in ', data_plot$no_gardens, ' collections globally. <br> For example: ', data_plot$one_plant)

fig <- plot_ly(data_plot, x = ~no_gardens, y = ~no_species_in_garden, 
         type = 'scatter',  mode = 'markers', hoverinfo = "text",  hovertext = text, colors = rgb(0,0,0,alpha=0.7), color = 'color')
fig <- fig |> layout(title = "",
  xaxis = list(title = "Number of LCs holding the taxa worldwide"),
  yaxis = list (title = "Number of taxa grown at the collection")) 
fig <- layout(fig,
             shapes = list(
               list(type = "rect",
                    fillcolor = "#41ab5d", line = list(color = "#41ab5d"), opacity = 0.3,
                    x0 = 0, x1 = 10.5, xref = "x",
                    y0 = 0, y1 = max(data_plot$no_species_in_garden), yref = "y"),
                list(type = "rect",
                    fillcolor = "#78c679", line = list(color = "#78c679"), opacity = 0.3,
                    x0 = 10.5, x1 = 50.5, xref = "x",
                    y0 = 0, y1 = max(data_plot$no_species_in_garden), yref = "y"),
               list(type = "rect",
                    fillcolor = "#addd8e", line = list(color = "#addd8e"), opacity = 0.3,
                    x0 = 50.5, x1 = 100.5, xref = "x",
                    y0 = 0, y1 = max(data_plot$no_species_in_garden), yref = "y"),
                list(type = "rect",
                    fillcolor = "#d9f0a3", line = list(color = "#d9f0a3"), opacity = 0.3,
                    x0 = 100.5, x1 = max(data_plot$no_gardens), xref = "x",
                    y0 = 0, y1 = max(data_plot$no_species_in_garden), yref = "y")               
              ))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Scatter-grown_in_LC_against_global.html'))
}

fig
}
```


Next we group taxa by the number of collections they are found in globally. These are:

- **Very Rare**: found in 10 or less collections.
- **Rare**: found in between 11 and 50 collections.
- **Common**: found in between 51 and 100 collections.
- **Very Common**: found in more than 100 collections.

Rarity of species at the LC

```{r, grouped rarity - data, fig.dim = c(10, 4), eval = do_global}
v_rare = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 0:10])  
rare = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 11:50]) 
common = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 51:100]) 
v_common = sum(data_plot$no_species_in_garden[data_plot$no_gardens %in% 100:1500]) 

doughnut_data = data.frame(rarity = c('Very Rare', 'Rare', 'Common', 'Very Common'),
                        no_items = c(v_rare, rare, common, v_common),
                        color = c('#41ab5d', '#78c679', '#addd8e', "#d9f0a3"))
doughnut_data$percent = paste0(round(doughnut_data$no_items / sum(doughnut_data$no_items)*100,digits = 1),'%')


# data formatted if we want to export/save it.
globally_held_taxa_grouped = doughnut_data[,c(1,2,4,3)]
names(globally_held_taxa_grouped) = c("Rarity in global LCs",   "Number of Taxa in LC", "Percentage",  "Colour" )
```

```{r, grouped rarity - static figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'static'){

  doughnut_data <- doughnut_data |> 
  dplyr::mutate(csum = rev(cumsum(rev(no_items))), 
         pos = no_items/2 + dplyr::lead(csum, 1),
         pos = dplyr::if_else(is.na(pos), no_items/2, pos))

  
  p = ggplot(doughnut_data, aes(x="", y=no_items, fill=forcats::fct_inorder(rarity))) +
  geom_bar(stat="identity", width=1, color="white") +
  # ggtheme(base_size = 18) +
  coord_polar("y", start=0) +
  ggtitle('') +
  scale_fill_manual(values= colors,) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.title = element_text(hjust = 0.5)) +
    guides(fill=guide_legend(title="Rarity"))
  
  if(value_on_fig){
    p = p + geom_label_repel(aes(y = pos,label = percent),
        size = 4.5, nudge_x = 1, show.legend = FALSE, fill = "white")
  }
  

if(separate_figure_folder){
   ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-grouped_global_rarity.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
}

```

```{r, grouped rarity - interactive figure, fig.dim = c(10, 4), eval = do_global}
if(report_kind == 'interactive'){
  text = paste0(doughnut_data$no_items, ' records classed as ', doughnut_data$rarity )

fig <- plot_ly(doughnut_data, labels = ~rarity, values = ~no_items, hoverinfo = "text",  hovertext = text, marker = list(colors = ~color) )
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",  showlegend = T,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-grouped_global_rarity.html'))
}

fig
}

```


***

## Duplication in the LC

### Number of accessions per taxa

```{r, number of accessions per taxa - data}
# Reduced to only unique accessions.
accessions = interest[match(unique(interest$AccNoFull),interest$AccNoFull),]

# Get a vector of all the plant names in unique accessions and work out frequencies. 
taxa_no_accessions = table(accessions$good_name)
taxa_no_accessions = data.frame(taxa = names(taxa_no_accessions), no_accessions = as.numeric(taxa_no_accessions))
taxa_no_accessions = taxa_no_accessions[order(taxa_no_accessions$no_accessions,decreasing = T),]

# Group the number of species by the number of accessions they have. 
accession_taxa = table(taxa_no_accessions$no_accessions)
accession_taxa = data.frame(total_accessions = as.numeric(names(accession_taxa)), 
                            no_species = as.numeric(accession_taxa))

top_name = taxa_no_accessions$taxa[taxa_no_accessions$no_accessions == max(accession_taxa$total_accessions)][1]
top_name = interest$print_name[match(top_name,interest$good_name)]

# data formatted if we want to export/save it.
Local_accession_taxa = accession_taxa
Local_accession_taxa$percent = paste0(round(Local_accession_taxa$no_species / sum(Local_accession_taxa$no_species)*100,digits = 2),'%')
names(Local_accession_taxa) = c("Number of Accessions in LC", "Number of species in LC", "Percentage")
```

```{r, number of accessions per taxa - static figure, fig.dim = c(10, 4), eval = report_kind == 'static'}
p<-ggplot(data=accession_taxa, aes(x=total_accessions, y=no_species+0.01)) +
geom_bar(stat="identity") +
   labs(title=paste0(""),
      x ="Number of Accessions",
      y = "Number of Taxa")
p = p + scale_y_continuous(trans='log10', expand = expansion(mult = c(0.01, .1)))
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0)), n.breaks = 10)

if(value_on_fig){
  p = p +geom_text(aes(label = no_species),vjust=-0.2)
}

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar-accessions_per_taxa.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

```{r, number of accessions per taxa - interactive figure, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
accession_taxa$text = paste0(accession_taxa$no_species, ' Taxa in the LC have ', accession_taxa$total_accessions, ' accessions')

fig <- plot_ly(accession_taxa, x = ~total_accessions, y = ~no_species, type = "bar",  hoverinfo = "text",  hovertext = ~text)

fig <- fig |> layout(title = "",
         xaxis = list(title = "Number of Accessions"),
         yaxis = list (title = "Number of Taxa", type = 'log')) 

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-accessions_per_taxa.html'))
}

fig
```

Statistics from number of accessions per taxa:

- The maximum number of accessions for a given taxon is **`r max(accession_taxa$total_accessions)`** this occurs for the accession **`r top_name`**. 
- The mean number of accessions per taxa is **`r round(mean(taxa_no_accessions$no_accessions),digits=2)`**.
- The median number of accessions per taxa is **`r median(taxa_no_accessions$no_accessions)`**.
- **`r format(accession_taxa$no_species[accession_taxa$total_accessions == 1], big.mark =',')`** taxa have a single accession.


Number of accessions per taxa 

```{r simplify accessions per taxa for donut chart}
doughnut_data =  accession_taxa[,1:2]
species_big_than = sum(doughnut_data$no_species[doughnut_data$total_accessions > join_bigger_than])
doughnut_data = doughnut_data[doughnut_data$total_accessions <=join_bigger_than,]
doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
doughnut_data$no_species = as.numeric(doughnut_data$no_species)

doughnut_data$percent = paste0(round(doughnut_data$no_species / sum(doughnut_data$no_species)*100,digits = 1),'%')

# data formatted if we want to export/save it.
Local_accession_taxa_simp = doughnut_data
names(Local_accession_taxa_simp) = c("Number of Accessions in LC", "Number of species in LC", "Percentage")
```

```{r Doughnut chart accessions per taxa - static figure, fig.dim = c(10, 4),  eval = report_kind == 'static'}
doughnut_data <- doughnut_data |> 
dplyr::mutate(csum = rev(cumsum(rev(no_species))), 
       pos = no_species/2 + dplyr::lead(csum, 1),
       pos = dplyr::if_else(is.na(pos), no_species/2, pos))


p = ggplot(doughnut_data, aes(x="", y=no_species, fill=forcats::fct_inorder(total_accessions))) +
geom_bar(stat="identity", width=1, color="white") +
# ggtheme(base_size = 18) +
coord_polar("y", start=0) +
ggtitle('') +
theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Number of \n accessions"))

if(value_on_fig){
  p = p + geom_label_repel(aes(y = pos,label = percent),
      size = 3.5, nudge_x = 1.2, show.legend = FALSE, fill = "white")
}


if(separate_figure_folder){
 ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-number_of_accessions_per_taxa.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

```{r Doughnut chart accessions per taxa - interactive figure, fig.dim = c(10, 4),  eval = report_kind == 'interactive'}
text = paste0('Accessions = ',doughnut_data$total_accessions, '<br>',
             'Taxa = ',doughnut_data$no_species, '<br>')
             
fig <- plot_ly(doughnut_data, labels = ~total_accessions, values = ~no_species, hoverinfo = "text",  hovertext = text)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-accessions_per_taxa.html'))
}

fig
```


***

### Number of items per taxa

```{r, number of items per taxa - data, echo = FALSE}
taxa = table(interest$good_name)
data_cur = data.frame(taxa = names(taxa), no_items = as.numeric(taxa))

item_taxa = table(data_cur$no_items)
item_taxa = data.frame(total_items = as.numeric(names(item_taxa)), 
                            no_species = as.numeric(item_taxa))

top_name = data_cur$taxa[data_cur$no_items == max(item_taxa$total_items)][1]
top_name = interest$print_name[match(top_name,interest$good_name)]

Local_item_taxa = item_taxa
Local_item_taxa$percent = paste0(round(Local_item_taxa$no_species / sum(Local_item_taxa$no_species)*100,digits = 2),'%')
names(Local_item_taxa) = c("Number of Items in LC", "Number of species in LC", "Percentage")
```

```{r, number of items per taxa - static figure, fig.dim = c(10, 4), eval = report_kind == 'static'}
p<-ggplot(data=item_taxa, aes(x=total_items, y=no_species+0.01)) +
geom_bar(stat="identity") +
   labs(title=paste0(""),
      x ="Number of Items",
      y = "Number of Taxa")
p = p + scale_y_continuous(trans='log10', expand = expansion(mult = c(0.01, .1)))
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0)), n.breaks = 10)

if(value_on_fig){
  p = p +geom_text(aes(label = no_species),vjust=-0.2, position = "dodge")
}



if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar-items_per_taxa.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p

```

```{r, number of items per taxa - interactive figure, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
item_taxa$text = paste0(item_taxa$no_species, ' Taxa in the LC have ', item_taxa$total_items, ' items')

fig <- plot_ly(item_taxa, x = ~total_items, y = ~no_species, type = "bar", hoverinfo = "text",  hovertext = ~text)

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Number of Items"),
         yaxis = list(title = "Number of Taxa", type = 'log')) 

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-items_per_taxa.html'))
}

fig
```

Statistics from number of items per taxa:

- The maximum number of items for a given taxa is **`r max(item_taxa$total_items)`**. An example is the taxon **`r top_name`**. 
- The mean number of items per taxa is **`r round(mean(data_cur$no_items),digits=2)`**.
- The median number of items per taxa is **`r median(data_cur$no_items)`**.
- **`r item_taxa$no_species[item_taxa$total_items == 1]`** taxa have a single item in the LC.

Number of items per taxa 

```{r simplify items per taxa for donut chart}
doughnut_data =  item_taxa[,1:2]
species_big_than = sum(doughnut_data$no_species[doughnut_data$total_items > join_bigger_than])
doughnut_data = doughnut_data[doughnut_data$total_items <=join_bigger_than,]
doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
doughnut_data$no_species = as.numeric(doughnut_data$no_species)

doughnut_data$percent = paste0(round(doughnut_data$no_species / sum(doughnut_data$no_species)*100,digits = 1),'%')

# data formatted if we want to export/save it.
Local_item_taxa_simp = doughnut_data
names(Local_accession_taxa_simp) = c("Number of Accessions in LC", "Number of species in LC", "Percentage")
```

```{r Doughnut chart items per taxa - static figure, fig.dim = c(10, 4),  eval = report_kind == 'static'}
doughnut_data <- doughnut_data |> 
dplyr::mutate(csum = rev(cumsum(rev(no_species))), 
       pos = no_species/2 + dplyr::lead(csum, 1),
       pos = dplyr::if_else(is.na(pos), no_species/2, pos))


p = ggplot(doughnut_data, aes(x="", y=no_species, fill=forcats::fct_inorder(total_items))) +
geom_bar(stat="identity", width=1, color="white") +
# ggtheme(base_size = 18) +
coord_polar("y", start=0) +
ggtitle('') +
theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Number of \n items"))

if(value_on_fig){
  p = p + geom_label_repel(aes(y = pos,label = percent),
      size = 3.5, nudge_x = 1.2, show.legend = FALSE, fill = "white")
}


if(separate_figure_folder){
 ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-number_of_items_per_taxa.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

```{r Doughnut chart items per taxa - interactive figure, fig.dim = c(10, 4),  eval = report_kind == 'interactive'}
text = paste0('Accessions = ',doughnut_data$total_items, '<br>',
             'Taxa = ',doughnut_data$no_species, '<br>')
             
fig <- plot_ly(doughnut_data, labels = ~total_items, values = ~no_species, hoverinfo = "text",  hovertext = text, sort = FALSE)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-items_per_taxa.html'))
}

fig
```


***

### Number of items per accession 

When considering the number of items per accession we first consider all of the plants that are existing in the LC. This is performed in the section 'Only considering items currently existing in the LC'. However, this does not account for how many items there were at the time of accessioning because some of the items might have died. Therefore, we will also explore the number of items in an accession at the time of accessioning. This will allow us to explore if the number of items per accession has changed over time. This is performed in the section 'Considering the total number of items in an accession at the time of accessioning'.


#### Only considering items currently existing in the LC

Number of accessions in the collection by their number of items (existing at this moment).

```{r, get items per accession data - existing, echo = FALSE}
existing_accessions = unique(report$AccNoFull)
accessions_existing = report$AccNoFull
accessions_all = enriched_report$AccNoFull[enriched_report$AccNoFull %in% existing_accessions]

item_per_access = table(accessions_all)
item_per_access = data.frame(accession = names(item_per_access), no_items = as.numeric(item_per_access))

item_per_access_existing = table(accessions_existing)
item_per_access_existing = data.frame(accession = names(item_per_access_existing), no_items = as.numeric(item_per_access_existing))

item_per_access$no_items_existing = item_per_access_existing$no_items

# data formatted if we want to export/save it.
Local_item_per_access = item_per_access
Local_item_per_access$prop_still_exist = round(Local_item_per_access$no_items_existing / Local_item_per_access$no_items*100,digits = 2)
names(Local_item_per_access) = c( "Accession", "Number of items at time of accessioning", "Number of items still existing", "Percentage of items still existing")

item_dist = table(item_per_access$no_items)
item_dist = data.frame(total_items = as.numeric(names(item_dist)), no_accessions = as.numeric(item_dist))

# data formatted if we want to export/save it.
Local_item_distribution = item_dist
Local_item_distribution$percent = paste0(round(Local_item_distribution$no_accessions / sum(Local_item_distribution$no_accessions)*100,digits = 2),'%')

names(Local_item_distribution) = c("Number of items", "Number of accessions", "Perentage of accessions")

item_dist_existing = table(item_per_access$no_items_existing)
item_dist_existing = data.frame(total_items = as.numeric(names(item_dist_existing)), no_accessions = as.numeric(item_dist_existing))

# data formatted if we want to export/save it.
Local_item_distribution_existing = item_dist_existing
Local_item_distribution_existing$percent = paste0(round(Local_item_distribution_existing$no_accessions / sum(Local_item_distribution_existing$no_accessions)*100,digits = 2),'%')

names(Local_item_distribution_existing) = c("Number of items", "Number of accessions", "Perentage of accessions")


max_accession = item_per_access$accession[item_per_access$no_items == max(item_dist$total_items)] 
max_accession_existing = item_per_access_existing$accession[item_per_access_existing$no_items == max(item_dist_existing$total_items)] 

plant_max_accession = paste0(report$sanitised_taxon[match(max_accession, report$AccNoFull)], ' ', report$extracted_author[match(max_accession, report$AccNoFull)])
plant_max_accession_existing = paste0(report$sanitised_taxon[match(max_accession_existing, report$AccNoFull)], ' ', report$extracted_author[match(max_accession_existing, report$AccNoFull)])


```

```{r, number of items per accession exisiting at this moment - static figure, fig.dim = c(10, 4), eval = report_kind == 'static'}
p<-ggplot(data=item_dist_existing, aes(x=total_items, y=no_accessions+0.01)) +
geom_bar(stat="identity") +
   labs(title=paste0(""),
      x ="Number of Items",
      y = "Number of Accessions")
p = p + scale_y_continuous(trans='log10', expand = expansion(mult = c(0.01, .1)))
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01)), n.breaks = 10)

if(value_on_fig){
  p = p +geom_text(aes(label = no_accessions),vjust=-0.2, hjust = 0.1)
}



if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar-items_per_accession_existing.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p

```

```{r, number of items per accession exisiting at this moment - interactive figure, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
item_dist_existing$text = paste0(item_dist_existing$no_accessions, ' accessions in the LC have ', item_dist_existing$total_items, ' items')

fig <- plot_ly(item_dist_existing, x = ~total_items, y = ~no_accessions, type = "bar", hoverinfo = "text",  hovertext = ~text)

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Number of Items"),
         yaxis = list(title = "Number of Accessions", type = 'log')) 

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-items_per_accession_existing.html'))
}

fig
```

Statistics from number of items per accession (at time of accessioning):

- The maximum number of items in an accession is **`r max(item_dist_existing$total_items)`**, for example the accession **`r max_accession[1]`** (`r interest$print_name[match(plant_max_accession_existing[1],interest$good_name)]`). 
- The mean number of items per accession is **`r round(mean(item_per_access_existing$no_items),digits=2)`**.
- The median number of items per accession is **`r median(item_per_access_existing$no_items)`**.
- **`r item_dist_existing$no_accessions[item_dist_existing$total_items==1]`** accessions are comprised of a single item.


Number of items per taxa 

```{r simplify items per accession for existing items  for donut chart}
doughnut_data =  item_dist_existing[,1:2]
species_big_than = sum(doughnut_data$no_accessions[doughnut_data$total_items > join_bigger_than])
doughnut_data = doughnut_data[doughnut_data$total_items <=join_bigger_than,]
doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
doughnut_data$no_accessions = as.numeric(doughnut_data$no_accessions)

doughnut_data$percent = paste0(round(doughnut_data$no_accessions / sum(doughnut_data$no_accessions)*100,digits = 1),'%')

# data formatted if we want to export/save it.
Local_item_accession_existing_simp = doughnut_data
names(Local_item_accession_existing_simp) = c("Number of items in accession", "Number of accessions in LC", "Percentage")
```

```{r Doughnut chart items per accession for existing items - static figure, fig.dim = c(10, 4),  eval = report_kind == 'static'}
doughnut_data <- doughnut_data |> 
dplyr::mutate(csum = rev(cumsum(rev(no_accessions))), 
       pos = no_accessions/2 + dplyr::lead(csum, 1),
       pos = dplyr::if_else(is.na(pos), no_accessions/2, pos))


p = ggplot(doughnut_data, aes(x="", y=no_accessions, fill=forcats::fct_inorder(total_items))) +
geom_bar(stat="identity", width=1, color="white") +
# ggtheme(base_size = 18) +
coord_polar("y", start=0) +
ggtitle('') +
theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Number of \n items"))

if(value_on_fig){
  p = p + geom_label_repel(aes(y = pos,label = percent),
      size = 3.5, nudge_x = 1.2, show.legend = FALSE, fill = "white")
}


if(separate_figure_folder){
 ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-number_of_items_per_accession_existing.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

```{r Doughnut chart items per accession for existing items - interactive figure, fig.dim = c(10, 4),  eval = report_kind == 'interactive'}
text = paste0('Items = ',doughnut_data$total_items, '<br>',
             'Accessions = ',doughnut_data$no_accessions, '<br>')
             
fig <- plot_ly(doughnut_data, labels = ~total_items, values = ~no_accessions, hoverinfo = "text",  hovertext = text, sort = FALSE)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-items_per_accession_existing.html'))
}

fig
```


#### Considering the total number of items in an accession at the time of accessioning

Number of accessions in the collection by their number of items (at the time of accession).

```{r, number of items per accession exisiting at time of accession - static figure, fig.dim = c(10, 4), eval = report_kind == 'static'}
p<-ggplot(data=item_dist, aes(x=total_items, y=no_accessions+0.01)) +
geom_bar(stat="identity") +
   labs(title=paste0(""),
      x ="Number of Items",
      y = "Number of Accessions")
p = p + scale_y_continuous(trans='log10', expand = expansion(mult = c(0.01, .1)))
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01)), n.breaks = 10)

if(value_on_fig){
  p = p +geom_text(aes(label = no_accessions),vjust=-0.2, hjust = 0.1)
}



if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Bar-items_per_accession_at_time_of_accession.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p

```

```{r, number of items per accession exisiting at time of accession - interactive figure, fig.dim = c(10, 4), eval = report_kind == 'interactive'}
item_dist$text = paste0(item_dist$no_accessions, ' accessions in the LC have ', item_dist$total_items, ' items')

fig <- plot_ly(item_dist, x = ~total_items, y = ~no_accessions, type = "bar", hoverinfo = "text",  hovertext = ~text)

fig <- fig %>% layout(title = "",
         xaxis = list(title = "Number of Items"),
         yaxis = list(title = "Number of Accessions", type = 'log')) 

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Bar-items_per_accession_at_time_of_accession.html'))
}

fig
```

Statistics from number of items per accession (at time of accessioning):

- The maximum number of items in an accession is **`r max(item_dist$total_items)`** for example the accession **`r max_accession[1]`** (`r interest$print_name[match(plant_max_accession[1],interest$good_name)]`). 
- The mean number of items per accession is **`r round(mean(item_per_access$no_items),digits=2)`**.
- The median number of items per accession is **`r median(item_per_access$no_items)`**.
- **`r item_dist$no_accessions[item_dist$total_items==1]`** accessions are comprised of a single item.

Number of items per taxa. 

```{r simplify items per accession exisiting at time of accession for donut chart}
doughnut_data =  item_dist[,1:2]
species_big_than = sum(doughnut_data$no_accessions[doughnut_data$total_items > join_bigger_than])
doughnut_data = doughnut_data[doughnut_data$total_items <=join_bigger_than,]
doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
doughnut_data$no_accessions = as.numeric(doughnut_data$no_accessions)

doughnut_data$percent = paste0(round(doughnut_data$no_accessions / sum(doughnut_data$no_accessions)*100,digits = 1),'%')

# data formatted if we want to export/save it.
Local_item_accession_at_origin_simp = doughnut_data
names(Local_item_accession_at_origin_simp) = c("Number of items in accession", "Number of accessions in LC", "Percentage")
```

```{r Doughnut chart items per accession exisiting at time of accession - static figure, fig.dim = c(10, 4),  eval = report_kind == 'static'}
doughnut_data <- doughnut_data |> 
dplyr::mutate(csum = rev(cumsum(rev(no_accessions))), 
       pos = no_accessions/2 + dplyr::lead(csum, 1),
       pos = dplyr::if_else(is.na(pos), no_accessions/2, pos))


p = ggplot(doughnut_data, aes(x="", y=no_accessions, fill=forcats::fct_inorder(total_items))) +
geom_bar(stat="identity", width=1, color="white") +
# ggtheme(base_size = 18) +
coord_polar("y", start=0) +
ggtitle('') +
theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank(),
      plot.title = element_text(hjust = 0.5)) +
  guides(fill=guide_legend(title="Number of \n items"))

if(value_on_fig){
  p = p + geom_label_repel(aes(y = pos,label = percent),
      size = 3.5, nudge_x = 1.2, show.legend = FALSE, fill = "white")
}


if(separate_figure_folder){
 ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Pie-number_of_items_per_accession.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p
```

```{r Doughnut chart items per accession exisiting at time of accession - interactive figure, fig.dim = c(10, 4),  eval = report_kind == 'interactive'}
text = paste0('Items = ',doughnut_data$total_items, '<br>',
             'Accessions = ',doughnut_data$no_accessions, '<br>')
             
fig <- plot_ly(doughnut_data, labels = ~total_items, values = ~no_accessions, hoverinfo = "text",  hovertext = text, sort = FALSE)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "",
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Pie-items_per_accession.html'))
}

fig
```


Since we are considering the number of items at the time of accessioning and each accession must occur in a singular year we can explore how the number of items per accession has varied over time. 

```{r data prep for items per accession over time}
years = min_year:as.numeric(format(Sys.Date(),'%Y'))

items_per_accession_years = lapply(years, function(year){
  accession_numbers  = enriched_report$AccNoFull[enriched_report$AccYear == year]
  if(length(accession_numbers) == 0){return(NA)}
  item_per_access = table(accession_numbers)
  item_per_access = data.frame(accession = names(item_per_access), no_items = as.numeric(item_per_access))

  item_dist = table(item_per_access$no_items)
  item_dist = data.frame(total_items = as.numeric(names(item_dist)), no_accessions = as.numeric(item_dist))
  item_dist$percent = round(item_dist$no_accessions / sum(item_dist$no_accessions)*100,digits = 3)

  doughnut_data =  item_dist[,1:2]
  species_big_than = sum(doughnut_data$no_accessions[doughnut_data$total_items > join_bigger_than])
  doughnut_data = doughnut_data[doughnut_data$total_items <=join_bigger_than,]
  doughnut_data[nrow(doughnut_data)+1,] = c(paste0('> ',join_bigger_than), species_big_than)
  doughnut_data$no_accessions = as.numeric(doughnut_data$no_accessions)
  
  doughnut_data$percent = round(doughnut_data$no_accessions / sum(doughnut_data$no_accessions)*100,digits = 3)

  return(list(item_per_access = item_dist, item_per_access_short = doughnut_data))
})
names(items_per_accession_years) = paste0('year: ', years )


# For stacked bar plot.
stacked_bar_data = NULL
for(i in 1:length(items_per_accession_years)){
  if('item_per_access_short' %in% names(items_per_accession_years[[i]])){
    d_cur = items_per_accession_years[[i]]$item_per_access_short
    d_cur$year = rep(years[i], nrow(d_cur))
    stacked_bar_data = rbind(stacked_bar_data, d_cur)
  }
}
options = as.character(c(1:join_bigger_than, paste0('> ',join_bigger_than)))
cats = options[options %in% unique(stacked_bar_data$total_items)]


if(!is.null(stacked_bar_data)){
  stacked_bar_data$total_items  <-  factor(stacked_bar_data$total_items, cats)
  items_per_accessions_over_years_simp = stacked_bar_data[,c(4,1,2,3)]
  names(items_per_accessions_over_years_simp) = c("Year", "Number of items", "Number of accessions", "Percentage of accessions")
}else{
  items_per_accessions_over_years_simp = NA
}

```

```{r items per accession over time - static figure,  fig.dim = c(10, 4),  eval = report_kind == 'static' & !is.null(stacked_bar_data)}
p = ggplot(stacked_bar_data, aes(fill=total_items, y=no_accessions, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) + labs(x = 'Year', y = 'Number of Accessions', fill = 'Items per \n accession')
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

p

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Stacked_Bar-items_per_accession_over_time.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}

p = ggplot(stacked_bar_data, aes(fill=total_items, y=percent, x=year)) + 
    geom_bar(position="stack", stat="identity", width = 1) + labs(x = 'Year', y = 'Proportion of Accessions', fill = 'Items per \n accession')
p = p + scale_x_continuous(expand = expansion(mult = c(0.01, 0.01))) + scale_y_continuous(expand = expansion(mult = c(0.01, 0.01)))

p

if(separate_figure_folder){
ggplot2::ggsave(plot = p, filename = paste0(figures_dir, '/','Stacked_Bar-percentage_items_per_accession_over_time.pdf'),device = 'pdf', scale = 1, limitsize = FALSE)
}
```

```{r items per accession over time - interactive figure,  fig.dim = c(10, 4),  eval = report_kind == 'interactive'& !is.null(stacked_bar_data)}

stacked_bar_data$text = paste0(round(stacked_bar_data$no_accessions,digits = 2), ' accessions have ', stacked_bar_data$total_items, ' items')

fig <- plot_ly(stacked_bar_data, x = ~year, y = ~no_accessions, color = ~total_items, type = 'bar',  hoverinfo = "text",  hovertext = ~text, sort = FALSE)
fig <- fig |> layout(yaxis = list(title = 'Number of Accessions'),
                     xaxis = list(title = "Year"),
                     legend=list(title=list(text='Number of Items')),
                     barmode = 'stack')
fig <- fig |> layout(hovermode = 'x unified', bargap =0)
fig

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-items_per_accession_over_time.html'))
}

stacked_bar_data$text = paste0(round(stacked_bar_data$percent,digits = 2), '% of accessions have ', stacked_bar_data$total_items, ' items')
fig <- plot_ly(stacked_bar_data, x = ~year, y = ~percent, color = ~total_items, type = 'bar',  hoverinfo = "text",  hovertext = ~text)
fig <- fig |> layout(yaxis = list(title = 'Percentage of Accessions'),
                     xaxis = list(title = "Year"),
                     legend=list(title=list(text='Number of Items')),
                     barmode = 'stack')
fig <- fig |> layout(hovermode = 'x unified', bargap =0)

fig

if(separate_figure_folder){
  htmlwidgets::saveWidget(fig, file = paste0(figures_dir, '/','Stacked_Bar-percentage_items_per_accession_over_time.html'))
}

```


```{r, export data, eval = export_data == TRUE}
duplication_data = list(
globally_held_taxa = globally_held_taxa,
globally_held_taxa_grouped = globally_held_taxa_grouped,
Local_accession_taxa = Local_accession_taxa,
Local_accession_taxa_simp = Local_accession_taxa_simp,
Local_item_taxa = Local_item_taxa,
Local_item_taxa_simp = Local_item_taxa_simp,
Local_item_per_access = Local_item_per_access,
Local_item_distribution = Local_item_distribution,
Local_item_distribution_existing = Local_item_distribution_existing,
Local_item_accession_existing_simp = Local_item_accession_existing_simp,
Local_item_accession_at_origin_simp = Local_item_accession_at_origin_simp,
items_per_accession_years = items_per_accession_years,
items_per_accessions_over_years_simp = items_per_accessions_over_years_simp)

save(duplication_data, file = paste0(output_dir,'/',collection, '_duplication_data.rda'))

library(xlsx)
wb = xlsx::createWorkbook()
sh0 = xlsx::createSheet(wb, 'globally_held_taxa')
xlsx::addDataFrame(as.data.frame(globally_held_taxa), sh0, startRow = 1,row.names = F)
sh1 = xlsx::createSheet(wb, 'globally_held_taxa_grouped')
xlsx::addDataFrame(globally_held_taxa_grouped, sh1, startRow = 1,row.names = F)
sh2 = xlsx::createSheet(wb, 'Local_accession_taxa')
xlsx::addDataFrame(Local_accession_taxa, sh2, startRow = 1,row.names = F)
sh3 = xlsx::createSheet(wb, 'Local_accession_taxa_simp')
xlsx::addDataFrame(Local_accession_taxa_simp, sh3, startRow = 1,row.names = F)
sh4 = xlsx::createSheet(wb, 'Local_item_taxa')
xlsx::addDataFrame(Local_item_taxa, sh4, startRow = 1,row.names = F)
sh5 = xlsx::createSheet(wb, 'Local_item_taxa_simp')
xlsx::addDataFrame(Local_item_taxa_simp, sh5, startRow = 1,row.names = F)
sh6 = xlsx::createSheet(wb, 'Local_item_per_access')
xlsx::addDataFrame(Local_item_per_access, sh6, startRow = 1,row.names = F)
sh7 = xlsx::createSheet(wb, 'Local_item_distribution')
xlsx::addDataFrame(Local_item_distribution, sh7, startRow = 1,row.names = F)
sh8 = xlsx::createSheet(wb, 'Local_item_distribution_existing')
xlsx::addDataFrame(Local_item_distribution_existing, sh8, startRow = 1,row.names = F)
sh9 = xlsx::createSheet(wb, 'Local_item_accession_existing_simp')
xlsx::addDataFrame(Local_item_accession_existing_simp, sh9, startRow = 1,row.names = F)
sh10 = xlsx::createSheet(wb, 'Local_item_accession_at_origin_simp')
xlsx::addDataFrame(Local_item_accession_at_origin_simp, sh10, startRow = 1, row.names = F)
sh11 = xlsx::createSheet(wb, 'items_per_accessions_over_years_simp')
xlsx::addDataFrame(items_per_accessions_over_years_simp, sh11, startRow = 1, row.names = F)
xlsx::saveWorkbook(wb, file = paste0(output_dir,'/',collection,'_duplication_data.xlsx'))
```
***

