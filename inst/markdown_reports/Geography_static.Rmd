---
title: "Geographic distribution of taxa at the collection"
output:
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(ggplot2)
library(sf)

library(ggplot2)
# Changing the default theme
if(is.null(ggtheme)){
   ggtheme <- function(base_size = 16) {
      ggplot2::theme_bw(base_size = base_size) %+replace%
        ggplot2::theme(
          plot.title = ggplot2::element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0.5),
          panel.grid.minor = ggplot2::element_blank(),
          panel.border = ggplot2::element_blank(),
          legend.title = ggplot2::element_text(size = rel(0.85), face = "bold"),
          legend.text = ggplot2::element_text(size = rel(0.70), face = "bold"),
          legend.key = ggplot2::element_rect(fill = "transparent", colour = NA),
          legend.key.size = ggplot2::unit(1.5, "lines"),
          legend.background = ggplot2::element_rect(fill = "transparent", colour = NA),
          strip.background = ggplot2::element_rect(fill = "#17252D", color = "#17252D"),
          strip.text = ggplot2::element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0)),
          axis.line=element_blank(),
          axis.text.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
        )
    }
}
theme_set(ggtheme())
update_geom_defaults("line", list(size = 2))

# Set the colour scale for the plots
scale_colour_continuous <- scale_colour_continuous
scale_colour_discrete   <- scale_colour_discrete
scale_colour_binned     <- scale_colour_binned
scale_fill_continuous <- scale_fill_continuous
scale_fill_discrete <- scale_fill_discrete
scale_fill_binned <- scale_fill_binned

exporting_data_store = list()

```

```{r, Set location settings}
# Inputs
# As an input we get 
# - Enriched report
# - Native
# collection = 'Kew'
# load('/Users/jakepowell/Cambridge/Enriched_reports_Jake/Kew_enriched_report.rda')
# native = 'Naturally occurring only'
# extinct = TRUE
# doubtful_locations = FALSE



####################################
enriched_report = enriched_report[enriched_report$ItemStatusType == 'Existing',]


no_items = nrow(enriched_report)
no_powo_matched = sum(!is.na(enriched_report$POWO_plant_name_id))
percent_matched = round(no_powo_matched/no_items*100,digits=2)

location_type_text = ''
if(native == 'Naturally occurring only'){
 location_type_text = paste0(location_type_text, 'naturally occuring only,', collapse = ' ')  
}else if(native == 'Introduced only'){
  location_type_text = paste0(location_type_text, 'introduced only,', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, 'Either naturally occurring or introduced,', collapse = ' ')  
}
if(extinct){
   location_type_text = paste0(location_type_text, ' allowing extinct regions and', collapse = ' ')  
}else{
  location_type_text = paste0(location_type_text, ' not including extinct regions and', collapse = ' ')  
}
if(doubtful_locations){
   location_type_text = paste0(location_type_text, ' allowing doubtful regions.', collapse = ' ')  
 
}else{
  location_type_text = paste0(location_type_text, ' not allowing doubtful regions.', collapse = ' ')  
}
```

This report explores the geographic distribution of existing taxa in `r collection`.

To get geographic information the LC has been enriched with information from [Plants of the World Online (POWO)](https://powo.science.kew.org). Only records that are matched to POWO have geographic information. This is true for `r percent_matched`% (`r format(no_powo_matched ,big.mark = ',')`)  of the items in the LC.

POWO uses [TDWG geographical codes](https://www.tdwg.org/standards/wgsrpd/) (Brummitt, 2001) expressed to that system's third level. This splits the world into 369 regions. Moreover, POWO splits the geographic distribution by three conditions:

- Native / non-native,
- Extinct / Not extinct,
- Location is doubtful / otherwise.

This document considers locations that are : `r location_type_text` 

```{r, Extract geographic distribution, echo = FALSE}
# Prepare the data for the plots.

# Restrict to only those matched to WCVP.
wanted_info = enriched_report[!is.na(enriched_report$POWO_plant_name_id),]
# Add species by combining taxonomic name and authors
wanted_info$species = paste0(wanted_info$POWO_taxon_name, ' ', wanted_info$POWO_taxon_authors)
#Restrict to only unique species.
wanted_info = wanted_info[match(unique(wanted_info$species), wanted_info$species),]

#Extract only the geography columns from wanted data.
geography_data = wanted_info[,grepl('_area_code_l3', names(wanted_info))]
#Begin with all the options and reduce depending
want = c('000','010','001','011','100','110','101')

#Depending on the values of the options reduce `want` to only the satisfactory values.
##A) introduced / naturally occurring only.
if(native == 'Introduced only'){
 want = want[grepl('^1',want)]
}else if(native == 'Naturally occurring only'){
 want = want[grepl('^0',want)]
}
## B) Extinct
if(!extinct){
 want = want[!grepl('010|011|110',want)]
}
## C) Doubtful
if(!doubtful_locations){
 want = want[!grepl('001|011|101',want)]
}

# Get the columns in wanted info that contain the geography information we want.
geography_data = geography_data[,grepl(paste0(want,collapse='|'), names(geography_data))]

if(length(want) > 1){
 level3codes =do.call("paste", c(geography_data, sep = ", "))
 level3codes = stringr::str_remove(level3codes, ', NA$')
 level3codes = stringr::str_remove(level3codes, 'NA, ')
}else{
 level3codes = geography_data
}

# Add level3codes to wanted_info.
wanted_info$geography_codes = level3codes

# Get all BRU level 3 location codes.
All_locations = wgsrpd3$LEVEL3_COD

# All_locations = wgsrpd3_level3_simp$code

#Get the number of speices for each location.
no_species = unlist(lapply(All_locations, function(x){
  sum(grepl(x, wanted_info$geography_codes))
}))

#Get the number of endemic species for each location.
endemic_info = wanted_info[stringr::str_length(wanted_info$geography_codes) == 3,]
no_endemic = unlist(lapply(All_locations, function(x){
  sum(grepl(x, endemic_info$geography_codes))
}))

#Get the number of threatened species for each location.
indicesA = which(wanted_info$POWO_Red_category %in%  c('EN', 'VU', 'CR', 'EW', 'EX'))
indicesB = which(wanted_info$redList_category %in%  c('EN', 'VU', 'CR', 'EW', 'EX'))
indices = unique(c(indicesA, indicesB))
threatened_info = wanted_info[indices,]
no_threatened = unlist(lapply(All_locations, function(x){
  sum(grepl(x, threatened_info$geography_codes))
}))

# Combine the wanted information into location data.
location_data = data.frame(code =  wgsrpd3$LEVEL3_COD,
                           name = wgsrpd3$LEVEL3_NAM,
                           no_species = no_species,
                           rep_species = no_species > 0,
                           no_endemic = no_endemic,
                           rep_endemic = no_endemic > 0,
                           no_threatened = no_threatened,
                           rep_threatened = no_threatened > 0
                           )
plot_info <- wgsrpd3 |>
  #add the location data to the geometry data
  dplyr::left_join(location_data, by=c("LEVEL3_COD"="code"))

# Do we want to export the data into an excel spreadsheet.
if(export_data){
  l = location_data
  names(l) = c('BRU level 3 code',
               'BRU level 3 name',
               'Number of Species',
               'Represented by Species',
               'Number of Endemic Species',
               'Represented by Endemic Species',
               'Number of Threatened Species',
               'Represented by Threatened Species')
  writexl::write_xlsx(l,path = paste0(collection,'_geography_data.xlsx'))
  rm(l)
}
```

***

## Species in the LC

### BRU level 3 areas represented in the LC

```{r, BRU level 3 areas represented in the LC - regions not represented.}
percent_rep = round(sum(plot_info$rep_species) / length(plot_info$rep_species) *100,digits = 2)
no_rep = plot_info$LEVEL3_NAM[!plot_info$rep_species]
```


```{r, BRU level 3 areas represented in the LC - Figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
fig = ggplot(plot_info)+
  geom_sf(aes(fill=rep_species),  col="transparent")+
  stat_sf_coordinates(aes(col=rep_species))+
  guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
         col = "none")

fig
```

In the LC `r percent_rep`% of the BRU level 3 regions are represented, with `r length(no_rep)` regions un-represented. 

```{r, print regions not in if less than 10, results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


### Number of species in the LC from each BRU level 3 area.

```{r, Number of species in the LC from each BRU level 3 area, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_species, decreasing = TRUE)][1:10]
top10_value = plot_info$no_species[order(plot_info$no_species, decreasing = TRUE)][1:10]
top10 = data.frame(region = top10_name, no_species = top10_value)

plot_info$no_species[plot_info$no_species == 0] = NA
fig = ggplot(plot_info)+
  geom_sf(aes(fill=no_species),  col="transparent")+
  stat_sf_coordinates(aes(col=no_species))+
  scale_colour_distiller(direction=1, 
                         name="Number of Species") +
  scale_fill_distiller(direction=1,
                       name="Number of Species")+
  coord_sf(expand=FALSE)

fig
```

The regions with the most number of species are:

```{r, Number of species in the LC from each BRU level 3 area - regions most speciies, results='asis'}
names(top10) = c('Region', 'Number of Species')
library(flextable)
top10 |>
  flextable() |>
  set_caption(caption = "Table 1: Top 10 regions with largest number of species in the LC") |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
```

***

## Endemic Species in the LC

Here we say a species is endemic if is belongs to a single BRU level 3 region (with the location criteria described at the start of the document).

### BRU level 3 areas represented by endemic species in the LC

```{r Endemic Species in the LC}
percent_rep = round(sum(plot_info$rep_endemic) / length(plot_info$rep_endemic) *100,digits = 2)
no_rep = plot_info$LEVEL3_NAM[!plot_info$rep_endemic]
```


```{r, Represented Endemic Species in the LC - figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
fig = ggplot(plot_info)+
  geom_sf(aes(fill=rep_endemic),  col="transparent")+
  stat_sf_coordinates(aes(col=rep_endemic))+
  guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
         col = "none")

fig
```

In the LC `r percent_rep`% of the BRU level 3 regions are represented by endemic species, with `r length(no_rep)` regions un-represented. 

```{r, Endemic Species in the LC 2,results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


### Number of endemic species in the LC from each BRU level 3 area.

```{r, Number Endemic Species in the LC - figure, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_endemic, decreasing = TRUE)][1:10]
top10_value = plot_info$no_endemic[order(plot_info$no_endemic, decreasing = TRUE)][1:10]
top10 = data.frame(region = top10_name, no_endemic = top10_value)

plot_info$no_endemic[plot_info$no_endemic == 0] = NA
fig = ggplot(plot_info)+
  geom_sf(aes(fill=no_endemic),  col="transparent")+
  stat_sf_coordinates(aes(col=no_endemic))+
  scale_colour_distiller(direction=1, 
                         name="Number of Species") +
  scale_fill_distiller(direction=1,
                       name="Number of Species")+
  coord_sf(expand=FALSE)


fig
```

The regions with the most number of endemic species are:

```{r, Number Endemic Species in the LC - table, results='asis'}
names(top10) = c('Region', 'Number of Endemic Species')
library(flextable)
top10 |>
  flextable() |>
  set_caption(caption = "Table 1: Top 10 regions with largest number of endemic species in the LC") |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
```

***

## Threatened Species in the LC

Here a threatened species is any taxa in the LC that has been flagged as vulnerable, endangered, critically endangered, extinct in the wild or extinct. A taxa can be flagged in two ways; either matching the original name in the collection directly to IUCN's red list or by matching the accepted name in POWO to IUCN's red list. 

### BRU level 3 areas represented by threatened species in the LC

```{r no threatened species regions represented}
percent_rep = round(sum(plot_info$rep_threatened) / length(plot_info$rep_threatened) *100,digits = 2)
no_rep = plot_info$LEVEL3_NAM[!plot_info$rep_threatened]
```


```{r, Represented Threatened Species in the LC - figure, echo = FALSE, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
fig = ggplot(plot_info)+
  geom_sf(aes(fill=rep_threatened),  col="transparent")+
  stat_sf_coordinates(aes(col=rep_threatened))+
  guides(fill=guide_legend(title="Species \nRepresented \nin LC"),
         col = "none")

fig
```

In the LC `r percent_rep`% of the BRU level 3 regions are represented by threatened species, with `r length(no_rep)` regions un-represented. 

```{r, show represented threatened regions, results = "asis", echo = FALSE, eval = length(no_rep) < 11}
cat('These are: ')
cat(paste0(no_rep, collapse=", "))
```


### Number of threatened species in the LC from each BRU level 3 area.

```{r, Number Threatened Species in the LC - figure, fig.fullwidth=FALSE, fig.dim = c(10, 6)}
top10_name = plot_info$LEVEL3_NAM[order(plot_info$no_threatened, decreasing = TRUE)][1:10]
top10_value = plot_info$no_threatened[order(plot_info$no_threatened, decreasing = TRUE)][1:10]
top10 = data.frame(region = top10_name, no_threatened = top10_value)

plot_info$no_threatened[plot_info$no_threatened == 0] = NA
fig = ggplot(plot_info)+
  geom_sf(aes(fill=no_threatened),  col="transparent")+
  stat_sf_coordinates(aes(col=no_threatened))+
  scale_colour_distiller(direction=1, 
                         name="Number of Species") +
  scale_fill_distiller(direction=1,
                       name="Number of Species")+
  coord_sf(expand=FALSE)

fig
```

The regions with the most number of threatened species are:

```{r, Number Threatened Species in the LC - table, results='asis'}
names(top10) = c('Region', 'Number of Threatened Species')
library(flextable)
top10 |>
  flextable() |>
  set_caption(caption = "Table 1: Top 10 regions with largest number of threatened species in the LC") |> 
  font(fontname = "Calibri (Body)", part = "all") |> 
  fontsize(size = table_font_size, part = "body") |> 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) |> 
  theme_booktabs() |> # default theme
  autofit()
```

***
