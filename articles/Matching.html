<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="BGSmartR">
<title>Method of Matching taxonomic records • BGSmartR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Method of Matching taxonomic records">
<meta property="og:description" content="BGSmartR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">BGSmartR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Matching.html">Method of Matching taxonomic records</a>
    <a class="dropdown-item" href="../articles/Creating_enrich_databases.html">Creating_enrich_databases</a>
    <a class="dropdown-item" href="../articles/value_of_items.html">Adding value to items in a collection</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="Matching_files/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="Matching_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="Matching_files/datatables-binding-0.30/datatables.js"></script><link href="Matching_files/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="Matching_files/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="Matching_files/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="Matching_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="Matching_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Method of Matching taxonomic records</h1>
            
      
      
      <div class="d-none name"><code>Matching.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakepowellcubg.github.io/BGR/">BGSmartR</a></span><span class="op">)</span></span></code></pre></div>
<p><em>In BGSmartR we use an opinionated method to match taxonomic
records to enrichment databases (such as <a href="https://powo.science.kew.org" class="external-link">Plants of the World Online</a>
(POWO) or <a href="https://www.iucnredlist.org" class="external-link">IUCN Red List</a>) using
taxonomic names of plants . Our method is automatic and does not require
any manual alterations. Moreover, rather than rely on “fuzzy” matching
in difficult cases we apply criteria functions to find the best possible
match.</em></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Records in a collection are matched via their taxonomic name and
taxonomic author/s (if provided). A frustration with taxonomic data is
that often the taxonomic name itself is frequently not unique - for
example <a href="https://powo.science.kew.org/results?q=Abies%20taxifolia" class="external-link">Abies
taxifolia</a>. This is often compounded by collections not storing the
taxonomic author, resulting in multiple matches. Moreover, since
collections data are often converted from old paper records there is a
strong possibility that there could be mistakes or typos in the
taxonomic name. For example an hybridization marker might be missed out
or the wrong infraspecific group used.</p>
<p>Hence, our method attempts to match taxonomic names to external
databases whilst automatically accounting for these common issues.</p>
<p>Matches of taxonomic records are found by processing the taxonomic
name and taxonomic author/s through a matching ‘pipeline’. The pipeline
is summarized in the flow chart below.</p>
<p><img src="images/flow.png"></p>
<p>Each taxonomic record is matched by flowing through the pipeline
shown. The purple state indicated the start of the algorithm. blue
states correspond to obtaining a match (or no match), yellow to process
steps and green to decisions that are made in the algorithm. Steps of
the algorithm (numbered in the diagram) are explored in <strong>Parts of
the Algorithm</strong> section.</p>
<p>The matching functions discussed within are wrapped together into the
function <code><a href="../reference/enrich_collection.html">enrich_collection()</a></code> to enrich a collection with
information from WCVP/Red list/BGCI. This can be used to match and
enrich your collection without concerning yourself with the method
applied. See vignette XX to see the function in action.</p>
<p>For those with interest, we discuss the functions used in matching
taxonomic names, how they link together and how they can be used to
create a custom-matching algorithm to other databases. Throughout we
will mostly concern ourself with matching to WCVP.</p>
<hr>
</div>
<div class="section level2">
<h2 id="whole-algorithm">Whole Algorithm<a class="anchor" aria-label="anchor" href="#whole-algorithm"></a>
</h2>
<p>To match to WCVP we use the function
<code><a href="../reference/match_collection_to_wcvp.html">match_collection_to_wcvp()</a></code> which performs all the steps of
the matching algorithm outlined previously.</p>
<p>We need to define a <code>collection</code> with taxonomic names and
authors and WCVP database before running the matching algorithm. The
<code>wcvp</code> database needs to be created using
<code><a href="../reference/import_wcvp_names.html">import_wcvp_names()</a></code> in BGSmartR. This takes the version of
WCVP from POWO and “enhances” it to include extra information required
in our matching algorithm.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load (simplfied) wcvp.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">'data/wcvp_matching_example.rda'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create collection database.</span></span>
<span><span class="va">ids</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">7</span></span>
<span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Amsonia ciliata'</span>, <span class="st">'Abies taxifolia'</span>, <span class="st">'Acalypha gracilens f. fraseri'</span>,</span>
<span>                <span class="st">"Petunia 'Night Sky'"</span>, <span class="st">'Artemisia pfaffii'</span>, <span class="st">'Acmena hemilamprae'</span>, <span class="st">'Amsonia gracilens'</span><span class="op">)</span></span>
<span><span class="va">taxon_authors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Walter'</span>, <span class="st">'Desf.'</span>, <span class="st">'Weath.'</span>, <span class="st">''</span>, <span class="st">'Giacom. &amp; Pignatti'</span>,<span class="st">'L.M.Perry'</span>, <span class="st">'L.'</span><span class="op">)</span></span>
<span><span class="va">collection</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ids</span>, <span class="va">taxon_names</span>, <span class="va">taxon_authors</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run matching to wcvp.</span></span>
<span><span class="fu"><a href="../reference/match_collection_to_wcvp.html">match_collection_to_wcvp</a></span><span class="op">(</span><span class="va">collection</span>,</span>
<span>                         wcvp <span class="op">=</span> <span class="va">wcvp</span>,taxon_name_column <span class="op">=</span> <span class="st">'taxon_names'</span>,</span>
<span>                         taxon_author_column <span class="op">=</span> <span class="st">'taxon_authors'</span>,</span>
<span>                         typo_method <span class="op">=</span> <span class="st">'All'</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `7` records found.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Extracting taxon names and authors from the original report</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Reducing to unique taxon name and author combinations</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `7` unique taxon names/ taxon name author combinations found.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Found 0 exceptions to known not in POWO.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Removing known not to be in POWO from 7 names</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Found 1 known not to be in POWO</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Matching 6 names to unique taxon names</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Found 1 of 6 names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Matching 5 names to non-unique taxon names</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Found 1 of 5 names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Testing and matching taxon name issues for 4 names</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying removing autonyms from taxon names</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying changing infraspecific level to 1 name</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying fixing hybrid for taxon names with 2/3/4 words 4 names</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Found 2 of 4 names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Testing and matching typos for 2 names</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Found 1 of 2 names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Converting to accepted name..</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Updated to accepted name for 3 of 7 names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Matching Complete</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 35 39  7 -1 17 30 -3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $details</span></span>
<span><span class="co">#&gt; [1] "Amsonia ciliata -&gt; (matches record with single entry) -&gt; (76904-1, Amsonia ciliata)"                                                                                                                                             </span></span>
<span><span class="co">#&gt; [2] "Abies taxifolia -&gt; (Multiple records in enriched database) -&gt; (Exact author match) -&gt; (261644-1, Abies taxifolia) -&gt; (Go to accepted name) -&gt; (60468511-2, Abies alba)"                                                          </span></span>
<span><span class="co">#&gt; [3] "Acalypha gracilens f. fraseri -&gt; (Try Fixing taxomonic name) -&gt; Acalypha gracilens var. fraseri -&gt;  (single fixed record) -&gt;  (1280-2, Acalypha gracilens var. fraseri) -&gt; (Go to accepted name) -&gt; (1278-2, Acalypha gracilens)"</span></span>
<span><span class="co">#&gt; [4] "Petunia 'Night Sky' -&gt; (Cultivar or Indeterminate &lt;Do not attempt matching&gt;)"                                                                                                                                                    </span></span>
<span><span class="co">#&gt; [5] "Artemisia pfaffii -&gt; (Try Fixing taxomonic name) -&gt; Artemisia × pfaffii -&gt;  (single fixed record) -&gt;  (179958-1, Artemisia × pfaffii)"                                                                                           </span></span>
<span><span class="co">#&gt; [6] "Acmena hemilamprae -&gt; (Typo) -&gt; Acmena hemilampra -&gt; (matches record with single entry) -&gt; (590531-1, Acmena hemilampra) -&gt; (Go to accepted name) -&gt; (77072406-1, Syzygium hemilamprum)"                                         </span></span>
<span><span class="co">#&gt; [7] "Amsonia gracilens -&gt; (No match found)"                                                                                                                                                                                           </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $details_short</span></span>
<span><span class="co">#&gt; [1] "EXACT"                 "EXACT, ACCEPTED"       "ACCEPTED, FIX"        </span></span>
<span><span class="co">#&gt; [4] "CULT/INDET"            "FIX"                   "EXACT, TYPO, ACCEPTED"</span></span>
<span><span class="co">#&gt; [7] "NO_MATCH"             </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $match_taxon_name</span></span>
<span><span class="co">#&gt; [1] "Amsonia ciliata"                 "Abies taxifolia"                </span></span>
<span><span class="co">#&gt; [3] "Acalypha gracilens var. fraseri" NA                               </span></span>
<span><span class="co">#&gt; [5] "Artemisia × pfaffii"             "Acmena hemilampra"              </span></span>
<span><span class="co">#&gt; [7] NA                               </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $original_authors</span></span>
<span><span class="co">#&gt; [1] "Walter"             "Desf."              "Weath."            </span></span>
<span><span class="co">#&gt; [4] ""                   "Giacom. &amp; Pignatti" "L.M.Perry"         </span></span>
<span><span class="co">#&gt; [7] "L."                </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $match_authors</span></span>
<span><span class="co">#&gt; [1] "Walter"                       "Desf."                       </span></span>
<span><span class="co">#&gt; [3] "(Mull.Arg.) Weath."           NA                            </span></span>
<span><span class="co">#&gt; [5] "Giacom. &amp; Pignatti"           "(F.Muell.) Merr. &amp; L.M.Perry"</span></span>
<span><span class="co">#&gt; [7] NA                            </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $author_check</span></span>
<span><span class="co">#&gt; [1] "Identical" "Identical" "Partial"   "No Match"  "Identical" "Partial"  </span></span>
<span><span class="co">#&gt; [7] "No Match"</span></span></code></pre></div>
<p>In the example we see that matches are found for 5 out of the 7
inputted taxonomic names (those with a positive <code>$match</code>).
The values in match correspond to the row number in wcvp of the matched
record. Moreover, the output provides <code>$details_short</code> and
<code>$details</code> that describe how the matches occurred. Also
outputted are <code>$match_taxon_name</code>,
<code>$original_authors</code>, <code>$match_authors</code> and
<code>$author_check</code> which can be used to compare authors and
taxonomic names between the inputted collection and wcvp.</p>
<p><code><a href="../reference/match_collection_to_wcvp.html">match_collection_to_wcvp()</a></code> takes a variety of different
inputs to allow flexibility in the matching. For example inputs
include</p>
<ul>
<li>
<code>do_add_split</code>: A toggle for whether we search for
missing f./var./subsp,</li>
<li>
<code>do_fix_hybrid</code>: A toggle for whether we search for
hybrid issues,</li>
<li>
<code>do_rm_autonym</code>: A toggle for whether we try removing
autonyms,</li>
<li>
<code>typo_method</code>: The level of typo finding required,</li>
<li>
<code>do_convert_accepted</code>: A toggle for whether we convert to
accepted names,</li>
</ul>
<p>further details can be found in the function’s documentation.</p>
<hr>
</div>
<div class="section level2">
<h2 id="parts-of-the-algorithm">Parts of the Algorithm<a class="anchor" aria-label="anchor" href="#parts-of-the-algorithm"></a>
</h2>
<p>In this section we will illustrate each part of the matching
algorithm. The database we want to match the collection’s taxonomic
names to we refer to as the enrichment database. Note that the
information of WCVP is contained within two databases named
<em>wcvp_names</em> and <em>wcvp_distribution.</em> In the following
matching examples we match to <em>wcvp_names</em> which is located at
<code>wcvp$wcvp_names</code>.</p>
<div class="section level3">
<h3 id="sanitise-taxon-names">1) Sanitise taxon names<a class="anchor" aria-label="anchor" href="#sanitise-taxon-names"></a>
</h3>
<p>This step is used to standardise the format of the taxon name in the
original report. The standard format we implement is every character
should be lower case except for the first letter of the Genus. We
standardise the hybrid sign to be × rather than <code>x</code> or
<code>X</code> (or the rare case of <code>h</code> or <code>H</code>).
We also ensure that the infraspecific level is of the format
<code>f.</code>, <code>var.</code>, <code>subsp.</code> or
<code>nothosubsp.</code>.</p>
<p>Note that the sanitisation should also be performed on the enrichment
database. For WCVP this is performed in
<code><a href="../reference/import_wcvp_names.html">import_wcvp_names()</a></code>.</p>
<p>We apply <code><a href="../reference/sanitise_name.html">sanitise_name()</a></code> to clean taxonomic names in the
collection.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sanitise_name.html">sanitise_name</a></span><span class="op">(</span><span class="st">'TRIGONELLA smyrnaea'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Trigonella smyrnaea"</span></span>
<span><span class="fu"><a href="../reference/sanitise_name.html">sanitise_name</a></span><span class="op">(</span><span class="st">'Halimium X pauanum'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Halimium × pauanum"</span></span>
<span><span class="fu"><a href="../reference/sanitise_name.html">sanitise_name</a></span><span class="op">(</span><span class="st">'Aruncus dioicus var acuminatus'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Aruncus dioicus var. acuminatus"</span></span></code></pre></div>
<hr>
</div>
<div class="section level3">
<h3 id="remove-cultivars-and-indeterminantes">2) Remove cultivars and indeterminantes<a class="anchor" aria-label="anchor" href="#remove-cultivars-and-indeterminantes"></a>
</h3>
<p>This step sets the match to <code>-1</code> for the taxon names we
know do not appear in the enrichment database. For WCVP this includes
cultivars and indeterminates. We find these taxon names by pattern
matching in particular we check for the following patterns.</p>
<ul>
<li>Includes <code>sp.</code>.</li>
<li>Includes <code>gx</code>.</li>
<li>Includes <code>gx</code>.</li>
<li>Includes <code>'XX'</code> for some text XX. This is common notation
for cultivars.</li>
<li>Includes <code>[</code>.</li>
<li>Begins with <code>Indet</code>.</li>
<li>Ends in <code>indet</code>.</li>
<li>Ends in <code>cv</code>.</li>
<li>Includes <code>cv.</code>.</li>
<li>Includes <code>unkn</code>.</li>
<li>Ends in <code>hybrid</code>.</li>
<li>Includes <code>unknown</code>.</li>
</ul>
<p>This is performed using by <code><a href="../reference/match_single.html">no_match_cultivar_indet()</a></code>.
For these taxon names we set the output message to
<code>(Cultivar or Indeterminate &lt;Do not attempt matching&gt;)</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Acalypha fruticulosa'</span>, <span class="st">'Asclepias sp.'</span>, <span class="st">"Abies umbilicata 'Some Cultivar'"</span>, </span>
<span>                 <span class="st">'Ammi copticum cv.'</span><span class="op">)</span></span>
<span> <span class="fu"><a href="../reference/match_single.html">no_match_cultivar_indet</a></span><span class="op">(</span><span class="va">taxon_names</span><span class="op">)</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] NA -1 -1 -1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] ""                                                         </span></span>
<span><span class="co">#&gt; [2] " -&gt; (Cultivar or Indeterminate &lt;Do not attempt matching&gt;)"</span></span>
<span><span class="co">#&gt; [3] " -&gt; (Cultivar or Indeterminate &lt;Do not attempt matching&gt;)"</span></span>
<span><span class="co">#&gt; [4] " -&gt; (Cultivar or Indeterminate &lt;Do not attempt matching&gt;)"</span></span></code></pre></div>
<hr>
</div>
<div class="section level3">
<h3 id="match-taxon-names-to-unique-taxon-names-in-enrichment-database">3) Match taxon names to “unique” taxon names in enrichment
database<a class="anchor" aria-label="anchor" href="#match-taxon-names-to-unique-taxon-names-in-enrichment-database"></a>
</h3>
<p>This step matches the taxon names in the collection to the records in
the enrichment database that have a “unique” taxonomic name. By this we
mean the taxonomic name exists for a single record in the enrichment
database and there are not multiple plants with different authors
sharing the same taxonomic name.</p>
<p>As the taxonomic name is unique no further matching decisions are
required (e.g authors).</p>
<p>This step is performed using <code><a href="../reference/match_single.html">match_single()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Choose some taxon names</span></span>
<span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Amaranthus graecizans subsp. silvestris"</span>, <span class="st">"Amsonia ciliata"</span>, <span class="st">"Aristolochia islandica"</span>, <span class="st">"Adenocalymma scabriusculum"</span>, <span class="st">"Fake name"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Choose the indices of wcvp which correspond to a unique taxon name using `single_entry`.</span></span>
<span><span class="va">wcvp_search_index_single</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">$</span><span class="va">single_entry</span> <span class="op">==</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform the match</span></span>
<span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_single.html">match_single</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>,</span>
<span>                     enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,</span>
<span>                     enrich_database_search_index <span class="op">=</span> <span class="va">wcvp_search_index_single</span>,</span>
<span>                     enrich_display_in_message_column <span class="op">=</span> <span class="st">'powo_id'</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="va">match</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 21 35 37 36 NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (matches record with single entry) -&gt; (108437-3, Amaranthus graecizans subsp. silvestris)"</span></span>
<span><span class="co">#&gt; [2] " -&gt; (matches record with single entry) -&gt; (76904-1, Amsonia ciliata)"                         </span></span>
<span><span class="co">#&gt; [3] " -&gt; (matches record with single entry) -&gt; (19504-2, Aristolochia islandica)"                  </span></span>
<span><span class="co">#&gt; [4] " -&gt; (matches record with single entry) -&gt; (108156-1, Adenocalymma scabriusculum)"             </span></span>
<span><span class="co">#&gt; [5] ""</span></span></code></pre></div>
<p>We see that <code>match</code> is a list that contains:</p>
<ul>
<li>
<code>$match</code> the corresponding row in
<code>wcvp$wcvp_names</code>, if no match return <code>NA</code>.</li>
<li>
<code>$message</code> that informs on how the match is obtained, if
no match the message is set to <code>''</code>.</li>
</ul>
<p>If we find a match the algorithm uses
<code>enrich_display_in_message_column</code> by default also provides
the <code>powo_id</code> (e.g. <code>108437-3</code>) which can be used
to search for the plant directly on POWO’s website. This output code in
the message can be changed for any column in
<code>wcvp$wcvp_names</code> using the input
<code>enrich_display_in_message_column</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/match_single.html">match_single</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>, enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,</span>
<span>             enrich_database_search_index <span class="op">=</span> <span class="va">wcvp_search_index_single</span>,</span>
<span>             enrich_display_in_message_column <span class="op">=</span> <span class="st">'plant_name_id'</span><span class="op">)</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 21 35 37 36 NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (matches record with single entry) -&gt; (2632859, Amaranthus graecizans subsp. silvestris)"</span></span>
<span><span class="co">#&gt; [2] " -&gt; (matches record with single entry) -&gt; (8441, Amsonia ciliata)"                           </span></span>
<span><span class="co">#&gt; [3] " -&gt; (matches record with single entry) -&gt; (2651517, Aristolochia islandica)"                 </span></span>
<span><span class="co">#&gt; [4] " -&gt; (matches record with single entry) -&gt; (319419, Adenocalymma scabriusculum)"              </span></span>
<span><span class="co">#&gt; [5] ""</span></span></code></pre></div>
<p>Moreover, for this function the match can be changed from the row
number in <code>wcvp$wcvp_names</code> to any column using the input
<code>match_column</code>, for example</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/match_single.html">match_single</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>, enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,</span>
<span>             enrich_database_search_index <span class="op">=</span> <span class="va">wcvp_search_index_single</span>,</span>
<span>             match_column <span class="op">=</span> <span class="st">'taxon_status'</span>,</span>
<span>             enrich_display_in_message_column <span class="op">=</span> <span class="st">'plant_name_id'</span><span class="op">)</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] "Accepted" "Accepted" "Accepted" "Accepted" NA        </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (matches record with single entry) -&gt; (2632859, Amaranthus graecizans subsp. silvestris)"</span></span>
<span><span class="co">#&gt; [2] " -&gt; (matches record with single entry) -&gt; (8441, Amsonia ciliata)"                           </span></span>
<span><span class="co">#&gt; [3] " -&gt; (matches record with single entry) -&gt; (2651517, Aristolochia islandica)"                 </span></span>
<span><span class="co">#&gt; [4] " -&gt; (matches record with single entry) -&gt; (319419, Adenocalymma scabriusculum)"              </span></span>
<span><span class="co">#&gt; [5] ""</span></span></code></pre></div>
<hr>
</div>
<div class="section level3">
<h3 id="match-to-non-unique-taxon-names-in-enrichment-database">4) Match to non-unique taxon names in enrichment database<a class="anchor" aria-label="anchor" href="#match-to-non-unique-taxon-names-in-enrichment-database"></a>
</h3>
<p>By non-unique taxon names we mean names that have multiple entries in
the enrichment database (with different authors). For example suppose
our collection contains the taxon name <code>'Abies taxifolia'</code>.
Searching in WCVP we find 6 records for that taxon name.</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-4995812663a4ce3e50e4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-4995812663a4ce3e50e4">{"x":{"filter":"none","vertical":false,"data":[["146571","146655","146808","176533","176535","688734"],[382029,382030,382027,382028,382031,382032],["Abies taxifolia","Abies taxifolia","Abies taxifolia","Abies taxifolia","Abies taxifolia","Abies taxifolia"],["Desf.","Raf.","Duhamel","Poir.","C.Presl","J.Jeffrey ex Gordon &amp; Glend."],["Synonym","Synonym","Synonym","Illegitimate","Synonym","Invalid"],[381621,381621,381621,469725,469725,469765]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>plant_name_id<\/th>\n      <th>taxon_name<\/th>\n      <th>taxon_authors<\/th>\n      <th>taxon_status<\/th>\n      <th>accepted_plant_name_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>To decide which record best matches the plant in the collection we
first try to match on the taxonomic author.</p>
<p>If it is not possible to match via taxonomic author we can use a
custom matching criteria dependent on the enrichment database used. For
WCVP one option is to use the taxon status and the accepted plant name
to determine the best match. In particular, if all records go to the
same accepted plant name then just pick any (if we later push matches to
accepted names). Otherwise, use the taxon status where we first use the
record if it is accepted, if none are accepted then use synonym.</p>
<p>To obtain the matches we use <code><a href="../reference/match_single.html">match_multiple()</a></code> that
applies both author matching and custom criterias.</p>
<p>Below we give an example with <em>Abies taxifolia</em> and varying
authors.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Choose some taxon names</span></span>
<span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Abies taxifolia'</span>,<span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">taxon_authors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Desf.'</span>, <span class="st">'Jeffrey'</span>, <span class="st">'Gor'</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Choose the indices of wcvp which correspond to a non-unique taxon name using `single_entry`.</span></span>
<span><span class="va">wcvp_search_index_mult</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">$</span><span class="va">single_entry</span> <span class="op">==</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform the match</span></span>
<span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_single.html">match_multiple</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>,</span>
<span>                       taxon_authors <span class="op">=</span> <span class="va">taxon_authors</span>,</span>
<span>                       enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>, </span>
<span>                       enrich_database_search_index <span class="op">=</span> <span class="va">wcvp_search_index_mult</span>,</span>
<span>                       matching_criterion <span class="op">=</span> <span class="fu">BGSmartR</span><span class="fu">::</span><span class="va"><a href="../reference/no_additional_matching.html">additional_wcvp_matching</a></span>,</span>
<span>                       enrich_plant_identifier_column <span class="op">=</span> <span class="st">'plant_name_id'</span>,</span>
<span>                       show_progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">match</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1]  9 20 20 -2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (Multiple records in enriched database) -&gt; (Exact author match) -&gt; (, Abies taxifolia)"              </span></span>
<span><span class="co">#&gt; [2] " -&gt; (Multiple records in enriched database) -&gt; (Partial author &lt;most words&gt;) -&gt; (, Abies taxifolia)"     </span></span>
<span><span class="co">#&gt; [3] " -&gt; (Multiple records in enriched database) -&gt; (Partial author &lt;most words&gt;) -&gt; (, Abies taxifolia)"     </span></span>
<span><span class="co">#&gt; [4] " -&gt; (Multiple records in enriched database) -&gt; (No authors) -&gt;(multiple best taxon status, do not match)"</span></span></code></pre></div>
<p>We see that without an author we cannot determine a match
(<code>$match = -2</code>) this is due to having to use taxon status and
accepted plant name id for the matching criteria and these cannot select
a single record (accepted plant name ids not all the same, multiple best
taxon status <em>synonym</em>). When the author was provided we found
matches. For <em>‘Desf.’</em> the author matches exactly a record in
WCVP and <em>Jeffrey</em>, <em>Gor</em> both partially match
<em>J.Jeffrey ex Gordon &amp; Glend.</em>.</p>
<p>By default <code><a href="../reference/match_single.html">match_multiple()</a></code> depends
<code><a href="../reference/match_authors.html">match_authors()</a></code> and <code><a href="../reference/no_additional_matching.html">no_additional_matching()</a></code>
which performs author matching and custom matching respectively. Above
we use <code><a href="../reference/no_additional_matching.html">additional_wcvp_matching()</a></code> which performs custom
matching for taxon_status and accepted plant name id. These can be
changed using the inputs <code>matching_authors</code> and
<code>matching_criterion</code>.</p>
<p>In the following subsections we describe author matching and custom
matching.</p>
<div class="section level4">
<h4 id="matching-using-taxonomic-author-">Matching using taxonomic author.<a class="anchor" aria-label="anchor" href="#matching-using-taxonomic-author-"></a>
</h4>
<p>Author matching is performed using <code><a href="../reference/match_authors.html">match_authors()</a></code>,
which takes both the author from the collection and the authors from the
enrichment database to compare. The function will initially try to match
the author exactly. If there are no exact matches it will then look for
partial matches (authors with shared words).</p>
<p>Example of an exact author match.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Restrict wcvp to only taxon_name = 'Abies taxifolia'</span></span>
<span><span class="va">wcvp_Abies_taxifolia</span> <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">[</span><span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">$</span><span class="va">taxon_name</span> <span class="op">==</span> <span class="st">'Abies taxifolia'</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># Get author name from the collection and author names from wcvp.</span></span>
<span><span class="va">collection_author</span> <span class="op">=</span> <span class="st">'Desf.'</span></span>
<span><span class="va">wcvp_authors</span> <span class="op">=</span> <span class="va">wcvp_Abies_taxifolia</span><span class="op">$</span><span class="va">taxon_authors</span></span>
<span></span>
<span><span class="co"># Match via authors</span></span>
<span><span class="va">matched_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_authors.html">match_authors</a></span><span class="op">(</span><span class="va">collection_author</span>, <span class="va">wcvp_authors</span><span class="op">)</span></span>
<span><span class="va">matched_info</span></span>
<span><span class="co">#&gt; $wanted</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(Exact author match)"</span></span>
<span></span>
<span><span class="co"># Restrict wcvp_Abies_taxifolia to only matched authors</span></span>
<span> <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="va">matched_info</span><span class="op">$</span><span class="va">wanted</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span>,options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-e38b9b257e7b5cbf2777" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-e38b9b257e7b5cbf2777">{"x":{"filter":"none","vertical":false,"data":[["146571"],[382029],["Abies taxifolia"],["Desf."],["Synonym"],[381621]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>plant_name_id<\/th>\n      <th>taxon_name<\/th>\n      <th>taxon_authors<\/th>\n      <th>taxon_status<\/th>\n      <th>accepted_plant_name_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>Example of a partial match.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Change author name for the collection</span></span>
<span><span class="va">collection_author</span> <span class="op">=</span> <span class="st">'Jeffrey'</span></span>
<span></span>
<span><span class="co"># Match via authors</span></span>
<span><span class="va">matched_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_authors.html">match_authors</a></span><span class="op">(</span><span class="va">collection_author</span>,<span class="va">wcvp_authors</span><span class="op">)</span></span>
<span><span class="va">matched_info</span></span>
<span><span class="co">#&gt; $wanted</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE FALSE FALSE FALSE  TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(Partial author &lt;most words&gt;)"</span></span>
<span></span>
<span><span class="co"># Restrict wcvp_Abies_taxifolia to only matched authors</span></span>
<span><span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="va">matched_info</span><span class="op">$</span><span class="va">wanted</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span><span class="op">]</span>,options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-e62c29949df980b727ac" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-e62c29949df980b727ac">{"x":{"filter":"none","vertical":false,"data":[["688734"],[382032],["Abies taxifolia"],["J.Jeffrey ex Gordon &amp; Glend."],["Invalid"],[469765]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>plant_name_id<\/th>\n      <th>taxon_name<\/th>\n      <th>taxon_authors<\/th>\n      <th>taxon_status<\/th>\n      <th>accepted_plant_name_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>By default partial matching chooses the records that shares the most
words with the author given in the collection (by default the input
<code>partial_method = 'most words'</code>) this can be changed to chose
any record with any level of partial matching using
<code>partial_method = 'any words'</code>.</p>
</div>
<div class="section level4">
<h4 id="custom-matching-">Custom matching.<a class="anchor" aria-label="anchor" href="#custom-matching-"></a>
</h4>
<p>Custom matching is performed by the so called
<code>matching_criteria()</code> function, this takes an extract of the
enrichment database (often those with idenitical taxon names) and
attempts to choose the best record using some criteria and returns the
rows which correspond to the best match.</p>
<p>To allow flexibility this function can be passed as an input
<code>matching_criteria</code> to <code><a href="../reference/match_single.html">match_multiple()</a></code>. The
package contains two custom matching criteria
<code><a href="../reference/no_additional_matching.html">no_additional_matching()</a></code> and
<code><a href="../reference/no_additional_matching.html">additional_wcvp_matching()</a></code>. By default
<code><a href="../reference/no_additional_matching.html">no_additional_matching()</a></code> is used.</p>
<p><code><a href="../reference/no_additional_matching.html">no_additional_matching()</a></code> always returns all rows with
the message <em>‘unclear, do not match’</em>. This corresponds to not
applying custom matching.</p>
<p><code><a href="../reference/no_additional_matching.html">additional_wcvp_matching()</a></code> matches records by first
looking at <code>accepted_plant_name_id</code> of the WCVP records
passed to it, if all the accepted plants names are the same the function
returns an accepted taxon status row or if non of these exists just the
first row. If there are differences in
<code>accepted_plant_name_id</code> then the function looks at
<code>taxon_status</code> and returns any rows that are accepted, and if
non are accepted any that are synonyms.</p>
<p>A couple examples are given below.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply to first 3 rows of taxon name  = Abies_taxifolia (i.e all have the same accepted plant name id)</span></span>
<span><span class="fu"><a href="../reference/no_additional_matching.html">additional_wcvp_matching</a></span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(all point to same accepted plant)"</span></span>
<span></span>
<span><span class="co"># Apply to rows 1,4,6 of taxon name  = Abies_taxifolia (i.e differing accepted plant name ids only only has taxon status = synonym)</span></span>
<span><span class="fu"><a href="../reference/no_additional_matching.html">additional_wcvp_matching</a></span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(choose via taxon_status)"</span></span>
<span></span>
<span><span class="co"># Apply to rows 1,4,6 of taxon name  = Abies_taxifolia (i.e differing accepted plant name ids all taxon status = synonym)</span></span>
<span><span class="fu"><a href="../reference/no_additional_matching.html">additional_wcvp_matching</a></span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(multiple best taxon status, do not match)"</span></span></code></pre></div>
<div class="section level5">
<h5 id="creating-new-custom-matching-criteria">Creating new custom matching criteria<a class="anchor" aria-label="anchor" href="#creating-new-custom-matching-criteria"></a>
</h5>
<p>To create a new custom matching function all we need a function that
takes an extract of the enrichment database as an input and returns a
list with <code>$row</code> of the best rows and <code>$message</code>
detailing what the custom matching did.</p>
<p>Within <em>wcvp_names</em> there is a column called
<em>publication_author</em> and suppose we decide if we cannot match via
author we want to use records that have a <em>publication_author</em>.
We create a new matching criteria function called
<code>wcvp_publication_matching()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wcvp_publication_matching</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">enrich_database_extract</span>, <span class="va">message</span> <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Sanity checks.</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">'publication_author'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">enrich_database_extract</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'No column called publication_author in enrichment database'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Find the records with non-NA publication_author.</span></span>
<span>  <span class="va">rows</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">enrich_database_extract</span><span class="op">$</span><span class="va">publication_author</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># If there are records with non-NA publication_author return these rows.</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rows</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">message</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">message</span>, <span class="st">'(Choose record with publication_author)'</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>row <span class="op">=</span> <span class="va">rows</span>, message <span class="op">=</span> <span class="va">message</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span> </span>
<span>  <span class="co"># all publication_author are NA. </span></span>
<span>  <span class="va">message</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">message</span>, <span class="st">'(All publication_author are NA)'</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>row <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">enrich_database_extract</span><span class="op">)</span>, message <span class="op">=</span> <span class="va">message</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Check that the function works as hoped.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># publication_authors in wcvp_Abies_taxifolia.</span></span>
<span><span class="va">wcvp_Abies_taxifolia</span><span class="op">$</span><span class="va">publication_author</span></span>
<span><span class="co">#&gt; [1] NA                   NA                   NA                  </span></span>
<span><span class="co">#&gt; [4] "J.B.A.M.de Lamarck" NA                   NA</span></span>
<span><span class="co"># New matching criteria.</span></span>
<span><span class="fu">wcvp_publication_matching</span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(Choose record with publication_author)"</span></span></code></pre></div>
<p>We see that the function returns the forth row which corresponds to
the only <em>Abies taxifolia</em> record in WCVP with publication
author.</p>
<p>So we can now apply this matching criteria in the function
<code><a href="../reference/match_single.html">match_multiple()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform the match</span></span>
<span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_single.html">match_multiple</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>,</span>
<span>                       taxon_authors <span class="op">=</span> <span class="va">taxon_authors</span>,</span>
<span>                       enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>, </span>
<span>                       enrich_database_search_index <span class="op">=</span> <span class="va">wcvp_search_index_mult</span>,</span>
<span>                       matching_criterion <span class="op">=</span> <span class="va">wcvp_publication_matching</span>,</span>
<span>                       enrich_plant_identifier_column <span class="op">=</span> <span class="st">'plant_name_id'</span>,</span>
<span>                       show_progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">match</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1]  9 20 20 13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (Multiple records in enriched database) -&gt; (Exact author match) -&gt; (, Abies taxifolia)"                                  </span></span>
<span><span class="co">#&gt; [2] " -&gt; (Multiple records in enriched database) -&gt; (Partial author &lt;most words&gt;) -&gt; (, Abies taxifolia)"                         </span></span>
<span><span class="co">#&gt; [3] " -&gt; (Multiple records in enriched database) -&gt; (Partial author &lt;most words&gt;) -&gt; (, Abies taxifolia)"                         </span></span>
<span><span class="co">#&gt; [4] " -&gt; (Multiple records in enriched database) -&gt; (No authors) -&gt;(Choose record with publication_author) -&gt; (, Abies taxifolia)"</span></span></code></pre></div>
<p>We see that the change of matching criterion now finds a match for
the forth record, whereas previous this record could not be matched
based on taxon status or accepted plant name id.</p>
</div>
<div class="section level5">
<h5 id="combining-custom-matching-criterias">Combining custom matching criterias<a class="anchor" aria-label="anchor" href="#combining-custom-matching-criterias"></a>
</h5>
<p>An advantage of the approach used is that it is easy to combine
multiple custom matching criterias into a new criteria function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wcvp_combined_custom_matching</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">enrich_database_extract</span>, <span class="va">message</span> <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### Taxon status and accepted name id matching.</span></span>
<span>  <span class="va">match_A</span> <span class="op">=</span> <span class="fu">BGSmartR</span><span class="fu">::</span><span class="fu"><a href="../reference/no_additional_matching.html">additional_wcvp_matching</a></span><span class="op">(</span><span class="va">enrich_database_extract</span>, <span class="va">message</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># If only one record remains after additional_wcvp_matching return it</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">match_A</span><span class="op">$</span><span class="va">row</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">match_A</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">### update extract and message prior to publication author matching</span></span>
<span>  <span class="va">enrich_database_extract</span> <span class="op">=</span> <span class="va">enrich_database_extract</span><span class="op">[</span><span class="va">match_A</span><span class="op">$</span><span class="va">row</span>,<span class="op">]</span></span>
<span>  <span class="va">message</span> <span class="op">=</span> <span class="va">match_A</span><span class="op">$</span><span class="va">message</span></span>
<span>  </span>
<span>   <span class="co">### publication author matching.</span></span>
<span>  <span class="va">match_B</span> <span class="op">=</span> <span class="fu">wcvp_publication_matching</span><span class="op">(</span><span class="va">enrich_database_extract</span>, <span class="va">message</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">match_B</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then applying the function onto the same cases as before</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply to first 3 rows of taxon name  = Abies_taxifolia (i.e all have the same accepted plant name id)</span></span>
<span><span class="fu">wcvp_combined_custom_matching</span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(all point to same accepted plant)"</span></span>
<span></span>
<span><span class="co"># Apply to rows 1,4,6 of taxon name  = Abies_taxifolia (i.e differing accepted plant name ids only only has taxon status = synonym)</span></span>
<span><span class="fu">wcvp_combined_custom_matching</span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">6</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(choose via taxon_status)"</span></span>
<span></span>
<span><span class="co"># Change the forth taxon_status to synonym so that custom matching will first restrict to synonym then choose the record with publication author.</span></span>
<span><span class="va">wcvp_Abies_taxifolia</span><span class="op">$</span><span class="va">taxon_status</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="st">'Synonym'</span></span>
<span><span class="fu">wcvp_combined_custom_matching</span><span class="op">(</span><span class="va">wcvp_Abies_taxifolia</span><span class="op">)</span></span>
<span><span class="co">#&gt; $row</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "(multiple best taxon status, do not match)(Choose record with publication_author)"</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="check-original-author-names-compared-to-matched-authors">5) Check original author names compared to matched authors<a class="anchor" aria-label="anchor" href="#check-original-author-names-compared-to-matched-authors"></a>
</h3>
<p>Another quirk of matching taxon names is that occasionally it is
possible to find a match where the taxon names are identical with
differing authors where a slight change to the taxon name will yield a
match with identical authors. For example suppose our collection has
<em>Salix fragilis</em> with author <em>L.</em>, in WCVP we have the
following:</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ccbf3218a4640fde0a4d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ccbf3218a4640fde0a4d">{"x":{"filter":"none","vertical":false,"data":[["388309","879346","1082952","1082953"],[2921957,2917719,2917720,2917721],["Salix fragilis","Salix fragilis","Salix fragilis","Salix × fragilis"],["Host","Host","Forssk.","L."],["Misapplied","Misapplied","Unplaced","Accepted"],[2918128,2921746,null,2917721]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>plant_name_id<\/th>\n      <th>taxon_name<\/th>\n      <th>taxon_authors<\/th>\n      <th>taxon_status<\/th>\n      <th>accepted_plant_name_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,5]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>We see in this case if we have a matching criteria that can identify
one of the first three records as the best match then without additional
checks we would go to an incorrect match.</p>
<p>To account for this pitfall after the initial matching by taxonomic
name if the authors do not agree then we search for fixes in the
taxonomic name which have an improved author match.</p>
<p>We use <code><a href="../reference/author_check.html">author_check()</a></code> to compare the authors, which will
output one of</p>
<ul>
<li>
<code>Exact</code> match, the authors are identical.</li>
<li>
<code>Partial</code> match, the authors are split into words and at
least one word is contained in the other (i.e a word in original author
is in matched author, or vice versa).</li>
<li>
<code>Different</code>, the authors are not in the above
categories.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/author_check.html">author_check</a></span><span class="op">(</span><span class="st">'Oliv.'</span>,<span class="st">'Oliv.'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Identical"</span></span>
<span><span class="fu"><a href="../reference/author_check.html">author_check</a></span><span class="op">(</span><span class="st">'(Bong.) D.Don (Piper) C.L.Hitche'</span>,<span class="st">'(Piper) C.H.Hitchc.'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Partial"</span></span>
<span><span class="fu"><a href="../reference/author_check.html">author_check</a></span><span class="op">(</span><span class="st">'L.'</span>,<span class="st">'(W.D.J.Koch) Arcang.'</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Different"</span></span></code></pre></div>
<p>For those with <code><a href="../reference/author_check.html">author_check()</a></code> equal
<code>Different</code> we run <code><a href="../reference/match_single.html">match_all_issue()</a></code> which
attempts to fix the taxon name and find matches. If a match if found
with this method and the author check improves to <code>Partial</code>
or <code>Exact</code> we update the match to the record with fixed taxon
name.</p>
</div>
<div class="section level3">
<h3 id="fix-the-taxon-name">6) Fix the taxon name<a class="anchor" aria-label="anchor" href="#fix-the-taxon-name"></a>
</h3>
<p>If we get to this stage in the algorithm either:</p>
<ul>
<li><p>The taxonomic name cannot be found in the enrichment database,
or</p></li>
<li><p>The taxonomic name has been found but the authors are
different.</p></li>
</ul>
<p>Therefore, we want to make small adjustments to the taxonomic name
and see if any of these adjusts leads to a name found in the enrichment
database.</p>
<p>The changes we make in this step are to try common mistakes in the
taxonomic name which includes:</p>
<ul>
<li>Change/Add/Remove the infraspecific levels.</li>
<li>Change/Add/Remove hybridisation markers.</li>
<li>Removing autonyms.</li>
</ul>
<p>The fixing is performed by <code><a href="../reference/match_single.html">match_all_issue()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Salix fragilis'</span>, <span class="st">'Acalypha gracilens f. fraseri'</span>, <span class="st">'Abies alba var. alba'</span><span class="op">)</span></span>
<span><span class="va">taxon_authors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'L.'</span>, <span class="st">'(Müll.Arg.) Weath.'</span>, <span class="st">'Mill.'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/match_single.html">match_all_issue</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="va">taxon_names</span>,</span>
<span>                taxon_authors <span class="op">=</span> <span class="va">taxon_authors</span>,</span>
<span>                enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,</span>
<span>                enrich_plant_identifier_column <span class="op">=</span> <span class="st">'plant_name_id'</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying removing autonyms from taxon names</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying changing infraspecific level to 2 names</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying fixing hybrid for taxon names with 2/3/4 words 3 names</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 33  6 39</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (Try Fixing taxomonic name) -&gt; Salix × fragilis -&gt;  (single fixed record) -&gt;  (, Salix × fragilis)"                              </span></span>
<span><span class="co">#&gt; [2] " -&gt; (Try Fixing taxomonic name) -&gt; Acalypha gracilens var. fraseri -&gt;  (single fixed record) -&gt;  (, Acalypha gracilens var. fraseri)"</span></span>
<span><span class="co">#&gt; [3] " -&gt; (Try Fixing taxomonic name) -&gt; Abies alba -&gt; (Exact author match)"</span></span></code></pre></div>
<p>We see that for each taxon name a fixed version is found and it is
put forward as a match.</p>
<p>Each method of finding fixed taxon names has a separate function,
namely <code><a href="../reference/match_single.html">try_fix_infraspecific_level()</a></code>,
<code><a href="../reference/match_single.html">try_fix_hybrid()</a></code> and <code><a href="../reference/match_single.html">try_rm_autonym()</a></code>. Each of
these functions creates potential new taxon names and checks whether
they are in the enrichment database’s taxon names.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the taxon names in the enrichment database</span></span>
<span><span class="va">enrich_database_taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">$</span><span class="va">taxon_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Try and find fixed taxon names via fixing  infraspecific level.</span></span>
<span><span class="fu"><a href="../reference/match_single.html">try_fix_infraspecific_level</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Amaranthus graecizans var. silvestris'</span>,</span>
<span>                                            <span class="st">'Aesculus × rubicunda whitleyi'</span>,</span>
<span>                                            <span class="st">'Abelia serrata gymnocarpa'</span><span class="op">)</span>,</span>
<span>                            enrich_database_taxon_names <span class="op">=</span> <span class="va">enrich_database_taxon_names</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying adding infraspecific level to 1 name</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying adding infraspecific level (taxon with hybrid markers) to 1 name</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying changing infraspecific level to 1 name</span></span>
<span><span class="co">#&gt; [1] "Amaranthus graecizans subsp. silvestris"                       </span></span>
<span><span class="co">#&gt; [2] "Aesculus × rubicunda var. whitleyi"                            </span></span>
<span><span class="co">#&gt; [3] "Abelia serrata var. gymnocarpa OR Abelia serrata f. gymnocarpa"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/match_single.html">try_fix_hybrid</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Aesculus rubicunda var. whitleyi'</span>,</span>
<span>                                            <span class="st">'Acer + pseudocreticum'</span>,</span>
<span>                                            <span class="st">'Salix fragilis'</span><span class="op">)</span>,</span>
<span>                            enrich_database_taxon_names <span class="op">=</span> <span class="va">enrich_database_taxon_names</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying fixing hybrid for taxon names with 2/3/4 words 3 names</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying changing/removing hybrid for taxon names 1 name</span></span>
<span><span class="co">#&gt; [1] "Aesculus × rubicunda var. whitleyi" "Acer × pseudocreticum"             </span></span>
<span><span class="co">#&gt; [3] "Salix × fragilis"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/match_single.html">try_rm_autonym</a></span><span class="op">(</span>taxon_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Adina nobilis var. nobilis'</span><span class="op">)</span>,</span>
<span>                            enrich_database_taxon_names <span class="op">=</span> <span class="va">enrich_database_taxon_names</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Trying removing autonyms from taxon names</span></span>
<span><span class="co">#&gt; [1] "Adina nobilis"</span></span></code></pre></div>
<p>We then combine the names given by each method and find the best
match via author matching and custom matching.</p>
<p>If those methods yield multiple potential matches we then select via
the method used to get the fixed taxon name. In particular, we select
first records obtains by <code><a href="../reference/match_single.html">try_fix_infraspecific_level()</a></code> then
<code><a href="../reference/match_single.html">try_fix_hybrid()</a></code> and finally
<code><a href="../reference/match_single.html">try_rm_autonym()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="typo-finding">7) Typo finding<a class="anchor" aria-label="anchor" href="#typo-finding"></a>
</h3>
<p>If a taxon name reaches this stage then a match has not being found
and neither could fixing the taxon name yield a match.</p>
<p>Therefore, our final attempt to find a match is to search for simple
or common typos in the taxon name. Typos are found in three ways:</p>
<ul>
<li>searching a data frame of known typos,</li>
<li>searching for common issues found in the taxon name,</li>
<li>searching for a single letter change in the taxon name.</li>
</ul>
<p>Once a typo is found the corresponding record is selected. I.e. the
first typo is selected and no further search is done.</p>
<p><code><a href="../reference/match_single.html">match_typos()</a></code> performs the typo searching and
matching.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Artemisia × pfaffi'</span>, <span class="st">'Adina racemosae'</span><span class="op">)</span></span>
<span><span class="va">taxon_authors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Giacom. &amp; Pignatti'</span>, <span class="st">'(Siebold &amp; Zucc.) Miq.'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/match_single.html">match_typos</a></span><span class="op">(</span><span class="va">taxon_names</span>, <span class="va">taxon_authors</span>,</span>
<span>            enrich_database <span class="op">=</span> <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,</span>
<span>            typo_method <span class="op">=</span> <span class="st">'All'</span>,</span>
<span>            enrich_display_in_message_column <span class="op">=</span> <span class="st">'powo_id'</span><span class="op">)</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 17 29</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (Typo) -&gt; Artemisia × pfaffii -&gt; (matches record with single entry) -&gt; (179958-1, Artemisia × pfaffii)"</span></span>
<span><span class="co">#&gt; [2] " -&gt; (Typo) -&gt; Adina racemosa -&gt; (matches record with single entry) -&gt; (742931-1, Adina racemosa)"</span></span></code></pre></div>
<p>This step can be computationally expensive, therefore we include the
input <code>typo_method</code> which allows 3 different levels of typo
checking.<code>typo_method = "All"</code> is the maximum level that
performs all typo checking.
<code>typo_method = "Data frame + Common"</code> is the intermediate
level that only tries the known typos and common fixes.
<code>typo_method = "Data frame only"</code> is the minimum level that
only checks whether typos are found from in the known typos data
frame.</p>
<p>Below we outline the three methods to finding typos.</p>
<div class="section level4">
<h4 id="searching-a-data-frame-of-original-names-and-fixed-names">Searching a data frame of original names and fixed names<a class="anchor" aria-label="anchor" href="#searching-a-data-frame-of-original-names-and-fixed-names"></a>
</h4>
<p>In our package we include a data frame of typos
<code><a href="../reference/typo_list.html">BGSmartR::typo_list</a></code>. This contains 8,253 typos that we have
found in collections.</p>
<p>We first find typos by checking against
<code><a href="../reference/typo_list.html">BGSmartR::typo_list</a></code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">BGSmartR</span><span class="fu">::</span><span class="va"><a href="../reference/typo_list.html">typo_list</a></span><span class="op">)</span></span>
<span><span class="co">#&gt;                 original                 fixed</span></span>
<span><span class="co">#&gt; 2       Acacia macrantha      Acacia micrantha</span></span>
<span><span class="co">#&gt; 3 Acoelorrhaphe wrightii Acoelorraphe wrightii</span></span>
<span><span class="co">#&gt; 4      Agave desmettiana      Agave desmetiana</span></span>
<span><span class="co">#&gt; 6      Agave lecheguilla     Agave lechuguilla</span></span>
<span><span class="co">#&gt; 7          Agave werklei        Agave wercklei</span></span>
<span><span class="co">#&gt; 8    Aleurites moluccana  Aleurites moluccanus</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="searching-for-common-issues-found-in-taxon-names">Searching for common issues found in taxon names<a class="anchor" aria-label="anchor" href="#searching-for-common-issues-found-in-taxon-names"></a>
</h4>
<p>If we have not found a match in the typo list we then check for
common issues found in taxon names. In particular we check for the
following changes at the end of the species name.</p>
<ul>
<li>‘i’ &lt;-&gt; ‘ii’</li>
<li>‘i’ &lt;-&gt; ‘ae’</li>
<li>‘a’ &lt;-&gt; ‘um’</li>
<li>‘a’ &lt;-&gt; ‘us’</li>
<li>‘ae’ &lt;-&gt; ‘eae’</li>
<li>‘e’ &lt;-&gt; ‘is’</li>
<li>‘is’ &lt;-&gt;‘e’</li>
<li>‘us’ &lt;-&gt; ‘is’</li>
<li>‘ense’ &lt;-&gt;‘iense’</li>
<li>‘oides’ &lt;-&gt; ‘ioides’</li>
<li>‘orum’ &lt;-&gt; ‘iorum’</li>
</ul>
<p>We also check the following patterns anywhere in the taxon name:</p>
<ul>
<li>‘i’ &lt;-&gt; ‘ae’</li>
</ul>
</div>
<div class="section level4">
<h4 id="searching-for-a-single-change-in-letter">Searching for a single change in letter<a class="anchor" aria-label="anchor" href="#searching-for-a-single-change-in-letter"></a>
</h4>
<p>Our final stage performs a larger check for a change in single
character. This involves:</p>
<ul>
<li>Checking removing a single character from the taxon name in all
positions.</li>
<li>Checking adding a single character (a-z and ‘-’) in all
positions.</li>
<li>Changing a current letter to any character in a-z in all
positions.</li>
</ul>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="update-matches-to-accepted-names-wcvp-only">Update matches to accepted names (WCVP only)<a class="anchor" aria-label="anchor" href="#update-matches-to-accepted-names-wcvp-only"></a>
</h3>
<p>To update taxon names to their accepted form we use the field
<code>accepted_plant_name_id</code> in WCVP. If the
<code>accepted_plant_name_id</code> does not match
<code>plant_name_id</code> then we update the match to correspond to the
accepted plant. This is performed by the function
<code><a href="../reference/convert_to_accepted_name.html">convert_to_accepted_name()</a></code> in BGSmartR, which takes in the
current state of the matches and updates to the accepted form. An
example is given below.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxon_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Adina nobilis'</span>, <span class="st">'Acalypha gracilens var. fraseri'</span>,</span>
<span>                <span class="st">'Andira zehntneri'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the original match.</span></span>
<span><span class="va">match</span> <span class="op">=</span> <span class="fu"><a href="../reference/match_single.html">match_single</a></span><span class="op">(</span><span class="va">taxon_names</span>,<span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span>,<span class="va">wcvp_search_index_single</span>,</span>
<span>                     enrich_display_in_message_column <span class="op">=</span> <span class="st">'powo_id'</span><span class="op">)</span></span>
<span><span class="va">match</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1]  5  6 15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (matches record with single entry) -&gt; (742921-1, Adina nobilis)"                </span></span>
<span><span class="co">#&gt; [2] " -&gt; (matches record with single entry) -&gt; (1280-2, Acalypha gracilens var. fraseri)"</span></span>
<span><span class="co">#&gt; [3] " -&gt; (matches record with single entry) -&gt; (12614-2, Andira zehntneri)"</span></span>
<span></span>
<span><span class="co"># Try to convert to accepted name.</span></span>
<span><span class="va">new_match</span> <span class="op">=</span> <span class="fu"><a href="../reference/convert_to_accepted_name.html">convert_to_accepted_name</a></span><span class="op">(</span><span class="va">match</span><span class="op">$</span><span class="va">match</span>, <span class="va">wcvp</span><span class="op">$</span><span class="va">wcvp_names</span><span class="op">)</span></span>
<span><span class="va">new_match</span></span>
<span><span class="co">#&gt; $match</span></span>
<span><span class="co">#&gt; [1] 29  7 15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] " -&gt; (Go to accepted name) -&gt; (742931-1, Adina racemosa)"  </span></span>
<span><span class="co">#&gt; [2] " -&gt; (Go to accepted name) -&gt; (1278-2, Acalypha gracilens)"</span></span>
<span><span class="co">#&gt; [3] ""</span></span>
<span></span>
<span><span class="co"># Putting the messages together.</span></span>
<span><span class="va">messages</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">match</span><span class="op">$</span><span class="va">message</span>, <span class="va">new_match</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span><span class="va">messages</span></span>
<span><span class="co">#&gt; [1] " -&gt; (matches record with single entry) -&gt; (742921-1, Adina nobilis) -&gt; (Go to accepted name) -&gt; (742931-1, Adina racemosa)"                  </span></span>
<span><span class="co">#&gt; [2] " -&gt; (matches record with single entry) -&gt; (1280-2, Acalypha gracilens var. fraseri) -&gt; (Go to accepted name) -&gt; (1278-2, Acalypha gracilens)"</span></span>
<span><span class="co">#&gt; [3] " -&gt; (matches record with single entry) -&gt; (12614-2, Andira zehntneri)"</span></span></code></pre></div>
<p>We see that the first two taxon names go to an accepted form and the
third does not. This is shown by both <code>$match</code> remaining the
same and an empty <code>$message</code> after running
<code><a href="../reference/convert_to_accepted_name.html">convert_to_accepted_name()</a></code>.</p>
<p>We can check the accepted name by using the codes provided in the
message on POWO’s website. This is done by changing the last part of the
URL. For example <code>Adina nobilis</code> can be found at the address
<a href="https://powo.science.kew.org/taxon/urn:lsid:ipni.org:names:742921-1" class="external-link uri">https://powo.science.kew.org/taxon/urn:lsid:ipni.org:names:742921-1</a>.
We see that this is indeed a synonym of Adina racemosa.</p>
<hr>
</div>
<div class="section level3">
<h3 id="set-remaining-to-not-matched">8) Set remaining to not matched<a class="anchor" aria-label="anchor" href="#set-remaining-to-not-matched"></a>
</h3>
<p>If there are any unmatched taxon names after all the steps mentioned
previously then their match index is set to <code>-3</code>, and their
message equals <code>(No match found)</code>.</p>
<hr>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jake Powell.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
